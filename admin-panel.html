<script>
// Protect Admin Panel - Only accessible after valid login
if (!sessionStorage.getItem("adminAccess")) {
  alert("Unauthorized access. Redirecting to home.");
  window.location.href = "index.html";
}

// Load and display all student reports from localStorage
window.onload = function () {
  const reportContainer = document.getElementById("admin-report-container");

  if (!reportContainer) return;

  let reports = [];
  for (let key in localStorage) {
    if (localStorage.hasOwnProperty(key) && key.startsWith("studentReport_")) {
      try {
        const report = JSON.parse(localStorage.getItem(key));
        reports.push(report);
      } catch (e) {
        console.error("Error parsing report for key:", key);
      }
    }
  }

  if (reports.length === 0) {
    reportContainer.innerHTML = "<p>No reports found yet.</p>";
    return;
  }

  let tableHTML = `
    <table border="1" cellpadding="10" cellspacing="0" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th>Student Name</th>
          <th>Email</th>
          <th>Grade</th>
          <th>Subjects</th>
          <th>Performance Summary</th>
          <th>Download</th>
        </tr>
      </thead>
      <tbody>
  `;

  reports.forEach(report => {
    const subjects = Object.keys(report.scores).join(", ");
    const performance = Object.entries(report.scores).map(([subject, score]) => {
      return `${subject}: ${score}%`;
    }).join("<br>");

    tableHTML += `
      <tr>
        <td>${report.studentName}</td>
        <td>${report.email}</td>
        <td>${report.grade}</td>
        <td>${subjects}</td>
        <td>${performance}</td>
        <td><button onclick='downloadReport("${report.studentName}")'>Download</button></td>
      </tr>
    `;
  });

  tableHTML += "</tbody></table>";
  reportContainer.innerHTML = tableHTML;
};

// Download individual report
function downloadReport(studentName) {
  const key = "studentReport_" + studentName;
  const report = JSON.parse(localStorage.getItem(key));
  if (!report) {
    alert("Report not found.");
    return;
  }

  const content = `
    Student Name: ${report.studentName}
    Email: ${report.email}
    Grade: ${report.grade}
    Subjects and Scores:\n${Object.entries(report.scores).map(([sub, sc]) => `${sub}: ${sc}%`).join("\n")}
  `;

  const blob = new Blob([content], { type: "text/plain" });
  const link = document.createElement("a");
  link.href = window.URL.createObjectURL(blob);
  link.download = `${report.studentName}_Report.txt`;
  link.click();
}

// Logout function
function logoutAdmin() {
  sessionStorage.removeItem("adminAccess");
  window.location.href = "index.html";
}
</script>
