<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Parent Portal Viewer - Blooming Kids House</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/libphonenumber-js@1.10.14/bundle/libphonenumber-js.min.js"></script>
    <style>
        .loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #10B981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-spinner-small {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10B981;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .admin-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #DC2626;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10000;
        }
        .preserve-whitespace {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .defective-account {
            border-left: 4px solid #DC2626;
            background-color: #FEF2F2;
        }
        .duplicate-account {
            border-left: 4px solid #F59E0B;
            background-color: #FFFBEB;
        }
        .student-card {
            border-left: 4px solid #3B82F6;
            background-color: #EFF6FF;
        }
        .report-month {
            display: inline-block;
            background: #D1FAE5;
            color: #065F46;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin: 2px;
        }
        .match-suggestion {
            border: 2px dashed #F59E0B;
            background-color: #FFFBEB;
        }
        .match-found {
            border: 2px solid #10B981;
            background-color: #D1FAE5;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10001;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="min-h-screen bg-gray-50 py-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Admin Header -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <div class="flex justify-between items-center">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">Admin Parent Portal Viewer</h1>
                            <p class="text-gray-600 mt-2">View any parent's portal by phone number - LOCAL MODE</p>
                            <p class="text-sm text-green-600 mt-1">‚úÖ Running locally - No deployment needed</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">Admin Mode</span>
                            <button onclick="showAdminTools()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                üõ†Ô∏è Admin Tools
                            </button>
                            <button onclick="showAdminInfo()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                ‚ÑπÔ∏è Admin Info
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Search Section -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Parent Phone Number
                            </label>
                            <input 
                                type="text" 
                                id="adminParentPhone" 
                                placeholder="Enter parent phone number (e.g., +1234567890, 2348012345678)"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                            >
                            <p class="text-sm text-gray-500 mt-2">
                                Enter the exact phone number the parent used to sign up
                            </p>
                        </div>
                        <div class="flex items-end space-x-4">
                            <button 
                                onclick="loadParentPortal()"
                                class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center justify-center"
                                id="searchBtn"
                            >
                                <span class="mr-2">üîç</span>
                                View Parent Portal
                            </button>
                            <button 
                                onclick="testWithSampleData()"
                                class="bg-yellow-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-yellow-700 transition-colors"
                                title="Test with sample phone numbers"
                            >
                                üß™ Test
                            </button>
                        </div>
                    </div>

                    <!-- Quick Search Options -->
                    <div class="mt-6 border-t pt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Search Options</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <button onclick="searchRecentParents()" class="bg-blue-100 text-blue-800 px-4 py-3 rounded-lg hover:bg-blue-200 transition-colors flex items-center justify-center">
                                <span class="mr-2">üìã</span> Recent Parents
                            </button>
                            <button onclick="searchByStudentName()" class="bg-green-100 text-green-800 px-4 py-3 rounded-lg hover:bg-green-200 transition-colors flex items-center justify-center">
                                <span class="mr-2">üë¶</span> By Student Name
                            </button>
                            <button onclick="showAllParents()" class="bg-purple-100 text-purple-800 px-4 py-3 rounded-lg hover:bg-purple-200 transition-colors flex items-center justify-center">
                                <span class="mr-2">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> All Parents
                            </button>
                            <button onclick="showDefectiveParents()" class="bg-red-100 text-red-800 px-4 py-3 rounded-lg hover:bg-red-200 transition-colors flex items-center justify-center">
                                <span class="mr-2">‚ö†Ô∏è</span> Defective Accounts
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results Area -->
                <div id="adminResultsArea" class="hidden">
                    <!-- Parent portal will be loaded here -->
                </div>

                <!-- Loading State -->
                <div id="adminLoader" class="hidden text-center py-12">
                    <div class="loading-spinner mx-auto" style="width: 60px; height: 60px;"></div>
                    <p class="text-green-600 font-semibold mt-4 text-lg">Loading parent portal...</p>
                    <p class="text-gray-500 text-sm mt-2" id="loadingDetails"></p>
                </div>

                <!-- Error State -->
                <div id="adminError" class="hidden text-center py-12">
                    <div class="text-6xl mb-4">‚ùå</div>
                    <h3 class="text-xl font-bold text-red-700 mb-2" id="adminErrorTitle">Unable to Load Parent Portal</h3>
                    <p class="text-gray-500 max-w-md mx-auto mb-4" id="adminErrorMessage"></p>
                    <button onclick="hideError()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        Try Again
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Tools Modal -->
    <div id="adminToolsModal" class="modal hidden">
        <div class="modal-content w-full max-w-6xl">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">üõ†Ô∏è Enhanced Admin Tools</h2>
                
                <!-- Parent Portal Overview -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-4">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Portal Overview</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <button onclick="loadAllParentsSummary()" class="bg-blue-100 text-blue-800 px-4 py-3 rounded-lg hover:bg-blue-200 transition-colors">
                            üìä View All Parent Portals
                        </button>
                        <button onclick="loadStudentsManagement()" class="bg-green-100 text-green-800 px-4 py-3 rounded-lg hover:bg-green-200 transition-colors">
                            üë®‚Äçüéì Manage Students
                        </button>
                        <button onclick="loadParentStudentMatching()" class="bg-purple-100 text-purple-800 px-4 py-3 rounded-lg hover:bg-purple-200 transition-colors">
                            üîó Match Parents to Students
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="showAllParents()" class="bg-gray-100 text-gray-800 px-4 py-3 rounded-lg hover:bg-gray-200 transition-colors">
                            üë• All Parent Users
                        </button>
                        <button onclick="showDuplicateAccounts()" class="bg-yellow-100 text-yellow-800 px-4 py-3 rounded-lg hover:bg-yellow-200 transition-colors">
                            üîç Duplicate Accounts
                        </button>
                        <button onclick="showDefectiveParents()" class="bg-red-100 text-red-800 px-4 py-3 rounded-lg hover:bg-red-200 transition-colors">
                            ‚ö†Ô∏è Defective Accounts
                        </button>
                    </div>
                </div>

                <!-- Data Management Tools -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-green-800 mb-4">üìà Data Management</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quick Edit Parent Email</label>
                            <div class="flex flex-col md:flex-row gap-2">
                                <input type="text" id="editEmailParentId" placeholder="Parent ID" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                                <input type="email" id="editEmailNewEmail" placeholder="New Email" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                                <button onclick="updateParentEmail()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                    Update Email
                                </button>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="exportAllData()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                                üì§ Export All Data
                            </button>
                            <button onclick="sendTestNotification()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-colors">
                                üîî Test Notification
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Information -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-yellow-800 mb-3">üìä System Information</h3>
                    <div id="systemStats" class="text-sm text-gray-700">
                        Loading system statistics...
                    </div>
                </div>

                <div class="flex justify-end mt-6">
                    <button onclick="hideAdminTools()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- All Parents Summary Modal -->
    <div id="allParentsSummaryModal" class="modal hidden">
        <div class="modal-content w-full max-w-6xl">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä All Parent Portals Summary</h2>
                <div id="allParentsSummaryContent" class="space-y-6">
                    Loading parent summaries...
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="hideAllParentsSummary()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Students Management Modal -->
    <div id="studentsManagementModal" class="modal hidden">
        <div class="modal-content w-full max-w-6xl">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üë®‚Äçüéì Student Users Management</h2>
                <div id="studentsManagementContent" class="space-y-6">
                    Loading student data...
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="hideStudentsManagement()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Parent-Student Matching Modal -->
    <div id="parentStudentMatchingModal" class="modal hidden">
        <div class="modal-content w-full max-w-6xl">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üîó Parent-Student Matching Tool</h2>
                <div class="bg-blue-50 p-4 rounded-lg mb-6">
                    <p class="text-blue-700">This tool helps you link students to their parents by matching student names with parent information.</p>
                </div>
                <div id="parentStudentMatchingContent" class="space-y-6">
                    Loading matching data...
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="hideParentStudentMatching()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Info Modal -->
    <div id="adminInfoModal" class="modal hidden">
        <div class="modal-content w-full max-w-2xl">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Parent Viewer Information</h2>
                <div class="space-y-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-800">‚úÖ Local Mode Active</h3>
                        <p class="text-green-700 text-sm mt-1">This tool runs completely locally - no server deployment needed!</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800">New Features Added:</h3>
                        <ul class="list-disc list-inside text-gray-600 space-y-1">
                            <li><strong>üìä Parent Portal Overview:</strong> See what each parent sees on their portal</li>
                            <li><strong>üë®‚Äçüéì Student Management:</strong> View all student users and their data</li>
                            <li><strong>üîó Parent-Student Matching:</strong> Link existing parent emails to students</li>
                            <li><strong>üìß Email Editing:</strong> Edit parent email addresses</li>
                            <li><strong>üì§ Data Export:</strong> Export all data for backup</li>
                        </ul>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="hideAdminInfo()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Email Modal -->
    <div id="editEmailModal" class="modal hidden">
        <div class="modal-content w-full max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Edit Parent Email</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Parent Name</label>
                        <input type="text" id="editEmailParentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Current Email</label>
                        <input type="text" id="editEmailCurrentEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">New Email</label>
                        <input type="email" id="editEmailNew" placeholder="Enter new email" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div id="emailValidation" class="text-sm hidden"></div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="hideEditEmailModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                        Cancel
                    </button>
                    <button onclick="saveParentEmail()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        Update Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Phone Modal -->
    <div id="editPhoneModal" class="modal hidden">
        <div class="modal-content w-full max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Edit Parent Phone Number</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Current Phone</label>
                        <input type="text" id="currentPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">New Phone Number</label>
                        <input type="text" id="newPhone" placeholder="Enter new phone number" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div id="phoneValidation" class="text-sm hidden"></div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="hideEditPhoneModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button onclick="updateParentPhone()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Update Phone
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div id="deleteAccountModal" class="modal hidden">
        <div class="modal-content w-full max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-bold text-red-800 mb-4">üóëÔ∏è Delete Parent Account</h3>
                <div class="space-y-4">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-700 font-semibold">‚ö†Ô∏è Warning: This action cannot be undone!</p>
                        <p class="text-red-600 text-sm mt-2">This will permanently delete the parent account and all associated data.</p>
                    </div>
                    <div>
                        <p><strong>Parent:</strong> <span id="deleteParentName"></span></p>
                        <p><strong>Phone:</strong> <span id="deleteParentPhone"></span></p>
                        <p><strong>Email:</strong> <span id="deleteParentEmail"></span></p>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="confirmDelete" class="mr-2">
                            <span class="text-sm text-red-700">I understand this action is permanent</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="hideDeleteAccountModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button onclick="deleteParentAccount()" id="confirmDeleteBtn" disabled class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors opacity-50">
                        Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD1lJhsWMMs_qerLBSzk7wKhjLyI_11RJg",
            authDomain: "bloomingkidsassessment.firebaseapp.com",
            projectId: "bloomingkidsassessment",
            storageBucket: "bloomingkidsassessment.appspot.com",
            messagingSenderId: "238975054977",
            appId: "1:238975054977:web:87c70b4db044998a204980"
        };

        // Initialize Firebase
        let db;
        let auth;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            showToast('‚úÖ Connected to Firebase database', 'success');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showToast('‚ùå Firebase Connection Error: ' + error.message, 'error');
        }

        // Global variables
        let currentParentData = null;
        let currentEditingUserId = null;
        let currentEditingEmailData = null;

        // Toast notification function
        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-blue-600'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${colors[type] || colors.info}`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Utility functions
        function capitalize(str) {
            if (!str) return "";
            return str.replace(/\b\w/g, l => l.toUpperCase());
        }

        function showError(title, message) {
            document.getElementById('adminErrorTitle').textContent = title;
            document.getElementById('adminErrorMessage').textContent = message;
            document.getElementById('adminError').classList.remove('hidden');
            document.getElementById('adminLoader').classList.add('hidden');
            document.getElementById('adminResultsArea').classList.add('hidden');
            showToast(message, 'error');
        }

        function hideError() {
            document.getElementById('adminError').classList.add('hidden');
        }

        // Phone number normalization
        function multiNormalizePhoneNumber(phone) {
            if (!phone || typeof phone !== 'string') {
                return [{ normalized: null, country: null, valid: false, error: 'Invalid input' }];
            }

            try {
                let cleaned = phone.replace(/[^\d+]/g, '');
                const normalizationAttempts = [];
                
                // Try standard normalization
                try {
                    const parsed = libphonenumber.parsePhoneNumberFromString(cleaned);
                    if (parsed && parsed.isValid()) {
                        normalizationAttempts.push({
                            normalized: parsed.format('E.164'),
                            country: parsed.country,
                            valid: true,
                            attempt: 'standard'
                        });
                        return normalizationAttempts;
                    }
                } catch (e) {}

                // Nigeria patterns
                if (cleaned.match(/^(234)?(80|70|81|90|91)/) && !cleaned.startsWith('+')) {
                    const ngNumber = '+234' + cleaned.replace(/^234/, '');
                    try {
                        const parsed = libphonenumber.parsePhoneNumberFromString(ngNumber);
                        if (parsed && parsed.isValid()) {
                            normalizationAttempts.push({
                                normalized: parsed.format('E.164'),
                                country: parsed.country,
                                valid: true,
                                attempt: 'nigeria_correction'
                            });
                            return normalizationAttempts;
                        }
                    } catch (e) {}
                }

                // US/Canada patterns
                if (cleaned.match(/^(1)?(469|214|972|713|281|832|210|817)/) && !cleaned.startsWith('+')) {
                    const usNumber = '+1' + cleaned.replace(/^1/, '');
                    try {
                        const parsed = libphonenumber.parsePhoneNumberFromString(usNumber);
                        if (parsed && parsed.isValid()) {
                            normalizationAttempts.push({
                                normalized: parsed.format('E.164'),
                                country: parsed.country,
                                valid: true,
                                attempt: 'us_correction'
                            });
                            return normalizationAttempts;
                        }
                    } catch (e) {}
                }

                // Digits only fallback
                const digitsOnly = cleaned.replace(/\D/g, '');
                if (digitsOnly.length >= 8 && digitsOnly.length <= 15) {
                    normalizationAttempts.push({
                        normalized: digitsOnly,
                        country: null,
                        valid: true,
                        attempt: 'digits_only'
                    });
                    return normalizationAttempts;
                }

                return [{ 
                    normalized: null, 
                    country: null, 
                    valid: false, 
                    error: 'No valid normalization found'
                }];
                
            } catch (error) {
                console.error("Phone normalization error:", error);
                return [{ 
                    normalized: null, 
                    country: null, 
                    valid: false, 
                    error: error.message
                }];
            }
        }

        // ==================== ENHANCED FEATURES ====================

        // 1. Load all parent summaries
        async function loadAllParentsSummary() {
            hideAdminTools();
            showModal('allParentsSummaryModal');
            
            try {
                const parentsSnapshot = await db.collection('parent_users').get();
                let html = '<div class="space-y-6">';
                
                for (const doc of parentsSnapshot.docs) {
                    const parent = doc.data();
                    const parentId = doc.id;
                    
                    // Get reports for this parent
                    const { assessmentResults, monthlyResults, academicData } = await getParentPortalData(parent.normalizedPhone || parent.phone);
                    
                    // Group by student
                    const studentsMap = new Map();
                    
                    assessmentResults.forEach(result => {
                        const studentName = result.studentName;
                        if (!studentsMap.has(studentName)) {
                            studentsMap.set(studentName, {
                                assessments: [],
                                monthly: [],
                                academics: { homework: 0, dailyTopics: 0 }
                            });
                        }
                        studentsMap.get(studentName).assessments.push(result);
                    });
                    
                    monthlyResults.forEach(report => {
                        const studentName = report.studentName;
                        if (!studentsMap.has(studentName)) {
                            studentsMap.set(studentName, {
                                assessments: [],
                                monthly: [],
                                academics: { homework: 0, dailyTopics: 0 }
                            });
                        }
                        studentsMap.get(studentName).monthly.push(report);
                    });
                    
                    // Add academic data
                    if (academicData) {
                        Object.keys(academicData).forEach(studentName => {
                            if (studentsMap.has(studentName)) {
                                studentsMap.get(studentName).academics = academicData[studentName];
                            }
                        });
                    }
                    
                    // Create parent summary card
                    html += `
                        <div class="bg-white border rounded-lg p-6 shadow-sm">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">${parent.parentName || 'Unknown Parent'}</h3>
                                    <p class="text-sm text-gray-600">üìû ${parent.phone} | üìß ${parent.email}</p>
                                    <p class="text-xs text-gray-500">ID: ${parentId}</p>
                                </div>
                                <div class="text-right">
                                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">
                                        ${studentsMap.size} student(s)
                                    </span>
                                    <button onclick="viewParentPortalById('${parentId}')" 
                                            class="ml-2 bg-green-100 text-green-800 px-3 py-1 rounded text-sm hover:bg-green-200">
                                        View Portal
                                    </button>
                                    <button onclick="editParentEmailPrompt('${parentId}', '${parent.parentName || 'Unknown'}', '${parent.email}')" 
                                            class="ml-2 bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm hover:bg-blue-200">
                                        Edit Email
                                    </button>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                    `;
                    
                    if (studentsMap.size === 0) {
                        html += `
                            <div class="text-center py-4 text-gray-500">
                                No students or reports found for this parent
                            </div>
                        `;
                    } else {
                        studentsMap.forEach((data, studentName) => {
                            const months = new Set();
                            data.assessments.forEach(r => {
                                const date = new Date(r.timestamp * 1000);
                                months.add(`${date.getMonth() + 1}/${date.getFullYear()}`);
                            });
                            data.monthly.forEach(r => {
                                const date = new Date(r.timestamp * 1000);
                                months.add(`${date.getMonth() + 1}/${date.getFullYear()}`);
                            });
                            
                            html += `
                                <div class="student-card p-4 rounded-lg">
                                    <h4 class="font-semibold text-blue-800 mb-2">${capitalize(studentName)}</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-2 text-sm">
                                        <div>
                                            <span class="font-semibold">Assessments:</span> ${data.assessments.length}
                                        </div>
                                        <div>
                                            <span class="font-semibold">Monthly Reports:</span> ${data.monthly.length}
                                        </div>
                                        <div>
                                            <span class="font-semibold">Homework:</span> ${data.academics.homework}
                                        </div>
                                        <div>
                                            <span class="font-semibold">Daily Topics:</span> ${data.academics.dailyTopics}
                                        </div>
                                    </div>
                                    ${months.size > 0 ? `
                                        <div class="mt-2">
                                            <span class="text-xs text-gray-600">Report Months:</span>
                                            <div class="mt-1">${Array.from(months).map(m => `<span class="report-month">${m}</span>`).join('')}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                document.getElementById('allParentsSummaryContent').innerHTML = html;
                
            } catch (error) {
                document.getElementById('allParentsSummaryContent').innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        Error loading parent summaries: ${error.message}
                    </div>
                `;
            }
        }

        // 2. Load students management
        async function loadStudentsManagement() {
            hideAdminTools();
            showModal('studentsManagementModal');
            
            try {
                // Get all unique students from reports
                const studentResults = await db.collection('student_results').get();
                const monthlyResults = await db.collection('tutor_submissions').get();
                
                const studentMap = new Map();
                
                // Process assessment reports
                studentResults.forEach(doc => {
                    const data = doc.data();
                    const studentName = data.studentName;
                    if (studentName) {
                        if (!studentMap.has(studentName)) {
                            studentMap.set(studentName, {
                                name: studentName,
                                parentPhone: data.parentPhone,
                                parentEmail: data.parentEmail,
                                assessmentCount: 0,
                                monthlyCount: 0,
                                lastReport: null
                            });
                        }
                        const student = studentMap.get(studentName);
                        student.assessmentCount++;
                        
                        // Update last report date
                        const date = data.submittedAt?.seconds ? new Date(data.submittedAt.seconds * 1000) : null;
                        if (date && (!student.lastReport || date > student.lastReport)) {
                            student.lastReport = date;
                        }
                    }
                });
                
                // Process monthly reports
                monthlyResults.forEach(doc => {
                    const data = doc.data();
                    const studentName = data.studentName;
                    if (studentName) {
                        if (!studentMap.has(studentName)) {
                            studentMap.set(studentName, {
                                name: studentName,
                                parentPhone: data.parentPhone,
                                parentEmail: data.parentEmail,
                                assessmentCount: 0,
                                monthlyCount: 0,
                                lastReport: null
                            });
                        }
                        const student = studentMap.get(studentName);
                        student.monthlyCount++;
                        
                        // Update last report date
                        const date = data.submittedAt?.seconds ? new Date(data.submittedAt.seconds * 1000) : null;
                        if (date && (!student.lastReport || date > student.lastReport)) {
                            student.lastReport = date;
                        }
                    }
                });
                
                let html = `
                    <div class="mb-4">
                        <p class="text-gray-600">Total Students Found: ${studentMap.size}</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Student Name</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Parent Phone</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Parent Email</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Assessments</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monthly Reports</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Report</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                const studentsArray = Array.from(studentMap.values()).sort((a, b) => 
                    a.name.localeCompare(b.name)
                );
                
                studentsArray.forEach(student => {
                    const hasParentEmail = student.parentEmail && student.parentEmail.includes('@');
                    
                    html += `
                        <tr class="${!hasParentEmail ? 'bg-yellow-50' : ''}">
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${capitalize(student.name)}</td>
                            <td class="px-4 py-3 text-sm text-gray-500">${student.parentPhone || 'N/A'}</td>
                            <td class="px-4 py-3 text-sm ${hasParentEmail ? 'text-gray-500' : 'text-red-600 font-semibold'}">
                                ${student.parentEmail || 'NO EMAIL'}
                                ${!hasParentEmail ? ' ‚ö†Ô∏è' : ''}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-500 text-center">${student.assessmentCount}</td>
                            <td class="px-4 py-3 text-sm text-gray-500 text-center">${student.monthlyCount}</td>
                            <td class="px-4 py-3 text-sm text-gray-500">${student.lastReport ? student.lastReport.toLocaleDateString() : 'N/A'}</td>
                            <td class="px-4 py-3 text-sm">
                                ${!hasParentEmail ? `
                                    <button onclick="findParentForStudent('${student.name}', '${student.parentPhone}')" 
                                            class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs hover:bg-blue-200">
                                        Find Parent
                                    </button>
                                ` : ''}
                                <button onclick="searchStudentReports('${student.name}')" 
                                        class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs hover:bg-green-200 ml-1">
                                    View Reports
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('studentsManagementContent').innerHTML = html;
                
            } catch (error) {
                document.getElementById('studentsManagementContent').innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        Error loading students: ${error.message}
                    </div>
                `;
            }
        }

        // 3. Parent-Student Matching Tool
        async function loadParentStudentMatching() {
            hideAdminTools();
            showModal('parentStudentMatchingModal');
            
            try {
                // Get all students without emails
                const studentResults = await db.collection('student_results').get();
                const monthlyResults = await db.collection('tutor_submissions').get();
                
                const studentsNeedingParents = new Map();
                
                // Find students needing parent linkage
                studentResults.forEach(doc => {
                    const data = doc.data();
                    if (data.studentName && (!data.parentEmail || !data.parentEmail.includes('@'))) {
                        if (!studentsNeedingParents.has(data.studentName)) {
                            studentsNeedingParents.set(data.studentName, {
                                name: data.studentName,
                                parentPhone: data.parentPhone,
                                documents: []
                            });
                        }
                        studentsNeedingParents.get(data.studentName).documents.push({
                            id: doc.id,
                            type: 'assessment'
                        });
                    }
                });
                
                monthlyResults.forEach(doc => {
                    const data = doc.data();
                    if (data.studentName && (!data.parentEmail || !data.parentEmail.includes('@'))) {
                        if (!studentsNeedingParents.has(data.studentName)) {
                            studentsNeedingParents.set(data.studentName, {
                                name: data.studentName,
                                parentPhone: data.parentPhone,
                                documents: []
                            });
                        }
                        studentsNeedingParents.get(data.studentName).documents.push({
                            id: doc.id,
                            type: 'monthly'
                        });
                    }
                });
                
                // Get all parents
                const parentsSnapshot = await db.collection('parent_users').get();
                const parents = [];
                parentsSnapshot.forEach(doc => {
                    parents.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                let html = `
                    <div class="mb-6">
                        <p class="text-gray-600">Found ${studentsNeedingParents.size} students needing parent email linkage</p>
                    </div>
                    <div class="space-y-6">
                `;
                
                studentsNeedingParents.forEach((student, studentName) => {
                    // Find potential parent matches
                    const potentialMatches = parents.filter(parent => {
                        if (student.parentPhone && parent.phone) {
                            const studentLast8 = student.parentPhone.slice(-8);
                            const parentLast8 = parent.phone.slice(-8);
                            return parent.phone.includes(studentLast8) || 
                                   student.parentPhone.includes(parentLast8);
                        }
                        return false;
                    });
                    
                    html += `
                        <div class="${potentialMatches.length > 0 ? 'match-found' : 'match-suggestion'} p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold text-gray-800">${capitalize(student.name)}</h4>
                                    <p class="text-sm text-gray-600">Phone: ${student.parentPhone || 'N/A'}</p>
                                    <p class="text-xs text-gray-500">${student.documents.length} document(s) need updating</p>
                                </div>
                                <div>
                                    <span class="bg-${potentialMatches.length > 0 ? 'green' : 'yellow'}-100 text-${potentialMatches.length > 0 ? 'green' : 'yellow'}-800 px-2 py-1 rounded text-xs">
                                        ${potentialMatches.length} potential match(es)
                                    </span>
                                </div>
                            </div>
                    `;
                    
                    if (potentialMatches.length > 0) {
                        html += `
                            <div class="mt-4">
                                <p class="text-sm font-medium text-gray-700 mb-2">Suggested Parent Matches:</p>
                                <div class="space-y-2">
                        `;
                        
                        potentialMatches.forEach(parent => {
                            html += `
                                <div class="bg-white border rounded p-3 flex justify-between items-center">
                                    <div>
                                        <p class="font-medium">${parent.parentName}</p>
                                        <p class="text-xs text-gray-600">üìû ${parent.phone} | üìß ${parent.email}</p>
                                    </div>
                                    <button onclick="linkStudentToParent('${student.name}', '${parent.id}', '${parent.email}')" 
                                            class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                        Link Student
                                    </button>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="mt-4">
                                <p class="text-sm text-gray-600">No automatic matches found.</p>
                                <div class="mt-2">
                                    <button onclick="manualSearchParent('${student.name}')" 
                                            class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                                        Search for Parent Manually
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
                document.getElementById('parentStudentMatchingContent').innerHTML = html;
                
            } catch (error) {
                document.getElementById('parentStudentMatchingContent').innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        Error loading matching data: ${error.message}
                    </div>
                `;
            }
        }

        // 4. Get parent portal data including academics
        async function getParentPortalData(parentPhone) {
            const normalizedVersions = multiNormalizePhoneNumber(parentPhone);
            const validVersions = normalizedVersions.filter(v => v.valid && v.normalized);
            
            let assessmentResults = [];
            let monthlyResults = [];
            let academicData = {};
            
            // Get assessment reports
            for (const version of validVersions) {
                try {
                    let assessmentSnapshot = await db.collection("student_results")
                        .where("normalizedParentPhone", "==", version.normalized)
                        .get();
                    
                    if (!assessmentSnapshot.empty) {
                        assessmentSnapshot.forEach(doc => {
                            const data = doc.data();
                            assessmentResults.push({ 
                                id: doc.id,
                                ...data,
                                timestamp: data.submittedAt?.seconds || Date.now() / 1000
                            });
                        });
                        break;
                    }
                } catch (error) {
                    console.log("Error getting assessment reports:", error.message);
                }
            }

            // Get monthly reports
            for (const version of validVersions) {
                try {
                    let monthlySnapshot = await db.collection("tutor_submissions")
                        .where("normalizedParentPhone", "==", version.normalized)
                        .get();
                    
                    if (!monthlySnapshot.empty) {
                        monthlySnapshot.forEach(doc => {
                            const data = doc.data();
                            monthlyResults.push({ 
                                id: doc.id,
                                ...data,
                                timestamp: data.submittedAt?.seconds || Date.now() / 1000
                            });
                        });
                        break;
                    }
                } catch (error) {
                    console.log("Error getting monthly reports:", error.message);
                }
            }

            // Get academic data
            try {
                const academicSnapshot = await db.collection("academic_data")
                    .where("parentPhone", "==", parentPhone)
                    .get();
                
                academicSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.studentName) {
                        if (!academicData[data.studentName]) {
                            academicData[data.studentName] = {
                                homework: 0,
                                dailyTopics: 0
                            };
                        }
                        academicData[data.studentName].homework += data.homeworkCount || 0;
                        academicData[data.studentName].dailyTopics += data.dailyTopicsCount || 0;
                    }
                });
            } catch (error) {
                console.log("No academic data found:", error.message);
            }
            
            return { assessmentResults, monthlyResults, academicData };
        }

        // 5. Link student to parent
        async function linkStudentToParent(studentName, parentId, parentEmail) {
            try {
                // Get parent details
                const parentDoc = await db.collection('parent_users').doc(parentId).get();
                const parent = parentDoc.data();
                
                if (!parent) {
                    showToast('Parent not found', 'error');
                    return;
                }
                
                // Update assessment reports
                const assessmentSnapshot = await db.collection('student_results')
                    .where('studentName', '==', studentName)
                    .get();
                
                const updatePromises = [];
                let updatedCount = 0;
                
                assessmentSnapshot.forEach(doc => {
                    updatePromises.push(
                        db.collection('student_results').doc(doc.id).update({
                            parentEmail: parentEmail,
                            normalizedParentPhone: parent.normalizedPhone,
                            parentPhone: parent.phone
                        }).then(() => updatedCount++)
                    );
                });
                
                // Update monthly reports
                const monthlySnapshot = await db.collection('tutor_submissions')
                    .where('studentName', '==', studentName)
                    .get();
                
                monthlySnapshot.forEach(doc => {
                    updatePromises.push(
                        db.collection('tutor_submissions').doc(doc.id).update({
                            parentEmail: parentEmail,
                            normalizedParentPhone: parent.normalizedPhone,
                            parentPhone: parent.phone
                        }).then(() => updatedCount++)
                    );
                });
                
                await Promise.all(updatePromises);
                
                showToast(`Successfully linked ${studentName} to ${parent.parentName}. Updated ${updatedCount} documents.`, 'success');
                
                // Reload the matching view
                loadParentStudentMatching();
                
            } catch (error) {
                showToast(`Error linking student: ${error.message}`, 'error');
            }
        }

        // 6. Email editing functions
        function editParentEmailPrompt(userId, parentName, currentEmail) {
            currentEditingEmailData = { userId, parentName, currentEmail };
            document.getElementById('editEmailParentName').value = parentName;
            document.getElementById('editEmailCurrentEmail').value = currentEmail;
            document.getElementById('editEmailNew').value = '';
            document.getElementById('emailValidation').classList.add('hidden');
            showModal('editEmailModal');
        }

        function hideEditEmailModal() {
            hideModal('editEmailModal');
            currentEditingEmailData = null;
        }

        async function saveParentEmail() {
            const newEmail = document.getElementById('editEmailNew').value.trim();
            const validationElement = document.getElementById('emailValidation');
            
            if (!newEmail || !newEmail.includes('@')) {
                validationElement.innerHTML = '<p class="text-red-600">Please enter a valid email address</p>';
                validationElement.classList.remove('hidden');
                return;
            }
            
            if (!currentEditingEmailData) return;
            
            try {
                // Update parent record
                await db.collection('parent_users').doc(currentEditingEmailData.userId).update({
                    email: newEmail,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Also update all related documents
                const parentDoc = await db.collection('parent_users').doc(currentEditingEmailData.userId).get();
                const parent = parentDoc.data();
                
                if (!parent) {
                    throw new Error('Parent not found');
                }
                
                // Update assessment reports
                const assessmentSnapshot = await db.collection('student_results')
                    .where('normalizedParentPhone', '==', parent.normalizedPhone)
                    .get();
                
                const updatePromises = [];
                let updatedCount = 0;
                
                assessmentSnapshot.forEach(doc => {
                    updatePromises.push(
                        db.collection('student_results').doc(doc.id).update({
                            parentEmail: newEmail
                        }).then(() => updatedCount++)
                    );
                });
                
                // Update monthly reports
                const monthlySnapshot = await db.collection('tutor_submissions')
                    .where('normalizedParentPhone', '==', parent.normalizedPhone)
                    .get();
                
                monthlySnapshot.forEach(doc => {
                    updatePromises.push(
                        db.collection('tutor_submissions').doc(doc.id).update({
                            parentEmail: newEmail
                        }).then(() => updatedCount++)
                    );
                });
                
                await Promise.all(updatePromises);
                
                validationElement.innerHTML = `
                    <p class="text-green-600">
                        ‚úÖ Email updated successfully! Updated ${updatedCount} documents.
                    </p>
                `;
                validationElement.classList.remove('hidden');
                
                setTimeout(() => {
                    hideEditEmailModal();
                    showToast('Email updated successfully across all documents!', 'success');
                }, 2000);
                
            } catch (error) {
                validationElement.innerHTML = `<p class="text-red-600">Error updating email: ${error.message}</p>`;
                validationElement.classList.remove('hidden');
            }
        }

        // 7. Update parent email from input fields
        async function updateParentEmail() {
            const parentId = document.getElementById('editEmailParentId').value.trim();
            const newEmail = document.getElementById('editEmailNewEmail').value.trim();
            
            if (!parentId || !newEmail) {
                showToast('Please enter both Parent ID and New Email', 'error');
                return;
            }
            
            try {
                await db.collection('parent_users').doc(parentId).update({
                    email: newEmail,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Email updated successfully!', 'success');
                document.getElementById('editEmailParentId').value = '';
                document.getElementById('editEmailNewEmail').value = '';
                
            } catch (error) {
                showToast(`Error updating email: ${error.message}`, 'error');
            }
        }

        // 8. Export all data
        async function exportAllData() {
            try {
                const parentsSnapshot = await db.collection('parent_users').get();
                const assessmentSnapshot = await db.collection('student_results').get();
                const monthlySnapshot = await db.collection('tutor_submissions').get();
                
                const data = {
                    parents: [],
                    assessments: [],
                    monthlyReports: [],
                    exportDate: new Date().toISOString(),
                    totalRecords: 0
                };
                
                parentsSnapshot.forEach(doc => {
                    data.parents.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                assessmentSnapshot.forEach(doc => {
                    data.assessments.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                monthlySnapshot.forEach(doc => {
                    data.monthlyReports.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                data.totalRecords = data.parents.length + data.assessments.length + data.monthlyReports.length;
                
                // Create downloadable file
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `blooming-kids-export-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showToast(`Data exported successfully! ${data.totalRecords} records exported.`, 'success');
                
            } catch (error) {
                showToast(`Error exporting data: ${error.message}`, 'error');
            }
        }

        // 9. Load system stats
        async function loadSystemStats() {
            try {
                const parentsSnapshot = await db.collection('parent_users').get();
                const totalParents = parentsSnapshot.size;
                
                let defectiveCount = 0;
                let duplicateCount = 0;
                
                parentsSnapshot.forEach(doc => {
                    const parent = doc.data();
                    if (!parent.normalizedPhone || !parent.phone || parent.phone.length < 8) {
                        defectiveCount++;
                    }
                });
                
                // Check for duplicates
                const phoneMap = new Map();
                parentsSnapshot.forEach(doc => {
                    const parent = doc.data();
                    if (parent.phone) {
                        if (!phoneMap.has(parent.phone)) {
                            phoneMap.set(parent.phone, []);
                        }
                        phoneMap.get(parent.phone).push(parent);
                    }
                });
                
                phoneMap.forEach((parents, phone) => {
                    if (parents.length > 1) {
                        duplicateCount += parents.length;
                    }
                });
                
                document.getElementById('systemStats').innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white p-3 rounded-lg border">
                            <div class="text-2xl font-bold text-blue-600">${totalParents}</div>
                            <div class="text-sm text-gray-600">Total Parents</div>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <div class="text-2xl font-bold text-red-600">${defectiveCount}</div>
                            <div class="text-sm text-gray-600">Defective Accounts</div>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <div class="text-2xl font-bold text-yellow-600">${duplicateCount}</div>
                            <div class="text-sm text-gray-600">Duplicate Accounts</div>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <div class="text-2xl font-bold text-green-600">${totalParents - defectiveCount}</div>
                            <div class="text-sm text-gray-600">Healthy Accounts</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('systemStats').innerHTML = `<p class="text-red-600">Error loading statistics: ${error.message}</p>`;
            }
        }

        // ==================== EXISTING FUNCTIONS ====================

        function showAdminTools() {
            loadSystemStats();
            showModal('adminToolsModal');
        }

        function hideAdminTools() {
            hideModal('adminToolsModal');
        }

        function showAdminInfo() {
            showModal('adminInfoModal');
        }

        function hideAdminInfo() {
            hideModal('adminInfoModal');
        }

        function hideAllParentsSummary() {
            hideModal('allParentsSummaryModal');
        }

        function hideStudentsManagement() {
            hideModal('studentsManagementModal');
        }

        function hideParentStudentMatching() {
            hideModal('parentStudentMatchingModal');
        }

        // Edit phone functions
        function editParentPhone(userId, currentPhone) {
            currentEditingUserId = userId;
            document.getElementById('currentPhone').value = currentPhone;
            document.getElementById('newPhone').value = '';
            document.getElementById('phoneValidation').classList.add('hidden');
            showModal('editPhoneModal');
        }

        function hideEditPhoneModal() {
            hideModal('editPhoneModal');
            currentEditingUserId = null;
        }

        async function updateParentPhone() {
            const newPhone = document.getElementById('newPhone').value.trim();
            const validationElement = document.getElementById('phoneValidation');
            
            if (!newPhone) {
                validationElement.innerHTML = '<p class="text-red-600">Please enter a phone number</p>';
                validationElement.classList.remove('hidden');
                return;
            }
            
            const normalizedVersions = multiNormalizePhoneNumber(newPhone);
            const validVersions = normalizedVersions.filter(v => v.valid && v.normalized);
            
            if (validVersions.length === 0) {
                validationElement.innerHTML = '<p class="text-red-600">Invalid phone number format</p>';
                validationElement.classList.remove('hidden');
                return;
            }
            
            const normalizedPhone = validVersions[0].normalized;
            
            try {
                await db.collection('parent_users').doc(currentEditingUserId).update({
                    phone: newPhone,
                    normalizedPhone: normalizedPhone,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                validationElement.innerHTML = '<p class="text-green-600">‚úÖ Phone number updated successfully!</p>';
                validationElement.classList.remove('hidden');
                
                setTimeout(() => {
                    hideEditPhoneModal();
                    showToast('Phone number updated successfully!', 'success');
                }, 2000);
                
            } catch (error) {
                validationElement.innerHTML = `<p class="text-red-600">Error updating phone: ${error.message}</p>`;
                validationElement.classList.remove('hidden');
            }
        }

        // Delete account functions
        function deleteParentAccountPrompt(userId, parentName, phone, email) {
            currentEditingUserId = userId;
            document.getElementById('deleteParentName').textContent = parentName;
            document.getElementById('deleteParentPhone').textContent = phone;
            document.getElementById('deleteParentEmail').textContent = email;
            document.getElementById('confirmDelete').checked = false;
            document.getElementById('confirmDeleteBtn').disabled = true;
            showModal('deleteAccountModal');
        }

        function hideDeleteAccountModal() {
            hideModal('deleteAccountModal');
            currentEditingUserId = null;
        }

        document.getElementById('confirmDelete').addEventListener('change', function() {
            document.getElementById('confirmDeleteBtn').disabled = !this.checked;
            document.getElementById('confirmDeleteBtn').classList.toggle('opacity-50', !this.checked);
        });

        async function deleteParentAccount() {
            if (!currentEditingUserId) return;
            
            try {
                await db.collection('parent_users').doc(currentEditingUserId).delete();
                showToast('Parent account deleted successfully!', 'success');
                hideDeleteAccountModal();
                
            } catch (error) {
                showToast('Error deleting account: ' + error.message, 'error');
            }
        }

        // Main load parent portal function
        async function loadParentPortal() {
            const phoneInput = document.getElementById('adminParentPhone');
            const phone = phoneInput.value.trim();
            const searchBtn = document.getElementById('searchBtn');
            
            if (!phone) {
                showError('Input Required', 'Please enter a phone number');
                return;
            }

            searchBtn.disabled = true;
            searchBtn.innerHTML = '<div class="loading-spinner-small mr-2"></div> Searching...';
            document.getElementById('adminLoader').classList.remove('hidden');
            document.getElementById('adminError').classList.add('hidden');
            document.getElementById('adminResultsArea').classList.add('hidden');
            document.getElementById('loadingDetails').textContent = `Searching for: ${phone}`;

            try {
                const normalizedVersions = multiNormalizePhoneNumber(phone);
                const validVersions = normalizedVersions.filter(v => v.valid && v.normalized);
                
                if (validVersions.length === 0) {
                    throw new Error('Invalid phone number format. Try formats like: +2348012345678 or 08012345678');
                }

                let parentUser = null;
                let parentUserId = null;

                for (const version of validVersions) {
                    const userQuery = await db.collection('parent_users')
                        .where('normalizedPhone', '==', version.normalized)
                        .limit(1)
                        .get();

                    if (!userQuery.empty) {
                        parentUser = userQuery.docs[0].data();
                        parentUserId = userQuery.docs[0].id;
                        break;
                    }
                }

                if (!parentUser) {
                    const fallbackQuery = await db.collection('parent_users')
                        .where('phone', '==', phone)
                        .limit(1)
                        .get();
                        
                    if (!fallbackQuery.empty) {
                        parentUser = fallbackQuery.docs[0].data();
                        parentUserId = fallbackQuery.docs[0].id;
                    }
                }

                if (!parentUser) {
                    throw new Error('No parent account found with this phone number');
                }

                await loadParentPortalForAdmin(parentUserId, parentUser.normalizedPhone || parentUser.phone, parentUser);

            } catch (error) {
                console.error('Admin parent portal error:', error);
                showError('Search Failed', error.message);
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<span class="mr-2">üîç</span> View Parent Portal';
            }
        }

        async function loadParentPortalForAdmin(parentUserId, parentPhone, parentUserData) {
            const resultsArea = document.getElementById('adminResultsArea');
            
            try {
                document.getElementById('loadingDetails').textContent = `Loading reports for ${parentUserData.parentName || 'Parent'}...`;

                resultsArea.innerHTML = `
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="bg-red-50 border-b border-red-200 p-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h2 class="text-xl font-bold text-red-800">Viewing Portal for: ${parentUserData.parentName || 'Parent'}</h2>
                                    <p class="text-red-600">Phone: ${parentUserData.phone} | Email: ${parentUserData.email}</p>
                                    <p class="text-red-600 text-sm">User ID: ${parentUserId}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-red-700">Account Created: ${parentUserData.createdAt?.toDate().toLocaleDateString() || 'Unknown'}</p>
                                    <p class="text-sm text-red-700">Referral Code: ${parentUserData.referralCode || 'None'}</p>
                                    <div class="flex space-x-2 mt-2">
                                        <button onclick="editParentPhone('${parentUserId}', '${parentUserData.phone}')" 
                                                class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                            ‚úèÔ∏è Edit Phone
                                        </button>
                                        <button onclick="editParentEmailPrompt('${parentUserId}', '${parentUserData.parentName || 'Unknown'}', '${parentUserData.email}')" 
                                                class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                            ‚úèÔ∏è Edit Email
                                        </button>
                                        <button onclick="deleteParentAccountPrompt('${parentUserId}', '${parentUserData.parentName || 'Unknown'}', '${parentUserData.phone}', '${parentUserData.email}')" 
                                                class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                            üóëÔ∏è Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="adminParentPortalContent" class="p-6">
                            <div class="text-center py-8">
                                <div class="loading-spinner mx-auto" style="width: 40px; height: 40px;"></div>
                                <p class="text-green-600 font-semibold mt-4">Loading parent reports...</p>
                            </div>
                        </div>
                    </div>
                `;

                const { assessmentResults, monthlyResults, academicData } = await getParentPortalData(parentPhone);

                currentParentData = {
                    user: parentUserData,
                    userId: parentUserId,
                    assessments: assessmentResults,
                    monthly: monthlyResults,
                    academicData: academicData
                };

                displayParentReports(assessmentResults, monthlyResults, academicData, parentUserData);

                document.getElementById('adminLoader').classList.add('hidden');
                resultsArea.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading parent portal:', error);
                resultsArea.innerHTML = `
                    <div class="bg-white rounded-lg shadow-lg p-8 text-center">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-xl font-bold text-red-700 mb-2">Error Loading Parent Portal</h3>
                        <p class="text-gray-500">${error.message}</p>
                    </div>
                `;
                document.getElementById('adminLoader').classList.add('hidden');
                resultsArea.classList.remove('hidden');
            }
        }

        function displayParentReports(assessmentResults, monthlyResults, academicData, parentUserData) {
            const portalContent = document.getElementById('adminParentPortalContent');

            if (assessmentResults.length === 0 && monthlyResults.length === 0) {
                portalContent.innerHTML = `
                    <div class="text-center py-16">
                        <div class="text-6xl mb-6">üìä</div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">No Reports Found</h2>
                        <p class="text-gray-600 max-w-2xl mx-auto mb-6">
                            This parent has no assessment or monthly reports yet.
                        </p>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 max-w-2xl mx-auto">
                            <h3 class="font-semibold text-yellow-800 mb-2">Parent Information:</h3>
                            <div class="text-left text-yellow-700 space-y-2">
                                <p><strong>Name:</strong> ${parentUserData.parentName || 'Not set'}</p>
                                <p><strong>Phone:</strong> ${parentUserData.phone}</p>
                                <p><strong>Email:</strong> ${parentUserData.email}</p>
                                <p><strong>Referral Code:</strong> ${parentUserData.referralCode || 'None'}</p>
                                <p><strong>Account Created:</strong> ${parentUserData.createdAt?.toDate().toLocaleDateString() || 'Unknown'}</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            let contentHTML = '';
            const studentsMap = new Map();

            // Process assessment reports
            assessmentResults.forEach(result => {
                const studentName = result.studentName;
                if (!studentsMap.has(studentName)) {
                    studentsMap.set(studentName, { assessments: [], monthly: [], academics: { homework: 0, dailyTopics: 0 } });
                }
                studentsMap.get(studentName).assessments.push(result);
            });

            // Process monthly reports
            monthlyResults.forEach(report => {
                const studentName = report.studentName;
                if (!studentsMap.has(studentName)) {
                    studentsMap.set(studentName, { assessments: [], monthly: [], academics: { homework: 0, dailyTopics: 0 } });
                }
                studentsMap.get(studentName).monthly.push(report);
            });

            // Add academic data
            if (academicData) {
                Object.keys(academicData).forEach(studentName => {
                    if (studentsMap.has(studentName)) {
                        studentsMap.get(studentName).academics = academicData[studentName];
                    }
                });
            }

            // Display reports for each student
            studentsMap.forEach((reports, studentName) => {
                const fullName = capitalize(studentName);
                
                contentHTML += `
                    <div class="bg-green-100 border-l-4 border-green-600 p-4 rounded-lg mb-6">
                        <h2 class="text-xl font-bold text-green-800">${fullName}</h2>
                        <p class="text-green-600">
                            ${reports.assessments.length} assessment(s), 
                            ${reports.monthly.length} monthly report(s)
                        </p>
                        <p class="text-green-600 text-sm">
                            üìö Homework: ${reports.academics.homework} | üìñ Daily Topics: ${reports.academics.dailyTopics}
                        </p>
                    </div>
                `;

                // Display Assessment Reports
                if (reports.assessments.length > 0) {
                    const uniqueSessions = new Map();
                    
                    reports.assessments.forEach((result) => {
                        const sessionKey = Math.floor(result.timestamp / 86400);
                        if (!uniqueSessions.has(sessionKey)) {
                            uniqueSessions.set(sessionKey, []);
                        }
                        uniqueSessions.get(sessionKey).push(result);
                    });

                    uniqueSessions.forEach((session, sessionKey) => {
                        const formattedDate = new Date(session[0].timestamp * 1000).toLocaleString('en-US', {
                            dateStyle: 'long',
                            timeStyle: 'short'
                        });

                        const tableRows = session.map(testResult => {
                            return {
                                subject: testResult.subject,
                                correct: testResult.score !== undefined ? testResult.score : 0,
                                total: testResult.totalScoreableQuestions !== undefined ? testResult.totalScoreableQuestions : 0,
                            };
                        }).map(res => `
                            <tr>
                                <td class="border px-4 py-2 font-semibold">${res.subject.toUpperCase()}</td>
                                <td class="border px-4 py-2 text-center">${res.correct} / ${res.total}</td>
                                <td class="border px-4 py-2 text-center">${Math.round((res.correct / res.total) * 100)}%</td>
                            </tr>
                        `).join("");

                        contentHTML += `
                            <div class="border rounded-lg shadow mb-8 p-6 bg-white">
                                <div class="text-center mb-6 border-b pb-4">
                                    <h2 class="text-2xl font-bold text-green-800">Assessment Report</h2>
                                    <p class="text-gray-600">Date: ${formattedDate}</p>
                                    <p class="text-gray-500 text-sm">Tutor: ${session[0].tutorEmail || 'N/A'}</p>
                                </div>
                                <table class="w-full text-sm mb-4 border border-collapse">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="border px-4 py-2 text-left">Subject</th>
                                            <th class="border px-4 py-2 text-center">Score</th>
                                            <th class="border px-4 py-2 text-center">Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>${tableRows}</tbody>
                                </table>
                            </div>
                        `;
                    });
                }
                
                // Display Monthly Reports
                if (reports.monthly.length > 0) {
                    reports.monthly.forEach((monthlyReport, index) => {
                        const formattedDate = new Date(monthlyReport.timestamp * 1000).toLocaleString('en-US', {
                            dateStyle: 'long',
                            timeStyle: 'short'
                        });

                        contentHTML += `
                            <div class="border rounded-lg shadow mb-8 p-6 bg-white">
                                <div class="text-center mb-6 border-b pb-4">
                                    <h2 class="text-2xl font-bold text-green-800">MONTHLY LEARNING REPORT</h2>
                                    <p class="text-gray-600">Date: ${formattedDate}</p>
                                    <p class="text-gray-500 text-sm">Tutor: ${monthlyReport.tutorName || 'N/A'}</p>
                                </div>
                                ${monthlyReport.introduction ? `
                                    <div class="mb-4">
                                        <h3 class="font-semibold text-green-700 mb-2">INTRODUCTION</h3>
                                        <p class="text-gray-700 preserve-whitespace">${monthlyReport.introduction}</p>
                                    </div>
                                ` : ''}
                                ${monthlyReport.progress ? `
                                    <div class="mb-4">
                                        <h3 class="font-semibold text-green-700 mb-2">PROGRESS & ACHIEVEMENTS</h3>
                                        <p class="text-gray-700 preserve-whitespace">${monthlyReport.progress}</p>
                                    </div>
                                ` : ''}
                                ${monthlyReport.recommendations ? `
                                    <div class="mb-4">
                                        <h3 class="font-semibold text-green-700 mb-2">RECOMMENDATIONS</h3>
                                        <p class="text-gray-700 preserve-whitespace">${monthlyReport.recommendations}</p>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                }
            });

            // Add parent summary
            contentHTML += `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mt-8">
                    <h3 class="text-lg font-semibold text-blue-800 mb-4">Parent Account Summary</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p><strong>Parent Name:</strong> ${parentUserData.parentName || 'Not set'}</p>
                            <p><strong>Phone:</strong> ${parentUserData.phone}</p>
                            <p><strong>Email:</strong> ${parentUserData.email}</p>
                        </div>
                        <div>
                            <p><strong>Referral Code:</strong> ${parentUserData.referralCode || 'None'}</p>
                            <p><strong>Total Children:</strong> ${studentsMap.size}</p>
                            <p><strong>Total Reports:</strong> ${assessmentResults.length + monthlyResults.length}</p>
                            <p><strong>Assessments:</strong> ${assessmentResults.length}</p>
                            <p><strong>Monthly Reports:</strong> ${monthlyResults.length}</p>
                        </div>
                    </div>
                </div>
            `;

            portalContent.innerHTML = contentHTML;
        }

        // Quick search functions
        async function searchRecentParents() {
            try {
                document.getElementById('loadingDetails').textContent = 'Loading recent parents...';
                document.getElementById('adminLoader').classList.remove('hidden');
                
                const recentParents = await db.collection('parent_users')
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .get();

                if (recentParents.empty) {
                    showError('No Parents Found', 'No parent accounts found in the system.');
                    return;
                }

                let parentsArray = [];
                recentParents.forEach(doc => {
                    parentsArray.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                displayParentList(parentsArray, 'Recent Parents', true);
                
            } catch (error) {
                showError('Search Failed', 'Error loading recent parents: ' + error.message);
            }
        }

        async function showAllParents() {
            try {
                document.getElementById('loadingDetails').textContent = 'Loading all parents...';
                document.getElementById('adminLoader').classList.remove('hidden');

                const allParents = await db.collection('parent_users').limit(50).get();

                if (allParents.empty) {
                    showError('No Parents', 'No parent accounts found in the system.');
                    return;
                }

                let parentsArray = [];
                allParents.forEach(doc => {
                    parentsArray.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                displayParentList(parentsArray, 'All Parents', true);

            } catch (error) {
                showError('Search Failed', 'Error loading all parents: ' + error.message);
            }
        }

        async function showDefectiveParents() {
            try {
                document.getElementById('loadingDetails').textContent = 'Finding defective accounts...';
                document.getElementById('adminLoader').classList.remove('hidden');
                
                const parentsSnapshot = await db.collection('parent_users').get();
                let defectiveParents = [];
                
                parentsSnapshot.forEach(doc => {
                    const parent = doc.data();
                    const issues = [];
                    
                    if (!parent.normalizedPhone) issues.push('No normalized phone');
                    if (!parent.phone || parent.phone.length < 8) issues.push('Invalid phone format');
                    if (!parent.email || !parent.email.includes('@')) issues.push('Invalid email');
                    if (!parent.parentName || parent.parentName === 'Parent') issues.push('Default parent name');
                    
                    if (issues.length > 0) {
                        defectiveParents.push({
                            id: doc.id,
                            ...parent,
                            issues: issues
                        });
                    }
                });
                
                if (defectiveParents.length === 0) {
                    showError('No Defective Accounts', 'All parent accounts appear to be healthy!');
                    return;
                }
                
                displayParentList(defectiveParents, 'Defective Accounts', true);
                
            } catch (error) {
                showError('Search Failed', 'Error finding defective accounts: ' + error.message);
            }
        }

        async function showDuplicateAccounts() {
            try {
                document.getElementById('loadingDetails').textContent = 'Finding duplicate accounts...';
                document.getElementById('adminLoader').classList.remove('hidden');
                
                const parentsSnapshot = await db.collection('parent_users').get();
                const phoneMap = new Map();
                
                parentsSnapshot.forEach(doc => {
                    const parent = doc.data();
                    if (parent.phone) {
                        if (!phoneMap.has(parent.phone)) {
                            phoneMap.set(parent.phone, []);
                        }
                        phoneMap.get(parent.phone).push({
                            id: doc.id,
                            ...parent
                        });
                    }
                });
                
                let duplicateParents = [];
                phoneMap.forEach((parents, phone) => {
                    if (parents.length > 1) {
                        duplicateParents = duplicateParents.concat(parents.map(p => ({
                            ...p,
                            duplicateCount: parents.length
                        })));
                    }
                });
                
                if (duplicateParents.length === 0) {
                    showError('No Duplicates', 'No duplicate accounts found!');
                    return;
                }
                
                displayParentList(duplicateParents, 'Duplicate Accounts', true);
                
            } catch (error) {
                showError('Search Failed', 'Error finding duplicate accounts: ' + error.message);
            }
        }

        function displayParentList(parents, title, showActions = false) {
            let optionsHTML = `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">${title} (${parents.length})</h3>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
            `;
            
            parents.forEach(parent => {
                const isDefective = parent.issues && parent.issues.length > 0;
                const isDuplicate = parent.duplicateCount > 1;
                
                let badgeHTML = '';
                if (isDefective) {
                    badgeHTML = `<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full ml-2">Defective</span>`;
                }
                if (isDuplicate) {
                    badgeHTML += `<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full ml-2">Duplicate (${parent.duplicateCount})</span>`;
                }
                
                optionsHTML += `
                    <div class="border rounded-lg p-4 ${isDefective ? 'defective-account' : isDuplicate ? 'duplicate-account' : ''}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <strong class="text-gray-800">${parent.parentName || 'Unknown Name'}</strong>
                                ${badgeHTML}
                                <div class="text-sm text-gray-600 mt-1">
                                    üìû ${parent.phone}<br>
                                    üìß ${parent.email}
                                </div>
                                ${parent.issues ? `
                                    <div class="text-xs text-red-600 mt-2">
                                        <strong>Issues:</strong> ${parent.issues.join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                            ${showActions ? `
                                <div class="flex flex-col space-y-2 ml-4">
                                    <button onclick="editParentEmailPrompt('${parent.id}', '${parent.parentName || 'Unknown'}', '${parent.email}')" 
                                            class="bg-green-100 text-green-800 px-3 py-1 rounded text-sm hover:bg-green-200">
                                        ‚úèÔ∏è Edit Email
                                    </button>
                                    <button onclick="viewParentPortalById('${parent.id}')" 
                                            class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm hover:bg-blue-200">
                                        üëÅÔ∏è View Portal
                                    </button>
                                    <button onclick="deleteParentAccountPrompt('${parent.id}', '${parent.parentName || 'Unknown'}', '${parent.phone}', '${parent.email}')" 
                                            class="bg-red-100 text-red-800 px-3 py-1 rounded text-sm hover:bg-red-200">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            optionsHTML += '</div></div>';
            
            document.getElementById('adminLoader').classList.add('hidden');
            document.getElementById('adminResultsArea').innerHTML = optionsHTML;
            document.getElementById('adminResultsArea').classList.remove('hidden');
        }

        async function viewParentPortalById(userId) {
            try {
                const userDoc = await db.collection('parent_users').doc(userId).get();
                if (userDoc.exists) {
                    const parentUser = userDoc.data();
                    document.getElementById('adminParentPhone').value = parentUser.phone;
                    loadParentPortal();
                    hideModal('adminToolsModal');
                }
            } catch (error) {
                showToast('Error loading parent: ' + error.message, 'error');
            }
        }

        async function searchByStudentName() {
            const studentName = prompt('Enter student name to search:');
            if (!studentName) return;

            try {
                document.getElementById('loadingDetails').textContent = `Searching for student: ${studentName}`;
                document.getElementById('adminLoader').classList.remove('hidden');

                const assessmentSnapshot = await db.collection('student_results')
                    .where('studentName', '>=', studentName)
                    .where('studentName', '<=', studentName + '\uf8ff')
                    .limit(10)
                    .get();

                let parentPhones = new Set();
                
                assessmentSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.parentPhone) {
                        parentPhones.add(data.parentPhone);
                    }
                });

                const monthlySnapshot = await db.collection('tutor_submissions')
                    .where('studentName', '>=', studentName)
                    .where('studentName', '<=', studentName + '\uf8ff')
                    .limit(10)
                    .get();

                monthlySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.parentPhone) {
                        parentPhones.add(data.parentPhone);
                    }
                });

                if (parentPhones.size === 0) {
                    showError('No Results', `No parents found for student: ${studentName}`);
                    return;
                }

                let parentsArray = [];
                for (let phone of parentPhones) {
                    const parentQuery = await db.collection('parent_users')
                        .where('phone', '==', phone)
                        .limit(1)
                        .get();
                    
                    if (!parentQuery.empty) {
                        parentsArray.push({
                            id: parentQuery.docs[0].id,
                            ...parentQuery.docs[0].data()
                        });
                    }
                }

                displayParentList(parentsArray, `Parents for Student: ${studentName}`, true);

            } catch (error) {
                showError('Search Failed', 'Error searching by student name: ' + error.message);
            }
        }

        async function searchStudentReports(studentName) {
            try {
                document.getElementById('loadingDetails').textContent = `Searching reports for: ${studentName}`;
                document.getElementById('adminLoader').classList.remove('hidden');

                const assessmentSnapshot = await db.collection('student_results')
                    .where('studentName', '==', studentName)
                    .get();

                const monthlySnapshot = await db.collection('tutor_submissions')
                    .where('studentName', '==', studentName)
                    .get();

                const resultsArea = document.getElementById('adminResultsArea');
                let html = `
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Reports for ${capitalize(studentName)}</h2>
                `;

                if (assessmentSnapshot.empty && monthlySnapshot.empty) {
                    html += `<p class="text-gray-500 text-center py-8">No reports found for this student.</p>`;
                } else {
                    html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">`;
                    
                    if (!assessmentSnapshot.empty) {
                        html += `
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-green-800 mb-3">Assessment Reports (${assessmentSnapshot.size})</h3>
                                <div class="space-y-2">
                        `;
                        
                        assessmentSnapshot.forEach(doc => {
                            const data = doc.data();
                            const date = data.submittedAt?.seconds ? 
                                new Date(data.submittedAt.seconds * 1000).toLocaleDateString() : 'Unknown date';
                            html += `
                                <div class="bg-white p-3 rounded border">
                                    <p class="font-medium">${data.subject || 'Unknown subject'}</p>
                                    <p class="text-sm text-gray-600">Date: ${date}</p>
                                    <p class="text-sm text-gray-600">Score: ${data.score || 0}/${data.totalScoreableQuestions || 0}</p>
                                    <p class="text-sm text-gray-600">Parent: ${data.parentPhone || 'N/A'}</p>
                                </div>
                            `;
                        });
                        
                        html += `</div></div>`;
                    }

                    if (!monthlySnapshot.empty) {
                        html += `
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-blue-800 mb-3">Monthly Reports (${monthlySnapshot.size})</h3>
                                <div class="space-y-2">
                        `;
                        
                        monthlySnapshot.forEach(doc => {
                            const data = doc.data();
                            const date = data.submittedAt?.seconds ? 
                                new Date(data.submittedAt.seconds * 1000).toLocaleDateString() : 'Unknown date';
                            html += `
                                <div class="bg-white p-3 rounded border">
                                    <p class="font-medium">Monthly Report</p>
                                    <p class="text-sm text-gray-600">Date: ${date}</p>
                                    <p class="text-sm text-gray-600">Tutor: ${data.tutorName || 'N/A'}</p>
                                    <p class="text-sm text-gray-600">Parent: ${data.parentPhone || 'N/A'}</p>
                                </div>
                            `;
                        });
                        
                        html += `</div></div>`;
                    }
                    
                    html += `</div>`;
                }

                html += `
                        <div class="flex justify-end">
                            <button onclick="document.getElementById('adminResultsArea').classList.add('hidden')" 
                                    class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('adminLoader').classList.add('hidden');
                resultsArea.innerHTML = html;
                resultsArea.classList.remove('hidden');

            } catch (error) {
                showError('Search Failed', 'Error loading student reports: ' + error.message);
            }
        }

        function testWithSampleData() {
            const sampleNumbers = [
                '+2348012345678',
                '+2347012345678',
                '+2348112345678',
                '+2349012345678'
            ];
            
            const randomNumber = sampleNumbers[Math.floor(Math.random() * sampleNumbers.length)];
            document.getElementById('adminParentPhone').value = randomNumber;
            
            showToast(`Testing with sample number: ${randomNumber}`, 'info');
            loadParentPortal();
        }

        function sendTestNotification() {
            showToast('Test notification sent successfully!', 'success');
        }

        function findParentForStudent(studentName, studentPhone) {
            document.getElementById('adminParentPhone').value = studentPhone || '';
            showToast(`Searching for parent of ${studentName}...`, 'info');
            loadParentPortal();
            hideModal('studentsManagementModal');
        }

        function manualSearchParent(studentName) {
            const parentPhone = prompt(`Enter parent phone number for ${studentName}:`);
            if (parentPhone) {
                document.getElementById('adminParentPhone').value = parentPhone;
                showToast(`Now search for parent with phone: ${parentPhone}`, 'info');
                hideModal('parentStudentMatchingModal');
            }
        }

        // Add admin badge
        function addAdminBadge() {
            const badge = document.createElement('div');
            badge.className = 'admin-badge';
            badge.textContent = 'ADMIN VIEW - LOCAL MODE';
            badge.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: #DC2626;
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            `;
            document.body.appendChild(badge);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addAdminBadge();
            console.log('üöÄ Enhanced Admin Parent Viewer running locally');
            
            // Allow Enter key to search
            document.getElementById('adminParentPhone').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadParentPortal();
                }
            });
            
            // Initialize delete confirmation
            document.getElementById('confirmDelete').addEventListener('change', function() {
                document.getElementById('confirmDeleteBtn').disabled = !this.checked;
                document.getElementById('confirmDeleteBtn').classList.toggle('opacity-50', !this.checked);
            });
        });
    </script>
</body>
</html>
