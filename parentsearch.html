<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Parent Portal Viewer - Blooming Kids House</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/libphonenumber-js@1.10.14/bundle/libphonenumber-js.min.js"></script>
    <style>
        .loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #10B981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-spinner-small {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10B981;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .admin-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #DC2626;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10000;
        }
        .preserve-whitespace {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .defective-account {
            border-left: 4px solid #DC2626;
            background-color: #FEF2F2;
        }
        .duplicate-account {
            border-left: 4px solid #F59E0B;
            background-color: #FFFBEB;
        }
        .student-card {
            border-left: 4px solid #3B82F6;
            background-color: #EFF6FF;
        }
        .report-month {
            display: inline-block;
            background: #D1FAE5;
            color: #065F46;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin: 2px;
        }
        .match-suggestion {
            border: 2px dashed #F59E0B;
            background-color: #FFFBEB;
        }
        .match-found {
            border: 2px solid #10B981;
            background-color: #D1FAE5;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10001;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        .academic-badge {
            display: inline-flex;
            align-items: center;
            background: #EFF6FF;
            border: 1px solid #3B82F6;
            color: #1E40AF;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin: 2px;
        }
        .collection-badge {
            display: inline-block;
            background: #6B7280;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
        }
        .defect-highlight {
            animation: pulse 2s infinite;
            border: 2px solid #DC2626;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        .fix-button {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .fix-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        .warning-badge {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            color: #92400E;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .search-result-item {
            transition: all 0.2s;
            cursor: pointer;
        }
        .search-result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .phone-format-badge {
            display: inline-block;
            background: #E0E7FF;
            color: #3730A3;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin: 2px;
            font-family: monospace;
        }
        .submission-item {
            border-left: 4px solid #10B981;
            margin-bottom: 8px;
        }
        .submission-mismatch {
            border-left: 4px solid #DC2626;
            background-color: #FEF2F2;
        }
        .submission-missing {
            border-left: 4px solid #F59E0B;
            background-color: #FFFBEB;
        }
        .format-match {
            background-color: #D1FAE5;
            border: 1px solid #10B981;
        }
        .format-mismatch {
            background-color: #FEE2E2;
            border: 1px solid #DC2626;
        }
        .format-missing {
            background-color: #FEF3C7;
            border: 1px solid #F59E0B;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="min-h-screen bg-gray-50 py-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Admin Header -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <div class="flex justify-between items-center">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">Admin Parent Portal Viewer</h1>
                            <p class="text-gray-600 mt-2">View any parent's portal by phone number - LOCAL MODE</p>
                            <p class="text-sm text-green-600 mt-1">‚úÖ Running locally - No deployment needed</p>
                            <p class="text-sm text-blue-600 mt-1">üîç Now searches ANY phone format: 08012345678, 2348012345678, +2348012345678</p>
                            <p class="text-sm text-purple-600 mt-1">üîó NEW: Student Connection Fixer - Fix tutor-parent phone mismatches</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">Admin Mode</span>
                            <button onclick="showAdminTools()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                üõ†Ô∏è Admin Tools
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Search Section -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Search Phone, Email, or Student Name
                            </label>
                            <input 
                                type="text" 
                                id="adminParentPhone" 
                                placeholder="Enter phone (any format), email, or student name"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                            >
                            <p class="text-sm text-gray-500 mt-2">
                                Universal search: Phone (any format), Email, or Student Name
                            </p>
                        </div>
                        <div class="flex items-end space-x-4">
                            <button 
                                onclick="loadParentPortal()"
                                class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center justify-center"
                                id="searchBtn"
                            >
                                <span class="mr-2">üîç</span>
                                View Parent Portal
                            </button>
                            <button 
                                onclick="testWithSampleData()"
                                class="bg-yellow-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-yellow-700 transition-colors"
                                title="Test with sample phone numbers"
                            >
                                üß™ Test
                            </button>
                        </div>
                    </div>

                    <!-- Quick Search Options -->
                    <div class="mt-6 border-t pt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Search Options</h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <button onclick="searchRecentParents()" class="bg-blue-100 text-blue-800 px-4 py-3 rounded-lg hover:bg-blue-200 transition-colors flex items-center justify-center">
                                <span class="mr-2">üìã</span> Recent Parents
                            </button>
                            <button onclick="searchByStudentName()" class="bg-green-100 text-green-800 px-4 py-3 rounded-lg hover:bg-green-200 transition-colors flex items-center justify-center">
                                <span class="mr-2">üë¶</span> By Student Name
                            </button>
                            <button onclick="showAllParents()" class="bg-purple-100 text-purple-800 px-4 py-3 rounded-lg hover:bg-purple-200 transition-colors flex items-center justify-center">
                                <span class="mr-2">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> All Parents
                            </button>
                            <button onclick="showDefectiveParents()" class="bg-red-100 text-red-800 px-4 py-3 rounded-lg hover:bg-red-200 transition-colors flex items-center justify-center">
                                <span class="mr-2">‚ö†Ô∏è</span> Defective Accounts
                            </button>
                            <button onclick="showOrphanedParents()" class="bg-orange-100 text-orange-800 px-4 py-3 rounded-lg hover:bg-orange-200 transition-colors flex items-center justify-center">
                                <span class="mr-2">üë§</span> Orphaned Parents
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results Area -->
                <div id="adminResultsArea" class="hidden">
                    <!-- Parent portal will be loaded here -->
                </div>

                <!-- Loading State -->
                <div id="adminLoader" class="hidden text-center py-12">
                    <div class="loading-spinner mx-auto" style="width: 60px; height: 60px;"></div>
                    <p class="text-green-600 font-semibold mt-4 text-lg">Loading parent portal...</p>
                    <p class="text-gray-500 text-sm mt-2" id="loadingDetails"></p>
                </div>

                <!-- Error State -->
                <div id="adminError" class="hidden text-center py-12">
                    <div class="text-6xl mb-4">‚ùå</div>
                    <h3 class="text-xl font-bold text-red-700 mb-2" id="adminErrorTitle">Unable to Load Parent Portal</h3>
                    <p class="text-gray-500 max-w-md mx-auto mb-4" id="adminErrorMessage"></p>
                    <button onclick="hideError()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        Try Again
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Tools Modal -->
    <div id="adminToolsModal" class="modal hidden">
        <div class="modal-content w-full max-w-6xl">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">üõ†Ô∏è Enhanced Admin Tools</h2>
                
                <!-- Parent Portal Overview - FIXED -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-4">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Portal Overview - NOW WORKING</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <button onclick="loadAllParentsSummary()" class="bg-blue-100 text-blue-800 px-4 py-3 rounded-lg hover:bg-blue-200 transition-colors">
                            üìä View All Parent Portals
                        </button>
                        <button onclick="loadStudentsManagement()" class="bg-green-100 text-green-800 px-4 py-3 rounded-lg hover:bg-green-200 transition-colors">
                            üë®‚Äçüéì Manage Students
                        </button>
                        <button onclick="scanAllStudentDefects()" class="bg-red-100 text-red-800 px-4 py-3 rounded-lg hover:bg-red-200 transition-colors">
                            üîç Scan Student Defects
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="showAllParents()" class="bg-gray-100 text-gray-800 px-4 py-3 rounded-lg hover:bg-gray-200 transition-colors">
                            üë• All Parent Users
                        </button>
                        <button onclick="showDuplicateAccounts()" class="bg-yellow-100 text-yellow-800 px-4 py-3 rounded-lg hover:bg-yellow-200 transition-colors">
                            üîç Duplicate Accounts
                        </button>
                        <button onclick="showDefectiveParents()" class="bg-red-100 text-red-800 px-4 py-3 rounded-lg hover:bg-red-200 transition-colors">
                            ‚ö†Ô∏è Defective Accounts
                        </button>
                    </div>
                </div>

                <!-- NEW: Student Connection Fixer -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-purple-800 mb-4">üîó NEW: Student Connection Fixer</h3>
                    <p class="text-purple-700 mb-4">Fix tutor-parent phone mismatches that prevent parents from seeing submissions</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Search Student by Name</label>
                            <div class="flex gap-2">
                                <input type="text" id="connectionFixStudentName" 
                                       placeholder="Enter student name to find connection issues"
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">
                                <button onclick="searchStudentConnections()" 
                                        class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                    üîç Search
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Fixes: Phone format mismatches, missing parent phones, unlinked submissions</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <button onclick="showPhoneFormatAnalyzer()" class="bg-indigo-100 text-indigo-800 px-4 py-3 rounded-lg hover:bg-indigo-200 transition-colors">
                                üì± Phone Format Analyzer
                            </button>
                            <button onclick="showAllPhoneFormats()" class="bg-pink-100 text-pink-800 px-4 py-3 rounded-lg hover:bg-pink-200 transition-colors">
                                üî¢ All Phone Formats
                            </button>
                            <button onclick="showBulkPhoneFixer()" class="bg-teal-100 text-teal-800 px-4 py-3 rounded-lg hover:bg-teal-200 transition-colors">
                                ‚ö° Bulk Phone Fixer
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Data Management Tools -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-green-800 mb-4">üìà Data Management</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quick Edit Parent Email</label>
                            <div class="flex flex-col md:flex-row gap-2">
                                <input type="text" id="editEmailParentId" placeholder="Parent ID" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                                <input type="email" id="editEmailNewEmail" placeholder="New Email" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                                <button onclick="updateParentEmail()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                    Update Email
                                </button>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="exportAllData()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                                üì§ Export All Data
                            </button>
                            <button onclick="runUniversalDataFix()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors">
                                üîß Universal Data Fix
                            </button>
                            <button onclick="sendTestNotification()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-colors">
                                üîî Test Notification
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Information -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-yellow-800 mb-3">üìä System Information</h3>
                    <div id="systemStats" class="text-sm text-gray-700">
                        Loading system statistics...
                    </div>
                </div>

                <div class="flex justify-end mt-6">
                    <button onclick="hideAdminTools()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Connection Fixer Modal -->
    <div id="studentConnectionFixerModal" class="modal hidden">
        <div class="modal-content w-full max-w-6xl">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üîó Student Connection Fixer</h2>
                <div id="studentConnectionFixerContent" class="space-y-6">
                    <!-- Content will be loaded here -->
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="hideStudentConnectionFixer()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Phone Format Analyzer Modal -->
    <div id="phoneFormatAnalyzerModal" class="modal hidden">
        <div class="modal-content w-full max-w-6xl">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üì± Phone Format Analyzer</h2>
                <div id="phoneFormatAnalyzerContent" class="space-y-6">
                    <!-- Content will be loaded here -->
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="hidePhoneFormatAnalyzer()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- All Parents Summary Modal -->
    <div id="allParentsSummaryModal" class="modal hidden">
        <div class="modal-content w-full max-w-6xl">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä All Parent Portals Summary</h2>
                <div id="allParentsSummaryContent" class="space-y-6">
                    Loading parent summaries...
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="hideAllParentsSummary()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Students Management Modal -->
    <div id="studentsManagementModal" class="modal hidden">
        <div class="modal-content w-full max-w-6xl">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üë®‚Äçüéì Student Users Management</h2>
                <div id="studentsManagementContent" class="space-y-6">
                    Loading student data...
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="hideStudentsManagement()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Defect Scanner Modal -->
    <div id="studentDefectScannerModal" class="modal hidden">
        <div class="modal-content w-full max-w-6xl">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üîç Student Defect Scanner</h2>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <p class="text-red-700 font-semibold">Scans ALL students for missing data and provides one-click fixes</p>
                </div>
                <div id="studentDefectScannerContent" class="space-y-6">
                    Loading defect scanner...
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="hideStudentDefectScanner()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Orphaned Parents Modal -->
    <div id="orphanedParentsModal" class="modal hidden">
        <div class="modal-content w-full max-w-6xl">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üë§ Orphaned Parents Finder</h2>
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
                    <p class="text-orange-700 font-semibold">Finds parents who signed up but have no students attached</p>
                </div>
                <div id="orphanedParentsContent" class="space-y-6">
                    Loading orphaned parents...
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="hideOrphanedParentsModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Phone Modal -->
    <div id="editPhoneModal" class="modal hidden">
        <div class="modal-content w-full max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Edit Parent Phone Number</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Current Phone</label>
                        <input type="text" id="currentPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">New Phone Number</label>
                        <input type="text" id="newPhone" placeholder="Enter new phone number" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div id="phoneValidation" class="text-sm hidden"></div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="hideEditPhoneModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button onclick="updateParentPhone()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Update Phone
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Phone Format Update Modal -->
    <div id="phoneFormatUpdateModal" class="modal hidden">
        <div class="modal-content w-full max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">üîÑ Update Phone Format</h3>
                <div class="space-y-4">
                    <div id="phoneFormatUpdateContent">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="hidePhoneFormatUpdateModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button onclick="applyPhoneFormatUpdate()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        Apply Update
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD1lJhsWMMs_qerLBSzk7wKhjLyI_11RJg",
            authDomain: "bloomingkidsassessment.firebaseapp.com",
            projectId: "bloomingkidsassessment",
            storageBucket: "bloomingkidsassessment.appspot.com",
            messagingSenderId: "238975054977",
            appId: "1:238975054977:web:87c70b4db044998a204980"
        };

        // Initialize Firebase
        let db;
        let auth;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log('‚úÖ Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Global variables
        let currentParentData = null;
        let currentEditingUserId = null;
        let currentEditingEmailData = null;
        let currentFixData = null;
        let allStudentsCache = null;
        let currentStudentConnectionData = null;
        let currentPhoneFormatData = null;

        // ==================== EXISTING FUNCTIONS FROM YOUR ORIGINAL CODE ====================

        // Toast notification function
        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-blue-600'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${colors[type] || colors.info}`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Utility functions
        function capitalize(str) {
            if (!str) return "";
            return str.replace(/\b\w/g, l => l.toUpperCase());
        }

        function showError(title, message) {
            document.getElementById('adminErrorTitle').textContent = title;
            document.getElementById('adminErrorMessage').textContent = message;
            document.getElementById('adminError').classList.remove('hidden');
            document.getElementById('adminLoader').classList.add('hidden');
            document.getElementById('adminResultsArea').classList.add('hidden');
            showToast(message, 'error');
        }

        function hideError() {
            document.getElementById('adminError').classList.add('hidden');
        }

        // ==================== YOUR EXISTING UNIVERSAL PHONE NORMALIZATION ====================
        function universalNormalizePhoneNumber(phone) {
            if (!phone || typeof phone !== 'string') {
                return [{ normalized: null, original: phone, valid: false, error: 'Invalid input' }];
            }

            const originalPhone = phone.trim();
            const normalizationAttempts = [];
            
            // Remove all non-digit characters except plus
            const cleaned = originalPhone.replace(/[^\d+]/g, '');
            
            // Try multiple normalization strategies
            const strategies = [
                // Strategy 1: Standard libphonenumber parsing
                () => {
                    try {
                        const parsed = libphonenumber.parsePhoneNumberFromString(originalPhone);
                        if (parsed && parsed.isValid()) {
                            return {
                                normalized: parsed.format('E.164'),
                                original: originalPhone,
                                valid: true,
                                attempt: 'standard_parse',
                                country: parsed.country
                            };
                        }
                    } catch (e) {}
                    return null;
                },
                
                // Strategy 2: Nigeria numbers with leading 0
                () => {
                    if (cleaned.match(/^0[7-9][0-9]/) && cleaned.length === 11) {
                        const ngNumber = '+234' + cleaned.substring(1);
                        try {
                            const parsed = libphonenumber.parsePhoneNumberFromString(ngNumber);
                            if (parsed && parsed.isValid()) {
                                return {
                                    normalized: parsed.format('E.164'),
                                    original: originalPhone,
                                    valid: true,
                                    attempt: 'nigeria_leading_zero',
                                    country: 'NG'
                                };
                            }
                        } catch (e) {}
                    }
                    return null;
                },
                
                // Strategy 3: Nigeria numbers without country code
                () => {
                    if (cleaned.match(/^[7-9][0-9]{9}$/) && cleaned.length === 10) {
                        const ngNumber = '+234' + cleaned;
                        try {
                            const parsed = libphonenumber.parsePhoneNumberFromString(ngNumber);
                            if (parsed && parsed.isValid()) {
                                return {
                                    normalized: parsed.format('E.164'),
                                    original: originalPhone,
                                    valid: true,
                                    attempt: 'nigeria_10_digits',
                                    country: 'NG'
                                };
                            }
                        } catch (e) {}
                    }
                    return null;
                },
                
                // Strategy 4: Nigeria numbers with 234 but no +
                () => {
                    if (cleaned.match(/^234[7-9][0-9]{9}$/) && cleaned.length === 13) {
                        const ngNumber = '+' + cleaned;
                        try {
                            const parsed = libphonenumber.parsePhoneNumberFromString(ngNumber);
                            if (parsed && parsed.isValid()) {
                                return {
                                    normalized: parsed.format('E.164'),
                                    original: originalPhone,
                                    valid: true,
                                    attempt: 'nigeria_234_prefix',
                                    country: 'NG'
                                };
                            }
                        } catch (e) {}
                    }
                    return null;
                },
                
                // Strategy 5: Digits only fallback
                () => {
                    const digitsOnly = cleaned.replace(/\D/g, '');
                    if (digitsOnly.length >= 8 && digitsOnly.length <= 15) {
                        return {
                            normalized: digitsOnly,
                            original: originalPhone,
                            valid: true,
                            attempt: 'digits_only',
                            country: null
                        };
                    }
                    return null;
                }
            ];
            
            // Execute all strategies
            for (const strategy of strategies) {
                const result = strategy();
                if (result) {
                    normalizationAttempts.push(result);
                    // Return first valid result
                    return normalizationAttempts;
                }
            }
            
            // If nothing works, return error
            normalizationAttempts.push({
                normalized: null,
                original: originalPhone,
                valid: false,
                error: 'No valid normalization found',
                attempt: 'all_failed'
            });
            
            return normalizationAttempts;
        }

        // ==================== UNIVERSAL PHONE SEARCH FUNCTION ====================
        async function searchPhoneInAllCollections(phone) {
            const normalizedVersions = universalNormalizePhoneNumber(phone);
            const validVersions = normalizedVersions.filter(v => v.valid && v.normalized);
            
            if (validVersions.length === 0) {
                throw new Error(`Cannot normalize phone: ${phone}. Try formats like: 08012345678, 2348012345678, +2348012345678`);
            }
            
            const searchResults = {
                parent: null,
                parentId: null,
                foundInCollections: new Set(),
                searchAttempts: validVersions,
                matchedVersion: null
            };
            
            // Define all collections to search
            const collectionsToSearch = [
                'parent_users',
                'students',
                'pending_students',
                'student_results',
                'tutor_submissions',
                'daily_topics',
                'homework_assignments',
                'referral_transactions'
            ];
            
            // Try each normalized version
            for (const version of validVersions) {
                const normalizedPhone = version.normalized;
                
                // 1. Search in parent_users (most important)
                try {
                    // Search by normalized phone
                    let query = await db.collection('parent_users')
                        .where('normalizedPhone', '==', normalizedPhone)
                        .limit(1)
                        .get();
                    
                    // If not found, search by phone field with various formats
                    if (query.empty) {
                        const phoneVariations = [
                            phone,
                            normalizedPhone,
                            phone.replace('+', ''),
                            phone.startsWith('0') ? '234' + phone.substring(1) : null,
                            phone.startsWith('234') ? '0' + phone.substring(3) : null
                        ].filter(Boolean);
                        
                        for (const variation of phoneVariations) {
                            query = await db.collection('parent_users')
                                .where('phone', '==', variation)
                                .limit(1)
                                .get();
                            
                            if (!query.empty) break;
                        }
                    }
                    
                    if (!query.empty) {
                        searchResults.parent = query.docs[0].data();
                        searchResults.parentId = query.docs[0].id;
                        searchResults.matchedVersion = version;
                        searchResults.foundInCollections.add('parent_users');
                        break; // Found parent, stop searching
                    }
                } catch (error) {
                    console.log(`Error searching parent_users for ${normalizedPhone}:`, error.message);
                }
            }
            
            // If parent not found, search in other collections for any records
            if (!searchResults.parent) {
                for (const collection of collectionsToSearch) {
                    if (collection === 'parent_users') continue;
                    
                    for (const version of validVersions) {
                        try {
                            // Try normalized phone field
                            let query = await db.collection(collection)
                                .where('normalizedParentPhone', '==', version.normalized)
                                .limit(1)
                                .get();
                            
                            // Try parentPhone field
                            if (query.empty) {
                                query = await db.collection(collection)
                                    .where('parentPhone', '==', phone)
                                    .limit(1)
                                    .get();
                            }
                            
                            // Try other phone variations
                            if (query.empty) {
                                const phoneVariations = [
                                    phone,
                                    version.normalized,
                                    phone.replace('+', ''),
                                    phone.startsWith('0') ? '234' + phone.substring(1) : null,
                                    phone.startsWith('234') ? '0' + phone.substring(3) : null
                                ].filter(Boolean);
                                
                                for (const variation of phoneVariations) {
                                    query = await db.collection(collection)
                                        .where('parentPhone', '==', variation)
                                        .limit(1)
                                        .get();
                                    
                                    if (!query.empty) break;
                                }
                            }
                            
                            if (!query.empty) {
                                searchResults.foundInCollections.add(collection);
                                // Extract parent info from found document
                                const docData = query.docs[0].data();
                                if (docData.parentEmail || docData.parentName) {
                                    searchResults.parent = {
                                        phone: phone,
                                        email: docData.parentEmail || 'unknown@example.com',
                                        parentName: docData.parentName || 'Unknown Parent'
                                    };
                                    searchResults.matchedVersion = version;
                                }
                                break;
                            }
                        } catch (error) {
                            console.log(`Error searching ${collection}:`, error.message);
                        }
                    }
                }
            }
            
            return searchResults;
        }

        // ==================== MISSING FUNCTION - ADD THIS ====================
        async function searchByPhone(phone) {
            return await searchPhoneInAllCollections(phone);
        }

        // ==================== ENHANCED UNIVERSAL SEARCH ====================
        async function universalSearch(query) {
            const trimmedQuery = query.trim();
            
            if (!trimmedQuery) {
                showToast('Please enter a search query', 'warning');
                return null;
            }
            
            // Determine search type
            let searchType = 'phone';
            let searchValue = trimmedQuery;
            
            // Check if it's an email
            if (trimmedQuery.includes('@')) {
                searchType = 'email';
            }
            // Check if it's a student name (contains letters and possibly numbers)
            else if (/[a-zA-Z]/.test(trimmedQuery)) {
                searchType = 'studentName';
            }
            // Otherwise assume it's a phone number
            else {
                searchType = 'phone';
            }
            
            try {
                switch (searchType) {
                    case 'phone':
                        return await searchByPhone(trimmedQuery);
                        
                    case 'email':
                        return await searchByEmail(trimmedQuery);
                        
                    case 'studentName':
                        return await searchByStudentNameUniversal(trimmedQuery);
                        
                    default:
                        return await searchByPhone(trimmedQuery);
                }
            } catch (error) {
                console.error('Universal search error:', error);
                return null;
            }
        }

        async function searchByEmail(email) {
            try {
                // Search in parent_users first
                let query = await db.collection('parent_users')
                    .where('email', '==', email)
                    .limit(1)
                    .get();
                
                if (!query.empty) {
                    const doc = query.docs[0];
                    return {
                        parent: doc.data(),
                        parentId: doc.id,
                        searchType: 'email',
                        foundIn: 'parent_users'
                    };
                }
                
                // Search in students for parentEmail
                query = await db.collection('students')
                    .where('parentEmail', '==', email)
                    .limit(1)
                    .get();
                
                if (!query.empty) {
                    const student = query.docs[0].data();
                    // Now find parent by phone
                    if (student.parentPhone) {
                        return await searchByPhone(student.parentPhone);
                    }
                }
                
                // Search in other collections
                const collections = ['tutor_submissions', 'student_results', 'daily_topics'];
                for (const collection of collections) {
                    try {
                        query = await db.collection(collection)
                            .where('parentEmail', '==', email)
                            .limit(1)
                            .get();
                        
                        if (!query.empty) {
                            const doc = query.docs[0].data();
                            if (doc.parentPhone) {
                                return await searchByPhone(doc.parentPhone);
                            }
                        }
                    } catch (error) {
                        // Collection might not have parentEmail field
                    }
                }
                
                return null;
            } catch (error) {
                throw new Error(`Email search failed: ${error.message}`);
            }
        }

        async function searchByStudentNameUniversal(studentName) {
            try {
                // First, try to find student in students collection
                let query = await db.collection('students')
                    .where('studentName', '==', studentName)
                    .limit(1)
                    .get();
                
                let student = null;
                let collection = 'students';
                
                if (query.empty) {
                    // Try pending_students
                    query = await db.collection('pending_students')
                        .where('studentName', '==', studentName)
                        .limit(1)
                        .get();
                    
                    if (!query.empty) {
                        collection = 'pending_students';
                    }
                }
                
                if (!query.empty) {
                    const doc = query.docs[0];
                    student = {
                        id: doc.id,
                        collection: collection,
                        ...doc.data()
                    };
                    
                    // Find parent by student's parentPhone
                    if (student.parentPhone) {
                        const parentSearch = await searchByPhone(student.parentPhone);
                        if (parentSearch && parentSearch.parent) {
                            return {
                                ...parentSearch,
                                foundStudent: student,
                                searchType: 'studentName'
                            };
                        }
                    }
                }
                
                // If student not found or no parent, search in submissions
                const collections = ['student_results', 'tutor_submissions'];
                for (const coll of collections) {
                    try {
                        query = await db.collection(coll)
                            .where('studentName', '==', studentName)
                            .limit(1)
                            .get();
                        
                        if (!query.empty) {
                            const submission = query.docs[0].data();
                            if (submission.parentPhone) {
                                const parentSearch = await searchByPhone(submission.parentPhone);
                                if (parentSearch && parentSearch.parent) {
                                    return {
                                        ...parentSearch,
                                        foundSubmission: submission,
                                        searchType: 'studentName'
                                    };
                                }
                            }
                        }
                    } catch (error) {
                        // Continue to next collection
                    }
                }
                
                // If we get here, we found student records but no parent
                if (student) {
                    return {
                        foundStudent: student,
                        parent: null,
                        searchType: 'studentName',
                        message: `Found student "${studentName}" but no parent account linked`
                    };
                }
                
                return null;
            } catch (error) {
                throw new Error(`Student name search failed: ${error.message}`);
            }
        }

        // ==================== ENHANCED PHONE MIGRATION - NUCLEAR UPDATE ====================
        function getAllPhoneVariations(phone) {
            if (!phone) return [];
            
            const variations = new Set();
            
            // Add original
            variations.add(phone);
            
            // Normalize to get variations
            const normalizedVersions = universalNormalizePhoneNumber(phone);
            normalizedVersions.forEach(v => {
                if (v.valid && v.normalized) {
                    variations.add(v.normalized);
                }
            });
            
            // Common variations for Nigerian numbers
            if (phone.startsWith('0') && phone.length === 11) {
                variations.add('+234' + phone.substring(1));  // +2348012345678
                variations.add('234' + phone.substring(1));   // 2348012345678
                variations.add(phone.substring(1));           // 8012345678
            }
            
            if (phone.startsWith('+234') && phone.length === 14) {
                variations.add('0' + phone.substring(4));     // 08012345678
                variations.add(phone.substring(1));           // 2348012345678
                variations.add(phone.substring(4));           // 8012345678
            }
            
            if (phone.startsWith('234') && phone.length === 13) {
                variations.add('+234' + phone.substring(3));  // +2348012345678
                variations.add('0' + phone.substring(3));     // 08012345678
                variations.add(phone.substring(3));           // 8012345678
            }
            
            if (phone.length === 10 && !phone.startsWith('0')) {
                variations.add('+234' + phone);               // +2348012345678
                variations.add('0' + phone);                  // 08012345678
                variations.add('234' + phone);                // 2348012345678
            }
            
            // Also add cleaned versions (remove spaces, dashes, etc.)
            const cleaned = phone.replace(/[^\d+]/g, '');
            if (cleaned !== phone) {
                variations.add(cleaned);
            }
            
            return Array.from(variations);
        }

        async function updateParentPhone() {
            const newPhone = document.getElementById('newPhone').value.trim();
            const validationElement = document.getElementById('phoneValidation');
            
            if (!newPhone) {
                validationElement.innerHTML = '<p class="text-red-600">Please enter a phone number</p>';
                validationElement.classList.remove('hidden');
                return;
            }
            
            const normalized = universalNormalizePhoneNumber(newPhone);
            const validVersions = normalized.filter(v => v.valid && v.normalized);
            
            if (validVersions.length === 0) {
                validationElement.innerHTML = '<p class="text-red-600">Invalid phone number format</p>';
                validationElement.classList.remove('hidden');
                return;
            }
            
            const normalizedPhone = validVersions[0].normalized;
            const oldPhone = document.getElementById('currentPhone').value;
            
            try {
                validationElement.innerHTML = '<p class="text-blue-600"><div class="loading-spinner-small inline-block mr-2"></div> Starting nuclear phone migration...</p>';
                validationElement.classList.remove('hidden');
                
                // Step 1: Update parent_users collection
                await db.collection('parent_users').doc(currentEditingUserId).update({
                    phone: newPhone,
                    normalizedPhone: normalizedPhone,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Step 2: Get ALL possible variations of the old phone
                const oldVariations = getAllPhoneVariations(oldPhone);
                const newVariations = getAllPhoneVariations(newPhone);
                
                // Step 3: Scan and update ALL 8 database collections
                const collectionsToUpdate = [
                    'students',
                    'student_results',
                    'tutor_submissions',
                    'daily_topics',
                    'homework_assignments',
                    'pending_students',
                    'referral_transactions',
                    'monthly_reports',
                    'assessment_reports',
                    'progress_reports'
                ];
                
                let totalUpdated = 0;
                const updatePromises = [];
                
                for (const collection of collectionsToUpdate) {
                    try {
                        // Search for ALL variations of the old phone
                        for (const oldVariant of oldVariations) {
                            // Try multiple field names
                            const fields = ['parentPhone', 'phone', 'contactPhone', 'guardianPhone'];
                            
                            for (const field of fields) {
                                try {
                                    const query = await db.collection(collection)
                                        .where(field, '==', oldVariant)
                                        .get();
                                    
                                    query.forEach(doc => {
                                        const updateData = {
                                            [field]: newPhone,
                                            normalizedParentPhone: normalizedPhone,
                                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                        };
                                        
                                        updatePromises.push(
                                            db.collection(collection).doc(doc.id).update(updateData)
                                        );
                                        totalUpdated++;
                                    });
                                } catch (error) {
                                    // Field might not exist in this collection
                                }
                            }
                            
                            // Also check normalizedParentPhone field
                            try {
                                const query = await db.collection(collection)
                                    .where('normalizedParentPhone', '==', oldVariant)
                                    .get();
                                
                                query.forEach(doc => {
                                    updatePromises.push(
                                        db.collection(collection).doc(doc.id).update({
                                            normalizedParentPhone: normalizedPhone,
                                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                        })
                                    );
                                    totalUpdated++;
                                });
                            } catch (error) {
                                // Field might not exist
                            }
                        }
                    } catch (error) {
                        console.log(`Collection ${collection} update error:`, error.message);
                    }
                }
                
                // Execute all updates
                if (updatePromises.length > 0) {
                    await Promise.all(updatePromises);
                }
                
                validationElement.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                        <p class="text-green-800 font-semibold">‚úÖ Nuclear Migration Complete!</p>
                        <p class="text-green-700 text-sm mt-1">
                            Updated parent phone and migrated ${totalUpdated} records across ${collectionsToUpdate.length} collections
                        </p>
                        <p class="text-green-600 text-xs mt-2">
                            Old phone variations: ${oldVariations.slice(0, 3).join(', ')}${oldVariations.length > 3 ? '...' : ''}
                        </p>
                        <p class="text-green-600 text-xs">
                            New phone: ${newPhone} ‚Üí ${normalizedPhone}
                        </p>
                    </div>
                `;
                
                setTimeout(() => {
                    hideEditPhoneModal();
                    showToast(`Nuclear migration complete! Updated ${totalUpdated} records`, 'success');
                    // Refresh current view if parent portal is open
                    if (currentParentData) {
                        document.getElementById('adminParentPhone').value = newPhone;
                        loadParentPortal();
                    }
                }, 3000);
                
            } catch (error) {
                validationElement.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-3">
                    <p class="text-red-800 font-semibold">‚ùå Migration Error</p>
                    <p class="text-red-700 text-sm">${error.message}</p>
                </div>`;
                validationElement.classList.remove('hidden');
            }
        }

        function hideEditPhoneModal() {
            hideModal('editPhoneModal');
            currentEditingUserId = null;
        }

        // ==================== EDIT EMAIL - COMPLETE IMPLEMENTATION ====================
        async function editParentEmailPrompt(userId, parentName, currentEmail) {
            const newEmail = prompt(`Edit email for ${parentName}\nCurrent: ${currentEmail}\n\nEnter new email address:`, currentEmail);
            
            if (!newEmail || newEmail === currentEmail) {
                return;
            }
            
            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(newEmail)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            try {
                await updateParentEmail(userId, newEmail);
            } catch (error) {
                showToast(`Error updating email: ${error.message}`, 'error');
            }
        }

        async function updateParentEmail(userId, newEmail) {
            try {
                await db.collection('parent_users').doc(userId).update({
                    email: newEmail,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast(`Email updated successfully to: ${newEmail}`, 'success');
                
                // Also update email in student records
                await updateEmailInRelatedCollections(userId, newEmail);
                
            } catch (error) {
                throw new Error(`Failed to update email: ${error.message}`);
            }
        }

        async function updateEmailInRelatedCollections(parentId, newEmail) {
            try {
                // Get parent phone first
                const parentDoc = await db.collection('parent_users').doc(parentId).get();
                if (!parentDoc.exists) return;
                
                const parentData = parentDoc.data();
                const parentPhone = parentData.phone;
                if (!parentPhone) return;
                
                // Collections to update
                const collections = ['students', 'pending_students', 'student_results', 'tutor_submissions'];
                let totalUpdated = 0;
                
                for (const collection of collections) {
                    try {
                        // Find documents with this parent phone
                        const query = await db.collection(collection)
                            .where('parentPhone', '==', parentPhone)
                            .get();
                        
                        const updatePromises = [];
                        query.forEach(doc => {
                            updatePromises.push(
                                db.collection(collection).doc(doc.id).update({
                                    parentEmail: newEmail,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                })
                            );
                        });
                        
                        if (updatePromises.length > 0) {
                            await Promise.all(updatePromises);
                            totalUpdated += updatePromises.length;
                        }
                    } catch (error) {
                        // Collection might not have parentPhone field
                    }
                }
                
                if (totalUpdated > 0) {
                    console.log(`Updated email in ${totalUpdated} related records`);
                }
            } catch (error) {
                console.log('Error updating related collections:', error.message);
            }
        }

        // ==================== COMPLETE PARENT PORTAL FUNCTIONS ====================
        async function loadCompleteParentPortal(parentUserId, parentPhone, parentUserData) {
            const resultsArea = document.getElementById('adminResultsArea');
            
            try {
                document.getElementById('loadingDetails').textContent = `Loading complete portal for ${parentUserData.parentName || 'Parent'}...`;

                resultsArea.innerHTML = `
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="bg-red-50 border-b border-red-200 p-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h2 class="text-xl font-bold text-red-800">Viewing Complete Portal for: ${parentUserData.parentName || 'Parent'}</h2>
                                    <p class="text-red-600">Phone: ${parentUserData.phone} | Email: ${parentUserData.email}</p>
                                    <p class="text-red-600 text-sm">User ID: ${parentUserId}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-red-700">Account Created: ${parentUserData.createdAt?.toDate().toLocaleDateString() || 'Unknown'}</p>
                                    <p class="text-sm text-red-700">Referral Code: ${parentUserData.referralCode || 'None'}</p>
                                    <div class="flex space-x-2 mt-2">
                                        <button onclick="editParentPhone('${parentUserId}', '${parentUserData.phone}')" 
                                                class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                            ‚úèÔ∏è Edit Phone
                                        </button>
                                        <button onclick="editParentEmailPrompt('${parentUserId}', '${parentUserData.parentName || 'Unknown'}', '${parentUserData.email}')" 
                                                class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                            ‚úèÔ∏è Edit Email
                                        </button>
                                        <button onclick="deleteParentAccountPrompt('${parentUserId}', '${parentUserData.parentName || 'Unknown'}', '${parentUserData.phone}', '${parentUserData.email}')" 
                                                class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                            üóëÔ∏è Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="adminParentPortalContent" class="p-6">
                            <div class="text-center py-8">
                                <div class="loading-spinner mx-auto" style="width: 40px; height: 40px;"></div>
                                <p class="text-green-600 font-semibold mt-4">Loading complete parent portal...</p>
                                <p class="text-gray-500 text-sm mt-2">Fetching data from all collections...</p>
                            </div>
                        </div>
                    </div>
                `;

                // Get COMPLETE data including daily academics
                const completeData = await getCompleteParentPortalData(parentPhone);

                currentParentData = {
                    user: parentUserData,
                    userId: parentUserId,
                    ...completeData
                };

                // Display the complete portal
                displayCompleteParentPortal(completeData, parentUserData);

                document.getElementById('adminLoader').classList.add('hidden');
                resultsArea.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading parent portal:', error);
                resultsArea.innerHTML = `
                    <div class="bg-white rounded-lg shadow-lg p-8 text-center">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-xl font-bold text-red-700 mb-2">Error Loading Parent Portal</h3>
                        <p class="text-gray-500">${error.message}</p>
                    </div>
                `;
                document.getElementById('adminLoader').classList.add('hidden');
                resultsArea.classList.remove('hidden');
            }
        }

        async function getCompleteParentPortalData(parentPhone) {
            const normalizedVersions = universalNormalizePhoneNumber(parentPhone);
            const validVersions = normalizedVersions.filter(v => v.valid && v.normalized);
            
            let allData = {
                assessmentResults: [],
                monthlyResults: [],
                dailyTopics: [],
                homeworkAssignments: [],
                students: [],
                pendingStudents: [],
                referralTransactions: [],
                
                // Backup/legacy collections
                backupReports: {
                    monthly_reports: [],
                    assessment_reports: [],
                    progress_reports: [],
                    reports: [],
                    student_reports: [],
                    parent_reports: [],
                    academic_reports: [],
                    session_reports: [],
                    performance_reports: []
                },
                
                // Statistics
                stats: {
                    totalAssessments: 0,
                    totalMonthlyReports: 0,
                    totalDailyTopics: 0,
                    totalHomework: 0,
                    totalStudents: 0,
                    totalReferrals: 0
                }
            };
            
            // Helper function to query collections
            async function queryCollection(collectionName, fieldName, value) {
                try {
                    const snapshot = await db.collection(collectionName)
                        .where(fieldName, '==', value)
                        .get();
                    
                    const results = [];
                    snapshot.forEach(doc => {
                        results.push({
                            id: doc.id,
                            ...doc.data(),
                            collection: collectionName
                        });
                    });
                    return results;
                } catch (error) {
                    console.log(`No data in ${collectionName}:`, error.message);
                    return [];
                }
            }
            
            // Query with multiple phone formats
            for (const version of validVersions) {
                // Primary collections with normalized phone
                if (!allData.assessmentResults.length) {
                    allData.assessmentResults = await queryCollection('student_results', 'normalizedParentPhone', version.normalized);
                }
                
                if (!allData.monthlyResults.length) {
                    allData.monthlyResults = await queryCollection('tutor_submissions', 'normalizedParentPhone', version.normalized);
                }
                
                // Daily academics
                if (!allData.dailyTopics.length) {
                    allData.dailyTopics = await queryCollection('daily_topics', 'parentPhone', parentPhone);
                }
                
                if (!allData.homeworkAssignments.length) {
                    allData.homeworkAssignments = await queryCollection('homework_assignments', 'parentPhone', parentPhone);
                }
                
                // Student records
                if (!allData.students.length) {
                    allData.students = await queryCollection('students', 'parentPhone', parentPhone);
                }
                
                if (!allData.pendingStudents.length) {
                    allData.pendingStudents = await queryCollection('pending_students', 'parentPhone', parentPhone);
                }
                
                // Referrals
                if (!allData.referralTransactions.length) {
                    allData.referralTransactions = await queryCollection('referral_transactions', 'parentPhone', parentPhone);
                }
                
                // Backup collections (try with regular phone)
                const backupCollections = [
                    'monthly_reports', 'assessment_reports', 'progress_reports', 'reports',
                    'student_reports', 'parent_reports', 'academic_reports', 'session_reports', 'performance_reports'
                ];
                
                for (const collection of backupCollections) {
                    if (allData.backupReports[collection].length === 0) {
                        const results = await queryCollection(collection, 'parentPhone', parentPhone);
                        allData.backupReports[collection] = results;
                    }
                }
            }
            
            // Calculate statistics
            allData.stats = {
                totalAssessments: allData.assessmentResults.length,
                totalMonthlyReports: allData.monthlyResults.length,
                totalDailyTopics: allData.dailyTopics.length,
                totalHomework: allData.homeworkAssignments.length,
                totalStudents: allData.students.length + allData.pendingStudents.length,
                totalReferrals: allData.referralTransactions.length,
                backupReportsCount: Object.values(allData.backupReports).flat().length
            };
            
            return allData;
        }

        function displayCompleteParentPortal(data, parentUserData) {
            const portalContent = document.getElementById('adminParentPortalContent');
            
            let contentHTML = `
                <div class="space-y-8">
                    <!-- Parent Information Header -->
                    <div class="bg-gradient-to-r from-blue-50 to-green-50 border-l-4 border-blue-600 p-6 rounded-lg">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">${parentUserData.parentName || 'Parent'}'s Complete Portal</h1>
                                <div class="flex flex-wrap gap-4 mt-2">
                                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                                        üìû ${parentUserData.phone}
                                    </span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                                        üìß ${parentUserData.email}
                                    </span>
                                    <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm">
                                        üë®‚Äçüëß‚Äçüë¶ ${data.stats.totalStudents} Student(s)
                                    </span>
                                </div>
                            </div>
                            <div class="mt-4 md:mt-0">
                                <div class="text-right">
                                    <p class="text-sm text-gray-600">Member since: ${parentUserData.createdAt?.toDate().toLocaleDateString() || 'Unknown'}</p>
                                    <p class="text-sm text-gray-600">Referral Code: ${parentUserData.referralCode || 'None'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats Overview -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white border rounded-lg p-4 text-center shadow-sm">
                            <div class="text-2xl font-bold text-blue-600">${data.stats.totalAssessments}</div>
                            <div class="text-sm text-gray-600">Assessment Reports</div>
                        </div>
                        <div class="bg-white border rounded-lg p-4 text-center shadow-sm">
                            <div class="text-2xl font-bold text-green-600">${data.stats.totalMonthlyReports}</div>
                            <div class="text-sm text-gray-600">Monthly Reports</div>
                        </div>
                        <div class="bg-white border rounded-lg p-4 text-center shadow-sm">
                            <div class="text-2xl font-bold text-purple-600">${data.stats.totalDailyTopics}</div>
                            <div class="text-sm text-gray-600">Daily Topics</div>
                        </div>
                        <div class="bg-white border rounded-lg p-4 text-center shadow-sm">
                            <div class="text-2xl font-bold text-yellow-600">${data.stats.totalHomework}</div>
                            <div class="text-sm text-gray-600">Homework Assignments</div>
                        </div>
                    </div>
            `;
            
            // Students Section
            if (data.students.length > 0 || data.pendingStudents.length > 0) {
                contentHTML += `
                    <div class="bg-white border rounded-lg p-6 shadow-sm">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">üë®‚Äçüéì</span> Students (${data.stats.totalStudents})
                        </h2>
                        <div class="space-y-4">
                `;
                
                // Active Students
                if (data.students.length > 0) {
                    contentHTML += `
                        <div>
                            <h3 class="font-semibold text-green-700 mb-2">Active Students (${data.students.length})</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    `;
                    
                    data.students.forEach(student => {
                        contentHTML += `
                            <div class="border rounded-lg p-3 bg-green-50">
                                <div class="font-medium">${capitalize(student.studentName || student.name || 'Unknown')}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    Grade: ${student.grade || 'N/A'} | Age: ${student.age || 'N/A'}
                                </div>
                                ${student.registrationDate ? `
                                    <div class="text-xs text-gray-500 mt-1">
                                        Registered: ${new Date(student.registrationDate?.seconds * 1000).toLocaleDateString()}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    contentHTML += `</div></div>`;
                }
                
                // Pending Students
                if (data.pendingStudents.length > 0) {
                    contentHTML += `
                        <div>
                            <h3 class="font-semibold text-yellow-700 mb-2">Pending Registration (${data.pendingStudents.length})</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    `;
                    
                    data.pendingStudents.forEach(student => {
                        contentHTML += `
                            <div class="border rounded-lg p-3 bg-yellow-50">
                                <div class="font-medium">${capitalize(student.studentName || student.name || 'Unknown')}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    Status: ${student.status || 'Pending'}
                                </div>
                                ${student.createdAt ? `
                                    <div class="text-xs text-gray-500 mt-1">
                                        Submitted: ${new Date(student.createdAt?.seconds * 1000).toLocaleDateString()}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    contentHTML += `</div></div>`;
                }
                
                contentHTML += `</div></div>`;
            }
            
            // Daily Academics Section
            if (data.dailyTopics.length > 0 || data.homeworkAssignments.length > 0) {
                contentHTML += `
                    <div class="bg-white border rounded-lg p-6 shadow-sm">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">üìö</span> Daily Academics
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                `;
                
                // Daily Topics
                if (data.dailyTopics.length > 0) {
                    const tutors = {};
                    const dates = new Set();
                    
                    data.dailyTopics.forEach(topic => {
                        const tutor = topic.tutorName || topic.tutorEmail || 'Unknown Tutor';
                        if (!tutors[tutor]) {
                            tutors[tutor] = { count: 0, dates: new Set() };
                        }
                        tutors[tutor].count++;
                        
                        if (topic.date) {
                            const date = new Date(topic.date?.seconds * 1000).toLocaleDateString();
                            dates.add(date);
                            tutors[tutor].dates.add(date);
                        }
                    });
                    
                    contentHTML += `
                        <div class="border rounded-lg p-4 bg-blue-50">
                            <h3 class="font-semibold text-blue-800 mb-3">Daily Topics (${data.dailyTopics.length})</h3>
                            <div class="space-y-3">
                    `;
                    
                    for (const [tutor, info] of Object.entries(tutors)) {
                        contentHTML += `
                            <div class="bg-white p-3 rounded border">
                                <div class="font-medium">${tutor}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    Sessions: ${info.count}
                                    ${info.dates.size > 0 ? `| Dates: ${info.dates.size} day(s)` : ''}
                                </div>
                                ${info.dates.size > 0 ? `
                                    <div class="text-xs text-gray-500 mt-2">
                                        Recent: ${Array.from(info.dates).slice(0, 3).join(', ')}
                                        ${info.dates.size > 3 ? '...' : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    contentHTML += `</div></div>`;
                } else {
                    contentHTML += `
                        <div class="border rounded-lg p-4 bg-blue-50">
                            <h3 class="font-semibold text-blue-800 mb-2">Daily Topics</h3>
                            <p class="text-gray-600">No daily topics found</p>
                        </div>
                    `;
                }
                
                // Homework Assignments
                if (data.homeworkAssignments.length > 0) {
                    const tutors = {};
                    const statusCount = { pending: 0, completed: 0, overdue: 0 };
                    
                    data.homeworkAssignments.forEach(hw => {
                        const tutor = hw.tutorName || hw.tutorEmail || 'Unknown Tutor';
                        if (!tutors[tutor]) {
                            tutors[tutor] = { count: 0, subjects: new Set() };
                        }
                        tutors[tutor].count++;
                        
                        if (hw.subject) tutors[tutor].subjects.add(hw.subject);
                        
                        // Count status
                        if (hw.status === 'completed') statusCount.completed++;
                        else if (hw.status === 'overdue') statusCount.overdue++;
                        else statusCount.pending++;
                    });
                    
                    contentHTML += `
                        <div class="border rounded-lg p-4 bg-green-50">
                            <h3 class="font-semibold text-green-800 mb-3">Homework Assignments (${data.homeworkAssignments.length})</h3>
                            <div class="mb-4">
                                <div class="flex justify-between text-sm mb-1">
                                    <span>Completed: ${statusCount.completed}</span>
                                    <span>Pending: ${statusCount.pending}</span>
                                    <span>Overdue: ${statusCount.overdue}</span>
                                </div>
                            </div>
                            <div class="space-y-3">
                    `;
                    
                    for (const [tutor, info] of Object.entries(tutors)) {
                        contentHTML += `
                            <div class="bg-white p-3 rounded border">
                                <div class="font-medium">${tutor}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    Assignments: ${info.count}
                                    ${info.subjects.size > 0 ? `| Subjects: ${info.subjects.size}` : ''}
                                </div>
                                ${info.subjects.size > 0 ? `
                                    <div class="text-xs text-gray-500 mt-2">
                                        Subjects: ${Array.from(info.subjects).slice(0, 3).join(', ')}
                                        ${info.subjects.size > 3 ? '...' : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    contentHTML += `</div></div>`;
                } else {
                    contentHTML += `
                        <div class="border rounded-lg p-4 bg-green-50">
                            <h3 class="font-semibold text-green-800 mb-2">Homework Assignments</h3>
                            <p class="text-gray-600">No homework assignments found</p>
                        </div>
                    `;
                }
                
                contentHTML += `</div></div>`;
            }
            
            // Assessment Reports
            if (data.assessmentResults.length > 0) {
                const studentsMap = new Map();
                
                data.assessmentResults.forEach(result => {
                    const studentName = result.studentName;
                    if (!studentsMap.has(studentName)) {
                        studentsMap.set(studentName, []);
                    }
                    studentsMap.get(studentName).push(result);
                });
                
                contentHTML += `
                    <div class="bg-white border rounded-lg p-6 shadow-sm">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">üìä</span> Assessment Reports (${data.assessmentResults.length})
                        </h2>
                        <div class="space-y-6">
                `;
                
                studentsMap.forEach((assessments, studentName) => {
                    const tutors = new Set();
                    const subjects = new Set();
                    const dates = new Set();
                    
                    assessments.forEach(assessment => {
                        if (assessment.tutorName || assessment.tutorEmail) {
                            tutors.add(assessment.tutorName || assessment.tutorEmail);
                        }
                        if (assessment.subject) subjects.add(assessment.subject);
                        if (assessment.submittedAt) {
                            const date = new Date(assessment.submittedAt.seconds * 1000).toLocaleDateString();
                            dates.add(date);
                        }
                    });
                    
                    contentHTML += `
                        <div class="border-l-4 border-blue-500 pl-4">
                            <h3 class="font-semibold text-blue-800">${capitalize(studentName)}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                                <div class="text-sm">
                                    <div class="font-medium">Assessments: ${assessments.length}</div>
                                    <div class="text-gray-600">Subjects: ${subjects.size}</div>
                                </div>
                                <div class="text-sm">
                                    <div class="font-medium">Tutors: ${tutors.size}</div>
                                    <div class="text-gray-600">${Array.from(tutors).slice(0, 2).join(', ')}${tutors.size > 2 ? '...' : ''}</div>
                                </div>
                                <div class="text-sm">
                                    <div class="font-medium">Dates: ${dates.size}</div>
                                    <div class="text-gray-600">${Array.from(dates).slice(0, 2).join(', ')}${dates.size > 2 ? '...' : ''}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                contentHTML += `</div></div>`;
            }
            
            // Monthly Reports
            if (data.monthlyResults.length > 0) {
                const studentsMap = new Map();
                
                data.monthlyResults.forEach(report => {
                    const studentName = report.studentName;
                    if (!studentsMap.has(studentName)) {
                        studentsMap.set(studentName, []);
                    }
                    studentsMap.get(studentName).push(report);
                });
                
                contentHTML += `
                    <div class="bg-white border rounded-lg p-6 shadow-sm">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">üìà</span> Monthly Reports (${data.monthlyResults.length})
                        </h2>
                        <div class="space-y-4">
                `;
                
                studentsMap.forEach((reports, studentName) => {
                    const tutors = new Set();
                    const months = new Set();
                    
                    reports.forEach(report => {
                        if (report.tutorName) tutors.add(report.tutorName);
                        if (report.submittedAt) {
                            const date = new Date(report.submittedAt.seconds * 1000);
                            months.add(`${date.getMonth() + 1}/${date.getFullYear()}`);
                        }
                    });
                    
                    contentHTML += `
                        <div class="border rounded-lg p-4 bg-green-50">
                            <h3 class="font-semibold text-green-800">${capitalize(studentName)}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                                <div class="text-sm">
                                    <div class="font-medium">Reports: ${reports.length}</div>
                                    <div class="text-gray-600">Tutors: ${tutors.size}</div>
                                </div>
                                <div class="text-sm">
                                    <div class="font-medium">Months Covered:</div>
                                    <div class="text-gray-600">${Array.from(months).join(', ')}</div>
                                </div>
                                <div class="text-sm">
                                    <div class="font-medium">Tutors:</div>
                                    <div class="text-gray-600">${Array.from(tutors).join(', ')}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                contentHTML += `</div></div>`;
            }
            
            // Referral Transactions
            if (data.referralTransactions.length > 0) {
                contentHTML += `
                    <div class="bg-white border rounded-lg p-6 shadow-sm">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">üí∞</span> Referral Transactions (${data.referralTransactions.length})
                        </h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Date</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Type</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Amount</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Status</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Referred To</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                data.referralTransactions.forEach(transaction => {
                    const date = transaction.timestamp ? 
                        new Date(transaction.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
                    
                    contentHTML += `
                        <tr>
                            <td class="px-4 py-2 text-sm">${date}</td>
                            <td class="px-4 py-2 text-sm">${transaction.type || 'N/A'}</td>
                            <td class="px-4 py-2 text-sm">${transaction.amount || '0'}</td>
                            <td class="px-4 py-2 text-sm">
                                <span class="px-2 py-1 rounded-full text-xs ${transaction.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${transaction.status || 'pending'}
                                </span>
                            </td>
                            <td class="px-4 py-2 text-sm">${transaction.referredTo || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                contentHTML += `</tbody></table></div></div>`;
            }
            
            // Backup Reports Summary
            const totalBackupReports = data.stats.backupReportsCount;
            if (totalBackupReports > 0) {
                contentHTML += `
                    <div class="bg-white border rounded-lg p-6 shadow-sm">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">üìÇ</span> Backup/Legacy Reports (${totalBackupReports})
                        </h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                `;
                
                for (const [collection, reports] of Object.entries(data.backupReports)) {
                    if (reports.length > 0) {
                        contentHTML += `
                            <div class="border rounded-lg p-3 bg-gray-50">
                                <div class="font-medium">${collection.replace('_', ' ')}</div>
                                <div class="text-sm text-gray-600 mt-1">${reports.length} report(s)</div>
                                <div class="text-xs text-gray-500 mt-2">
                                    ${reports[0].studentName ? `Students: ${new Set(reports.map(r => r.studentName)).size}` : ''}
                                </div>
                            </div>
                        `;
                    }
                }
                
                contentHTML += `</div></div>`;
            }
            
            // Collection Summary
            contentHTML += `
                <div class="bg-gray-50 border rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üìã Data Collection Summary</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>Parent Users:</span>
                            <span class="font-medium">1 <span class="collection-badge">parent_users</span></span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Students:</span>
                            <span class="font-medium">${data.stats.totalStudents} <span class="collection-badge">students/pending_students</span></span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Daily Topics:</span>
                            <span class="font-medium">${data.stats.totalDailyTopics} <span class="collection-badge">daily_topics</span></span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Homework:</span>
                            <span class="font-medium">${data.stats.totalHomework} <span class="collection-badge">homework_assignments</span></span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Assessment Reports:</span>
                            <span class="font-medium">${data.stats.totalAssessments} <span class="collection-badge">student_results</span></span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Monthly Reports:</span>
                            <span class="font-medium">${data.stats.totalMonthlyReports} <span class="collection-badge">tutor_submissions</span></span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Referrals:</span>
                            <span class="font-medium">${data.stats.totalReferrals} <span class="collection-badge">referral_transactions</span></span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Backup Reports:</span>
                            <span class="font-medium">${totalBackupReports} <span class="collection-badge">9 collections</span></span>
                        </div>
                    </div>
                </div>
            `;
            
            contentHTML += `</div>`;
            portalContent.innerHTML = contentHTML;
        }

        // ==================== MANAGE STUDENTS - COMPLETE IMPLEMENTATION ====================
        async function loadStudentsManagement() {
            hideAdminTools();
            showModal('studentsManagementModal');
            
            try {
                document.getElementById('studentsManagementContent').innerHTML = `
                    <div class="text-center py-8">
                        <div class="loading-spinner mx-auto" style="width: 40px; height: 40px;"></div>
                        <p class="text-green-600 font-semibold mt-4">Loading all students...</p>
                    </div>
                `;
                
                // Get all students from both collections
                const [activeStudents, pendingStudents] = await Promise.all([
                    db.collection('students').get(),
                    db.collection('pending_students').get()
                ]);
                
                const allStudents = [];
                
                activeStudents.forEach(doc => {
                    const student = doc.data();
                    allStudents.push({
                        id: doc.id,
                        collection: 'students',
                        status: 'Active',
                        ...student
                    });
                });
                
                pendingStudents.forEach(doc => {
                    const student = doc.data();
                    allStudents.push({
                        id: doc.id,
                        collection: 'pending_students',
                        status: 'Pending',
                        ...student
                    });
                });
                
                // Sort by student name
                allStudents.sort((a, b) => {
                    const nameA = a.studentName || a.name || '';
                    const nameB = b.studentName || b.name || '';
                    return nameA.localeCompare(nameB);
                });
                
                displayStudentsTable(allStudents);
                
            } catch (error) {
                document.getElementById('studentsManagementContent').innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <p>Error loading students: ${error.message}</p>
                    </div>
                `;
            }
        }

        function displayStudentsTable(students) {
            let html = `
                <div class="mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700">Total Students: ${students.length}</h3>
                            <p class="text-sm text-gray-600">Active: ${students.filter(s => s.status === 'Active').length} | 
                            Pending: ${students.filter(s => s.status === 'Pending').length}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="exportStudentsToCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                                üì§ Export CSV
                            </button>
                            <button onclick="findUnlinkedStudents()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
                                üîç Find Unlinked
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Student</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Grade/Age</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Parent Phone</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Linked Parent</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            if (students.length === 0) {
                html += `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            No students found in the system
                        </td>
                    </tr>
                `;
            } else {
                students.forEach((student, index) => {
                    const studentName = student.studentName || student.name || 'Unknown';
                    const parentPhone = student.parentPhone || 'Unlinked';
                    const parentEmail = student.parentEmail || '';
                    const grade = student.grade || student.class || 'N/A';
                    const age = student.age || 'N/A';
                    
                    // Check if parent exists
                    const isLinked = parentPhone !== 'Unlinked';
                    let linkedParentInfo = 'Not Found';
                    let linkedStatus = 'text-red-600';
                    
                    if (isLinked) {
                        linkedParentInfo = parentPhone;
                        linkedStatus = 'text-green-600';
                        if (parentEmail) {
                            linkedParentInfo += `<br><span class="text-xs text-gray-500">${parentEmail}</span>`;
                        }
                    }
                    
                    html += `
                        <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-blue-50">
                            <td class="px-4 py-3 text-sm">
                                <div class="font-medium text-gray-900">${capitalize(studentName)}</div>
                                <div class="text-xs text-gray-500">ID: ${student.id.substring(0, 8)}...</div>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${grade}</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs ml-1">Age: ${age}</span>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <span class="font-mono ${isLinked ? 'text-green-700' : 'text-red-700'}">
                                    ${parentPhone}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <span class="px-2 py-1 rounded-full text-xs ${student.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${student.status}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm ${linkedStatus}">
                                <div class="text-xs">${linkedParentInfo}</div>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <div class="flex space-x-1">
                                    <button onclick="viewStudentPortal('${student.id}', '${student.collection}')" 
                                            class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs hover:bg-blue-200">
                                        üëÅÔ∏è View
                                    </button>
                                    ${isLinked ? `
                                        <button onclick="viewParentByStudentPhone('${parentPhone}')" 
                                                class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs hover:bg-green-200">
                                            üë®‚Äçüë¶ Parent
                                        </button>
                                    ` : `
                                        <button onclick="linkStudentToParent('${student.id}', '${student.collection}')" 
                                                class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs hover:bg-red-200">
                                            üîó Link
                                        </button>
                                    `}
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 text-sm text-gray-600">
                    <p>üìä Summary: ${students.filter(s => s.parentPhone).length} linked to parents | 
                    ${students.filter(s => !s.parentPhone).length} unlinked</p>
                </div>
            `;
            
            document.getElementById('studentsManagementContent').innerHTML = html;
        }

        async function viewStudentPortal(studentId, collection) {
            try {
                const studentDoc = await db.collection(collection).doc(studentId).get();
                if (studentDoc.exists) {
                    const student = studentDoc.data();
                    const studentName = student.studentName || student.name || 'Student';
                    
                    let portalHTML = `
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h2 class="text-xl font-bold text-gray-800">${studentName} Portal</h2>
                                    <div class="mt-2 space-y-1">
                                        <p class="text-sm text-gray-600">ID: ${studentId}</p>
                                        <p class="text-sm text-gray-600">Collection: ${collection}</p>
                                        <p class="text-sm text-gray-600">Status: ${student.status || 'Active'}</p>
                                    </div>
                                </div>
                                <button onclick="hideModal('studentsManagementModal')" 
                                        class="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm">
                                    Close
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="border rounded-lg p-4">
                                    <h3 class="font-semibold text-gray-700 mb-3">Student Details</h3>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Name:</span>
                                            <span class="font-medium">${studentName}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Grade:</span>
                                            <span>${student.grade || student.class || 'N/A'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Age:</span>
                                            <span>${student.age || 'N/A'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Gender:</span>
                                            <span>${student.gender || 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="border rounded-lg p-4">
                                    <h3 class="font-semibold text-gray-700 mb-3">Parent Connection</h3>
                                    <div class="space-y-2">
                    `;
                    
                    if (student.parentPhone) {
                        portalHTML += `
                            <div class="flex justify-between">
                                <span class="text-gray-600">Phone:</span>
                                <span class="font-mono text-green-700">${student.parentPhone}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Email:</span>
                                <span>${student.parentEmail || 'N/A'}</span>
                            </div>
                            <div class="mt-4">
                                <button onclick="viewParentByStudentPhone('${student.parentPhone}')" 
                                        class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                                    üë®‚Äçüë¶ Go to Parent Portal
                                </button>
                            </div>
                        `;
                    } else {
                        portalHTML += `
                            <div class="text-center py-4">
                                <p class="text-red-600 font-semibold">‚ö†Ô∏è No Parent Linked</p>
                                <button onclick="linkStudentToParent('${studentId}', '${collection}')" 
                                        class="mt-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                                    üîó Link to Parent
                                </button>
                            </div>
                        `;
                    }
                    
                    portalHTML += `
                            </div>
                        </div>
                    </div>
                    
                    <!-- Student Submissions -->
                    <div class="mt-6">
                        <h3 class="font-semibold text-gray-700 mb-3">Recent Submissions</h3>
                        <div id="studentSubmissionsContent" class="text-center py-4">
                            <div class="loading-spinner-small mx-auto"></div>
                            <p class="text-gray-600 text-sm mt-2">Loading submissions...</p>
                        </div>
                    </div>
                </div>
            `;
                    
                    // Create a modal for student portal
                    const studentModal = document.createElement('div');
                    studentModal.className = 'modal';
                    studentModal.id = 'studentPortalModal';
                    studentModal.innerHTML = `
                        <div class="modal-content w-full max-w-4xl">
                            <div class="p-6">
                                ${portalHTML}
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(studentModal);
                    showModal('studentPortalModal');
                    
                    // Load student submissions
                    loadStudentSubmissions(studentName);
                }
            } catch (error) {
                showToast(`Error loading student: ${error.message}`, 'error');
            }
        }

        async function loadStudentSubmissions(studentName) {
            try {
                const contentDiv = document.getElementById('studentSubmissionsContent');
                if (!contentDiv) return;
                
                const collections = ['student_results', 'tutor_submissions', 'daily_topics', 'homework_assignments'];
                let totalSubmissions = 0;
                
                for (const collection of collections) {
                    try {
                        const query = await db.collection(collection)
                            .where('studentName', '==', studentName)
                            .limit(5)
                            .get();
                        
                        if (!query.empty) {
                            totalSubmissions += query.size;
                        }
                    } catch (error) {
                        // Collection might not exist or have studentName field
                    }
                }
                
                contentDiv.innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-blue-800 font-semibold">Found ${totalSubmissions} submissions</p>
                                <p class="text-blue-600 text-sm">Across ${collections.length} collections</p>
                            </div>
                            <button onclick="searchStudentNameGlobal('${studentName}')" 
                                    class="bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                üîç Search All Records
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.log('Error loading submissions:', error.message);
            }
        }

        async function viewParentByStudentPhone(phone) {
            if (!phone) {
                showToast('No parent phone found for this student', 'warning');
                return;
            }
            
            document.getElementById('adminParentPhone').value = phone;
            loadParentPortal();
            hideModal('studentPortalModal');
            hideModal('studentsManagementModal');
        }

        async function findUnlinkedStudents() {
            try {
                const allStudents = await getAllStudents();
                const unlinkedStudents = allStudents.filter(student => !student.parentPhone);
                
                if (unlinkedStudents.length === 0) {
                    showToast('All students are linked to parents!', 'success');
                    return;
                }
                
                // Create a modal to show unlinked students
                let modalHTML = `
                    <div class="modal-content w-full max-w-4xl">
                        <div class="p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">üîç Unlinked Students (${unlinkedStudents.length})</h2>
                            <div class="overflow-x-auto border rounded-lg">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-red-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-700 uppercase">Student</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-700 uppercase">Collection</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-700 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                unlinkedStudents.forEach(student => {
                    const studentName = student.studentName || student.name || 'Unknown';
                    modalHTML += `
                        <tr class="border-b hover:bg-red-50">
                            <td class="px-4 py-3 text-sm">
                                <div class="font-medium">${capitalize(studentName)}</div>
                                <div class="text-xs text-gray-500">ID: ${student.id.substring(0, 8)}...</div>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs">${student.collection}</span>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <button onclick="linkStudentToParent('${student.id}', '${student.collection}')" 
                                        class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                    üîó Link Now
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                modalHTML += `
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4">
                                <button onclick="bulkLinkUnlinkedStudents()" 
                                        class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">
                                    ‚ö° Bulk Link All Unlinked Students
                                </button>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="hideModal('unlinkedStudentsModal')" 
                                        class="bg-gray-600 text-white px-4 py-2 rounded-lg">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'unlinkedStudentsModal';
                modal.innerHTML = modalHTML;
                
                document.body.appendChild(modal);
                showModal('unlinkedStudentsModal');
                
            } catch (error) {
                showToast(`Error finding unlinked students: ${error.message}`, 'error');
            }
        }

        async function getAllStudents() {
            const [activeStudents, pendingStudents] = await Promise.all([
                db.collection('students').get(),
                db.collection('pending_students').get()
            ]);
            
            const allStudents = [];
            
            activeStudents.forEach(doc => {
                allStudents.push({
                    id: doc.id,
                    collection: 'students',
                    status: 'Active',
                    ...doc.data()
                });
            });
            
            pendingStudents.forEach(doc => {
                allStudents.push({
                    id: doc.id,
                    collection: 'pending_students',
                    status: 'Pending',
                    ...doc.data()
                });
            });
            
            return allStudents;
        }

        // ==================== PHONE FORMAT ANALYZER - COMPLETE IMPLEMENTATION ====================
        async function showPhoneFormatAnalyzer() {
            showModal('phoneFormatAnalyzerModal');
            
            const contentDiv = document.getElementById('phoneFormatAnalyzerContent');
            contentDiv.innerHTML = `
                <div class="text-center py-8">
                    <div class="loading-spinner mx-auto" style="width: 40px; height: 40px;"></div>
                    <p class="text-green-600 font-semibold mt-4">Analyzing phone formats across all collections...</p>
                </div>
            `;
            
            setTimeout(() => {
                analyzePhoneFormats();
            }, 100);
        }

        async function analyzePhoneFormats() {
            try {
                const contentDiv = document.getElementById('phoneFormatAnalyzerContent');
                
                // Get all parent users
                const parentsSnapshot = await db.collection('parent_users').get();
                
                let formatStats = {
                    total: 0,
                    goodFormats: 0,      // +234 format
                    riskyFormats: 0,     // 0xxx format
                    otherFormats: 0,     // 234xxx, etc.
                    invalidFormats: 0,
                    formatDetails: {
                        '+234': 0,
                        '0xxx': 0,
                        '234xxx': 0,
                        'xxxxxx': 0,
                        'invalid': 0
                    },
                    examples: {
                        good: [],
                        risky: [],
                        invalid: []
                    }
                };
                
                parentsSnapshot.forEach(doc => {
                    const parent = doc.data();
                    const phone = parent.phone || '';
                    const normalized = parent.normalizedPhone || '';
                    
                    formatStats.total++;
                    
                    // Analyze format
                    if (phone.startsWith('+234')) {
                        formatStats.goodFormats++;
                        formatStats.formatDetails['+234']++;
                        if (formatStats.examples.good.length < 3) {
                            formatStats.examples.good.push({
                                phone: phone,
                                name: parent.parentName || 'Unknown',
                                id: doc.id
                            });
                        }
                    } else if (phone.startsWith('0') && phone.length === 11) {
                        formatStats.riskyFormats++;
                        formatStats.formatDetails['0xxx']++;
                        if (formatStats.examples.risky.length < 3) {
                            formatStats.examples.risky.push({
                                phone: phone,
                                name: parent.parentName || 'Unknown',
                                id: doc.id
                            });
                        }
                    } else if (phone.startsWith('234') && phone.length === 13) {
                        formatStats.otherFormats++;
                        formatStats.formatDetails['234xxx']++;
                    } else if (phone.length >= 8 && phone.length <= 15 && /^\d+$/.test(phone)) {
                        formatStats.otherFormats++;
                        formatStats.formatDetails['xxxxxx']++;
                    } else {
                        formatStats.invalidFormats++;
                        formatStats.formatDetails['invalid']++;
                        if (formatStats.examples.invalid.length < 3 && phone) {
                            formatStats.examples.invalid.push({
                                phone: phone,
                                name: parent.parentName || 'Unknown',
                                id: doc.id
                            });
                        }
                    }
                });
                
                // Also check student records
                const studentsSnapshot = await db.collection('students').get();
                let studentPhoneStats = {
                    total: 0,
                    hasPhone: 0,
                    missingPhone: 0,
                    formatIssues: 0
                };
                
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    studentPhoneStats.total++;
                    
                    if (student.parentPhone) {
                        studentPhoneStats.hasPhone++;
                        const normalized = universalNormalizePhoneNumber(student.parentPhone);
                        if (normalized.length === 0 || !normalized[0].valid) {
                            studentPhoneStats.formatIssues++;
                        }
                    } else {
                        studentPhoneStats.missingPhone++;
                    }
                });
                
                // Display results
                let html = `
                    <div class="space-y-6">
                        <!-- Summary Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="text-2xl font-bold text-green-600">${formatStats.goodFormats}</div>
                                <div class="text-sm text-green-800">Good Formats (+234)</div>
                                <div class="text-xs text-green-600 mt-1">${((formatStats.goodFormats/formatStats.total)*100).toFixed(1)}% of total</div>
                            </div>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div class="text-2xl font-bold text-yellow-600">${formatStats.riskyFormats}</div>
                                <div class="text-sm text-yellow-800">Risky Formats (0xxx)</div>
                                <div class="text-xs text-yellow-600 mt-1">${((formatStats.riskyFormats/formatStats.total)*100).toFixed(1)}% of total</div>
                            </div>
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="text-2xl font-bold text-red-600">${formatStats.invalidFormats}</div>
                                <div class="text-sm text-red-800">Invalid Formats</div>
                                <div class="text-xs text-red-600 mt-1">${((formatStats.invalidFormats/formatStats.total)*100).toFixed(1)}% of total</div>
                            </div>
                        </div>
                        
                        <!-- Student Phone Stats -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h3 class="font-semibold text-blue-800 mb-3">üë®‚Äçüéì Student Phone Analysis</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <div class="text-lg font-bold text-blue-700">${studentPhoneStats.hasPhone}</div>
                                    <div class="text-sm text-blue-600">Students with Phone</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-red-700">${studentPhoneStats.missingPhone}</div>
                                    <div class="text-sm text-red-600">Missing Phone</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-yellow-700">${studentPhoneStats.formatIssues}</div>
                                    <div class="text-sm text-yellow-600">Format Issues</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Format Details -->
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-3">üìä Format Breakdown</h3>
                            <div class="space-y-4">
                `;
                
                // Format breakdown
                for (const [format, count] of Object.entries(formatStats.formatDetails)) {
                    if (count > 0) {
                        const percentage = ((count/formatStats.total)*100).toFixed(1);
                        let color = 'gray';
                        let bgColor = 'gray-100';
                        let textColor = 'gray-800';
                        
                        if (format === '+234') {
                            color = 'green';
                            bgColor = 'green-100';
                            textColor = 'green-800';
                        } else if (format === '0xxx') {
                            color = 'yellow';
                            bgColor = 'yellow-100';
                            textColor = 'yellow-800';
                        } else if (format === 'invalid') {
                            color = 'red';
                            bgColor = 'red-100';
                            textColor = 'red-800';
                        }
                        
                        html += `
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-medium">${format === '+234' ? '+234xxxxxxxxx' : 
                                                              format === '0xxx' ? '0xxxxxxxxxx' : 
                                                              format === '234xxx' ? '234xxxxxxxxx' : 
                                                              format === 'xxxxxx' ? 'xxxxxxxxxx' : 'Invalid'}</span>
                                    <span class="text-xs text-gray-500 ml-2">(${format})</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-48 bg-${bgColor} rounded-full h-2.5 mr-3">
                                        <div class="bg-${color}-600 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                    <span class="text-${textColor} font-medium">${count} (${percentage}%)</span>
                                </div>
                            </div>
                        `;
                    }
                }
                
                html += `
                            </div>
                        </div>
                        
                        <!-- Examples -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="border border-green-200 rounded-lg p-4">
                                <h4 class="font-semibold text-green-800 mb-2">‚úÖ Good Format Examples</h4>
                                <div class="space-y-2">
                `;
                
                if (formatStats.examples.good.length > 0) {
                    formatStats.examples.good.forEach(example => {
                        html += `
                            <div class="bg-green-50 p-2 rounded">
                                <div class="font-mono text-green-700">${example.phone}</div>
                                <div class="text-xs text-green-600">${example.name}</div>
                            </div>
                        `;
                    });
                } else {
                    html += `<p class="text-green-600 text-sm">No examples found</p>`;
                }
                
                html += `
                                </div>
                            </div>
                            
                            <div class="border border-yellow-200 rounded-lg p-4">
                                <h4 class="font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Risky Format Examples</h4>
                                <div class="space-y-2">
                `;
                
                if (formatStats.examples.risky.length > 0) {
                    formatStats.examples.risky.forEach(example => {
                        const normalized = universalNormalizePhoneNumber(example.phone);
                        const suggested = normalized.length > 0 && normalized[0].valid ? 
                            normalized[0].normalized : 'Cannot normalize';
                        
                        html += `
                            <div class="bg-yellow-50 p-2 rounded">
                                <div class="font-mono text-yellow-700">${example.phone}</div>
                                <div class="text-xs text-yellow-600">${example.name}</div>
                                <div class="text-xs text-green-600 mt-1">Suggested: ${suggested}</div>
                            </div>
                        `;
                    });
                } else {
                    html += `<p class="text-yellow-600 text-sm">No risky formats found</p>`;
                }
                
                html += `
                                </div>
                            </div>
                            
                            <div class="border border-red-200 rounded-lg p-4">
                                <h4 class="font-semibold text-red-800 mb-2">‚ùå Invalid Format Examples</h4>
                                <div class="space-y-2">
                `;
                
                if (formatStats.examples.invalid.length > 0) {
                    formatStats.examples.invalid.forEach(example => {
                        html += `
                            <div class="bg-red-50 p-2 rounded">
                                <div class="font-mono text-red-700">${example.phone || 'Empty'}</div>
                                <div class="text-xs text-red-600">${example.name}</div>
                                <button onclick="editParentPhone('${example.id}', '${example.phone || ''}')" 
                                        class="mt-1 text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">
                                    Fix
                                </button>
                            </div>
                        `;
                    });
                } else {
                    html += `<p class="text-red-600 text-sm">No invalid formats found</p>`;
                }
                
                html += `
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h4 class="font-semibold text-purple-800 mb-3">üöÄ Bulk Actions</h4>
                            <div class="flex flex-wrap gap-3">
                                <button onclick="fixAllRiskyFormats()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700">
                                    üîÑ Fix All Risky Formats (${formatStats.riskyFormats})
                                </button>
                                <button onclick="normalizeAllPhones()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                    ‚ö° Normalize All Phones (${formatStats.total})
                                </button>
                                <button onclick="generatePhoneReport()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    üìä Generate Report
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                contentDiv.innerHTML = html;
                
            } catch (error) {
                contentDiv.innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <p>Error analyzing phone formats: ${error.message}</p>
                    </div>
                `;
            }
        }

        function hidePhoneFormatAnalyzer() {
            hideModal('phoneFormatAnalyzerModal');
        }

        // ==================== MAIN PARENT PORTAL LOADER ====================
        async function loadParentPortal() {
            const searchInput = document.getElementById('adminParentPhone');
            const query = searchInput.value.trim();
            const searchBtn = document.getElementById('searchBtn');
            
            if (!query) {
                showError('Input Required', 'Please enter a phone number, email, or student name');
                return;
            }

            searchBtn.disabled = true;
            searchBtn.innerHTML = '<div class="loading-spinner-small mr-2"></div> Searching...';
            document.getElementById('adminLoader').classList.remove('hidden');
            document.getElementById('adminError').classList.add('hidden');
            document.getElementById('adminResultsArea').classList.add('hidden');
            document.getElementById('loadingDetails').textContent = `Searching for: ${query}`;

            try {
                // Use universal search
                const searchResult = await universalSearch(query);
                
                if (!searchResult || !searchResult.parent) {
                    // Check if we found student but no parent
                    if (searchResult && searchResult.foundStudent) {
                        throw new Error(`Found student "${searchResult.foundStudent.studentName}" but no parent account is linked. You may need to link a parent first.`);
                    }
                    
                    if (searchResult && searchResult.message) {
                        throw new Error(searchResult.message);
                    }
                    
                    throw new Error('No account found with that phone, email, or student name.');
                }

                // Load the parent portal
                await loadCompleteParentPortal(searchResult.parentId, searchResult.parent.phone || query, searchResult.parent);

            } catch (error) {
                console.error('Admin portal error:', error);
                showError('Search Failed', error.message);
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<span class="mr-2">üîç</span> View Parent Portal';
            }
        }

        // ==================== EXISTING ADMIN TOOLS FUNCTIONS ====================
        function showAdminTools() {
            loadSystemStats();
            showModal('adminToolsModal');
        }

        function hideAdminTools() {
            hideModal('adminToolsModal');
        }

        // Quick test function
        function testWithSampleData() {
            const sampleNumbers = [
                '08012345678',
                '2348012345678',
                '+2348012345678',
                '8012345678',
                '07012345678',
                '2347012345678'
            ];
            
            const randomNumber = sampleNumbers[Math.floor(Math.random() * sampleNumbers.length)];
            document.getElementById('adminParentPhone').value = randomNumber;
            
            showToast(`Testing with: ${randomNumber}`, 'info');
            loadParentPortal();
        }

        // Quick search functions
        async function searchRecentParents() {
            try {
                document.getElementById('loadingDetails').textContent = 'Loading recent parents...';
                document.getElementById('adminLoader').classList.remove('hidden');
                
                const recentParents = await db.collection('parent_users')
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .get();

                if (recentParents.empty) {
                    showError('No Parents Found', 'No parent accounts found in the system.');
                    return;
                }

                let parentsArray = [];
                recentParents.forEach(doc => {
                    parentsArray.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                displayParentList(parentsArray, 'Recent Parents', true);
                
            } catch (error) {
                showError('Search Failed', 'Error loading recent parents: ' + error.message);
            }
        }

        async function showAllParents() {
            try {
                document.getElementById('loadingDetails').textContent = 'Loading all parents...';
                document.getElementById('adminLoader').classList.remove('hidden');

                const allParents = await db.collection('parent_users').limit(50).get();

                if (allParents.empty) {
                    showError('No Parents', 'No parent accounts found in the system.');
                    return;
                }

                let parentsArray = [];
                allParents.forEach(doc => {
                    parentsArray.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                displayParentList(parentsArray, 'All Parents', true);

            } catch (error) {
                showError('Search Failed', 'Error loading all parents: ' + error.message);
            }
        }

        function displayParentList(parents, title, showActions = false) {
            let optionsHTML = `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">${title} (${parents.length})</h3>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
            `;
            
            parents.forEach(parent => {
                const isDefective = parent.issues && parent.issues.length > 0;
                const isDuplicate = parent.duplicateCount > 1;
                
                let badgeHTML = '';
                if (isDefective) {
                    badgeHTML = `<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full ml-2">Defective</span>`;
                }
                if (isDuplicate) {
                    badgeHTML += `<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full ml-2">Duplicate (${parent.duplicateCount})</span>`;
                }
                
                optionsHTML += `
                    <div class="border rounded-lg p-4 ${isDefective ? 'defective-account' : isDuplicate ? 'duplicate-account' : ''}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <strong class="text-gray-800">${parent.parentName || 'Unknown Name'}</strong>
                                ${badgeHTML}
                                <div class="text-sm text-gray-600 mt-1">
                                    üìû ${parent.phone}<br>
                                    üìß ${parent.email}
                                </div>
                                ${parent.issues ? `
                                    <div class="text-xs text-red-600 mt-2">
                                        <strong>Issues:</strong> ${parent.issues.join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                            ${showActions ? `
                                <div class="flex flex-col space-y-2 ml-4">
                                    <button onclick="editParentEmailPrompt('${parent.id}', '${parent.parentName || 'Unknown'}', '${parent.email}')" 
                                            class="bg-green-100 text-green-800 px-3 py-1 rounded text-sm hover:bg-green-200">
                                        ‚úèÔ∏è Edit Email
                                    </button>
                                    <button onclick="viewParentPortalById('${parent.id}')" 
                                            class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm hover:bg-blue-200">
                                        üëÅÔ∏è View Portal
                                    </button>
                                    <button onclick="deleteParentAccountPrompt('${parent.id}', '${parent.parentName || 'Unknown'}', '${parent.phone}', '${parent.email}')" 
                                            class="bg-red-100 text-red-800 px-3 py-1 rounded text-sm hover:bg-red-200">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            optionsHTML += '</div></div>';
            
            document.getElementById('adminLoader').classList.add('hidden');
            document.getElementById('adminResultsArea').innerHTML = optionsHTML;
            document.getElementById('adminResultsArea').classList.remove('hidden');
        }

        async function viewParentPortalById(userId) {
            try {
                const userDoc = await db.collection('parent_users').doc(userId).get();
                if (userDoc.exists) {
                    const parentUser = userDoc.data();
                    document.getElementById('adminParentPhone').value = parentUser.phone;
                    loadParentPortal();
                    hideModal('adminToolsModal');
                }
            } catch (error) {
                showToast('Error loading parent: ' + error.message, 'error');
            }
        }

        async function searchByStudentName() {
            const studentName = prompt('Enter student name to search:');
            if (!studentName) return;

            try {
                document.getElementById('loadingDetails').textContent = `Searching for student: ${studentName}`;
                document.getElementById('adminLoader').classList.remove('hidden');

                const assessmentSnapshot = await db.collection('student_results')
                    .where('studentName', '>=', studentName)
                    .where('studentName', '<=', studentName + '\uf8ff')
                    .limit(10)
                    .get();

                let parentPhones = new Set();
                
                assessmentSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.parentPhone) {
                        parentPhones.add(data.parentPhone);
                    }
                });

                const monthlySnapshot = await db.collection('tutor_submissions')
                    .where('studentName', '>=', studentName)
                    .where('studentName', '<=', studentName + '\uf8ff')
                    .limit(10)
                    .get();

                monthlySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.parentPhone) {
                        parentPhones.add(data.parentPhone);
                    }
                });

                if (parentPhones.size === 0) {
                    showError('No Results', `No parents found for student: ${studentName}`);
                    return;
                }

                let parentsArray = [];
                for (let phone of parentPhones) {
                    const parentQuery = await db.collection('parent_users')
                        .where('phone', '==', phone)
                        .limit(1)
                        .get();
                    
                    if (!parentQuery.empty) {
                        parentsArray.push({
                            id: parentQuery.docs[0].id,
                            ...parentQuery.docs[0].data()
                        });
                    }
                }

                displayParentList(parentsArray, `Parents for Student: ${studentName}`, true);

            } catch (error) {
                showError('Search Failed', 'Error searching by student name: ' + error.message);
            }
        }

        function sendTestNotification() {
            showToast('Test notification sent successfully!', 'success');
        }

        // Load system stats
        async function loadSystemStats() {
            try {
                const parentsSnapshot = await db.collection('parent_users').get();
                const studentsSnapshot = await db.collection('students').get();
                const totalParents = parentsSnapshot.size;
                const totalStudents = studentsSnapshot.size;
                
                let defectiveCount = 0;
                let duplicateCount = 0;
                
                parentsSnapshot.forEach(doc => {
                    const parent = doc.data();
                    if (!parent.normalizedPhone || !parent.phone || parent.phone.length < 8) {
                        defectiveCount++;
                    }
                });
                
                document.getElementById('systemStats').innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white p-3 rounded-lg border">
                            <div class="text-2xl font-bold text-blue-600">${totalParents}</div>
                            <div class="text-sm text-gray-600">Total Parents</div>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <div class="text-2xl font-bold text-green-600">${totalStudents}</div>
                            <div class="text-sm text-gray-600">Total Students</div>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <div class="text-2xl font-bold text-red-600">${defectiveCount}</div>
                            <div class="text-sm text-gray-600">Defective Accounts</div>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <div class="text-2xl font-bold text-purple-600">${totalParents - defectiveCount}</div>
                            <div class="text-sm text-gray-600">Healthy Accounts</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('systemStats').innerHTML = `<p class="text-red-600">Error loading statistics: ${error.message}</p>`;
            }
        }

        // ==================== EDIT PHONE FUNCTIONS ====================
        function editParentPhone(userId, currentPhone) {
            currentEditingUserId = userId;
            document.getElementById('currentPhone').value = currentPhone;
            document.getElementById('newPhone').value = '';
            document.getElementById('phoneValidation').classList.add('hidden');
            showModal('editPhoneModal');
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Admin Parent Viewer with Universal Search & Fix Tools');
            
            // Allow Enter key to search
            document.getElementById('adminParentPhone').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadParentPortal();
                }
            });
            
            // Show welcome message
            setTimeout(() => {
                showToast('üîó NEW: Student Connection Fixer added! Fix tutor-parent phone mismatches', 'info');
            }, 1000);
        });

        // Add admin badge
        function addAdminBadge() {
            const badge = document.createElement('div');
            badge.className = 'admin-badge';
            badge.textContent = 'ADMIN VIEW - CONNECTION FIXER';
            badge.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: #DC2626;
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            `;
            document.body.appendChild(badge);
        }

        // Initialize on load
        setTimeout(addAdminBadge, 500);

    </script>
</body>
</html>
