<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Portal | BKH LMS</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
if (window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<!-- Firebase SDK ‚Äî fixed: was 12.0.0 (does not exist), now 10.12.2 -->
<script type="module">
      import { auth, db } from './firebaseConfig-studentsignupmodular.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { collection, query, where, getDocs, doc, getDoc, updateDoc, addDoc, setDoc, orderBy, onSnapshot, Timestamp, limit }
        from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL }
        from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";
    window.firebaseModules = {
        auth, db, onAuthStateChanged, signOut, collection, query, where, getDocs,
        doc, getDoc, updateDoc, addDoc, setDoc, orderBy, onSnapshot, Timestamp, limit,
        getStorage, ref, uploadBytes, getDownloadURL
    };
</script>

<script>
tailwind.config = {
    theme: { extend: { colors: {
        brand: { light:'#d1fae5', primary:'#059669', dark:'#064e3b', accent:'#fbbf24' }
    }}}
}
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
body { font-family: 'Inter', sans-serif; }
.nav-item.active { background:#ecfdf5; color:#059669; border-right:4px solid #059669; }
.fade-in { animation: fadeIn 0.3s ease-in-out; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
.view-section { display:none; }
.view-section.active { display:block; }
#notif-dropdown { max-height:460px; overflow-y:auto; }
.notif-item { border-bottom:1px solid #f3f4f6; padding:10px 14px; font-size:.83rem; cursor:pointer; transition:background .15s; }
.notif-item:hover { background:#f0fdf4; }
.notif-item.unread { background:#eff6ff; border-left:3px solid #3b82f6; }
.notif-item.clickable:hover { background:#ecfdf5; }
.notif-badge { position:absolute; top:2px; right:2px; background:#ef4444; color:#fff;
    border-radius:999px; min-width:16px; height:16px; font-size:.65rem; font-weight:700;
    display:flex; align-items:center; justify-content:center; padding:0 3px; }
.chat-me { background:#059669; color:#fff; border-radius:16px 16px 4px 16px; padding:8px 12px; max-width:72%; margin-left:auto; font-size:.875rem; }
.chat-them { background:#fff; color:#1f2937; border:1px solid #e5e7eb; border-radius:16px 16px 16px 4px; padding:8px 12px; max-width:72%; font-size:.875rem; }
details > summary { list-style:none; cursor:pointer; user-select:none; }
details > summary::-webkit-details-marker { display:none; }
details[open] > summary .chev { transform:rotate(90deg); }
.chev { display:inline-block; transition:transform .2s; }
@keyframes spin { to{transform:rotate(360deg)} }
/* Annotation canvas styles */
.annot-toolbar {
    display:flex; align-items:center; gap:6px; flex-wrap:wrap;
    padding:8px 10px; background:#f8fafc;
    border-radius:10px; border:1px solid #e5e7eb; margin-bottom:10px;
    position:sticky; top:0; z-index:40;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
}
.annot-tool-btn { width:32px; height:32px; border-radius:8px; border:2px solid transparent; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:.75rem; transition:all .15s; }
.annot-tool-btn.active { border-color:#059669; background:#ecfdf5; color:#059669; }
.annot-tool-btn:not(.active) { background:#e5e7eb; color:#4b5563; }
.annot-tool-btn:hover:not(.active) { background:#d1d5db; }
.color-dot { width:20px; height:20px; border-radius:50%; cursor:pointer; border:3px solid transparent; transition:border-color .15s; flex-shrink:0; }
.color-dot.active { border-color:#059669; }
/* PDF annotate loading */
.annot-loading { text-align:center; padding:40px; color:#9ca3af; }
.annot-loading i { font-size:2rem; margin-bottom:10px; display:block; animation:spin 1s linear infinite; }
/* Select tool styles */
.annot-tool-btn[title="Select & Move"].active { border-color:#3b82f6; background:#eff6ff; color:#3b82f6; }
/* Inline text input overlay */
#annot-text-input-overlay {
    position:fixed; z-index:9999; display:none;
    background:#fff; border:2px solid #059669; border-radius:8px;
    box-shadow:0 4px 16px rgba(0,0,0,0.18); padding:4px;
    flex-direction:column; gap:4px; min-width:220px;
}
#annot-text-input-overlay.visible { display:flex; }
#annot-text-input-box {
    border:none; outline:none; font-family:'Inter',sans-serif;
    font-size:16px; font-weight:600; padding:6px 8px;
    resize:none; min-height:60px; width:100%; border-radius:4px;
    background:#f8fafc; color:#1f2937;
}
#annot-text-input-actions { display:flex; gap:4px; justify-content:flex-end; }
#annot-text-input-actions button { padding:4px 12px; border-radius:6px; font-size:.75rem; font-weight:600; cursor:pointer; border:none; }
#annot-text-ok  { background:#059669; color:#fff; }
#annot-text-ok:hover { background:#047857; }
#annot-text-cancel { background:#e5e7eb; color:#4b5563; }
#annot-text-cancel:hover { background:#d1d5db; }
/* Font size selector in toolbar */
.annot-font-size { width:44px; height:28px; border:1px solid #d1d5db; border-radius:6px; font-size:.75rem; background:#fff; cursor:pointer; text-align:center; }
/* Ws tab styles */
.ws-tab-btn { padding:10px 18px; font-size:.875rem; font-weight:600; border-bottom:2px solid transparent; transition:all .15s; cursor:pointer; background:none; border-left:none; border-right:none; border-top:none; }
.ws-tab-btn.active { color:#059669; border-bottom-color:#059669; }
.ws-tab-btn:not(.active) { color:#6b7280; }
.ws-tab-btn:not(.active):hover { color:#059669; }
/* Responsive workspace modal */
@media (max-width: 640px) {
    .ws-modal-container { max-width:100vw!important; width:100vw!important; height:100vh!important; max-height:100vh!important; border-radius:0!important; }
    .annot-toolbar { padding:6px 8px; gap:4px; }
    .annot-tool-btn { width:28px; height:28px; font-size:.65rem; }
}
@media (min-width: 641px) and (max-width: 1024px) {
    .ws-modal-container { max-width:92vw!important; width:92vw!important; }
}
/* Notif ring animation */
@keyframes bellRing { 0%,100%{transform:rotate(0)} 20%{transform:rotate(-15deg)} 40%{transform:rotate(15deg)} 60%{transform:rotate(-10deg)} 80%{transform:rotate(10deg)} }
.bell-ring { animation: bellRing 0.6s ease; }
</style>
</head>

<body class="bg-gray-50 text-gray-800 h-screen flex overflow-hidden">

<!-- SIDEBAR -->
<aside id="main-sidebar" class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col justify-between z-20 shadow-lg">
    <div>
        <div class="h-20 flex items-center px-8 border-b border-gray-100">
            <div class="h-10 w-10 bg-brand-primary rounded-lg flex items-center justify-center text-white font-bold text-xl mr-3">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <span class="text-xl font-bold text-gray-900">BKH Student Portal</span>
        </div>
        <nav class="mt-6 px-4 space-y-1">
            <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item active flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50">
                <i class="fas fa-th-large w-6"></i> Dashboard
            </a>
            <a href="#" onclick="switchTab('messages')" id="nav-messages" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50">
                <i class="fas fa-comments w-6"></i> Messages
                <span id="msg-badge" class="ml-auto hidden bg-brand-primary text-white text-xs rounded-full px-2 py-0.5">0</span>
            </a>
            <a href="#" onclick="switchTab('courses')" id="nav-courses" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50">
                <i class="fas fa-book w-6"></i> My Courses
            </a>
            <a href="#" onclick="switchTab('assignments')" id="nav-assignments" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50">
                <i class="fas fa-clipboard-list w-6"></i> Assignments
                <span id="pending-count" class="ml-auto bg-brand-accent text-white py-0.5 px-2 rounded-full text-xs font-bold">0</span>
            </a>
            <a href="#" onclick="switchTab('results')" id="nav-results" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50">
                <i class="fas fa-chart-line w-6"></i> Results
            </a>
            <a href="#" onclick="switchTab('calendar')" id="nav-calendar" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50">
                <i class="fas fa-calendar-alt w-6"></i> Schedule
            </a>
            <a href="#" onclick="switchTab('games')" id="nav-games" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50">
                <i class="fas fa-gamepad w-6"></i> Games
            </a>
        </nav>
    </div>
    <div class="p-4 border-t border-gray-100">
        <div id="profile-section" class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 border border-gray-200 cursor-pointer hover:bg-gray-100" onclick="toggleProfileMenu()">
            <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center">
                <i class="fas fa-user text-gray-500"></i>
            </div>
            <div class="flex-1">
                <p id="student-display-name" class="text-sm font-semibold text-gray-700">Loading...</p>
                <p id="student-grade-country" class="text-xs text-gray-500">--</p>
            </div>
            <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
        </div>
        <div id="profile-menu" class="hidden mt-2 bg-white border border-gray-200 rounded-lg shadow-lg">
            <button onclick="logout()" class="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 rounded-lg flex items-center">
                <i class="fas fa-sign-out-alt mr-2"></i> Logout
            </button>
        </div>
    </div>
</aside>

<!-- MOBILE HEADER -->
<div class="md:hidden fixed top-0 w-full bg-white z-30 border-b px-4 h-16 flex items-center justify-between shadow-sm">
    <div class="font-bold text-lg text-brand-primary">BKH Student Portal</div>
    <button class="text-gray-600" onclick="toggleMobileMenu()"><i class="fas fa-bars text-xl"></i></button>
</div>

<!-- MAIN -->
<main class="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-8 pt-20 md:pt-8 relative">

    <header class="flex justify-between items-start mb-8 gap-4 flex-wrap">
        <div>
            <h1 id="page-title" class="text-2xl font-bold text-gray-900">Dashboard Overview</h1>
            <p id="page-date" class="text-sm text-gray-500 mt-1">--</p>
        </div>
        <div class="flex items-center gap-3 flex-wrap justify-end">
            <div class="text-right hidden md:block">
                <div id="student-clock" class="text-sm font-semibold text-blue-700 bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-200 whitespace-nowrap">--</div>
                <div id="student-location" class="text-xs text-gray-400 mt-0.5">Detecting location...</div>
            </div>
            <div class="relative">
                <button id="bell-btn" onclick="toggleNotifications()" class="p-2 text-gray-400 hover:text-brand-primary relative">
                    <i class="fas fa-bell text-xl"></i>
                    <span id="notification-badge" class="notif-badge hidden">0</span>
                </button>
                <div id="notif-dropdown" class="hidden absolute right-0 top-10 w-80 bg-white border border-gray-200 rounded-xl shadow-xl z-50">
                    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
                        <span class="font-bold text-gray-800">Notifications</span>
                        <button onclick="markAllRead()" class="text-xs text-brand-primary hover:underline">Mark all read</button>
                    </div>
                    <div id="notif-list"><div class="text-center py-6 text-gray-400 text-sm"><i class="fas fa-spinner fa-spin mr-1"></i> Loading...</div></div>
                </div>
            </div>
        </div>
    </header>

    <!-- DASHBOARD -->
    <div id="view-dashboard" class="view-section active fade-in space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 relative overflow-hidden hover:shadow-md transition-all">
                <div class="absolute right-0 top-0 h-full w-1 bg-brand-primary"></div>
                <div class="flex justify-between items-start">
                    <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Attendance</p>
                    <h3 id="attendance-percent" class="text-2xl font-bold text-gray-800 mt-1">--</h3></div>
                    <div class="h-8 w-8 rounded-full bg-green-50 flex items-center justify-center text-green-600"><i class="fas fa-check"></i></div>
                </div>
                <p id="attendance-trend" class="text-xs text-green-600 mt-auto flex items-center"><i class="fas fa-arrow-up mr-1"></i> Calculating...</p>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 hover:shadow-md transition-all">
                <div class="flex justify-between items-start">
                    <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Pending Tasks</p>
                    <h3 id="pending-tasks-count" class="text-2xl font-bold text-gray-800 mt-1">0</h3></div>
                    <div class="h-8 w-8 rounded-full bg-yellow-50 flex items-center justify-center text-yellow-600"><i class="fas fa-clock"></i></div>
                </div>
                <p id="pending-due" class="text-xs text-gray-500 mt-auto">--</p>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 hover:shadow-md transition-all">
                <div class="flex justify-between items-start">
                    <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Avg Grade</p>
                    <h3 id="average-grade" class="text-2xl font-bold text-gray-800 mt-1">--</h3></div>
                    <div class="h-8 w-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-600"><i class="fas fa-star"></i></div>
                </div>
                <p id="grade-ranking" class="text-xs text-gray-500 mt-auto">Calculating rank...</p>
            </div>

            <div class="bg-brand-primary p-6 rounded-2xl shadow-lg shadow-emerald-200 text-white flex flex-col justify-between h-32 relative overflow-hidden">
                <div class="absolute -right-6 -bottom-6 text-white opacity-10 text-9xl"><i class="fas fa-graduation-cap"></i></div>
                <div>
                    <p class="text-xs font-bold text-emerald-100 uppercase tracking-wider">Next Live Class</p>
                    <h3 id="next-class-subject" class="text-base font-bold mt-1">Loading...</h3>
                    <p id="next-class-time" class="text-xs text-emerald-100 mt-0.5">--</p>
                </div>
                <p id="next-class-local" class="text-xs text-emerald-100 mt-1">Your local time: --</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800">Performance Overview</h3>
                    <select id="performance-period" class="text-xs bg-gray-50 border border-gray-200 rounded-lg text-gray-500 p-2">
                        <option value="month">This Month</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="h-64"><canvas id="performanceChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-4">Upcoming Schedule</h3>
                <div id="upcoming-schedule-list" class="space-y-3">
                    <div class="text-center py-8 text-gray-400"><i class="fas fa-calendar-alt text-3xl mb-2"></i><p>Loading...</p></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MESSAGES -->
    <div id="view-messages" class="view-section fade-in">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden" style="height:72vh;display:flex;">
            <div style="width:260px;min-width:220px;border-right:1px solid #e5e7eb;display:flex;flex-direction:column;background:#fafafa;flex-shrink:0;">
                <div style="padding:14px 16px;border-bottom:1px solid #e5e7eb;font-weight:700;font-size:1rem;color:#1f2937;">Messages</div>
                <div id="student-conv-list" style="flex:1;overflow-y:auto;"></div>
            </div>
            <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
                <div id="student-chat-header" style="padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#fff;font-weight:700;color:#1f2937;">Select a conversation</div>
                <div id="student-chat-messages" style="flex:1;overflow-y:auto;padding:14px 16px;background:#f9fafb;display:flex;flex-direction:column;gap:8px;">
                    <div style="text-align:center;color:#9ca3af;margin-top:40px;">Select a conversation to read messages</div>
                </div>
                <div id="student-chat-inputs" style="border-top:1px solid #e5e7eb;padding:10px 14px;background:#fff;display:none;gap:8px;align-items:flex-end;">
                    <textarea id="student-msg-input" rows="2" placeholder="Type a message..." style="flex:1;border:1px solid #d1d5db;border-radius:8px;padding:8px;resize:none;font-size:.875rem;"></textarea>
                    <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;">
                        <label style="cursor:pointer;font-size:1.2rem;text-align:center;" title="Attach image">
                            <input type="file" id="student-img-file" accept="image/*" style="display:none;">
                            üìé
                        </label>
                        <button id="student-send-btn" style="background:#059669;color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font-weight:700;">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- COURSES -->
    <div id="view-courses" class="view-section fade-in">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="courses-container">
            <div class="text-center col-span-3 py-12 text-gray-400">
                <i class="fas fa-book-open text-4xl mb-4"></i><h3 class="text-lg font-semibold mb-2">Loading Courses</h3><p>Fetching materials...</p>
            </div>
        </div>
    </div>

    <!-- ASSIGNMENTS -->
    <div id="view-assignments" class="view-section fade-in">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-gray-800">Assignments</h3>
                <div class="flex gap-3">
                    <button id="filter-all"       onclick="filterAssignments('all')"       class="text-xs font-medium text-brand-primary border-b-2 border-brand-primary pb-0.5">All</button>
                    <button id="filter-pending"   onclick="filterAssignments('pending')"   class="text-xs font-medium text-gray-500 hover:text-brand-primary">Pending</button>
                    <button id="filter-submitted" onclick="filterAssignments('submitted')" class="text-xs font-medium text-gray-500 hover:text-brand-primary">Submitted</button>
                    <button id="filter-graded"    onclick="filterAssignments('graded')"    class="text-xs font-medium text-gray-500 hover:text-brand-primary">Graded</button>
                </div>
            </div>
            <div id="assignments-list" class="p-4 space-y-3">
                <div class="p-8 text-center text-gray-400"><i class="fas fa-clipboard-list text-3xl mb-3"></i><p>Loading assignments...</p></div>
            </div>
        </div>
    </div>

    <!-- RESULTS -->
    <div id="view-results" class="view-section fade-in">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <h3 class="font-bold text-gray-800 mb-6">Academic Results</h3>
            <div id="results-container">
                <div class="text-center py-8 text-gray-400"><i class="fas fa-chart-line text-3xl mb-3"></i><p>Loading results...</p></div>
            </div>
        </div>
    </div>

    <!-- SCHEDULE -->
    <div id="view-calendar" class="view-section fade-in">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <h3 class="font-bold text-gray-800 mb-6">Class Schedule</h3>
            <div id="full-schedule-container">
                <div class="text-center py-8 text-gray-400"><i class="fas fa-calendar text-3xl mb-3"></i><p>Loading schedule...</p></div>
            </div>
        </div>
    </div>

    <!-- GAMES -->
    <div id="view-games" class="view-section fade-in">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-800">Educational Games</h3>
                <button id="show-leaderboard" onclick="toggleLeaderboard()" class="text-sm text-brand-primary font-semibold hover:text-brand-dark">
                    <i class="fas fa-trophy mr-1"></i> Leaderboard
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="games-container">
                <div class="text-center py-8 text-gray-400 col-span-3"><i class="fas fa-gamepad text-3xl mb-3"></i><p>Loading games...</p></div>
            </div>
            <div id="leaderboard-container" class="hidden">
                <h4 class="font-bold text-gray-700 mb-4">Top Performers</h4>
                <div id="leaderboard-content" class="bg-gray-50 rounded-xl p-4"></div>
            </div>
        </div>
    </div>

</main>

<script type="module">
document.addEventListener('DOMContentLoaded', async () => {

// ‚îÄ‚îÄ Wait for Firebase modules (max 5s) ‚îÄ‚îÄ
await new Promise(r => { const t=setInterval(()=>{if(window.firebaseModules){clearInterval(t);r();}},50); setTimeout(()=>{clearInterval(t);r();},5000); });

const { auth,db,onAuthStateChanged,signOut,collection,query,where,getDocs,doc,getDoc,
        updateDoc,addDoc,setDoc,orderBy,onSnapshot,Timestamp,limit,getStorage,ref,uploadBytes,getDownloadURL }
    = window.firebaseModules || {};

if (!auth) { document.body.innerHTML = '<div style="padding:40px;text-align:center;color:red;font-size:1.2rem;">‚ö†Ô∏è Firebase failed to load. Check firebaseConfig file and internet connection.</div>'; return; }

const CLOUDINARY = { cloudName:'dwjq7j5zp', preset:'tutor_homework' };
let performanceChart       = null;
let _perfListenerAttached  = false;
let allAssignments         = [];
let studentUnsubChat       = null;
let studentUnsubInbox      = null;
let _notifUnsubscribers    = [];
let _notifData             = { pending: 0, pendingDocs: [], messages: 0, materials: [], convs: [] };
let _notifLoaded           = false;
let _prevNotifTotal        = 0;
const _annotState          = window._annotState = {};
const _resizeObservers     = window._resizeObservers = {};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ NOTIFICATION SOUNDS (Web Audio API) ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function playNotifSound(type) {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const master = ctx.createGain();
        master.gain.value = 0.35;
        master.connect(ctx.destination);

        if (type === 'message') {
            // Friendly two-tone ascending ping
            [[660, 0], [880, 0.18]].forEach(([freq, delay]) => {
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.connect(g); g.connect(master);
                osc.type = 'sine'; osc.frequency.value = freq;
                g.gain.setValueAtTime(0, ctx.currentTime + delay);
                g.gain.linearRampToValueAtTime(0.8, ctx.currentTime + delay + 0.02);
                g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + 0.35);
                osc.start(ctx.currentTime + delay);
                osc.stop(ctx.currentTime + delay + 0.35);
            });
        } else if (type === 'assignment') {
            // Three-note alert: C5, E5, G5
            [[523, 0], [659, 0.2], [784, 0.4]].forEach(([freq, delay]) => {
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.connect(g); g.connect(master);
                osc.type = 'triangle'; osc.frequency.value = freq;
                g.gain.setValueAtTime(0, ctx.currentTime + delay);
                g.gain.linearRampToValueAtTime(0.9, ctx.currentTime + delay + 0.02);
                g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + 0.28);
                osc.start(ctx.currentTime + delay);
                osc.stop(ctx.currentTime + delay + 0.28);
            });
        } else {
            // Single soft chime for general/material
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.connect(g); g.connect(master);
            osc.type = 'sine'; osc.frequency.value = 528;
            g.gain.setValueAtTime(0, ctx.currentTime);
            g.gain.linearRampToValueAtTime(0.7, ctx.currentTime + 0.03);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.6);
            osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.6);
        }
    } catch(e) { /* AudioContext blocked ‚Äî silent */ }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function escH(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a; }

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
function startClock(){
    const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
    const el=document.getElementById('student-clock');
    const loc=document.getElementById('student-location');
    if(loc) loc.textContent='üìç '+tz.replace(/_/g,' ');
    function tick(){
        if(el) el.textContent=new Intl.DateTimeFormat('en-US',{weekday:'short',day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true,timeZone:tz}).format(new Date());
    }
    tick(); setInterval(tick,1000);
}
startClock();
document.getElementById('page-date').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

// ‚îÄ‚îÄ TAB SWITCH (fixed: auto-close mobile menu) ‚îÄ‚îÄ
window.switchTab = (tab) => {
    document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active'));
    const v=document.getElementById('view-'+tab);
    if(v) v.classList.add('active');
    document.querySelectorAll('.nav-item').forEach(el=>{el.classList.remove('active','text-brand-primary');el.classList.add('text-gray-600');});
    const nav=document.getElementById('nav-'+tab);
    if(nav) nav.classList.add('active');
    const titles={dashboard:'Dashboard Overview',messages:'Messages',courses:'My Courses',assignments:'Assignments',results:'Academic Results',calendar:'Class Schedule',games:'Educational Games'};
    document.getElementById('page-title').textContent=titles[tab]||'Portal';
    // Auto-close mobile sidebar on nav
    if(window.innerWidth < 768) closeMobileMenu();
};

function closeMobileMenu(){
    const s=document.getElementById('main-sidebar');
    if(!s) return;
    s.classList.add('hidden');
    s.classList.remove('flex','fixed','inset-0','z-40');
}
window.toggleMobileMenu=()=>{
    const s=document.getElementById('main-sidebar');
    s.classList.toggle('hidden');
    s.classList.toggle('flex');
    s.classList.toggle('fixed');
    s.classList.toggle('inset-0');
    s.classList.toggle('z-40');
};
window.toggleProfileMenu=()=>document.getElementById('profile-menu').classList.toggle('hidden');
// Fixed: redirect to login page (update path if your login page differs)
window.logout=async()=>{
    try{await signOut(auth); window.location.href='studentsignup.html';}
    catch(e){alert('Logout error: '+e.message);}
};

document.addEventListener('click',e=>{
    const pm=document.getElementById('profile-menu');const ps=document.getElementById('profile-section');
    if(pm&&ps&&!ps.contains(e.target)&&!pm.contains(e.target)) pm.classList.add('hidden');
    const nd=document.getElementById('notif-dropdown');const bb=document.getElementById('bell-btn');
    if(nd&&bb&&!nd.contains(e.target)&&!bb.contains(e.target)) nd.classList.add('hidden');
});

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
onAuthStateChanged(auth, async user => {
    if(!user){window.location.href='studentsignup.html';return;}
    await initStudent(user);
});

async function initStudent(user){
    try{
        let snap=await getDocs(query(collection(db,'students'),where('studentUid','==',user.uid)));
        if(snap.empty) snap=await getDocs(query(collection(db,'students'),where('email','==',user.email)));
        if(snap.empty){document.getElementById('student-grade-country').textContent='Profile not found';return;}
        buildStudentGlobal(snap.docs[0],user);
        await loadAll();
    }catch(e){console.error('initStudent',e);}
}

function buildStudentGlobal(studentDoc, user){
    const d=studentDoc.data();
    document.getElementById('student-display-name').textContent=d.studentName||user.displayName||'Student';
    document.getElementById('student-grade-country').textContent=`${d.grade||'--'} ¬∑ ${d.country||'--'}`;
    window.currentStudent={
        uid:user.uid, id:studentDoc.id,
        name:d.studentName||user.displayName||'Student',
        email:d.email||user.email,
        grade:d.grade||'',
        country:d.country||'',
        subjects:d.subjects||[],
        tutorEmail:d.assignedTutor||d.tutorEmail||'',
        tutorId:d.tutorId||'',
        tutorName:d.tutorName||'',
        schedule:d.schedule||[]
    };
}

async function loadAll(){
    await Promise.allSettled([
        loadAttendance(),
        loadPendingTasks(),
        loadAverageGrade(),
        loadNextClass(),
        loadUpcomingSchedule(),
        loadPerformanceChart(),
        loadCourses(),
        loadAssignments(),
        loadResults(),
        loadSchedule(),
        loadGames(),
        initMessaging()
    ]);
    // Start real-time notifications AFTER other data is loaded
    initRealtimeNotifications();
}

// ‚îÄ‚îÄ ATTENDANCE ‚îÄ‚îÄ
async function loadAttendance(){
    try{
        const snap=await getDocs(query(collection(db,'homework_assignments'),where('studentId','==',window.currentStudent.id)));
        const total=snap.size;
        const done=snap.docs.filter(d=>['graded','submitted'].includes(d.data().status)).length;
        const pct=total>0?Math.round((done/total)*100):100;
        document.getElementById('attendance-percent').textContent=pct+'%';
        const trendEl=document.getElementById('attendance-trend');
        trendEl.innerHTML=`<i class="fas fa-arrow-${pct>=80?'up':'down'} mr-1"></i>${pct>=90?'Excellent attendance':pct>=75?'Good attendance':'Needs improvement'}`;
        trendEl.className=`text-xs ${pct>=80?'text-green-600':pct>=60?'text-yellow-600':'text-red-600'} mt-auto flex items-center`;
    }catch(e){console.error(e);}
}

// ‚îÄ‚îÄ PENDING TASKS ‚îÄ‚îÄ
async function loadPendingTasks(){
    try{
        const snap=await getDocs(query(collection(db,'homework_assignments'),where('studentId','==',window.currentStudent.id),where('status','in',['assigned','pending'])));
        document.getElementById('pending-tasks-count').textContent=snap.size;
        document.getElementById('pending-count').textContent=snap.size;
        const now=new Date();let due48=0;
        snap.forEach(d=>{const dd=new Date(d.data().dueDate||'');if(!isNaN(dd)&&(dd-now)/3600000<=48)due48++;});
        const el=document.getElementById('pending-due');
        el.textContent=due48>0?`${due48} due within 48 hrs`:'No immediate deadlines';
        el.className=`text-xs ${due48>0?'text-red-500':'text-gray-500'} mt-auto`;
    }catch(e){console.error(e);}
}

// ‚îÄ‚îÄ AVERAGE GRADE ‚îÄ‚îÄ
async function loadAverageGrade(){
    try{
        const mySnap=await getDocs(query(collection(db,'homework_assignments'),where('studentId','==',window.currentStudent.id),where('status','==','graded')));
        if(mySnap.empty){document.getElementById('average-grade').textContent='--';document.getElementById('grade-ranking').textContent='No grades yet';return;}
        let myTotal=0,myCount=0;
        mySnap.forEach(d=>{const s=parseFloat(d.data().score);if(!isNaN(s)){myTotal+=s;myCount++;}});
        const myAvg=myCount>0?Math.round(myTotal/myCount):0;
        const letter=myAvg>=90?'A':myAvg>=80?'B+':myAvg>=70?'B':myAvg>=60?'C+':myAvg>=50?'C':'F';
        document.getElementById('average-grade').textContent=`${myAvg}% (${letter})`;
        // Peer comparison ‚Äî batch-limited to avoid N+1 overload
        const grade=window.currentStudent.grade;
        if(grade){
            const peerStudents=await getDocs(query(collection(db,'students'),where('grade','==',grade)));
            // Limit to 8 peers to reduce reads
            const peerIds=peerStudents.docs.map(d=>d.id).filter(id=>id!==window.currentStudent.id).slice(0,8);
            let peerTotal=0,peerCount=0;
            for(const pid of peerIds){
                const ps=await getDocs(query(collection(db,'homework_assignments'),where('studentId','==',pid),where('status','==','graded')));
                ps.forEach(d=>{const s=parseFloat(d.data().score);if(!isNaN(s)){peerTotal+=s;peerCount++;}});
            }
            const rankEl=document.getElementById('grade-ranking');
            if(peerCount>0){
                const pAvg=Math.round(peerTotal/peerCount);
                const diff=myAvg-pAvg;
                rankEl.textContent=(diff>=0?'+':'')+diff+'% vs grade average ('+pAvg+'%)';
                rankEl.className=`text-xs ${diff>=0?'text-green-600':'text-red-500'} mt-auto`;
            } else {
                rankEl.textContent='Only student in this grade';
            }
        }
    }catch(e){console.error(e);}
}

// ‚îÄ‚îÄ TIME HELPERS ‚îÄ‚îÄ
function formatSlotTime(t){
    if(!t)return'';
    const[h,m]=t.split(':').map(Number);
    return (h%12||12)+':'+(m<10?'0':'')+m+' '+(h>=12?'PM':'AM');
}
function watSlotToLocal(day,startStr){
    const DAYS=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const watNow=new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Lagos'}));
    const todayIdx=watNow.getDay();const targetIdx=DAYS.indexOf(day);
    if(targetIdx===-1)return null;
    let ahead=targetIdx-todayIdx;
    if(ahead<0)ahead+=7;
    if(ahead===0){
        const[h,m]=startStr.split(':').map(Number);
        if(watNow.getHours()>h||(watNow.getHours()===h&&watNow.getMinutes()>=m))ahead=7;
    }
    const[h,m]=startStr.split(':').map(Number);
    const watDate=new Date(watNow);watDate.setDate(watNow.getDate()+ahead);watDate.setHours(h,m,0,0);
    return new Date(watDate.getTime()-3600000); // WAT=UTC+1
}

// ‚îÄ‚îÄ NEXT CLASS (fixed: shows day + time, not just day name) ‚îÄ‚îÄ
async function loadNextClass(){
    try{
        const schedule=window.currentStudent.schedule||[];
        if(!schedule.length){
            document.getElementById('next-class-subject').textContent='No schedule set';
            document.getElementById('next-class-time').textContent='Contact your tutor';
            return;
        }
        let soonest=null,soonestMs=Infinity;
        schedule.forEach(slot=>{
            const u=watSlotToLocal(slot.day,slot.start);
            if(u&&u.getTime()<soonestMs){soonestMs=u.getTime();soonest={slot,utc:u};}
        });
        if(!soonest)return;
        // Show subject if available, otherwise show day + "Live Class"
        const subjectLabel = soonest.slot.subject || ('Live Class ¬∑ ' + soonest.slot.day);
        document.getElementById('next-class-subject').textContent = subjectLabel;
        document.getElementById('next-class-time').textContent=`${formatSlotTime(soonest.slot.start)} ‚Äì ${formatSlotTime(soonest.slot.end)} (WAT)`;
        document.getElementById('next-class-local').textContent=
            'Your time: '+soonest.utc.toLocaleString([],{weekday:'short',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:true});
    }catch(e){console.error(e);}
}

// ‚îÄ‚îÄ UPCOMING SCHEDULE ‚îÄ‚îÄ
async function loadUpcomingSchedule(){
    const c=document.getElementById('upcoming-schedule-list');
    try{
        const schedule=window.currentStudent.schedule||[];
        if(!schedule.length){c.innerHTML='<p class="text-gray-500 text-sm">No schedule set.</p>';return;}
        const items=schedule.map(slot=>{const u=watSlotToLocal(slot.day,slot.start);return{...slot,utc:u};})
            .filter(s=>s.utc).sort((a,b)=>a.utc-b.utc).slice(0,4);
        c.innerHTML=items.map(s=>`
        <div class="flex items-start gap-4 pb-4 border-b border-gray-50 last:border-0 last:pb-0">
            <div class="flex flex-col items-center justify-center bg-gray-50 rounded-lg h-12 w-12 text-gray-500 flex-shrink-0">
                <span class="text-xs font-bold uppercase">${s.utc.toLocaleString('en-US',{month:'short'})}</span>
                <span class="text-lg font-bold text-gray-800">${s.utc.getDate()}</span>
            </div>
            <div>
                <h4 class="text-sm font-bold text-gray-800">${escH(s.subject||s.day)}</h4>
                <p class="text-xs text-gray-500 mt-0.5">${formatSlotTime(s.start)} ‚Äì ${formatSlotTime(s.end)} WAT</p>
                <p class="text-xs text-blue-500 mt-0.5">Local: ${s.utc.toLocaleString([],{hour:'2-digit',minute:'2-digit',hour12:true})}</p>
            </div>
        </div>`).join('')||'<p class="text-gray-500 text-sm">No upcoming classes.</p>';
    }catch(e){console.error(e);}
}

// ‚îÄ‚îÄ PERFORMANCE CHART (fixed: no duplicate listeners) ‚îÄ‚îÄ
async function loadPerformanceChart(){
    try{
        const snap=await getDocs(query(collection(db,'homework_assignments'),where('studentId','==',window.currentStudent.id),where('status','==','graded'),orderBy('gradedAt','asc')));
        window._allGradedSnap=snap.docs;
        renderChart(snap.docs);
        if(!_perfListenerAttached){
            _perfListenerAttached=true;
            document.getElementById('performance-period').addEventListener('change',e=>{
                const period=e.target.value,now=new Date();
                const filtered=(window._allGradedSnap||[]).filter(d=>{
                    const a=d.data();const date=a.gradedAt?.toDate?a.gradedAt.toDate():new Date(a.gradedAt||0);
                    return period==='month'?(date.getMonth()===now.getMonth()&&date.getFullYear()===now.getFullYear()):true;
                });
                renderChart(filtered);
            });
        }
    }catch(e){console.error(e);}
}

function renderChart(docs){
    const labels=[],scores=[],bySubject={};
    docs.forEach(d=>{
        const a=d.data();const s=parseFloat(a.score);if(isNaN(s))return;
        const date=a.gradedAt?.toDate?a.gradedAt.toDate():new Date(a.gradedAt||0);
        labels.push(date.toLocaleDateString('en-US',{month:'short',day:'numeric'}));
        scores.push(s);
        const sub=a.subject||'General';
        if(!bySubject[sub])bySubject[sub]=[];
        bySubject[sub].push(s);
    });
    const canvasEl=document.getElementById('performanceChart');
    if(!canvasEl)return;
    const ctx=canvasEl.getContext('2d');
    if(performanceChart){performanceChart.destroy();performanceChart=null;}
    if(!scores.length){
        ctx.clearRect(0,0,canvasEl.offsetWidth||400,canvasEl.offsetHeight||256);
        ctx.fillStyle='#9ca3af';ctx.font='14px Inter,sans-serif';
        ctx.textAlign='center';
        ctx.fillText('No graded results yet',(canvasEl.offsetWidth||400)/2,(canvasEl.offsetHeight||256)/2);
        return;
    }
    const colours=['#059669','#3b82f6','#f59e0b','#ef4444','#8b5cf6'];
    const subjectEntries=Object.entries(bySubject);let datasets;
    if(subjectEntries.length>1){
        datasets=subjectEntries.map(([sub,vals],i)=>{
            let vi=0;
            const data=labels.map((_,li)=>{
                const d=docs[li]?.data();if(!d)return null;
                return(d.subject||'General')===sub?vals[vi++]||null:null;
            });
            return{label:sub,data,borderColor:colours[i%colours.length],backgroundColor:'transparent',tension:0.4,spanGaps:true,pointRadius:4,pointBackgroundColor:colours[i%colours.length]};
        });
    } else {
        datasets=[{label:'Score (%)',data:scores,borderColor:'#059669',backgroundColor:'rgba(5,150,105,0.1)',tension:0.4,fill:true,pointRadius:5,pointBackgroundColor:'#059669',pointHoverRadius:7}];
    }
    performanceChart=new Chart(ctx,{
        type:'line',data:{labels,datasets},
        options:{
            responsive:true,maintainAspectRatio:false,
            interaction:{mode:'index',intersect:false},
            plugins:{
                legend:{position:'bottom',labels:{font:{family:'Inter',size:12},padding:16}},
                tooltip:{backgroundColor:'rgba(15,23,42,0.85)',titleFont:{family:'Inter',size:12},bodyFont:{family:'Inter',size:12},callbacks:{label:ctx=>`${ctx.dataset.label}: ${ctx.parsed.y}%`}}
            },
            scales:{
                y:{beginAtZero:false,min:0,max:100,grid:{color:'#f3f4f6'},ticks:{callback:v=>v+'%',font:{family:'Inter',size:11}}},
                x:{grid:{display:false},ticks:{font:{family:'Inter',size:11},maxRotation:30}}
            }
        }
    });
}

// ‚îÄ‚îÄ COURSES ‚îÄ‚îÄ
async function loadCourses(){
    const c=document.getElementById('courses-container');
    try{
        const snap=await getDocs(query(collection(db,'course_materials'),where('studentId','==',window.currentStudent.id),orderBy('uploadedAt','desc')));
        if(snap.empty){c.innerHTML='<div class="col-span-3 text-center py-12 text-gray-400"><i class="fas fa-book-open text-4xl mb-4"></i><p>No course materials yet.</p></div>';return;}
        const ICONS={'pdf':'üìÑ','jpg':'üñºÔ∏è','jpeg':'üñºÔ∏è','png':'üñºÔ∏è','gif':'üñºÔ∏è','ppt':'üìä','pptx':'üìä','doc':'üìù','docx':'üìù','xls':'üìä','xlsx':'üìä'};
        const COLORS=['from-emerald-500 to-teal-400','from-blue-500 to-cyan-400','from-purple-500 to-pink-400','from-orange-500 to-amber-400','from-red-500 to-rose-400'];
        c.innerHTML=snap.docs.map((d,i)=>{
            const m=d.data();
            const date=m.uploadedAt?.toDate?m.uploadedAt.toDate().toLocaleDateString():'';
            const ext=(m.fileName||'').split('.').pop().toLowerCase();
            const icon=ICONS[ext]||'üìÅ';
            return `
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-all">
                <div class="h-36 bg-gradient-to-br ${COLORS[i%COLORS.length]} flex items-center justify-center text-5xl">${icon}</div>
                <div class="p-4">
                    <h3 class="font-bold text-gray-800 mb-1 truncate">${escH(m.title)}</h3>
                    ${m.description?`<p class="text-xs text-gray-500 mb-3 line-clamp-2">${escH(m.description)}</p>`:''}
                    <div class="flex items-center justify-between mt-2">
                        <span class="text-xs text-gray-400">${escH(date)}</span>
                        <a href="${escH(m.fileUrl||'#')}" target="_blank" rel="noopener noreferrer"
                           class="px-3 py-1.5 bg-brand-primary text-white text-xs font-bold rounded-lg hover:bg-brand-dark">
                            Open <i class="fas fa-external-link-alt ml-1"></i>
                        </a>
                    </div>
                </div>
            </div>`;
        }).join('');
    }catch(e){console.error(e);c.innerHTML='<div class="col-span-3 text-center py-12 text-red-400">Error loading courses.</div>';}
}

// ‚îÄ‚îÄ ASSIGNMENTS ‚îÄ‚îÄ
async function loadAssignments(){
    const c=document.getElementById('assignments-list');
    try{
        const snap=await getDocs(query(collection(db,'homework_assignments'),where('studentId','==',window.currentStudent.id),orderBy('assignedDate','desc')));
        if(snap.empty){c.innerHTML='<div class="text-center py-8 text-gray-400">No assignments yet.</div>';return;}
        allAssignments=snap.docs.map(d=>({id:d.id,...d.data()}));
        renderAssignments(allAssignments);
    }catch(e){console.error(e);}
}

// Fixed: added 'submitted' filter
window.filterAssignments=(f)=>{
    ['all','pending','submitted','graded'].forEach(x=>{
        const btn=document.getElementById('filter-'+x);
        if(btn) btn.className=x===f
            ?'text-xs font-medium text-brand-primary border-b-2 border-brand-primary pb-0.5'
            :'text-xs font-medium text-gray-500 hover:text-brand-primary';
    });
    const filtered=f==='all'?allAssignments:allAssignments.filter(a=>{
        if(f==='pending') return a.status==='assigned'||a.status==='pending';
        return a.status===f;
    });
    renderAssignments(filtered);
};

function getWeekStart(date){
    const d=new Date(date);const day=d.getDay();
    const diff=d.getDate()-day+(day===0?-6:1);
    const ws=new Date(d);ws.setDate(diff);ws.setHours(0,0,0,0);return ws;
}

function renderAssignments(assignments){
    const c=document.getElementById('assignments-list');
    if(!assignments.length){c.innerHTML='<div class="text-center py-8 text-gray-400">No assignments in this category.</div>';return;}
    const weeks={};
    assignments.forEach(a=>{
        const raw=a.assignedDate||a.createdAt;
        const d=raw?.toDate?raw.toDate():new Date(raw||0);
        if(isNaN(d.getTime()))return;
        const ws=getWeekStart(d).toISOString();
        if(!weeks[ws])weeks[ws]=[];
        weeks[ws].push(a);
    });
    const sorted=Object.keys(weeks).sort((a,b)=>b.localeCompare(a));
    c.innerHTML=sorted.map(wk=>{
        const ws=new Date(wk);const we=new Date(wk);we.setDate(we.getDate()+6);
        const label=`Week of ${ws.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ‚Äì ${we.toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;
        const items=weeks[wk];
        return `
        <details class="bg-white border border-gray-200 rounded-xl overflow-hidden mb-3">
            <summary class="flex items-center gap-3 px-5 py-4 hover:bg-gray-50">
                <span class="font-bold text-gray-700 text-sm">${escH(label)}</span>
                <span class="ml-auto text-xs text-gray-400">${items.length} item${items.length!==1?'s':''}</span>
                <i class="fas fa-chevron-right text-gray-300 text-xs chev ml-1"></i>
            </summary>
            <div class="px-5 pb-5 space-y-3 bg-gray-50">
                ${items.map(a=>{
                    const sc=a.status==='graded'?'text-green-700 bg-green-100':a.status==='submitted'?'text-blue-700 bg-blue-100':'text-amber-700 bg-amber-100';
                    const sl=a.status==='graded'?'Graded':a.status==='submitted'?'Submitted':'Pending';
                    const fileUrl=a.fileUrl||a.attachmentUrl||(a.attachments&&a.attachments[0]?.url)||'';
                    return `
                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-gray-800">${escH(a.title||'Untitled')}</div>
                                ${a.description?`<div class="text-xs text-gray-500 mt-1 line-clamp-2">${escH(a.description)}</div>`:''}
                                <div class="text-xs text-gray-400 mt-1.5">Due: ${escH(a.dueDate||'‚Äî')}${a.score!=null?' ‚Ä¢ Score: '+a.score+'/100':''}</div>
                                ${a.feedback?`<div class="text-xs italic text-gray-500 mt-1 bg-gray-50 p-1.5 rounded">"${escH(a.feedback)}"</div>`:''}
                            </div>
                            <div class="flex flex-col items-end gap-2 flex-shrink-0">
                                <span class="text-xs font-bold px-2.5 py-1 rounded-full ${sc}">${sl}</span>
                                <div class="flex gap-1.5">
                                    ${fileUrl?`<a href="${escH(fileUrl)}" target="_blank" class="text-xs text-brand-primary hover:underline">View</a>`:''}
                                    ${a.status!=='graded'?`<button data-id="${escH(a.id)}" onclick="openWorkspace(this.dataset.id)" class="text-xs bg-brand-primary text-white px-3 py-1 rounded-lg hover:bg-brand-dark">${a.status==='submitted'?'View / Edit':'Submit'}</button>`:''}
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </details>`;
    }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ OPEN WORKSPACE ‚Äî with annotation tab ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openWorkspace = async (assignmentId) => {
    // Remove any existing workspace modal
    const existingModal = document.getElementById('ws-modal-' + assignmentId);
    if (existingModal) existingModal.remove();

    // Clean up any existing resize observer
    if (_resizeObservers[assignmentId]) {
        _resizeObservers[assignmentId].disconnect();
        delete _resizeObservers[assignmentId];
    }

    const snap = await getDoc(doc(db, 'homework_assignments', assignmentId));
    if (!snap.exists()) return alert('Assignment not found');
    const a = snap.data();

    // ‚îÄ‚îÄ Build full file list from all possible Firestore fields ‚îÄ‚îÄ
    const _buildFileList = (asgn) => {
        const seen = new Set(); const files = [];
        const add = (url, name) => {
            if (!url || seen.has(url)) return; seen.add(url);
            const raw = (name || url || '').split('?')[0];
            const ext = raw.split('.').pop().toLowerCase();
            const isImage = ['jpg','jpeg','png','gif','webp','bmp','svg'].includes(ext);
            const isPdf   = ext === 'pdf' || url.toLowerCase().includes('.pdf');
            const label   = name || url.split('/').pop().split('?')[0] || ('File '+(files.length+1));
            files.push({ url, name: label, ext, isImage, isPdf });
        };
        if (Array.isArray(asgn.attachments))  asgn.attachments.forEach(f => add(f?.url||f, f?.name||f?.fileName));
        if (Array.isArray(asgn.files))         asgn.files.forEach(f => add(f?.url||f, f?.name||f?.fileName));
        if (Array.isArray(asgn.fileUrls))      asgn.fileUrls.forEach((u,i) => add(u, asgn.fileNames?.[i]||null));
        add(asgn.fileUrl,       asgn.fileName);
        add(asgn.attachmentUrl, asgn.attachmentFileName);
        return files;
    };
    const allFiles = _buildFileList(a);
    // Convenience ‚Äî first file (or blank)
    const fileUrl  = allFiles[0]?.url   || '';
    const isImage  = allFiles[0]?.isImage || false;
    const isPdf    = allFiles[0]?.isPdf   || false;
    const multiFile = allFiles.length > 1;

    const modal = document.createElement('div');
    modal.id = 'ws-modal-' + assignmentId;
    modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-3';

    const colorDots = ['#1f2937','#ef4444','#3b82f6','#f59e0b','#059669','#8b5cf6']
        .map(c => `<span class="color-dot active" data-color="${c}" onclick="setAnnotColor('${assignmentId}','${c}')" style="background:${c};"></span>`).join('');

    // ‚îÄ‚îÄ File strip HTML helper (shared by View + Annotate tabs) ‚îÄ‚îÄ
    const fileIcon = f => f.isImage ? 'fa-image' : f.isPdf ? 'fa-file-pdf' : 'fa-file-alt';
    const fileStripView = allFiles.length > 1
        ? `<div id="view-file-strip-${assignmentId}" class="flex gap-2 flex-wrap mb-3">
            ${allFiles.map((f,i) => `
              <button onclick="switchViewFile('${assignmentId}',${i})"
                id="view-ftab-${assignmentId}-${i}"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold border transition-all
                  ${i===0 ? 'bg-brand-primary text-white border-brand-primary' : 'bg-white text-gray-600 border-gray-300 hover:border-brand-primary hover:text-brand-primary'}">
                <i class="fas ${fileIcon(f)}"></i>
                <span class="max-w-[120px] truncate">${escH(f.name)}</span>
              </button>`).join('')}
          </div>`
        : '';

    const fileStripAnnot = allFiles.length > 1
        ? `<div id="annot-file-strip-${assignmentId}" class="flex gap-2 flex-wrap mb-3">
            ${allFiles.map((f,i) => `
              <button onclick="switchAnnotFile('${assignmentId}',${i})"
                id="annot-ftab-${assignmentId}-${i}"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold border transition-all
                  ${i===0 ? 'bg-brand-primary text-white border-brand-primary' : 'bg-white text-gray-600 border-gray-300 hover:border-brand-primary hover:text-brand-primary'}">
                <i class="fas ${fileIcon(f)}"></i>
                <span class="max-w-[120px] truncate">${escH(f.name)}</span>
                <span id="annot-fdot-${assignmentId}-${i}" class="hidden w-2 h-2 rounded-full bg-green-400 ml-0.5" title="Has annotations"></span>
              </button>`).join('')}
          </div>
          <p class="text-xs text-blue-600 mb-2"><i class="fas fa-info-circle mr-1"></i>Annotate each file separately ‚Äî all will be merged on submit.</p>`
        : '';

    // ‚îÄ‚îÄ Helper: render a single file for viewing ‚îÄ‚îÄ
    const buildViewerHTML = (f, idSuffix) => {
        if (!f) return '<p class="text-sm text-gray-400 italic text-center py-4">No file attached.</p>';
        const { url, isImage: img, isPdf: pdf, name } = f;
        const isDoc = ['doc','docx'].includes(f.ext);
        const isPPT = ['ppt','pptx'].includes(f.ext);
        const isXLS = ['xls','xlsx'].includes(f.ext);
        const officeViewable = isDoc || isPPT || isXLS;
        const fileIcons = { doc:'üìù', docx:'üìù', ppt:'üìä', pptx:'üìä', xls:'üìà', xlsx:'üìà', txt:'üìÑ', zip:'üóúÔ∏è', mp4:'üé¨', mp3:'üéµ' };
        return `
        <div class="border border-gray-200 rounded-xl overflow-hidden">
            ${img
              ? `<img src="${escH(url)}" class="w-full object-contain" style="max-height:420px;">`
              : pdf
              ? `<iframe src="https://docs.google.com/gview?url=${encodeURIComponent(url)}&embedded=true" class="w-full" style="height:500px;border:none;" allowfullscreen></iframe>`
              : officeViewable
              ? `<iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}" class="w-full" style="height:500px;border:none;" allowfullscreen></iframe>`
              : `<div class="flex flex-col items-center justify-center py-12 bg-gradient-to-br from-sky-50 to-blue-100">
                   <div class="text-6xl mb-3">${fileIcons[f.ext]||'üìé'}</div>
                   <p class="font-bold text-sky-800 mb-1">${escH(name)}</p>
                   <p class="text-sm text-gray-500 mb-4">Click to open this file</p>
                   <a href="${escH(url)}" target="_blank" class="px-5 py-2.5 bg-sky-700 text-white rounded-lg font-bold text-sm">üìÇ Open File ‚Üó</a>
                 </div>`
            }
        </div>
        <a href="${escH(url)}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-brand-primary text-xs font-medium hover:underline mt-1">
            <i class="fas fa-external-link-alt"></i>Open "${escH(name)}" in new tab
        </a>`;
    };

    // ‚îÄ‚îÄ Build annotate canvas area for file ‚îÄ‚îÄ
    const buildAnnotAreaHTML = (f, id) => {
        if (!f) return `<canvas id="annot-canvas-${id}" width="580" height="380"
            style="border:2px dashed #d1d5db;border-radius:12px;cursor:crosshair;display:block;background:#fff;max-width:100%;"></canvas>`;
        const { url, isImage: img, isPdf: pdf, ext, name } = f;
        const isDoc = ['doc','docx'].includes(ext);
        const isPPT = ['ppt','pptx'].includes(ext);
        const isXLS = ['xls','xlsx'].includes(ext);
        const officeViewable = isDoc || isPPT || isXLS;
        const fileIcons = { doc:'üìù', docx:'üìù', ppt:'üìä', pptx:'üìä', xls:'üìà', xlsx:'üìà', txt:'üìÑ', zip:'üóúÔ∏è' };

        if (officeViewable) {
            // Show Office Online viewer for reading + a blank annotation canvas below
            return `<div style="margin-bottom:8px;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;">
                <iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}"
                    style="width:100%;height:550px;border:none;display:block;"></iframe>
            </div>
            <p class="text-xs text-amber-600 mb-2"><i class="fas fa-info-circle mr-1"></i>Word/Office files can't be drawn on directly ‚Äî use the canvas below to add your annotations.</p>
            <canvas id="annot-canvas-${id}" width="700" height="300"
                style="border:2px dashed #d1d5db;border-radius:12px;cursor:crosshair;display:block;background:#fff;max-width:100%;"></canvas>`;
        }

        return `<div id="annot-wrapper-${id}" style="position:relative;display:inline-block;width:100%;max-width:100%;min-height:200px;">
            ${img
              ? `<img id="annot-bg-${id}" src="${escH(url)}" style="max-width:100%;display:block;border-radius:10px;border:1px solid #e5e7eb;" crossorigin="anonymous"
                     onerror="this.style.display='none';document.getElementById('annot-fallback-${id}').style.display='block';">
                 <div id="annot-fallback-${id}" style="display:none;width:100%;height:500px;border-radius:10px;border:1px solid #e5e7eb;overflow:hidden;">
                     <iframe src="${escH(url)}" style="width:100%;height:100%;border:none;"></iframe>
                 </div>`
              : pdf
              ? `<div id="annot-bg-frame-${id}" style="width:100%;height:600px;border-radius:10px;border:1px solid #e5e7eb;overflow:hidden;background:#f5f5f5;">
                     <div id="annot-pdf-loading-${id}" style="text-align:center;padding:40px;color:#9ca3af;">
                         <i class="fas fa-spinner fa-spin" style="font-size:2rem;margin-bottom:10px;display:block;"></i><span>Loading PDF...</span>
                     </div>
                     <canvas id="annot-bg-canvas-${id}" style="display:none;max-width:100%;"></canvas>
                     <iframe id="annot-bg-iframe-${id}" style="display:none;width:100%;height:100%;border:none;"></iframe>
                 </div>
                 <div id="annot-pdf-controls-${id}" class="hidden flex items-center gap-2 mt-2 text-xs">
                     <button onclick="annotPdfPage('${id}',-1)" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 font-bold">‚óÄ Prev</button>
                     <span id="annot-pdf-pageinfo-${id}" class="text-gray-500">Page 1 / ?</span>
                     <button onclick="annotPdfPage('${id}',1)" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 font-bold">Next ‚ñ∂</button>
                 </div>`
              : `<div id="annot-bg-frame-${id}" style="width:100%;height:500px;border-radius:10px;border:1px solid #e5e7eb;overflow:hidden;">
                     <div style="text-align:center;padding:48px;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);">
                         <div style="font-size:4rem;margin-bottom:12px;">${fileIcons[ext]||'üìé'}</div>
                         <p style="font-weight:700;color:#0369a1;margin-bottom:4px;">${escH(name)}</p>
                         <a href="${escH(url)}" target="_blank" style="color:#2563eb;font-size:.875rem;">Open file ‚Üó</a>
                     </div>
                 </div>`
            }
            <canvas id="annot-canvas-${id}" style="position:absolute;top:0;left:0;cursor:crosshair;border-radius:10px;"></canvas>
        </div>
        ${!img ? '<p class="text-xs text-amber-600 mt-1"><i class="fas fa-info-circle mr-1"></i>Draw your annotations directly on top of the document.</p>' : ''}`;
    };

    // ‚îÄ‚îÄ All-files download links for submit tab ‚îÄ‚îÄ
    const allFilesLinks = allFiles.map((f,i) =>
        `<a href="${escH(f.url)}" target="_blank" rel="noopener noreferrer"
            class="inline-flex items-center gap-2 text-brand-primary text-xs font-medium hover:underline">
            <i class="fas ${fileIcon(f)}"></i>${escH(f.name)}
         </a>`).join('<span class="text-gray-300 mx-1">|</span>');

    modal.innerHTML = `
    <div class="bg-white rounded-2xl w-full flex flex-col ws-modal-container" style="max-width:95vw;width:95vw;height:95vh;max-height:95vh;">
        <!-- Header -->
        <div class="flex justify-between items-center px-5 py-4 border-b flex-shrink-0">
            <div>
                <h3 class="font-bold text-gray-800 text-base">${escH(a.title||'Assignment')}</h3>
                <div class="flex items-center gap-2 mt-0.5 flex-wrap">
                    ${a.subject ? `<span class="text-xs text-gray-400">${escH(a.subject)}</span>` : ''}
                    ${allFiles.length > 1 ? `<span class="text-xs bg-blue-100 text-blue-700 font-semibold px-2 py-0.5 rounded-full"><i class="fas fa-paperclip mr-1"></i>${allFiles.length} files</span>` : ''}
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-1 bg-gray-100 rounded-lg px-2 py-1" id="zoom-controls-${assignmentId}">
                    <button onclick="annotZoom('${assignmentId}',-0.25)" class="text-xs font-bold text-gray-600 hover:text-gray-900 px-1.5 py-0.5 rounded hover:bg-gray-200">‚àí</button>
                    <span id="zoom-level-${assignmentId}" class="text-[.65rem] font-mono text-gray-500 min-w-[36px] text-center">100%</span>
                    <button onclick="annotZoom('${assignmentId}',0.25)" class="text-xs font-bold text-gray-600 hover:text-gray-900 px-1.5 py-0.5 rounded hover:bg-gray-200">+</button>
                    <button onclick="annotZoom('${assignmentId}','fit')" class="text-[.65rem] font-semibold text-blue-600 hover:text-blue-800 px-1.5 py-0.5 rounded hover:bg-blue-50 ml-1">Fit</button>
                </div>
                <button onclick="document.getElementById('ws-modal-${assignmentId}').remove()" class="text-gray-400 hover:text-gray-600 text-xl leading-none">&times;</button>
            </div>
        </div>
        <!-- Tabs -->
        <div class="flex border-b flex-shrink-0 bg-gray-50 px-2">
            <button class="ws-tab-btn active" id="wstab-view-${assignmentId}" onclick="wsTab('${assignmentId}','view')">
                <i class="fas fa-eye mr-1"></i>View
            </button>
            <button class="ws-tab-btn" id="wstab-annotate-${assignmentId}" onclick="wsTab('${assignmentId}','annotate')">
                <i class="fas fa-pen-nib mr-1"></i>Annotate
            </button>
            <button class="ws-tab-btn" id="wstab-submit-${assignmentId}" onclick="wsTab('${assignmentId}','submit')">
                <i class="fas fa-paper-plane mr-1"></i>Submit
            </button>
        </div>
        <!-- Tab bodies -->
        <div style="overflow-y:auto;flex:1;">

            <!-- VIEW TAB -->
            <div id="wscontent-view-${assignmentId}" class="p-5 space-y-4">
                <div class="bg-gray-50 rounded-xl p-4">
                    <h5 class="font-semibold text-gray-700 mb-2 text-sm">üìã Instructions</h5>
                    <p class="text-sm text-gray-600 leading-relaxed">${escH(a.description||a.instructions||'No specific instructions provided.')}</p>
                </div>
                ${a.dueDate?`<div class="flex items-center gap-2 text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2"><i class="fas fa-clock"></i><span>Due: <strong>${escH(a.dueDate)}</strong></span></div>`:''}
                ${a.score!=null?`<div class="flex items-center gap-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded-lg px-3 py-2"><i class="fas fa-star"></i><span>Score: <strong>${a.score}/100</strong></span></div>`:''}
                ${allFiles.length > 0 ? `
                  ${fileStripView}
                  <div id="view-file-preview-${assignmentId}">
                      ${buildViewerHTML(allFiles[0], assignmentId)}
                  </div>
                ` : `<p class="text-sm text-gray-400 italic text-center py-4">No file attached to this assignment.</p>`}
                ${a.feedback?`<div class="bg-blue-50 border border-blue-200 rounded-xl p-4"><p class="text-xs font-bold text-blue-700 mb-1">Tutor Feedback:</p><p class="text-sm text-blue-800 italic">"${escH(a.feedback)}"</p></div>`:''}
            </div>

            <!-- ANNOTATE TAB -->
            <div id="wscontent-annotate-${assignmentId}" class="p-5 hidden">
                <p class="text-xs text-gray-500 mb-3">Use the tools below to annotate your assignment. Your annotation will be included when you submit.</p>
                <div class="annot-toolbar">
                    <span class="text-xs font-semibold text-gray-500">Tool:</span>
                    <button id="tool-select-${assignmentId}" class="annot-tool-btn" onclick="setAnnotTool('${assignmentId}','select')" title="Select & Move"><i class="fas fa-mouse-pointer"></i></button>
                    <button id="tool-pen-${assignmentId}" class="annot-tool-btn active" onclick="setAnnotTool('${assignmentId}','pen')" title="Pen"><i class="fas fa-pen"></i></button>
                    <button id="tool-highlighter-${assignmentId}" class="annot-tool-btn" onclick="setAnnotTool('${assignmentId}','highlighter')" title="Highlighter"><i class="fas fa-highlighter"></i></button>
                    <button id="tool-text-${assignmentId}" class="annot-tool-btn" onclick="setAnnotTool('${assignmentId}','text')" title="Add Text"><i class="fas fa-font"></i></button>
                    <button id="tool-rect-${assignmentId}" class="annot-tool-btn" onclick="setAnnotTool('${assignmentId}','rect')" title="Rectangle"><i class="fas fa-square" style="font-size:.6rem;"></i></button>
                    <button id="tool-circle-${assignmentId}" class="annot-tool-btn" onclick="setAnnotTool('${assignmentId}','circle')" title="Circle"><i class="fas fa-circle" style="font-size:.6rem;"></i></button>
                    <button id="tool-arrow-${assignmentId}" class="annot-tool-btn" onclick="setAnnotTool('${assignmentId}','arrow')" title="Arrow"><i class="fas fa-arrow-right"></i></button>
                    <button id="tool-line-${assignmentId}" class="annot-tool-btn" onclick="setAnnotTool('${assignmentId}','line')" title="Line"><i class="fas fa-minus"></i></button>
                    <button id="tool-eraser-${assignmentId}" class="annot-tool-btn" onclick="setAnnotTool('${assignmentId}','eraser')" title="Eraser"><i class="fas fa-eraser"></i></button>
                    <span class="text-xs font-semibold text-gray-500 ml-1">Size:</span>
                    <input type="range" id="brush-size-${assignmentId}" min="1" max="20" value="3" class="w-20" oninput="window._annotState&amp;&amp;window._annotState['${assignmentId}']&amp;&amp;(window._annotState['${assignmentId}'].size=+this.value)">
                    <span class="text-xs font-semibold text-gray-500 ml-1">Font:</span>
                    <select class="annot-font-size" onchange="window._annotState&amp;&amp;window._annotState['${assignmentId}']&amp;&amp;(window._annotState['${assignmentId}'].fontSize=+this.value)">
                        <option value="14">14</option><option value="18" selected>18</option><option value="24">24</option><option value="32">32</option><option value="48">48</option>
                    </select>
                    <span class="text-xs font-semibold text-gray-500 ml-1">Color:</span>
                    ${colorDots}
                    <button onclick="undoAnnot('${assignmentId}')" class="ml-1 px-2 py-1 text-xs bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300" title="Undo"><i class="fas fa-undo"></i></button>
                    <button onclick="clearAnnotCanvas('${assignmentId}')" class="px-2 py-1 text-xs bg-red-100 text-red-600 rounded-lg hover:bg-red-200" title="Clear"><i class="fas fa-trash-alt"></i></button>
                </div>
                ${fileStripAnnot}
                <div id="annot-area-${assignmentId}">
                    ${buildAnnotAreaHTML(allFiles[0], assignmentId)}
                </div>
                <p id="annot-hint-${assignmentId}" class="text-xs text-blue-500 mt-2"><i class="fas fa-pen mr-1"></i>Pen selected ‚Äî click and drag to draw</p>
                <div id="annot-live-preview-${assignmentId}" class="hidden mt-4 bg-gray-50 rounded-xl p-3 border border-gray-200">
                    <p class="text-xs font-bold text-gray-600 mb-2"><i class="fas fa-eye mr-1 text-brand-primary"></i>Merged preview (what the tutor will see):</p>
                    <img id="annot-live-preview-img-${assignmentId}" class="max-w-full rounded-lg border border-gray-200" src="" style="max-height:260px;">
                </div>
                <div class="flex gap-3 mt-4 pt-3 border-t border-gray-100">
                    <button onclick="previewAnnotation('${assignmentId}')" class="px-4 py-2.5 bg-blue-50 text-blue-700 rounded-xl text-sm font-semibold hover:bg-blue-100 transition-colors">
                        <i class="fas fa-eye mr-1"></i>Preview
                    </button>
                    <button id="annot-submit-btn-${assignmentId}" onclick="submitAnnotation('${assignmentId}')"
                        class="flex-1 px-4 py-2.5 bg-brand-primary text-white rounded-xl text-sm font-bold hover:bg-brand-dark transition-colors">
                        <i class="fas fa-paper-plane mr-1"></i>Submit Annotation${allFiles.length>1?' (All Files)':''} to Tutor
                    </button>
                </div>
            </div>

            <!-- SUBMIT TAB -->
            <div id="wscontent-submit-${assignmentId}" class="p-5 hidden">
                <div class="space-y-4">
                    ${allFiles.length > 0 ? `
                    <div class="bg-blue-50 border border-blue-200 rounded-xl px-4 py-3">
                        <p class="text-xs font-bold text-blue-700 mb-2"><i class="fas fa-paperclip mr-1"></i>Assignment files (${allFiles.length}):</p>
                        <div class="flex flex-wrap gap-2">${allFilesLinks}</div>
                    </div>` : ''}
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Your Answer / Notes</label>
                        <textarea id="ws-text-${assignmentId}" rows="6"
                            class="w-full p-3 border border-gray-300 rounded-xl text-sm resize-none focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                            placeholder="Type your answer, working-out, or notes here...">${escH(a.studentWork||'')}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Upload Your Work <span class="text-gray-400 font-normal">(optional ‚Äî image, PDF, Word)</span></label>
                        <input type="file" id="ws-file-${assignmentId}" accept="image/*,.pdf,.doc,.docx"
                            class="block w-full text-sm text-gray-500 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-brand-light file:text-brand-dark file:font-semibold hover:file:bg-emerald-200">
                    </div>
                    <div id="annot-preview-${assignmentId}" class="hidden bg-gray-50 rounded-xl p-3 border border-gray-200">
                        <p class="text-xs font-bold text-gray-600 mb-2"><i class="fas fa-pen-nib mr-1 text-brand-primary"></i>Your annotation will be sent to the tutor:</p>
                        <img id="annot-preview-img-${assignmentId}" class="max-w-xs rounded-lg border border-gray-200" src="">
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button onclick="document.getElementById('ws-modal-${assignmentId}').remove()"
                            class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-colors">Cancel</button>
                        <button data-id="${escH(assignmentId)}" onclick="submitWork(this.dataset.id)" id="submit-btn-${assignmentId}"
                            class="flex-1 px-4 py-3 bg-brand-primary text-white rounded-xl font-bold hover:bg-brand-dark transition-colors">
                            <i class="fas fa-paper-plane mr-1"></i>Submit
                        </button>
                    </div>
                </div>
            </div>

        </div><!-- end scrollable -->
    </div>`;

    document.body.appendChild(modal);

    // ‚îÄ‚îÄ Init annotation state ‚Äî supports per-file sub-states ‚îÄ‚îÄ
    _annotState[assignmentId] = {
        tool:'pen', color:'#1f2937', size:3, fontSize:18,
        drawing:false, history:[], ctx:null, _zoom:1,
        // Multi-file support
        _files: allFiles,
        _fileIdx: 0,          // which file is currently loaded in annotate canvas
        _fileStates: {},       // fileIdx ‚Üí { history, pageAnnotations, pdfDoc, pdfPage, pdfTotal, pdfRendering, bgBlobUrl, bgOffscreenImg }
        // current file convenience
        fileUrl: fileUrl, isImage, isPdf,
        ext: (allFiles[0]?.ext||''),
        _pdfDoc: null, _pdfPage: 1, _pdfTotal: 0, _pdfRendering: false,
        _bgOffscreenImg: null, _bgBlobUrl: null,
        _pageAnnotations: {},
        _sel: null, _shapeStart: null, _shapeSnapshot: null, _textPending: null
    };
};

// ‚îÄ‚îÄ Switch file in VIEW tab ‚îÄ‚îÄ
window.switchViewFile = (id, idx) => {
    const s = _annotState[id]; if (!s) return;
    const f = s._files[idx]; if (!f) return;
    // Update tab buttons
    s._files.forEach((_, i) => {
        const btn = document.getElementById('view-ftab-'+id+'-'+i);
        if (btn) btn.className = btn.className.replace(
            i===idx ? 'bg-white text-gray-600 border-gray-300 hover:border-brand-primary hover:text-brand-primary'
                     : 'bg-brand-primary text-white border-brand-primary',
            i===idx ? 'bg-brand-primary text-white border-brand-primary'
                     : 'bg-white text-gray-600 border-gray-300 hover:border-brand-primary hover:text-brand-primary'
        );
    });
    // Rebuild preview
    const preview = document.getElementById('view-file-preview-'+id);
    if (!preview) return;
    const { url, isImage: img, isPdf: pdf, name } = f;
    preview.innerHTML = `
        <div class="border border-gray-200 rounded-xl overflow-hidden">
            ${img
              ? `<img src="${url.replace(/"/g,'&quot;')}" class="w-full object-contain" style="max-height:420px;">`
              : pdf
              ? `<iframe src="https://docs.google.com/gview?url=${encodeURIComponent(url)}&embedded=true" class="w-full" style="height:500px;border:none;" allowfullscreen></iframe>`
              : `<iframe src="${url.replace(/"/g,'&quot;')}" class="w-full" style="height:420px;border:none;" allowfullscreen></iframe>`
            }
        </div>
        <a href="${url.replace(/"/g,'&quot;')}" target="_blank" rel="noopener noreferrer"
           class="inline-flex items-center gap-2 text-brand-primary text-xs font-medium hover:underline mt-1">
            <i class="fas fa-external-link-alt"></i>Open in new tab
        </a>`;
};

// ‚îÄ‚îÄ Switch file in ANNOTATE tab (save current, load new) ‚îÄ‚îÄ
window.switchAnnotFile = async (id, idx) => {
    const s = _annotState[id]; if (!s) return;
    const prevIdx = s._fileIdx;
    if (prevIdx === idx) return;
    const f = s._files[idx]; if (!f) return;

    // Save current file's full state
    _saveCurrentFileAnnotState(id, prevIdx);

    // Update tab buttons
    s._files.forEach((_, i) => {
        const btn = document.getElementById('annot-ftab-'+id+'-'+i);
        if (!btn) return;
        const isActive = i === idx;
        btn.classList.toggle('bg-brand-primary', isActive);
        btn.classList.toggle('text-white', isActive);
        btn.classList.toggle('border-brand-primary', isActive);
        btn.classList.toggle('bg-white', !isActive);
        btn.classList.toggle('text-gray-600', !isActive);
        btn.classList.toggle('border-gray-300', !isActive);
    });

    // Update state for new file
    s._fileIdx = idx;
    s.fileUrl  = f.url;
    s.isImage  = f.isImage;
    s.isPdf    = f.isPdf;
    s.ext      = f.ext;

    // Restore new file's saved canvas state or clear
    const savedState = s._fileStates[idx];
    s.history            = savedState?.history           || [];
    s._pageAnnotations   = savedState?.pageAnnotations   || {};
    s._pdfDoc            = savedState?.pdfDoc            || null;
    s._pdfPage           = savedState?.pdfPage           || 1;
    s._pdfTotal          = savedState?.pdfTotal          || 0;
    s._pdfRendering      = false;
    s._bgOffscreenImg    = savedState?.bgOffscreenImg    || null;
    s._bgBlobUrl         = savedState?.bgBlobUrl         || null;

    // Rebuild the canvas area DOM
    const area = document.getElementById('annot-area-'+id);
    if (!area) return;
    const { url, isImage: img, isPdf: pdf } = f;
    area.innerHTML = img
        ? `<div id="annot-wrapper-${id}" style="position:relative;display:inline-block;width:100%;max-width:100%;min-height:200px;">
               <img id="annot-bg-${id}" src="${url.replace(/"/g,'&quot;')}" style="max-width:100%;display:block;border-radius:10px;border:1px solid #e5e7eb;">
               <canvas id="annot-canvas-${id}" style="position:absolute;top:0;left:0;cursor:crosshair;border-radius:10px;"></canvas>
           </div>`
        : pdf
        ? `<div id="annot-wrapper-${id}" style="position:relative;display:inline-block;width:100%;max-width:100%;min-height:200px;">
               <div id="annot-bg-frame-${id}" style="width:100%;height:600px;border-radius:10px;border:1px solid #e5e7eb;overflow:hidden;background:#f5f5f5;">
                   <div id="annot-pdf-loading-${id}" style="text-align:center;padding:40px;color:#9ca3af;">
                       <i class="fas fa-spinner fa-spin" style="font-size:2rem;margin-bottom:10px;display:block;"></i><span>Loading PDF...</span>
                   </div>
                   <canvas id="annot-bg-canvas-${id}" style="display:none;max-width:100%;"></canvas>
                   <iframe id="annot-bg-iframe-${id}" style="display:none;width:100%;height:100%;border:none;"></iframe>
               </div>
               <div id="annot-pdf-controls-${id}" class="hidden flex items-center gap-2 mt-2 text-xs">
                   <button onclick="annotPdfPage('${id}',-1)" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 font-bold">‚óÄ Prev</button>
                   <span id="annot-pdf-pageinfo-${id}" class="text-gray-500">Page 1 / ?</span>
                   <button onclick="annotPdfPage('${id}',1)" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 font-bold">Next ‚ñ∂</button>
               </div>
               <canvas id="annot-canvas-${id}" style="position:absolute;top:0;left:0;cursor:crosshair;border-radius:10px;"></canvas>
           </div>`
        : `<div id="annot-wrapper-${id}" style="position:relative;display:inline-block;width:100%;max-width:100%;min-height:200px;">
               <div id="annot-bg-frame-${id}" style="width:100%;height:500px;border-radius:10px;border:1px solid #e5e7eb;overflow:hidden;">
                   <iframe src="${url.replace(/"/g,'&quot;')}" style="width:100%;height:100%;border:none;"></iframe>
               </div>
               <canvas id="annot-canvas-${id}" style="position:absolute;top:0;left:0;cursor:crosshair;border-radius:10px;"></canvas>
           </div>`;

    // Re-init canvas listeners + background
    s.ctx = null;
    s._sel = null; s._shapeStart = null; s._shapeSnapshot = null;
    setTimeout(() => initAnnotCanvas(id), 80);
};

// ‚îÄ‚îÄ Save current file's annotation state into _fileStates ‚îÄ‚îÄ
function _saveCurrentFileAnnotState(id, fileIdx) {
    const s = _annotState[id]; if (!s) return;
    // Save current page for multi-page PDFs
    if (s.isPdf) _saveCurrentPageAnnot(id);
    const c = document.getElementById('annot-canvas-'+id);
    const hasAnnot = c && c.width > 0 && (() => {
        try {
            const d = c.getContext('2d').getImageData(0,0,c.width,c.height).data;
            return Array.from(d).some((v,i) => i%4===3 && v>0);
        } catch(e) { return false; }
    })();
    // Update dot indicator
    const dot = document.getElementById('annot-fdot-'+id+'-'+fileIdx);
    if (dot) {
        const hasAny = hasAnnot || Object.values(s._pageAnnotations).some(v => v && v !== '');
        dot.classList.toggle('hidden', !hasAny);
    }
    s._fileStates[fileIdx] = {
        history:         [...s.history],
        pageAnnotations: {...s._pageAnnotations},
        pdfDoc:          s._pdfDoc,
        pdfPage:         s._pdfPage,
        pdfTotal:        s._pdfTotal,
        bgOffscreenImg:  s._bgOffscreenImg,
        bgBlobUrl:       s._bgBlobUrl,
    };
}

// ‚îÄ‚îÄ ANNOTATION CANVAS ENGINE ‚îÄ‚îÄ
function initAnnotCanvas(id) {
    const canvas = document.getElementById('annot-canvas-' + id);
    if (!canvas) return;
    const s = _annotState[id];
    if (!s) return;
    const { isImage, isPdf, fileUrl } = s;

    // Helper: size the annotation canvas to match something
    function sizeCanvasTo(w, h) {
        canvas.width = w;
        canvas.height = h;
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';
    }

    // ‚îÄ‚îÄ Prefetch the file as a same-origin blob so we can merge later without CORS issues ‚îÄ‚îÄ
    if (fileUrl && (isImage || isPdf)) {
        fetch(fileUrl, { mode:'cors' })
            .then(r => r.blob())
            .then(blob => {
                s._bgBlobUrl = URL.createObjectURL(blob);
                // For images, also preload into an offscreen Image so merge is instant
                if (isImage) {
                    const offscreen = new Image();
                    offscreen.onload = () => { s._bgOffscreenImg = offscreen; };
                    offscreen.src = s._bgBlobUrl;
                }
            })
            .catch(() => { /* CORS blocked ‚Äî will use PDF canvas or fallback at merge time */ });
    }

    // ‚îÄ‚îÄ‚îÄ IMAGE background ‚îÄ‚îÄ‚îÄ
    if (isImage && fileUrl) {
        const img = document.getElementById('annot-bg-' + id);
        if (img) {
            const applySize = () => {
                const w = img.offsetWidth || img.naturalWidth || 580;
                const h = img.offsetHeight || img.naturalHeight || 380;
                sizeCanvasTo(w, h);
            };

            if (img.complete && img.naturalWidth > 0) {
                applySize();
            } else {
                img.addEventListener('load', applySize);
            }

            // Handle image load failure ‚Äî show fallback iframe
            img.addEventListener('error', () => {
                const fb = document.getElementById('annot-fallback-' + id);
                if (fb) {
                    fb.style.display = 'block';
                    img.style.display = 'none';
                    sizeCanvasTo(fb.offsetWidth || 800, fb.offsetHeight || 500);
                }
            });

            // ResizeObserver
            if (window.ResizeObserver) {
                const observer = new ResizeObserver(() => {
                    const el = img.offsetWidth > 0 ? img : document.getElementById('annot-fallback-' + id);
                    if (el && el.offsetWidth > 0) {
                        sizeCanvasTo(el.offsetWidth, el.offsetHeight);
                        _restoreAnnotHistory(id);
                    }
                });
                observer.observe(img);
                _resizeObservers[id] = observer;
            }
        }
    }

    // ‚îÄ‚îÄ‚îÄ PDF background ‚îÄ‚îÄ‚îÄ
    else if (isPdf && fileUrl) {
        const frameContainer = document.getElementById('annot-bg-frame-' + id);
        const bgCanvas = document.getElementById('annot-bg-canvas-' + id);
        const bgIframe = document.getElementById('annot-bg-iframe-' + id);
        const loadingEl = document.getElementById('annot-pdf-loading-' + id);
        const controlsEl = document.getElementById('annot-pdf-controls-' + id);

        // Try PDF.js first, then fall back to Google Docs Viewer iframe
        const tryPdfJs = async () => {
            if (!window.pdfjsLib) throw new Error('PDF.js not loaded');
            const pdfDoc = await pdfjsLib.getDocument({ url: fileUrl }).promise;
            s._pdfDoc = pdfDoc;
            s._pdfTotal = pdfDoc.numPages;
            s._pdfPage = 1;
            if (loadingEl) loadingEl.style.display = 'none';
            if (bgCanvas) bgCanvas.style.display = 'block';
            if (controlsEl) controlsEl.classList.remove('hidden');
            await renderPdfPage(id, 1);
        };

        const fallbackToGoogleViewer = () => {
            console.warn('PDF.js failed, using Google Docs Viewer');
            if (loadingEl) loadingEl.style.display = 'none';
            if (bgIframe) {
                bgIframe.src = 'https://docs.google.com/gview?url=' + encodeURIComponent(fileUrl) + '&embedded=true';
                bgIframe.style.display = 'block';
            }
            // Size canvas to match frame
            const h = frameContainer ? (frameContainer.offsetHeight || 600) : 600;
            const w = frameContainer ? (frameContainer.offsetWidth || 800) : 800;
            sizeCanvasTo(w, h);
        };

        tryPdfJs().catch(fallbackToGoogleViewer);

        // ResizeObserver for frame
        if (frameContainer && window.ResizeObserver) {
            const observer = new ResizeObserver(() => {
                if (frameContainer.offsetWidth > 0 && !s._pdfDoc) {
                    sizeCanvasTo(frameContainer.offsetWidth, frameContainer.offsetHeight);
                }
            });
            observer.observe(frameContainer);
            _resizeObservers[id] = observer;
        }
    }

    // ‚îÄ‚îÄ‚îÄ Other files (iframe overlay) ‚îÄ‚îÄ‚îÄ
    else if (fileUrl) {
        const frameContainer = document.getElementById('annot-bg-frame-' + id);
        if (frameContainer) {
            const w = frameContainer.offsetWidth || 800;
            const h = frameContainer.offsetHeight || 500;
            sizeCanvasTo(w, h);
            if (window.ResizeObserver) {
                const observer = new ResizeObserver(() => {
                    sizeCanvasTo(frameContainer.offsetWidth || 800, frameContainer.offsetHeight || 500);
                });
                observer.observe(frameContainer);
                _resizeObservers[id] = observer;
            }
        }
    }

    // ‚îÄ‚îÄ‚îÄ No file ‚Äî blank canvas already has width/height in HTML ‚îÄ‚îÄ‚îÄ

    // Initialize drawing context
    const ctx = canvas.getContext('2d');
    s.ctx = ctx;
    _saveAnnotHistory(id);
    _attachCanvasListeners(canvas, id);
}

// Restore last drawing state after resize
function _restoreAnnotHistory(id) {
    const s = _annotState[id];
    if (!s || !s.history || s.history.length === 0) return;
    const lastState = s.history[s.history.length - 1];
    if (!lastState || lastState === 'data:,') return;
    const c = document.getElementById('annot-canvas-' + id);
    if (!c) return;
    const tempImg = new Image();
    tempImg.onload = () => {
        s.ctx.clearRect(0, 0, c.width, c.height);
        s.ctx.drawImage(tempImg, 0, 0, c.width, c.height);
    };
    tempImg.src = lastState;
}

// ‚îÄ‚îÄ‚îÄ PDF page rendering ‚îÄ‚îÄ‚îÄ
async function renderPdfPage(id, pageNum) {
    const s = _annotState[id];
    if (!s || !s._pdfDoc) return;
    try {
        const page = await s._pdfDoc.getPage(pageNum);
        const bgCanvas = document.getElementById('annot-bg-canvas-' + id);
        const annotCanvas = document.getElementById('annot-canvas-' + id);
        const frameContainer = document.getElementById('annot-bg-frame-' + id);
        if (!bgCanvas || !annotCanvas) return;

        // Calculate scale to fit container width
        const containerW = (frameContainer ? frameContainer.offsetWidth : bgCanvas.parentElement?.offsetWidth) || 800;
        const baseViewport = page.getViewport({ scale: 1 });
        const scale = Math.max(1, containerW / baseViewport.width);
        const viewport = page.getViewport({ scale });

        bgCanvas.width = viewport.width;
        bgCanvas.height = viewport.height;
        bgCanvas.style.width = viewport.width + 'px';
        bgCanvas.style.height = viewport.height + 'px';

        if (frameContainer) {
            frameContainer.style.height = viewport.height + 'px';
        }

        annotCanvas.width = viewport.width;
        annotCanvas.height = viewport.height;
        annotCanvas.style.width = viewport.width + 'px';
        annotCanvas.style.height = viewport.height + 'px';

        const bgCtx = bgCanvas.getContext('2d');
        bgCtx.fillStyle = '#ffffff';
        bgCtx.fillRect(0, 0, viewport.width, viewport.height);
        await page.render({ canvasContext: bgCtx, viewport }).promise;

        // Update annotState ctx
        s.ctx = annotCanvas.getContext('2d');

        // ‚îÄ‚îÄ Restore saved annotations for this page (if any) ‚îÄ‚îÄ
        const savedAnnot = s._pageAnnotations[pageNum];
        if (savedAnnot && savedAnnot !== 'data:,') {
            const restoreImg = new Image();
            restoreImg.onload = () => {
                s.ctx.clearRect(0, 0, annotCanvas.width, annotCanvas.height);
                s.ctx.drawImage(restoreImg, 0, 0, annotCanvas.width, annotCanvas.height);
                // Reset undo history for this page from saved state
                s.history = [savedAnnot];
            };
            restoreImg.src = savedAnnot;
        } else {
            s.history = [];
            _saveAnnotHistory(id);
        }

        const info = document.getElementById('annot-pdf-pageinfo-' + id);
        if (info) {
            const hasAnnot = s._pageAnnotations[pageNum] && s._pageAnnotations[pageNum] !== '' && s._pageAnnotations[pageNum] !== 'data:,';
            info.innerHTML = 'Page ' + pageNum + ' / ' + s._pdfTotal + (hasAnnot ? ' <span style="color:#059669;font-weight:700;" title="This page has annotations">‚óè</span>' : '');
        }
    } catch(err) {
        console.error('PDF page render error:', err);
    }
}

// ‚îÄ‚îÄ Save current page annotations before navigating away ‚îÄ‚îÄ
function _saveCurrentPageAnnot(id) {
    const s = _annotState[id];
    if (!s || !s.isPdf || !s._pdfPage) return;
    const c = document.getElementById('annot-canvas-' + id);
    if (!c || c.width === 0) return;
    // Check if there's anything drawn
    const data = c.getContext('2d').getImageData(0, 0, c.width, c.height).data;
    const hasContent = Array.from(data).some((v, i) => i % 4 === 3 && v > 0);
    if (hasContent) {
        s._pageAnnotations[s._pdfPage] = c.toDataURL();
    } else {
        // Save empty marker so we know we visited this page
        s._pageAnnotations[s._pdfPage] = '';
    }
}

window.annotPdfPage = (id, delta) => {
    const s = _annotState[id];
    if (!s || !s._pdfDoc) return;
    const newPage = s._pdfPage + delta;
    if (newPage < 1 || newPage > s._pdfTotal) return;

    // ‚îÄ‚îÄ Save current page's annotation before leaving ‚îÄ‚îÄ
    _saveCurrentPageAnnot(id);

    // Drop any active selection
    if (s._sel) { _commitSelection(id); }

    s._pdfPage = newPage;
    renderPdfPage(id, newPage);
};

// ‚îÄ‚îÄ‚îÄ Attach canvas listeners (extracted to avoid duplication) ‚îÄ‚îÄ‚îÄ
function _attachCanvasListeners(canvas, id) {
    if (canvas.dataset.listenersAttached) return;
    canvas.dataset.listenersAttached = '1';

    canvas.addEventListener('mousedown', e => _annotStart(e, id, canvas));
    canvas.addEventListener('mousemove', e => _annotDraw(e, id, canvas));
    canvas.addEventListener('mouseup',   () => _annotStop(id));
    canvas.addEventListener('mouseleave',() => _annotStop(id));
    canvas.addEventListener('touchstart', e => { e.preventDefault(); _annotStart(e.touches[0], id, canvas); }, {passive:false});
    canvas.addEventListener('touchmove',  e => { e.preventDefault(); _annotDraw(e.touches[0], id, canvas); }, {passive:false});
    canvas.addEventListener('touchend',   () => _annotStop(id));
}

function _getPos(e, canvas) {
    const r = canvas.getBoundingClientRect();
    return { x:(e.clientX-r.left)*(canvas.width/r.width), y:(e.clientY-r.top)*(canvas.height/r.height) };
}

// ‚îÄ‚îÄ Selection helpers ‚îÄ‚îÄ
function _commitSelection(id) {
    const s = _annotState[id]; if (!s || !s._sel) return;
    const c = document.getElementById('annot-canvas-'+id); if (!c) return;
    const sel = s._sel;
    // Restore snapshot (original canvas without the selection cut)
    // Then draw the moved content at new position
    if (sel._snapshot) {
        const snapImg = new Image();
        snapImg.onload = () => {
            s.ctx.clearRect(0, 0, c.width, c.height);
            s.ctx.drawImage(snapImg, 0, 0);
            // Erase original area
            s.ctx.clearRect(sel._origX, sel._origY, sel.w, sel.h);
            // Draw content at new position
            if (sel.img) s.ctx.drawImage(sel.img, sel.x, sel.y, sel.w, sel.h);
            s._sel = null;
            _saveAnnotHistory(id);
        };
        snapImg.src = sel._snapshot;
    } else {
        if (sel.img) s.ctx.drawImage(sel.img, sel.x, sel.y, sel.w, sel.h);
        s._sel = null;
        _saveAnnotHistory(id);
    }
}

function _cancelSelection(id) {
    const s = _annotState[id]; if (!s || !s._sel) return;
    const c = document.getElementById('annot-canvas-'+id); if (!c) return;
    // Restore snapshot ‚Äî discard move
    if (s._sel._snapshot) {
        const snapImg = new Image();
        snapImg.onload = () => {
            s.ctx.clearRect(0, 0, c.width, c.height);
            s.ctx.drawImage(snapImg, 0, 0);
            s._sel = null;
        };
        snapImg.src = s._sel._snapshot;
    } else {
        s._sel = null;
    }
}

function _redrawAnnotCanvas(id, cb) {
    const s = _annotState[id]; if (!s) return;
    const c = document.getElementById('annot-canvas-'+id); if (!c) return;
    if (s.history.length > 0) {
        const last = s.history[s.history.length - 1];
        if (last && last !== 'data:,') {
            const img = new Image();
            img.onload = () => {
                s.ctx.clearRect(0, 0, c.width, c.height);
                s.ctx.drawImage(img, 0, 0, c.width, c.height);
                if (s._sel) _drawSelectionOverlay(id);
                if (cb) cb();
            };
            img.src = last;
            return;
        }
    }
    s.ctx.clearRect(0, 0, c.width, c.height);
    if (s._sel) _drawSelectionOverlay(id);
    if (cb) cb();
}

function _drawSelectionOverlay(id) {
    const s = _annotState[id]; if (!s || !s._sel) return;
    const sel = s._sel;
    // Draw the content being moved at its current position
    if (sel.phase !== 'select' && sel.img) {
        s.ctx.drawImage(sel.img, sel.x, sel.y, sel.w, sel.h);
    }
    // Draw marching-ants selection rectangle
    const rx = sel.phase === 'select' ? Math.min(sel.startX, sel.x) : sel.x;
    const ry = sel.phase === 'select' ? Math.min(sel.startY, sel.y) : sel.y;
    const rw = sel.phase === 'select' ? sel.w : sel.w;
    const rh = sel.phase === 'select' ? sel.h : sel.h;
    s.ctx.save();
    s.ctx.strokeStyle = '#3b82f6';
    s.ctx.lineWidth = 1.5;
    s.ctx.setLineDash([6, 3]);
    s.ctx.strokeRect(rx, ry, rw, rh);
    if (sel.phase !== 'select') {
        // Fill hint
        s.ctx.fillStyle = 'rgba(59,130,246,0.05)';
        s.ctx.fillRect(rx, ry, rw, rh);
        // Corner handles
        const hs = 8; s.ctx.setLineDash([]); s.ctx.fillStyle = '#3b82f6';
        [[rx,ry],[rx+rw,ry],[rx,ry+rh],[rx+rw,ry+rh]].forEach(([cx,cy]) => {
            s.ctx.beginPath(); s.ctx.arc(cx, cy, hs/2, 0, Math.PI*2); s.ctx.fill();
        });
    }
    s.ctx.restore();
}

// ‚îÄ‚îÄ Shape drawing helpers ‚îÄ‚îÄ
function _drawShape(ctx, tool, x1, y1, x2, y2, color, size) {
    ctx.save();
    ctx.strokeStyle = color;
    ctx.lineWidth = size;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.setLineDash([]);
    const w = x2 - x1, h = y2 - y1;
    if (tool === 'rect') {
        ctx.strokeRect(x1, y1, w, h);
    } else if (tool === 'circle') {
        ctx.beginPath();
        ctx.ellipse(x1 + w/2, y1 + h/2, Math.abs(w/2), Math.abs(h/2), 0, 0, Math.PI*2);
        ctx.stroke();
    } else if (tool === 'line') {
        ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
    } else if (tool === 'arrow') {
        const dx = x2 - x1, dy = y2 - y1;
        const angle = Math.atan2(dy, dx);
        const headLen = Math.min(30, Math.sqrt(dx*dx+dy*dy)*0.35) + size*2;
        ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x2, y2);
        ctx.lineTo(x2 - headLen * Math.cos(angle - Math.PI/6), y2 - headLen * Math.sin(angle - Math.PI/6));
        ctx.moveTo(x2, y2);
        ctx.lineTo(x2 - headLen * Math.cos(angle + Math.PI/6), y2 - headLen * Math.sin(angle + Math.PI/6));
        ctx.stroke();
    }
    ctx.restore();
}

function _annotStart(e, id, canvas) {
    const s = _annotState[id]; if (!s) return;
    const pos = _getPos(e, canvas);

    // Close any open text overlay if clicking elsewhere
    const textOverlay = document.getElementById('annot-text-input-overlay');
    if (textOverlay && textOverlay.classList.contains('visible') && s._textPending && s._textPending.assignId === id) {
        window._annotTextOk();
        return;
    }

    // ‚îÄ‚îÄ TEXT tool ‚Äî show inline overlay ‚îÄ‚îÄ
    if (s.tool === 'text') {
        s._textPending = { canvasX: pos.x, canvasY: pos.y, assignId: id };
        const canvasRect = canvas.getBoundingClientRect();
        const screenX = canvasRect.left + (pos.x * (canvasRect.width / canvas.width));
        const screenY = canvasRect.top  + (pos.y * (canvasRect.height / canvas.height));
        const overlay = document.getElementById('annot-text-input-overlay');
        const box = document.getElementById('annot-text-input-box');
        if (overlay && box) {
            box.value = '';
            box.style.color = s.color;
            box.style.fontSize = s.fontSize + 'px';
            const ow = 240, oh = 110;
            let ox = Math.min(screenX, window.innerWidth - ow - 8);
            let oy = Math.min(screenY, window.innerHeight - oh - 8);
            overlay.style.left = Math.max(8, ox) + 'px';
            overlay.style.top  = Math.max(8, oy) + 'px';
            overlay.classList.add('visible');
            setTimeout(() => box.focus(), 40);
        }
        return;
    }

    // ‚îÄ‚îÄ SELECT tool ‚îÄ‚îÄ
    if (s.tool === 'select') {
        // If we have a floating selection, check if click is inside ‚Üí start dragging
        if (s._sel && s._sel.phase === 'float') {
            const sel = s._sel;
            if (pos.x >= sel.x && pos.x <= sel.x + sel.w && pos.y >= sel.y && pos.y <= sel.y + sel.h) {
                sel.phase = 'drag';
                sel.dragOffX = pos.x - sel.x;
                sel.dragOffY = pos.y - sel.y;
                s.drawing = true;
                return;
            } else {
                // Clicked outside ‚Äî commit and start fresh
                _commitSelection(id);
            }
        }
        // Start drawing a new selection rectangle (NO cutting yet)
        s._sel = { phase: 'select', startX: pos.x, startY: pos.y, x: pos.x, y: pos.y, w: 0, h: 0, img: null, _origX:0, _origY:0, _snapshot: null };
        s.drawing = true;
        return;
    }

    // ‚îÄ‚îÄ If there's a floating selection and user uses another tool, commit it ‚îÄ‚îÄ
    if (s._sel && s._sel.phase === 'float') { _commitSelection(id); }

    // ‚îÄ‚îÄ Shape tools (rect, circle, line, arrow) ‚îÄ‚îÄ
    const SHAPE_TOOLS = ['rect','circle','line','arrow'];
    if (SHAPE_TOOLS.includes(s.tool)) {
        // Save snapshot before shape starts
        s._shapeStart = { x: pos.x, y: pos.y };
        s._shapeSnapshot = canvas.toDataURL();
        s.drawing = true;
        return;
    }

    // ‚îÄ‚îÄ PEN / HIGHLIGHTER / ERASER ‚îÄ‚îÄ
    s.drawing = true;
    s.ctx.beginPath();
    s.ctx.moveTo(pos.x, pos.y);
}

function _annotDraw(e, id, canvas) {
    const s = _annotState[id]; if (!s || !s.drawing) return;
    const pos = _getPos(e, canvas);

    // ‚îÄ‚îÄ SELECT: drawing selection rectangle ‚îÄ‚îÄ
    if (s.tool === 'select' && s._sel && s._sel.phase === 'select') {
        const sel = s._sel;
        sel.x = Math.min(sel.startX, pos.x);
        sel.y = Math.min(sel.startY, pos.y);
        sel.w = Math.abs(pos.x - sel.startX);
        sel.h = Math.abs(pos.y - sel.startY);
        _redrawAnnotCanvas(id);
        // Draw live selection rectangle
        s.ctx.save();
        s.ctx.strokeStyle = '#3b82f6';
        s.ctx.lineWidth = 1.5;
        s.ctx.setLineDash([6, 3]);
        s.ctx.strokeRect(sel.x, sel.y, sel.w, sel.h);
        s.ctx.fillStyle = 'rgba(59,130,246,0.06)';
        s.ctx.fillRect(sel.x, sel.y, sel.w, sel.h);
        s.ctx.restore();
        return;
    }

    // ‚îÄ‚îÄ SELECT: dragging floating selection ‚îÄ‚îÄ
    if (s.tool === 'select' && s._sel && s._sel.phase === 'drag') {
        s._sel.x = pos.x - s._sel.dragOffX;
        s._sel.y = pos.y - s._sel.dragOffY;
        _redrawAnnotCanvas(id);
        return;
    }

    // ‚îÄ‚îÄ SHAPE TOOLS: live preview ‚îÄ‚îÄ
    const SHAPE_TOOLS = ['rect','circle','line','arrow'];
    if (SHAPE_TOOLS.includes(s.tool) && s._shapeStart && s._shapeSnapshot) {
        // Restore snapshot then draw preview
        const snapImg = new Image();
        snapImg.onload = () => {
            s.ctx.clearRect(0, 0, canvas.width, canvas.height);
            s.ctx.drawImage(snapImg, 0, 0);
            _drawShape(s.ctx, s.tool, s._shapeStart.x, s._shapeStart.y, pos.x, pos.y, s.color, s.size);
        };
        snapImg.src = s._shapeSnapshot;
        return;
    }

    // ‚îÄ‚îÄ ERASER ‚îÄ‚îÄ
    if (s.tool === 'eraser') {
        s.ctx.clearRect(pos.x - s.size*2, pos.y - s.size*2, s.size*4, s.size*4);
        return;
    }

    // ‚îÄ‚îÄ HIGHLIGHTER ‚îÄ‚îÄ
    if (s.tool === 'highlighter') {
        s.ctx.save();
        s.ctx.globalAlpha = 0.35;
        s.ctx.strokeStyle = s.color;
        s.ctx.lineWidth = s.size * 5;
        s.ctx.lineCap = 'square';
        s.ctx.lineJoin = 'square';
        s.ctx.lineTo(pos.x, pos.y);
        s.ctx.stroke();
        s.ctx.restore();
        return;
    }

    // ‚îÄ‚îÄ PEN ‚îÄ‚îÄ
    s.ctx.strokeStyle = s.color;
    s.ctx.lineWidth = s.size;
    s.ctx.lineCap = 'round';
    s.ctx.lineJoin = 'round';
    s.ctx.lineTo(pos.x, pos.y);
    s.ctx.stroke();
}

function _annotStop(id) {
    const s = _annotState[id]; if (!s) return;

    // ‚îÄ‚îÄ SELECT: finished drawing selection rect ‚Üí lift the area without cutting ‚îÄ‚îÄ
    if (s.tool === 'select' && s._sel && s._sel.phase === 'select' && s.drawing) {
        s.drawing = false;
        const sel = s._sel;
        if (sel.w < 4 || sel.h < 4) { s._sel = null; _redrawAnnotCanvas(id); return; }
        const c = document.getElementById('annot-canvas-'+id); if (!c) return;
        // Capture selected pixels as image (for preview when dragging)
        const selCanvas = document.createElement('canvas');
        selCanvas.width = sel.w; selCanvas.height = sel.h;
        selCanvas.getContext('2d').drawImage(c, sel.x, sel.y, sel.w, sel.h, 0, 0, sel.w, sel.h);
        const selImg = new Image();
        selImg.onload = () => {
            sel.img = selImg;
            sel._origX = sel.x; sel._origY = sel.y;
            // Save a snapshot of the canvas BEFORE erasing the selected area
            sel._snapshot = c.toDataURL();
            sel.phase = 'float';
            _redrawAnnotCanvas(id);
        };
        selImg.src = selCanvas.toDataURL();
        return;
    }

    // ‚îÄ‚îÄ SELECT: finished dragging ‚îÄ‚îÄ
    if (s.tool === 'select' && s._sel && s._sel.phase === 'drag' && s.drawing) {
        s.drawing = false;
        s._sel.phase = 'float';
        _redrawAnnotCanvas(id);
        return;
    }

    // ‚îÄ‚îÄ SHAPE TOOLS: commit final shape ‚îÄ‚îÄ
    const SHAPE_TOOLS = ['rect','circle','line','arrow'];
    if (SHAPE_TOOLS.includes(s.tool) && s._shapeStart && s._shapeSnapshot && s.drawing) {
        s.drawing = false;
        // The shape is already drawn in the live preview; just save history
        s._shapeStart = null;
        s._shapeSnapshot = null;
        _saveAnnotHistory(id);
        return;
    }

    if (!s.drawing) return;
    s.drawing = false;
    if (s.tool === 'highlighter') { s.ctx.restore && s.ctx.restore(); }
    _saveAnnotHistory(id);
}

function _saveAnnotHistory(id) {
    const s = _annotState[id]; if (!s) return;
    const c = document.getElementById('annot-canvas-'+id); if (!c) return;
    s.history.push(c.toDataURL());
    if (s.history.length > 40) s.history.shift();
}

// ‚îÄ‚îÄ Inline text overlay handlers ‚îÄ‚îÄ
window._annotTextOk = () => {
    const overlay = document.getElementById('annot-text-input-overlay');
    const box = document.getElementById('annot-text-input-box');
    if (!overlay || !box) return;
    // Find which assignment is active
    let id = null;
    for (const key of Object.keys(_annotState)) {
        if (_annotState[key]._textPending && _annotState[key]._textPending.assignId === key) { id = key; break; }
    }
    // Try all states
    if (!id) {
        for (const key of Object.keys(_annotState)) {
            if (_annotState[key]._textPending) { id = key; break; }
        }
    }
    overlay.classList.remove('visible');
    if (!id) return;
    const s = _annotState[id];
    const txt = box.value.trim();
    if (txt && s && s.ctx && s._textPending) {
        const { canvasX, canvasY } = s._textPending;
        s.ctx.save();
        s.ctx.font = `bold ${s.fontSize || 18}px Inter, sans-serif`;
        s.ctx.fillStyle = s.color;
        s.ctx.globalAlpha = 1;
        // Multi-line support
        const lines = txt.split('\n');
        const lineH = (s.fontSize || 18) * 1.35;
        lines.forEach((line, i) => s.ctx.fillText(line, canvasX, canvasY + i * lineH));
        s.ctx.restore();
        _saveAnnotHistory(id);
    }
    s._textPending = null;
};
window._annotTextCancel = () => {
    const overlay = document.getElementById('annot-text-input-overlay');
    if (overlay) overlay.classList.remove('visible');
    for (const key of Object.keys(_annotState)) { _annotState[key]._textPending = null; }
};

window.setAnnotTool = (id, tool) => {
    const s = _annotState[id]; if (!s) return;

    // Commit any floating selection when switching tools
    if (s._sel && s._sel.phase === 'float' && tool !== 'select') {
        _commitSelection(id);
    }
    // Close text overlay
    const overlay = document.getElementById('annot-text-input-overlay');
    if (overlay && overlay.classList.contains('visible')) window._annotTextCancel();

    s.tool = tool;
    const allTools = ['select','pen','highlighter','text','rect','circle','arrow','line','eraser'];
    allTools.forEach(t => {
        const btn = document.getElementById('tool-'+t+'-'+id);
        if (!btn) return;
        btn.classList.toggle('active', t === tool);
    });
    const hints = {
        select:      '<i class="fas fa-mouse-pointer mr-1"></i>Select ‚Äî drag a rectangle to pick, then drag to move',
        pen:         '<i class="fas fa-pen mr-1"></i>Pen ‚Äî click and drag to draw',
        highlighter: '<i class="fas fa-highlighter mr-1"></i>Highlighter ‚Äî drag to highlight text',
        text:        '<i class="fas fa-font mr-1"></i>Text ‚Äî click where you want to type',
        rect:        '<i class="fas fa-square mr-1"></i>Rectangle ‚Äî drag to draw a rectangle',
        circle:      '<i class="fas fa-circle mr-1"></i>Circle ‚Äî drag to draw an ellipse',
        arrow:       '<i class="fas fa-arrow-right mr-1"></i>Arrow ‚Äî drag to draw an arrow',
        line:        '<i class="fas fa-minus mr-1"></i>Line ‚Äî drag to draw a straight line',
        eraser:      '<i class="fas fa-eraser mr-1"></i>Eraser ‚Äî drag to erase areas'
    };
    const hint = document.getElementById('annot-hint-'+id);
    if (hint) hint.innerHTML = hints[tool] || '';

    const canvas = document.getElementById('annot-canvas-'+id);
    if (canvas) {
        canvas.style.cursor = tool === 'select' ? 'default' : tool === 'text' ? 'text' : 'crosshair';
    }
};

window.setAnnotColor = (id, color) => {
    const s = _annotState[id]; if (!s) return;
    s.color = color;
    if (s.tool === 'eraser') setAnnotTool(id, 'pen');
    document.querySelectorAll(`#ws-modal-${id} .color-dot`).forEach(dot => {
        dot.classList.toggle('active', dot.dataset.color === color);
    });
};

window.undoAnnot = (id) => {
    const s = _annotState[id]; if (!s) return;
    // If there's a floating selection, cancel it (restore original)
    if (s._sel) {
        _cancelSelection(id);
        return;
    }
    if (s.history.length < 2) return;
    s.history.pop();
    const c = document.getElementById('annot-canvas-'+id); if (!c) return;
    const img = new Image();
    img.onload = () => { s.ctx.clearRect(0,0,c.width,c.height); s.ctx.drawImage(img,0,0); };
    img.src = s.history[s.history.length-1];
};

window.clearAnnotCanvas = (id) => {
    const s = _annotState[id]; if (!s) return;
    s._sel = null; // drop any selection
    const c = document.getElementById('annot-canvas-'+id); if (!c) return;
    s.ctx.clearRect(0,0,c.width,c.height);
    _saveAnnotHistory(id);
};

/** Zoom controls for annotation workspace */
window.annotZoom = (id, delta) => {
    const s = _annotState[id];
    const wrapper = document.getElementById('annot-wrapper-'+id);
    const bgImg = document.getElementById('annot-bg-'+id);
    const bgCanvas = document.getElementById('annot-bg-canvas-'+id);
    const canvas = document.getElementById('annot-canvas-'+id);
    if (!wrapper || !canvas) return;

    // Initialize zoom state if needed
    if (!s._zoom) s._zoom = 1;

    if (delta === 'fit') {
        const parentW = wrapper.parentElement?.clientWidth || wrapper.clientWidth;
        const canvasW = canvas.width || 580;
        s._zoom = Math.min(parentW / canvasW, 2);
    } else {
        s._zoom = Math.max(0.25, Math.min(4, s._zoom + delta));
    }

    const scale = s._zoom;
    const transformCSS = `transform-origin:top left;transform:scale(${scale});`;
    if (bgImg) bgImg.style.cssText += transformCSS;
    if (bgCanvas) bgCanvas.style.cssText += transformCSS;
    canvas.style.cssText += transformCSS;
    wrapper.style.width = (canvas.width * scale) + 'px';
    wrapper.style.height = (canvas.height * scale) + 'px';

    // Update label
    const label = document.getElementById('zoom-level-'+id);
    if (label) label.textContent = Math.round(scale * 100) + '%';
};

window.wsTab = (id, tab) => {
    ['view','annotate','submit'].forEach(t => {
        const content = document.getElementById('wscontent-'+t+'-'+id);
        const btn = document.getElementById('wstab-'+t+'-'+id);
        if (content) content.classList.toggle('hidden', t !== tab);
        if (btn) btn.classList.toggle('active', t === tab);
    });
    
    // Initialize annotation canvas when switching to annotate tab
    if (tab === 'annotate') {
        const s = _annotState[id];
        if (!s || !s.ctx) {
            // Small delay to let the tab content become visible so offsetWidth/Height work
            setTimeout(() => initAnnotCanvas(id), 80);
        } else {
            // Resync canvas size after tab switch
            setTimeout(() => {
                const canvas = document.getElementById('annot-canvas-'+id);
                if (!canvas) return;
                const bgImg = document.getElementById('annot-bg-'+id);
                const bgFrame = document.getElementById('annot-bg-frame-'+id);
                if (bgImg && bgImg.complete && bgImg.naturalWidth > 0 && bgImg.offsetWidth > 0) {
                    canvas.width = bgImg.offsetWidth;
                    canvas.height = bgImg.offsetHeight;
                    canvas.style.width = bgImg.offsetWidth + 'px';
                    canvas.style.height = bgImg.offsetHeight + 'px';
                    _restoreAnnotHistory(id);
                } else if (bgFrame && bgFrame.offsetWidth > 0) {
                    canvas.width = bgFrame.offsetWidth;
                    canvas.height = bgFrame.offsetHeight;
                    canvas.style.width = bgFrame.offsetWidth + 'px';
                    canvas.style.height = bgFrame.offsetHeight + 'px';
                    _restoreAnnotHistory(id);
                }
            }, 80);
        }
    }
    
    if (tab === 'submit') _updateAnnotPreview(id);
};

async function _updateAnnotPreview(id) {
    const canvas = document.getElementById('annot-canvas-'+id);
    const preview = document.getElementById('annot-preview-'+id);
    const previewImg = document.getElementById('annot-preview-img-'+id);
    if (!canvas || !preview || !previewImg) return;
    const s = _annotState[id];

    // Check current canvas for content
    const data = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height).data;
    let hasContent = Array.from(data).some((v,i) => i%4===3 && v>0);

    // Also check saved page annotations for multi-page PDFs
    if (!hasContent && s && s._pageAnnotations) {
        hasContent = Object.values(s._pageAnnotations).some(v => v && v !== '' && v !== 'data:,');
    }

    if (hasContent) {
        preview.classList.remove('hidden');
        previewImg.src = await _getMergedAnnotation(id);
    } else {
        preview.classList.add('hidden');
    }
}

// ‚îÄ‚îÄ Merge background + annotations into one image (async, CORS-safe) ‚îÄ‚îÄ
// For multi-page PDFs, merges ALL pages that have annotations into a single tall image
async function _getMergedAnnotation(id) {
    const s = _annotState[id]; if (!s) return '';
    const annotCanvas = document.getElementById('annot-canvas-'+id);

    // Commit any floating selection first
    if (s._sel && s._sel.phase === 'float') { _commitSelection(id); }

    // ‚îÄ‚îÄ Save current file's state before merging ‚îÄ‚îÄ
    _saveCurrentFileAnnotState(id, s._fileIdx);

    // ‚îÄ‚îÄ Helper: merge single file (url, isImage, isPdf, saved fileState) into canvas ‚îÄ‚îÄ
    const _mergeOneFile = async (fileObj, fileState) => {
        const { url, isImage: img, isPdf: pdf, name } = fileObj;
        const history         = fileState?.history          || [];
        const pageAnnotations = fileState?.pageAnnotations  || {};
        const pdfDoc          = fileState?.pdfDoc           || null;
        const pdfPage         = fileState?.pdfPage          || 1;
        const pdfTotal        = fileState?.pdfTotal         || 0;
        const bgOffscreenImg  = fileState?.bgOffscreenImg   || null;

        const pageCanvases = [];

        // ‚îÄ‚îÄ Multi-page PDF ‚îÄ‚îÄ
        if (pdf && pdfDoc && pdfTotal > 1) {
            const annotatedPages = [];
            for (let p = 1; p <= pdfTotal; p++) {
                if (pageAnnotations[p] && pageAnnotations[p] !== '' && pageAnnotations[p] !== 'data:,') {
                    annotatedPages.push(p);
                }
            }
            // If only 1 page annotated (current page not saved yet)
            if (annotatedPages.length === 0 && history.length > 0) {
                annotatedPages.push(pdfPage);
            }
            for (const pageNum of annotatedPages) {
                try {
                    const page = await pdfDoc.getPage(pageNum);
                    const baseVp = page.getViewport({ scale: 1 });
                    const pScale = Math.max(1, 800 / baseVp.width);
                    const vp = page.getViewport({ scale: pScale });
                    const pc = document.createElement('canvas');
                    pc.width = vp.width; pc.height = vp.height;
                    const pCtx = pc.getContext('2d');
                    pCtx.fillStyle = '#ffffff'; pCtx.fillRect(0, 0, vp.width, vp.height);
                    await page.render({ canvasContext: pCtx, viewport: vp }).promise;
                    const annotDataUrl = pageAnnotations[pageNum];
                    if (annotDataUrl && annotDataUrl !== 'data:,') {
                        const aImg = await new Promise(r => { const i=new Image(); i.onload=()=>r(i); i.onerror=()=>r(null); i.src=annotDataUrl; });
                        if (aImg) pCtx.drawImage(aImg, 0, 0, vp.width, vp.height);
                    }
                    pCtx.save(); pCtx.fillStyle='rgba(0,0,0,0.45)'; pCtx.font='bold 13px Inter,sans-serif';
                    pCtx.fillText(`${name} ‚Äî Page ${pageNum}`, 10, vp.height-10); pCtx.restore();
                    pageCanvases.push(pc);
                } catch(e) { console.warn('PDF page render failed', e); }
            }
        } else {
            // ‚îÄ‚îÄ Single page / image / other ‚îÄ‚îÄ
            let w = 580, h = 380;
            // Try to get size from history snapshot
            if (history.length > 0) {
                const snapImg = await new Promise(r => {
                    const i = new Image();
                    i.onload = () => r(i); i.onerror = () => r(null);
                    i.src = history[history.length - 1];
                });
                if (snapImg) { w = snapImg.width; h = snapImg.height; }
            }
            const pc = document.createElement('canvas'); pc.width = w; pc.height = h;
            const pCtx = pc.getContext('2d');
            pCtx.fillStyle = '#ffffff'; pCtx.fillRect(0, 0, w, h);
            // Draw background
            let bgDrawn = false;
            if (pdf && pdfDoc) {
                try {
                    const page = await pdfDoc.getPage(pdfPage);
                    const vp = page.getViewport({ scale: w / page.getViewport({scale:1}).width });
                    pc.height = vp.height;
                    pCtx.fillStyle = '#ffffff'; pCtx.fillRect(0,0,pc.width,pc.height);
                    await page.render({ canvasContext: pCtx, viewport: vp }).promise;
                    bgDrawn = true;
                } catch(e) {}
            }
            if (!bgDrawn && bgOffscreenImg) {
                try { pCtx.drawImage(bgOffscreenImg, 0, 0, w, h); bgDrawn = true; } catch(e) {}
            }
            if (!bgDrawn && img && url) {
                try {
                    const resp = await fetch(url, { mode:'cors' });
                    const blob = await resp.blob();
                    const blobUrl = URL.createObjectURL(blob);
                    const bImg = await new Promise((res,rej) => { const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=blobUrl; });
                    pCtx.drawImage(bImg, 0, 0, w, h);
                    URL.revokeObjectURL(blobUrl);
                    bgDrawn = true;
                } catch(e) {}
            }
            // Draw annotation layer (last history state)
            if (history.length > 0) {
                const aImg = await new Promise(r => { const i=new Image(); i.onload=()=>r(i); i.onerror=()=>r(null); i.src=history[history.length-1]; });
                if (aImg) pCtx.drawImage(aImg, 0, 0, pc.width, pc.height);
            }
            pageCanvases.push(pc);
        }
        return pageCanvases;
    };

    // ‚îÄ‚îÄ Check which files actually have annotations ‚îÄ‚îÄ
    const fileCanvasGroups = [];
    for (let fi = 0; fi < s._files.length; fi++) {
        const fState = s._fileStates[fi];
        const hist = fState?.history || (fi === s._fileIdx ? s.history : []);
        const pages = fState?.pageAnnotations || (fi === s._fileIdx ? s._pageAnnotations : {});
        const hasAnnot = hist.length > 0 || Object.values(pages).some(v => v && v !== '');
        if (!hasAnnot) continue;
        const fObj = s._files[fi];
        const resolvedState = fi === s._fileIdx
            ? { history: s.history, pageAnnotations: s._pageAnnotations, pdfDoc: s._pdfDoc, pdfPage: s._pdfPage, pdfTotal: s._pdfTotal, bgOffscreenImg: s._bgOffscreenImg }
            : fState;
        const canvases = await _mergeOneFile(fObj, resolvedState);
        if (canvases.length > 0) {
            // Add file label header if multiple files
            if (s._files.length > 1) {
                const labelC = document.createElement('canvas');
                labelC.width = canvases[0].width; labelC.height = 28;
                const lCtx = labelC.getContext('2d');
                lCtx.fillStyle = '#059669'; lCtx.fillRect(0,0,labelC.width,28);
                lCtx.fillStyle = '#fff'; lCtx.font = 'bold 13px Inter,sans-serif';
                lCtx.fillText(`üìé File ${fi+1}: ${fObj.name}`, 10, 19);
                fileCanvasGroups.push(labelC, ...canvases);
            } else {
                fileCanvasGroups.push(...canvases);
            }
        }
    }

    if (fileCanvasGroups.length === 0) return '';

    // ‚îÄ‚îÄ Stack all canvases vertically ‚îÄ‚îÄ
    const gap = 10;
    const totalW = Math.max(...fileCanvasGroups.map(c => c.width));
    const totalH = fileCanvasGroups.reduce((h, c) => h + c.height + gap, -gap);
    const final = document.createElement('canvas');
    final.width = totalW; final.height = totalH;
    const fCtx = final.getContext('2d');
    fCtx.fillStyle = '#f3f4f6'; fCtx.fillRect(0,0,totalW,totalH);
    let yOff = 0;
    for (const c of fileCanvasGroups) {
        fCtx.drawImage(c, 0, yOff); yOff += c.height + gap;
    }
    return final.toDataURL('image/png');
}

// ‚îÄ‚îÄ PREVIEW & SUBMIT ANNOTATION (from annotate tab) ‚îÄ‚îÄ
window.previewAnnotation = async (id) => {
    const preview = document.getElementById('annot-live-preview-'+id);
    const previewImg = document.getElementById('annot-live-preview-img-'+id);
    if (!preview || !previewImg) return;
    const s = _annotState[id];

    // Save current page first
    if (s && s.isPdf) _saveCurrentPageAnnot(id);

    // Check current canvas AND saved pages for any content
    const canvas = document.getElementById('annot-canvas-'+id);
    let hasContent = false;
    if (canvas && canvas.width > 0) {
        const data = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height).data;
        hasContent = Array.from(data).some((v,i) => i%4===3 && v>0);
    }
    if (!hasContent && s && s._pageAnnotations) {
        hasContent = Object.values(s._pageAnnotations).some(v => v && v !== '' && v !== 'data:,');
    }
    if (!hasContent) {
        alert('Nothing drawn yet ‚Äî use the tools above to annotate first.');
        return;
    }

    preview.classList.remove('hidden');
    previewImg.src = '';
    previewImg.alt = 'Generating preview...';
    const merged = await _getMergedAnnotation(id);
    if (merged) {
        previewImg.src = merged;
        previewImg.alt = 'Annotation preview';
    } else {
        previewImg.alt = 'Could not generate preview';
    }
};

window.submitAnnotation = async (id) => {
    const s = _annotState[id];

    // Save current file + page state first
    _saveCurrentFileAnnotState(id, s._fileIdx);
    if (s && s.isPdf) _saveCurrentPageAnnot(id);

    // Check ALL files (not just current canvas) for any annotation content
    let hasContent = false;
    for (let fi = 0; fi < (s?._files?.length || 0); fi++) {
        const fState = s._fileStates[fi];
        const hist = fState?.history || (fi === s._fileIdx ? s.history : []);
        const pages = fState?.pageAnnotations || (fi === s._fileIdx ? s._pageAnnotations : {});
        if (hist.length > 0 || Object.values(pages).some(v => v && v !== '')) { hasContent = true; break; }
    }
    // Also check live canvas
    const canvas = document.getElementById('annot-canvas-'+id);
    if (!hasContent && canvas && canvas.width > 0) {
        try {
            const data = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height).data;
            hasContent = Array.from(data).some((v,i) => i%4===3 && v>0);
        } catch(e) {}
    }
    if (!hasContent) { alert('Nothing drawn yet ‚Äî use the tools above to annotate first.'); return; }

    const btn = document.getElementById('annot-submit-btn-'+id);
    const origHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Merging & uploading...';
    btn.disabled = true;

    try {
        // 1) Merge background + annotations (handles multi-page)
        const mergedDataUrl = await _getMergedAnnotation(id);
        if (!mergedDataUrl) throw new Error('Failed to generate merged annotation');

        // 2) Upload to Cloudinary
        const mergedBlob = await (await fetch(mergedDataUrl)).blob();
        const fd = new FormData();
        fd.append('file', mergedBlob, 'annotation.png');
        fd.append('upload_preset', CLOUDINARY.preset);
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/upload`, {method:'POST', body:fd});
        const d = await res.json();
        const annotUrl = d.secure_url || '';
        if (!annotUrl) throw new Error('Upload failed');

        // 3) Update Firestore assignment
        const annotatedFileCount = (s?._files||[]).filter((_,fi) => {
            const fs = s._fileStates[fi];
            return (fs?.history?.length||0) > 0 || Object.values(fs?.pageAnnotations||{}).some(v=>v&&v!=='');
        }).length || 1;
        await updateDoc(doc(db,'homework_assignments',id), {
            status: 'submitted',
            submittedAt: new Date(),
            annotationUrl: annotUrl,
            annotationSubmittedAt: new Date(),
            hasAnnotation: true,
            annotatedFileCount: annotatedFileCount,
            totalFileCount: (s?._files?.length||1)
        });

        // 4) Send to tutor's conversation AND create tutor notification
        if (window.currentStudent) {
            try {
                const convSnap = await getDocs(query(collection(db,'conversations'), where('studentId','==',window.currentStudent.id)));
                const convId = convSnap.docs[0]?.id;
                const convData = convSnap.docs[0]?.data();
                const tutorId = convData?.tutorId || convData?.teacherId || null;

                if (convId) {
                    const assignSnap = await getDoc(doc(db,'homework_assignments',id));
                    const aTitle = assignSnap.exists() ? (assignSnap.data().title||'Assignment') : 'Assignment';
                    const pageCount = s && s._pageAnnotations ? Object.keys(s._pageAnnotations).filter(k => s._pageAnnotations[k] && s._pageAnnotations[k] !== '').length : 0;
                    const pageNote = pageCount > 1 ? ` (${pageCount} pages annotated)` : '';
                    const fileNote = (s?._files?.length||1) > 1 ? ` ‚Äî ${annotatedFileCount} of ${s._files.length} files annotated` : pageNote;
                    // Message in conversation
                    await addDoc(collection(db,'conversations',convId,'messages'), {
                        content: `üìù Annotated work for: "${aTitle}"${fileNote}`,
                        imageUrl: annotUrl,
                        senderId: window.currentStudent.id,
                        senderName: window.currentStudent.name,
                        senderRole: 'student',
                        createdAt: new Date(),
                        read: false,
                        type: 'annotation_submission',
                        assignmentId: id,
                        assignmentTitle: aTitle,
                        annotationUrl: annotUrl
                    });
                    const cSnap = await getDoc(doc(db,'conversations',convId));
                    const cur = cSnap.exists() ? (cSnap.data().unreadCount||0) : 0;
                    await updateDoc(doc(db,'conversations',convId), {
                        lastMessage: `üìù ${window.currentStudent.name} submitted annotated work: "${aTitle}"`,
                        lastMessageTimestamp: new Date(),
                        lastSenderId: window.currentStudent.id,
                        unreadCount: cur + 1,
                        hasUnreadAnnotation: true
                    });
                    // Dedicated tutor notification doc
                    if (tutorId) {
                        await addDoc(collection(db,'tutor_notifications'), {
                            tutorId: tutorId,
                            type: 'annotation_submitted',
                            studentId: window.currentStudent.id,
                            studentName: window.currentStudent.name,
                            assignmentId: id,
                            assignmentTitle: aTitle,
                            annotationUrl: annotUrl,
                            convId: convId,
                            createdAt: new Date(),
                            read: false
                        });
                    }
                }
            } catch(msgErr) { console.warn('Could not send to conversation:', msgErr); }
        }

        // 5) Cleanup
        if (_resizeObservers[id]) { _resizeObservers[id].disconnect(); delete _resizeObservers[id]; }
        if (s && s._bgBlobUrl) { URL.revokeObjectURL(s._bgBlobUrl); }
        document.getElementById('ws-modal-'+id)?.remove();
        playNotifSound('general');
        alert('‚úÖ Annotation submitted successfully!');
        await loadAssignments();
        await loadPendingTasks();
    } catch(e) {
        console.error('Annotation submit error:', e);
        btn.innerHTML = origHTML;
        btn.disabled = false;
        alert('Error submitting annotation: ' + e.message);
    }
};

// ‚îÄ‚îÄ SUBMIT WORK (with annotation upload) ‚îÄ‚îÄ
window.submitWork = async (id) => {
    const btn = document.getElementById('submit-btn-'+id);
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Submitting...';
    btn.disabled = true;
    try {
        const txt = document.getElementById('ws-text-'+id)?.value || '';
        const fi = document.getElementById('ws-file-'+id);
        let subUrl = '';

        // Upload attached file (Cloudinary)
        if (fi?.files[0]) {
            const fd = new FormData();
            fd.append('file', fi.files[0]);
            fd.append('upload_preset', CLOUDINARY.preset);
            const r = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/upload`, {method:'POST',body:fd});
            const d = await r.json();
            subUrl = d.secure_url || '';
        }

        // Upload annotation canvas if student drew anything
        let annotUrl = '';
        const _ss = _annotState[id];
        // Save current page for multi-page PDFs
        if (_ss && _ss.isPdf) _saveCurrentPageAnnot(id);
        // Commit any floating selection
        if (_ss && _ss._sel && _ss._sel.phase === 'float') _commitSelection(id);

        const canvas = document.getElementById('annot-canvas-'+id);
        let hasAnnot = false;
        if (canvas && canvas.width > 0) {
            const data = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height).data;
            hasAnnot = Array.from(data).some((v,i) => i%4===3 && v>0);
        }
        if (!hasAnnot && _ss && _ss._pageAnnotations) {
            hasAnnot = Object.values(_ss._pageAnnotations).some(v => v && v !== '' && v !== 'data:,');
        }
        if (hasAnnot) {
            const mergedDataUrl = await _getMergedAnnotation(id);
            if (mergedDataUrl) {
                const mergedBlob = await (await fetch(mergedDataUrl)).blob();
                const fd = new FormData();
                fd.append('file', mergedBlob, 'annotation.png');
                fd.append('upload_preset', CLOUDINARY.preset);
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/upload`, {method:'POST',body:fd});
                const d = await res.json();
                annotUrl = d.secure_url || '';
            }
        }

        // Update assignment in Firestore
        await updateDoc(doc(db,'homework_assignments',id), {
            status: 'submitted',
            submittedAt: new Date(),
            studentWork: txt,
            ...(subUrl ? {submissionUrl:subUrl, submissionFileName:fi.files[0].name} : {}),
            ...(annotUrl ? {annotationUrl:annotUrl} : {})
        });

        // Send annotation + notes to tutor via conversation
        if ((annotUrl || txt) && window.currentStudent) {
            try {
                const convSnap = await getDocs(query(collection(db,'conversations'), where('studentId','==',window.currentStudent.id)));
                const convId = convSnap.docs[0]?.id;
                const convData = convSnap.docs[0]?.data();
                const tutorId = convData?.tutorId || convData?.teacherId || null;
                if (convId) {
                    const assignSnap = await getDoc(doc(db,'homework_assignments',id));
                    const aTitle = assignSnap.exists() ? (assignSnap.data().title||'Assignment') : 'Assignment';
                    const msgContent = `üìé Submitted work for: "${aTitle}"${txt?'\n\nNotes: '+txt:''}`;
                    await addDoc(collection(db,'conversations',convId,'messages'), {
                        content: msgContent,
                        imageUrl: annotUrl || null,
                        senderId: window.currentStudent.id,
                        senderName: window.currentStudent.name,
                        senderRole: 'student',
                        createdAt: new Date(),
                        read: false,
                        type: annotUrl ? 'annotation_submission' : 'work_submission',
                        assignmentId: id,
                        assignmentTitle: aTitle,
                        ...(annotUrl ? {annotationUrl: annotUrl} : {})
                    });
                    const cSnap = await getDoc(doc(db,'conversations',convId));
                    const cur = cSnap.exists() ? (cSnap.data().unreadCount||0) : 0;
                    await updateDoc(doc(db,'conversations',convId), {
                        lastMessage: annotUrl ? `üìé ${window.currentStudent.name} submitted annotated work` : `üìé ${window.currentStudent.name} submitted work`,
                        lastMessageTimestamp: new Date(),
                        lastSenderId: window.currentStudent.id,
                        unreadCount: cur + 1,
                        ...(annotUrl ? {hasUnreadAnnotation: true} : {})
                    });
                    // Dedicated tutor notification doc
                    if (tutorId) {
                        await addDoc(collection(db,'tutor_notifications'), {
                            tutorId: tutorId,
                            type: annotUrl ? 'annotation_submitted' : 'work_submitted',
                            studentId: window.currentStudent.id,
                            studentName: window.currentStudent.name,
                            assignmentId: id,
                            assignmentTitle: aTitle,
                            ...(annotUrl ? {annotationUrl: annotUrl} : {}),
                            ...(subUrl ? {submissionUrl: subUrl} : {}),
                            convId: convId,
                            createdAt: new Date(),
                            read: false
                        });
                    }
                }
            } catch(msgErr) { console.warn('Could not send to conversation:', msgErr); }
        }

        // Clean up resize observer and blob URLs
        if (_resizeObservers[id]) {
            _resizeObservers[id].disconnect();
            delete _resizeObservers[id];
        }
        const _s = _annotState[id];
        if (_s && _s._bgBlobUrl) { URL.revokeObjectURL(_s._bgBlobUrl); }

        // Close modal by its unique ID
        document.getElementById('ws-modal-'+id)?.remove();
        playNotifSound('general');
        alert('‚úÖ Submitted successfully!');
        await loadAssignments();
        await loadPendingTasks();
    } catch(e) {
        btn.innerHTML = '<i class="fas fa-paper-plane mr-1"></i>Submit';
        btn.disabled = false;
        alert('Error submitting: ' + e.message);
    }
};

// ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ
async function loadResults(){
    const c=document.getElementById('results-container');
    try{
        const snap=await getDocs(query(collection(db,'homework_assignments'),where('studentId','==',window.currentStudent.id),where('status','==','graded'),orderBy('gradedAt','desc')));
        if(snap.empty){c.innerHTML='<div class="text-center py-8 text-gray-400">No graded results yet.</div>';return;}
        c.innerHTML=`<div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="border-b border-gray-200 text-left">
            <th class="pb-3 font-semibold text-gray-500">Assignment</th>
            <th class="pb-3 font-semibold text-gray-500">Subject</th>
            <th class="pb-3 font-semibold text-gray-500">Score</th>
            <th class="pb-3 font-semibold text-gray-500">Grade</th>
            <th class="pb-3 font-semibold text-gray-500">Date</th>
            <th class="pb-3 font-semibold text-gray-500">Feedback</th>
        </tr></thead><tbody>
        ${snap.docs.map(d=>{
            const a=d.data();
            const score=parseFloat(a.score)||0;
            const letter=score>=90?'A':score>=80?'B+':score>=70?'B':score>=60?'C+':score>=50?'C':'F';
            const color=score>=75?'text-green-600':score>=50?'text-yellow-600':'text-red-600';
            const dt=a.gradedAt?.toDate?a.gradedAt.toDate().toLocaleDateString():'--';
            return `<tr class="border-b border-gray-50 hover:bg-gray-50">
                <td class="py-3 font-medium text-gray-800">${escH(a.title||'Untitled')}</td>
                <td class="py-3 text-gray-500">${escH(a.subject||'--')}</td>
                <td class="py-3 font-bold ${color}">${score}/100</td>
                <td class="py-3 font-bold ${color}">${letter}</td>
                <td class="py-3 text-gray-500">${escH(dt)}</td>
                <td class="py-3 text-gray-500 italic text-xs max-w-xs truncate">${escH(a.feedback||'--')}</td>
            </tr>`;
        }).join('')}
        </tbody></table></div>`;
    }catch(e){console.error(e);}
}

// ‚îÄ‚îÄ SCHEDULE ‚îÄ‚îÄ
async function loadSchedule(){
    const c=document.getElementById('full-schedule-container');
    const schedule=window.currentStudent.schedule||[];
    if(!schedule.length){c.innerHTML='<div class="text-center py-8 text-gray-400">No schedule set by your tutor yet.</div>';return;}
    const DAYS=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
    const byDay={};DAYS.forEach(d=>{byDay[d]=[];});
    schedule.forEach(s=>{if(byDay[s.day])byDay[s.day].push(s);});
    DAYS.forEach(d=>byDay[d].sort((a,b)=>a.start.localeCompare(b.start)));
    const todayWAT=new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Lagos'})).toLocaleDateString('en-US',{weekday:'long'});
    c.innerHTML=`
    <div class="overflow-x-auto">
        <div style="display:grid;grid-template-columns:repeat(7,minmax(110px,1fr));border-left:1px solid #e5e7eb;border-top:1px solid #e5e7eb;">
        ${DAYS.map(day=>{
            const isToday=day===todayWAT;const cls=byDay[day];
            return `<div style="border-right:1px solid #e5e7eb;">
                <div style="padding:8px 10px;font-weight:700;font-size:.72rem;text-transform:uppercase;background:${isToday?'#ecfdf5':'#f9fafb'};color:${isToday?'#059669':'#6b7280'};border-bottom:1px solid #e5e7eb;">
                    ${day.substring(0,3)} ${isToday?'‚ñ∂':''}
                </div>
                <div style="padding:8px;min-height:80px;">
                ${cls.length?cls.map(slot=>`
                    <div style="background:${isToday?'#ecfdf5':'#f3f4f6'};border:1px solid ${isToday?'#bbf7d0':'#e5e7eb'};border-radius:6px;padding:5px 7px;margin-bottom:4px;font-size:.73rem;">
                        <div style="font-weight:700;color:#1f2937;">${formatSlotTime(slot.start)}</div>
                        <div style="color:#6b7280;">‚Äì ${formatSlotTime(slot.end)}</div>
                        ${slot.subject?`<div style="color:#059669;font-size:.68rem;margin-top:2px;">${escH(slot.subject)}</div>`:''}
                    </div>`).join(''):'<div style="color:#d1d5db;font-size:.7rem;text-align:center;padding:10px;">Free</div>'}
                </div>
            </div>`;
        }).join('')}
        </div>
    </div>
    <div class="mt-4 p-4 bg-blue-50 rounded-xl text-sm text-blue-700">
        <i class="fas fa-info-circle mr-2"></i>All times are in <strong>Nigeria time (WAT / UTC+1)</strong>.
        Your local conversion is shown on the clock above.
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ REAL-TIME NOTIFICATIONS (onSnapshot) ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initRealtimeNotifications() {
    const student = window.currentStudent;
    if (!student) return;

    // Unsubscribe any previous listeners
    _notifUnsubscribers.forEach(u => u());
    _notifUnsubscribers = [];

    // 1. Live pending assignments listener ‚Äî also updates dashboard widgets
    const q1 = query(collection(db,'homework_assignments'), where('studentId','==',student.id), where('status','in',['assigned','pending']));
    _notifUnsubscribers.push(onSnapshot(q1, snap => {
        const prev = _notifData.pending;
        _notifData.pending = snap.size;
        _notifData.pendingDocs = snap.docs.map(d => ({id:d.id,...d.data()}));
        if (_notifLoaded && snap.size > prev) {
            playNotifSound('assignment');
            _ringBell();
        }
        _updateNotifBadge();
        // Update dashboard pending tasks count
        const pendEl = document.getElementById('dash-pending-count');
        if (pendEl) pendEl.textContent = snap.size;
    }, err => console.warn('Notif assignments listener:', err)));

    // 1b. ALL homework listener ‚Äî for average grade, graded count, due-soon
    const q1b = query(collection(db,'homework_assignments'), where('studentId','==',student.id));
    _notifUnsubscribers.push(onSnapshot(q1b, snap => {
        let totalScore = 0, gradedCount = 0, dueSoon = 0;
        const now = new Date();
        snap.docs.forEach(d => {
            const data = d.data();
            if (data.status === 'graded' && data.score != null) {
                totalScore += Number(data.score);
                gradedCount++;
            }
            if ((data.status === 'assigned' || data.status === 'pending') && data.dueDate) {
                const due = new Date(data.dueDate);
                if (!isNaN(due.getTime()) && (due - now) < 48*3600000 && due > now) dueSoon++;
            }
        });
        // Update dashboard average grade
        const avgEl = document.getElementById('dash-avg-grade');
        if (avgEl && gradedCount > 0) {
            const avg = Math.round(totalScore / gradedCount);
            const letter = avg >= 90 ? 'A' : avg >= 80 ? 'B' : avg >= 70 ? 'C' : avg >= 60 ? 'D' : 'F';
            avgEl.textContent = avg + '% (' + letter + ')';
        }
        // Update due-soon indicator
        const dueEl = document.getElementById('dash-due-soon');
        if (dueEl) dueEl.textContent = dueSoon > 0 ? dueSoon + ' due soon' : '';
    }, err => console.warn('Notif all-homework listener:', err)));

    // 2. Live conversations (messages) listener
    const q2 = query(collection(db,'conversations'), where('studentId','==',student.id));
    _notifUnsubscribers.push(onSnapshot(q2, snap => {
        let msgCount = 0;
        _notifData.convs = snap.docs.map(d => ({id:d.id,...d.data()}));
        _notifData.convs.forEach(c => { if(c.unreadCount>0 && c.lastSenderId!==student.id) msgCount++; });
        const prev = _notifData.messages;
        _notifData.messages = msgCount;
        if (_notifLoaded && msgCount > prev) {
            playNotifSound('message');
            _ringBell();
        }
        _updateNotifBadge();
    }, err => console.warn('Notif conversations listener:', err)));

    // 3. New course materials listener
    const q3 = query(collection(db,'course_materials'), where('studentId','==',student.id), orderBy('uploadedAt','desc'), limit(5));
    _notifUnsubscribers.push(onSnapshot(q3, snap => {
        const now = new Date();
        const prev = _notifData.materials.length;
        _notifData.materials = [];
        snap.docs.forEach(d => {
            const m = d.data();
            const dt = m.uploadedAt?.toDate ? m.uploadedAt.toDate() : null;
            if (dt && (now - dt)/86400000 < 7) _notifData.materials.push(m);
        });
        if (_notifLoaded && _notifData.materials.length > prev) {
            playNotifSound('general');
            _ringBell();
        }
        _updateNotifBadge();
    }, err => console.warn('Notif materials listener:', err)));

    // 4. Daily topics listener ‚Äî real-time topic updates
    if (student.tutorEmail) {
        const q4 = query(collection(db,'daily_topics'), where('studentId','==',student.id), orderBy('createdAt','desc'), limit(5));
        _notifUnsubscribers.push(onSnapshot(q4, snap => {
            if (_notifLoaded && snap.docChanges().some(c => c.type === 'added')) {
                // Subtle notification for new topics
                playNotifSound('general');
            }
        }, err => console.warn('Notif topics listener:', err)));
    }

    // 5. Student document listener ‚Äî schedule, subjects, grade changes
    if (student.id) {
        const studentDocRef = doc(db, 'students', student.id);
        _notifUnsubscribers.push(onSnapshot(studentDocRef, snap => {
            if (!snap.exists()) return;
            const data = snap.data();
            // Auto-update schedule widgets when tutor modifies schedule
            const schedEl = document.getElementById('dash-schedule-info');
            if (schedEl && data.schedule) {
                // Update the stored student data
                window.currentStudent = { ...window.currentStudent, ...data, id: snap.id };
            }
            // Update subjects display
            const subjEl = document.getElementById('dash-subjects');
            if (subjEl && data.subjects) {
                const subjs = Array.isArray(data.subjects) ? data.subjects : [data.subjects];
                subjEl.textContent = subjs.join(', ');
            }
        }, err => console.warn('Student doc listener:', err)));
    }

    _notifLoaded = true;
}

function _ringBell() {
    const bellBtn = document.getElementById('bell-btn');
    if (!bellBtn) return;
    bellBtn.classList.remove('bell-ring');
    // Reflow trick to restart animation
    void bellBtn.offsetWidth;
    bellBtn.classList.add('bell-ring');
    setTimeout(() => bellBtn.classList.remove('bell-ring'), 700);
}

function _updateNotifBadge() {
    const total = _notifData.pending + _notifData.messages + _notifData.materials.length;
    const badge = document.getElementById('notification-badge');
    if (!badge) return;
    if (total > 0) {
        badge.textContent = total > 99 ? '99+' : total;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
    // Also update message badge in sidebar
    const msgBadge = document.getElementById('msg-badge');
    if (msgBadge) {
        if (_notifData.messages > 0) { msgBadge.textContent = _notifData.messages; msgBadge.classList.remove('hidden'); }
        else msgBadge.classList.add('hidden');
    }
}

// Build personalized notification dropdown content (called each time bell is clicked)
function _buildNotifList() {
    const list = document.getElementById('notif-list');
    if (!list) return;
    const student = window.currentStudent;
    if (!student) { list.innerHTML = '<div class="py-6 text-center text-gray-400 text-sm">Loading...</div>'; return; }

    const now = new Date();
    const dow = now.getDay();       // 0=Sun
    const dom = now.getDate();      // day of month
    const hour = now.getHours();
    const firstName = student.name.split(' ')[0];

    const items = [];

    // ‚îÄ‚îÄ Real-time: new messages ‚îÄ‚îÄ
    if (_notifData.messages > 0) {
        items.push({
            icon: 'üí¨',
            text: `You have <strong>${_notifData.messages} new message${_notifData.messages!==1?'s':''}</strong> from your tutor`,
            type: 'message', unread: true, time: 'New message'
        });
    }

    // ‚îÄ‚îÄ Real-time: pending assignments (each one listed, max 5) ‚îÄ‚îÄ
    if (_notifData.pendingDocs.length > 0) {
        _notifData.pendingDocs.slice(0,5).forEach(a => {
            const dueStr = a.dueDate ? ` ‚Äî Due: <strong>${escH(a.dueDate)}</strong>` : '';
            items.push({
                icon: 'üìù',
                text: `Assignment pending: <strong>${escH(a.title||'Untitled')}</strong>${dueStr}`,
                type: 'assignment', assignmentId: a.id,
                unread: true, time: 'Pending'
            });
        });
    }

    // ‚îÄ‚îÄ Real-time: new course materials ‚îÄ‚îÄ
    _notifData.materials.forEach(m => {
        items.push({
            icon: 'üìö',
            text: `New material added: <strong>${escH(m.title||'Untitled')}</strong> ‚Äî check My Courses`,
            type: 'material', unread: true, time: 'New this week'
        });
    });

    // ‚îÄ‚îÄ Personalised time-of-day greeting ‚îÄ‚îÄ
    const greetWord = hour < 12 ? 'morning' : hour < 17 ? 'afternoon' : 'evening';
    const tutorPart = student.tutorName ? ` Your tutor <strong>${escH(student.tutorName)}</strong> is here to support you.` : '';
    items.push({
        icon: 'üëã',
        text: `Good ${greetWord}, <strong>${escH(firstName)}</strong>!${tutorPart}`,
        type: 'general', unread: false, time: 'Welcome back'
    });

    // ‚îÄ‚îÄ Day-of-week personalised reminder ‚îÄ‚îÄ
    const DAY_MSGS = {
        1: `üóìÔ∏è <strong>New week, ${escH(firstName)}!</strong> Monday is perfect for reviewing last week and planning this week's goals.`,
        2: `‚úèÔ∏è <strong>Tuesday study tip:</strong> Break your work into 25-min sessions with short breaks for best focus.`,
        3: `üìñ <strong>Mid-week check-in!</strong> How's the homework going? Stay consistent ‚Äî small daily effort adds up fast.`,
        4: `üí° <strong>Thursday motivation:</strong> Almost there! Push through today and you'll thank yourself tomorrow.`,
        5: `üéâ <strong>Friday, ${escH(firstName)}!</strong> Finish strong, review your notes, then enjoy the weekend.`,
        6: `‚òÄÔ∏è <strong>Saturday reminder:</strong> A little weekend reading keeps knowledge fresh ‚Äî just 20 mins helps!`,
        0: `üìó <strong>Sunday tip:</strong> Use today to preview what's coming this week ‚Äî a quick look makes lessons easier.`
    };
    items.push({ icon: 'üìÖ', text: DAY_MSGS[dow] || '', type: 'general', unread: false, time: 'Today' });

    // ‚îÄ‚îÄ Rotating daily tip (changes each day based on date number) ‚îÄ‚îÄ
    const DAILY_TIPS = [
        `üí° Reading 20 minutes daily boosts your vocabulary and comprehension dramatically over time.`,
        `üß† Spaced repetition works: review a topic after 1 day, 1 week, then 1 month for strong memory.`,
        `üéØ Set one specific learning goal before each study session ‚Äî it makes everything more focused.`,
        `üìä Consistency beats cramming every time. 30 minutes daily beats 5 hours the night before.`,
        `üí™ You're making progress, ${escH(firstName)}! Every assignment you complete is a step forward.`,
        `üåü If anything is unclear, ask your tutor straight away ‚Äî that's exactly what they're here for.`,
        `‚úçÔ∏è Writing notes in your own words helps your brain process and remember better than just reading.`,
        `üîÑ Practice past questions ‚Äî it's one of the most effective ways to prepare for assessments.`,
        `‚è∞ Study at your peak energy time. Morning person? Study early. Night owl? Use those evening hours.`,
        `üìù Completing homework on time isn't just a grade ‚Äî it builds the discipline that leads to success.`,
    ];
    const tipIdx = dom % DAILY_TIPS.length;
    items.push({ icon: '‚ú®', text: DAILY_TIPS[tipIdx], type: 'general', unread: false, time: 'Tip of the day' });

    // ‚îÄ‚îÄ Monthly milestones ‚îÄ‚îÄ
    if (dom <= 3) items.push({ icon: 'üìÖ', text: `<strong>New month!</strong> Great time to set fresh goals and check your progress, ${escH(firstName)}.`, type: 'general', unread: true, time: 'Monthly' });
    if (dom >= 14 && dom <= 16) items.push({ icon: 'üìä', text: `<strong>Mid-month check-in!</strong> Have you reviewed all your subjects this month?`, type: 'general', unread: false, time: 'Mid-month' });
    if (dom >= 28) items.push({ icon: 'üèÅ', text: `<strong>End of month coming!</strong> Great time to review what you've learned and prep for next month.`, type: 'general', unread: false, time: 'End of month' });

    // ‚îÄ‚îÄ Performance-based message (if we have avg grade) ‚îÄ‚îÄ
    const avgEl = document.getElementById('average-grade');
    if (avgEl && avgEl.textContent !== '--') {
        const avgText = avgEl.textContent;
        const avgNum = parseInt(avgText);
        if (!isNaN(avgNum)) {
            let perfMsg = '';
            if (avgNum >= 90) perfMsg = `üèÜ Outstanding work, ${escH(firstName)}! Your average of <strong>${avgText}</strong> is excellent ‚Äî keep it up!`;
            else if (avgNum >= 75) perfMsg = `‚≠ê Great job! Your average of <strong>${avgText}</strong> is really solid. Keep pushing for that A!`;
            else if (avgNum >= 60) perfMsg = `üìà Your average is <strong>${avgText}</strong>. You're doing well ‚Äî a bit more practice will push you higher!`;
            else if (avgNum > 0) perfMsg = `üí™ Current average: <strong>${avgText}</strong>. Let's work together to improve ‚Äî you've got this, ${escH(firstName)}!`;
            if (perfMsg) items.push({ icon: 'üìä', text: perfMsg, type: 'general', unread: false, time: 'Your performance' });
        }
    }

    if (!items.length) {
        list.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">üéâ All caught up!</div>';
        return;
    }

    list.innerHTML = items.map(n => {
        const isClickable = n.type === 'message' || n.type === 'assignment' || n.type === 'material';
        return `<div class="notif-item ${n.unread?'unread':''} ${isClickable?'clickable':''}"
            data-type="${n.type}" data-assignment-id="${n.assignmentId||''}"
            onclick="handleNotifClick(this)">
            <div class="text-gray-800">${n.text}</div>
            <div class="text-gray-400 text-xs mt-0.5">${n.time}</div>
        </div>`;
    }).join('');
}

window.toggleNotifications = () => {
    const dd = document.getElementById('notif-dropdown');
    const wasHidden = dd.classList.contains('hidden');
    dd.classList.toggle('hidden');
    if (wasHidden) _buildNotifList(); // Rebuild fresh each time it opens
};

window.markAllRead = () => {
    _notifData.messages = 0;
    document.querySelectorAll('.notif-item.unread').forEach(el => el.classList.remove('unread'));
    _updateNotifBadge();
};

// Click handler for notification items
window.handleNotifClick = (el) => {
    el.classList.remove('unread');
    const type = el.dataset.type;
    const aId = el.dataset.assignmentId;
    if (type === 'message') {
        document.getElementById('notif-dropdown').classList.add('hidden');
        switchTab('messages');
    } else if (type === 'assignment' && aId) {
        document.getElementById('notif-dropdown').classList.add('hidden');
        switchTab('assignments');
        // Wait for tab render then open workspace
        setTimeout(() => openWorkspace(aId), 250);
    } else if (type === 'material') {
        document.getElementById('notif-dropdown').classList.add('hidden');
        switchTab('courses');
    }
};

// ‚îÄ‚îÄ MESSAGING ‚îÄ‚îÄ
async function initMessaging(){
    if(studentUnsubInbox)studentUnsubInbox();
    const q=query(collection(db,'conversations'),where('studentId','==',window.currentStudent.id));
    studentUnsubInbox=onSnapshot(q,snap=>{
        const convs=snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>{
            const tA=a.lastMessageTimestamp?.toDate?a.lastMessageTimestamp.toDate():new Date(a.lastMessageTimestamp||0);
            const tB=b.lastMessageTimestamp?.toDate?b.lastMessageTimestamp.toDate():new Date(b.lastMessageTimestamp||0);
            return tB-tA;
        });
        renderConvList(convs);
    });
}

function renderConvList(convs){
    const list=document.getElementById('student-conv-list');
    if(!convs.length){list.innerHTML='<div style="padding:20px;text-align:center;color:#9ca3af;font-size:.875rem;">No messages yet.</div>';return;}
    list.innerHTML='';
    convs.forEach(conv=>{
        const name=conv.tutorName||'Tutor';
        const isUnread=conv.unreadCount>0&&conv.lastSenderId!==window.currentStudent.id;
        const last=conv.lastMessage||'';
        const el=document.createElement('div');
        el.style.cssText=`padding:12px 14px;border-bottom:1px solid #f3f4f6;cursor:pointer;display:flex;align-items:center;gap:10px;background:${isUnread?'#eff6ff':'#fff'};`;
        el.innerHTML=`
            <div style="width:38px;height:38px;border-radius:50%;background:${isUnread?'#059669':'#e5e7eb'};color:${isUnread?'#fff':'#6b7280'};display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1rem;flex-shrink:0;">${escH(name.charAt(0).toUpperCase())}</div>
            <div style="flex:1;min-width:0;">
                <div style="font-weight:${isUnread?700:600};font-size:.875rem;color:#1f2937;">${escH(name)}</div>
                <div style="font-size:.75rem;color:#6b7280;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${isUnread?'':'You: '}${escH(last.substring(0,40))}${last.length>40?'‚Ä¶':''}</div>
            </div>
            ${isUnread?`<span style="background:#059669;color:#fff;border-radius:50%;min-width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;padding:0 3px;">${conv.unreadCount}</span>`:''}`;
        el.onmouseover=()=>el.style.background='#f0fdf4';
        el.onmouseout=()=>el.style.background=isUnread?'#eff6ff':'#fff';
        el.onclick=()=>openChat(conv.id,name);
        list.appendChild(el);
    });
}

function openChat(convId,name){
    document.getElementById('student-chat-header').textContent=name;
    document.getElementById('student-chat-inputs').style.display='flex';
    const msgEl=document.getElementById('student-chat-messages');
    msgEl.innerHTML='<div style="text-align:center;margin-top:40px;"><div style="display:inline-block;border:3px solid #059669;border-top-color:transparent;border-radius:50%;width:24px;height:24px;animation:spin .8s linear infinite;"></div></div>';
    updateDoc(doc(db,'conversations',convId),{unreadCount:0}).catch(()=>{});
    if(studentUnsubChat)studentUnsubChat();
    studentUnsubChat=onSnapshot(query(collection(db,'conversations',convId,'messages'),orderBy('createdAt','asc')),snap=>{
        msgEl.innerHTML='';
        snap.forEach(d=>{
            const msg=d.data();
            const isMe=msg.senderId===window.currentStudent.id;
            const wrap=document.createElement('div');
            wrap.style.cssText=`display:flex;flex-direction:column;align-items:${isMe?'flex-end':'flex-start'};`;
            const bubble=document.createElement('div');
            bubble.className=isMe?'chat-me':'chat-them';
            let html='';
            if(msg.subject) html+=`<div style="font-weight:700;font-size:.78rem;margin-bottom:3px;">${escH(msg.subject)}</div>`;
            if(msg.content) html+=`<div>${escH(msg.content)}</div>`;
            if(msg.imageUrl) html+=`<img src="${escH(msg.imageUrl)}" style="max-width:180px;border-radius:8px;margin-top:6px;cursor:pointer;" onclick="window.open('${escH(msg.imageUrl)}','_blank')">`;
            const ts=msg.createdAt?.toDate?msg.createdAt.toDate():new Date(msg.createdAt||0);
            html+=`<div style="font-size:.65rem;opacity:.7;margin-top:4px;">${ts.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}${msg.isUrgent?' üî¥':''}</div>`;
            bubble.innerHTML=html;wrap.appendChild(bubble);msgEl.appendChild(wrap);
        });
        msgEl.scrollTop=msgEl.scrollHeight;
    });
    const sendBtn=document.getElementById('student-send-btn');
    const input=document.getElementById('student-msg-input');
    const imgInput=document.getElementById('student-img-file');
    const newBtn=sendBtn.cloneNode(true);
    sendBtn.parentNode.replaceChild(newBtn,sendBtn);
    newBtn.onclick=async()=>{
        const txt=input.value.trim();const imgFile=imgInput.files[0]||null;
        if(!txt&&!imgFile)return;
        newBtn.disabled=true;newBtn.textContent='‚Ä¶';
        try{
            let imageUrl=null;
            if(imgFile){
                const fd=new FormData();fd.append('file',imgFile);fd.append('upload_preset',CLOUDINARY.preset);
                const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/image/upload`,{method:'POST',body:fd});
                const data=await res.json();imageUrl=data.secure_url||null;imgInput.value='';
            }
            const now=new Date();const lastMsg=imageUrl?(txt||'üì∑ Image'):txt;
            await addDoc(collection(db,'conversations',convId,'messages'),{content:txt,imageUrl,senderId:window.currentStudent.id,senderName:window.currentStudent.name,senderRole:'student',createdAt:now,read:false});
            const cSnap=await getDoc(doc(db,'conversations',convId));
            const cur=cSnap.exists()?(cSnap.data().unreadCount||0):0;
            await updateDoc(doc(db,'conversations',convId),{lastMessage:lastMsg,lastMessageTimestamp:now,lastSenderId:window.currentStudent.id,unreadCount:cur+1});
            input.value='';
        }catch(e){alert('Error: '+e.message);}
        finally{newBtn.disabled=false;newBtn.textContent='‚û§';}
    };
    input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();newBtn.click();}});
}

// ‚îÄ‚îÄ GAMES ‚îÄ‚îÄ
async function loadGames(){
    const c=document.getElementById('games-container');
    const student=window.currentStudent;
    const grade=parseInt(String(student.grade||'').replace(/\D/g,''))||3;
    const subjects=student.subjects||[];
    const hasSub=s=>subjects.length===0||subjects.some(x=>x.toLowerCase().includes(s.toLowerCase()));
    const ALL_GAMES=[
        {id:'math_quiz',name:'Maths Quiz',subject:'Maths',icon:'fa-calculator',grad:'from-blue-500 to-cyan-400',always:true},
        {id:'ela_quiz',name:'ELA Quiz',subject:'ELA',icon:'fa-spell-check',grad:'from-purple-500 to-pink-400',always:true},
        {id:'bio_quiz',name:'Biology Quiz',subject:'Biology',icon:'fa-dna',grad:'from-green-500 to-emerald-400',always:false},
        {id:'chem_quiz',name:'Chemistry Quiz',subject:'Chemistry',icon:'fa-flask',grad:'from-orange-500 to-amber-400',always:false},
        {id:'phy_quiz',name:'Physics Quiz',subject:'Physics',icon:'fa-atom',grad:'from-red-500 to-rose-400',always:false},
        {id:'scrabble',name:'Scrabble',subject:'ELA',icon:'fa-font',grad:'from-teal-500 to-cyan-400',always:true},
        {id:'snake',name:'Snake',subject:'Fun',icon:'fa-gamepad',grad:'from-gray-700 to-gray-900',always:true},
    ];
    const visible=ALL_GAMES.filter(g=>g.always||hasSub(g.subject));
    c.innerHTML=visible.map(g=>`
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-all">
        <div class="h-36 bg-gradient-to-r ${g.grad} flex items-center justify-center">
            <i class="fas ${g.icon} text-white text-5xl opacity-80"></i>
        </div>
        <div class="p-5">
            <h3 class="font-bold text-gray-800 mb-1">${escH(g.name)}</h3>
            <p class="text-xs text-gray-500 mb-4">${escH(g.subject)} ¬∑ Grade ${grade} difficulty</p>
            <button data-gameid="${g.id}" data-gamename="${escH(g.name)}" data-grade="${grade}"
                onclick="startGame(this.dataset.gameid,this.dataset.gamename,+this.dataset.grade)"
                class="w-full px-4 py-2 bg-brand-primary text-white text-sm font-bold rounded-xl hover:bg-brand-dark">
                Play <i class="fas fa-play ml-1"></i>
            </button>
        </div>
    </div>`).join('');
}

window.startGame=(gameId,gameName,grade)=>{
    // Clear any old game state
    if(window._gTimer)clearInterval(window._gTimer);
    if(window._snakeInt)clearInterval(window._snakeInt);
    const existing=document.getElementById('game-overlay');if(existing)existing.remove();

    const overlay=document.createElement('div');
    overlay.className='fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4';
    overlay.id='game-overlay';
    overlay.innerHTML=`
    <div style="width:100%;max-width:580px;background:#111827;border-radius:16px;overflow:hidden;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#0f172a;">
            <div><div style="font-size:1.1rem;font-weight:700;color:#fff;">${escH(gameName)}</div><div style="font-size:.75rem;color:#9ca3af;">Grade ${grade}</div></div>
            <button onclick="endGame()" style="color:#9ca3af;background:none;border:none;font-size:1.5rem;cursor:pointer;">&times;</button>
        </div>
        <div id="game-viewport" style="padding:16px;background:#1a1a2e;min-height:280px;"></div>
        <div style="padding:12px 18px;background:#0f172a;display:flex;gap:20px;">
            <div style="color:#fff;font-size:.875rem;">Score: <strong id="game-score" style="color:#10b981;">0</strong></div>
            <div style="color:#fff;font-size:.875rem;">Level: <strong id="game-level" style="color:#f59e0b;">${grade}</strong></div>
            <div style="color:#fff;font-size:.875rem;margin-left:auto;">Time: <strong id="game-timer" style="color:#60a5fa;">60s</strong></div>
        </div>
    </div>`;
    document.body.appendChild(overlay);
    window._lastGameId=gameId;
    if(gameId==='snake')startSnake(grade);
    else if(gameId==='scrabble')startScrabble(grade);
    else startQuiz(gameId,grade);
};

window.endGame=()=>{
    if(window._gTimer){clearInterval(window._gTimer);window._gTimer=null;}
    if(window._snakeInt){clearInterval(window._snakeInt);window._snakeInt=null;}
    const score=parseInt(document.getElementById('game-score')?.textContent)||0;
    if(score>0&&window.currentStudent){
        addDoc(collection(db,'game_scores'),{studentId:window.currentStudent.id,studentName:window.currentStudent.name,grade:window.currentStudent.grade,score,gameId:window._lastGameId||'quiz',playedAt:new Date()}).catch(()=>{});
    }
    document.getElementById('game-overlay')?.remove();
};

function startQuiz(gameId,grade){
    let score=0,timeLeft=60;
    const vp=document.getElementById('game-viewport');
    const qs=shuffle(getQuestions(gameId,grade));let qi=0;
    function showQ(){
        if(qi>=qs.length){qi=0;shuffle(qs);}
        const q=qs[qi++];const opts=shuffle([...q.wrong,q.correct]);
        vp.innerHTML=`<div style="color:#fff;font-size:1rem;font-weight:600;margin-bottom:16px;line-height:1.4;">${escH(q.q)}</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            ${opts.map(o=>`<button data-ans="${escH(o)}" data-correct="${escH(q.correct)}" data-grade="${grade}" onclick="ansQ(this)"
                style="background:#1e293b;color:#f1f5f9;border:1px solid #334155;border-radius:8px;padding:10px 14px;cursor:pointer;font-size:.85rem;text-align:left;">${escH(o)}</button>`).join('')}
            </div>`;
    }
    window.ansQ=(btn)=>{
        const chosen=btn.dataset.ans,correct=btn.dataset.correct,g=+btn.dataset.grade;
        const right=chosen===correct;
        btn.style.background=right?'#065f46':'#7f1d1d';
        vp.querySelectorAll('button').forEach(b=>{b.disabled=true;if(b.dataset.ans===correct)b.style.background='#065f46';});
        if(right){score+=10*g;document.getElementById('game-score').textContent=score;}
        setTimeout(showQ,700);
    };
    window._gTimer=setInterval(()=>{
        timeLeft--;document.getElementById('game-timer').textContent=timeLeft+'s';
        if(timeLeft<=0){clearInterval(window._gTimer);window._gTimer=null;vp.innerHTML=`<div style="text-align:center;color:#fff;padding:40px;"><div style="font-size:2rem;">üéâ</div><div style="font-size:1.4rem;font-weight:700;margin-top:8px;">Game Over!</div><div style="color:#10b981;font-size:1.2rem;margin-top:6px;">Score: ${score}</div><button onclick="endGame()" style="margin-top:16px;background:#059669;color:#fff;border:none;border-radius:8px;padding:10px 24px;font-weight:700;cursor:pointer;">Close</button></div>`;}
    },1000);
    showQ();
}

function getQuestions(id,g){
    if(id==='math_quiz'||id==='phy_quiz')return getMathQs(g);
    if(id==='ela_quiz')return getELAQs(g);
    if(id==='bio_quiz')return getBioQs();
    if(id==='chem_quiz')return getChemQs();
    return getMathQs(g);
}
function getMathQs(g){
    const qs=[];
    for(let i=0;i<20;i++){
        if(g<=4){const a=rand(1,10),b=rand(1,10),op=['+','-'][rand(0,1)];const ans=op==='+'?a+b:a-b;qs.push({q:`${a} ${op} ${b} = ?`,correct:String(ans),wrong:[String(ans+rand(1,4)),String(Math.abs(ans-rand(1,3))),String(ans+rand(5,9))]});}
        else if(g<=7){const a=rand(2,12),b=rand(2,12);qs.push({q:`${a} √ó ${b} = ?`,correct:String(a*b),wrong:[String(a*b+rand(1,5)),String(a*b-rand(1,4)),String(a*b+rand(6,12))]});}
        else{const a=rand(2,15);qs.push({q:`${a}¬≤ = ?`,correct:String(a*a),wrong:[String(a*a+rand(1,9)),String(a*a-rand(1,5)),String(a*(a+1))]});}
    }
    return qs;
}
function getELAQs(g){
    const base=[
        {q:'Choose the correct spelling:',correct:'necessary',wrong:['nessecary','necesary','neceserry']},
        {q:'Synonym of "happy":',correct:'joyful',wrong:['sad','angry','tired']},
        {q:'Antonym of "hot":',correct:'cold',wrong:['warm','boiling','sunny']},
        {q:'Which is correct?',correct:'She runs every day.',wrong:['She run every day.','Her runs every day.','She running every day.']},
        {q:'"quickly" is a:',correct:'Adverb',wrong:['Noun','Verb','Adjective']},
        {q:'Plural of "child":',correct:'children',wrong:['childs','childes','childrens']},
        {q:'He ___ to school every day.',correct:'goes',wrong:['go','gone','going']},
        {q:'"sat" in "The cat sat" is a:',correct:'Verb',wrong:['Noun','Adjective','Pronoun']},
    ];
    if(g>=6){base.push({q:'"The wind whispered" is:',correct:'Personification',wrong:['Simile','Metaphor','Alliteration']},{q:'"Fast as lightning" is a:',correct:'Simile',wrong:['Metaphor','Hyperbole','Personification']});}
    return base;
}
function getBioQs(){return[
    {q:'Powerhouse of the cell:',correct:'Mitochondria',wrong:['Nucleus','Ribosome','Vacuole']},
    {q:'Human heart chambers:',correct:'4',wrong:['2','3','6']},
    {q:'Plants absorb ___ during photosynthesis:',correct:'CO‚ÇÇ',wrong:['O‚ÇÇ','N‚ÇÇ','H‚ÇÇO']},
    {q:'DNA stands for:',correct:'Deoxyribonucleic acid',wrong:['Diribose nucleic acid','Dioxy nucleic acid','Deoxyribon acid']},
    {q:'Insulin is produced by:',correct:'Pancreas',wrong:['Liver','Kidney','Spleen']},
    {q:'Cell division is called:',correct:'Mitosis',wrong:['Photosynthesis','Osmosis','Diffusion']},
    {q:'Infection-fighting cells:',correct:'White blood cells',wrong:['Red blood cells','Platelets','Plasma']},
];}
function getChemQs(){return[
    {q:'H‚ÇÇO is:',correct:'Water',wrong:['Oxygen','Hydrogen peroxide','Salt']},
    {q:'Symbol for Gold:',correct:'Au',wrong:['Go','Gd','Gl']},
    {q:'Atomic number of Carbon:',correct:'6',wrong:['12','8','14']},
    {q:'NaCl is:',correct:'Table salt',wrong:['Sugar','Baking soda','Bleach']},
    {q:'pH of pure water:',correct:'7',wrong:['0','14','5']},
    {q:'Chemical symbol for Iron:',correct:'Fe',wrong:['Ir','In','Fr']},
    {q:'Which is a compound?',correct:'H‚ÇÇO (water)',wrong:['O‚ÇÇ','N‚ÇÇ','Au']},
];}

function startSnake(grade){
    const vp=document.getElementById('game-viewport');
    const speed=Math.max(70,160-grade*10);
    vp.innerHTML=`<canvas id="snake-canvas" width="380" height="260" style="display:block;margin:auto;background:#1a1a2e;border-radius:8px;"></canvas><div style="color:#9ca3af;text-align:center;font-size:.72rem;margin-top:8px;">Arrow keys or WASD ¬∑ Swipe on mobile</div>`;
    const cv=document.getElementById('snake-canvas');const ctx=cv.getContext('2d');
    const CELL=20,COLS=19,ROWS=13;
    let snake=[{x:5,y:6}],dir={x:1,y:0},nxt={x:1,y:0},food={x:rand(0,COLS-1),y:rand(0,ROWS-1)},score=0,alive=true;
    function draw(){
        ctx.fillStyle='#1a1a2e';ctx.fillRect(0,0,cv.width,cv.height);
        ctx.fillStyle='#f59e0b';ctx.beginPath();ctx.arc(food.x*CELL+CELL/2,food.y*CELL+CELL/2,CELL/2-2,0,Math.PI*2);ctx.fill();
        snake.forEach((seg,i)=>{ctx.fillStyle=i===0?'#10b981':'#059669';ctx.fillRect(seg.x*CELL+1,seg.y*CELL+1,CELL-2,CELL-2);});
    }
    function step(){
        if(!alive)return;dir={...nxt};
        const h={x:snake[0].x+dir.x,y:snake[0].y+dir.y};
        if(h.x<0||h.x>=COLS||h.y<0||h.y>=ROWS||snake.some(s=>s.x===h.x&&s.y===h.y)){
            alive=false;clearInterval(window._snakeInt);window._snakeInt=null;
            ctx.fillStyle='rgba(0,0,0,.65)';ctx.fillRect(0,0,cv.width,cv.height);
            ctx.fillStyle='#fff';ctx.font='bold 22px Inter';ctx.textAlign='center';
            ctx.fillText('Game Over!',cv.width/2,cv.height/2-10);
            ctx.font='16px Inter';ctx.fillText('Score: '+score,cv.width/2,cv.height/2+18);return;
        }
        snake.unshift(h);
        if(h.x===food.x&&h.y===food.y){score+=10;document.getElementById('game-score').textContent=score;food={x:rand(0,COLS-1),y:rand(0,ROWS-1)};}else snake.pop();
        draw();
    }
    function keyFn(e){
        if(!document.getElementById('snake-canvas')){document.removeEventListener('keydown',keyFn);return;}
        if(['ArrowUp','w'].includes(e.key)&&dir.y!==1)nxt={x:0,y:-1};
        else if(['ArrowDown','s'].includes(e.key)&&dir.y!==-1)nxt={x:0,y:1};
        else if(['ArrowLeft','a'].includes(e.key)&&dir.x!==1)nxt={x:-1,y:0};
        else if(['ArrowRight','d'].includes(e.key)&&dir.x!==-1)nxt={x:1,y:0};
        if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key))e.preventDefault();
    }
    document.addEventListener('keydown',keyFn);
    let tx=0,ty=0;
    cv.addEventListener('touchstart',e=>{tx=e.touches[0].clientX;ty=e.touches[0].clientY;},{passive:true});
    cv.addEventListener('touchend',e=>{
        const dx=e.changedTouches[0].clientX-tx,dy=e.changedTouches[0].clientY-ty;
        if(Math.abs(dx)>Math.abs(dy)){if(dx>0&&dir.x!==-1)nxt={x:1,y:0};else if(dir.x!==1)nxt={x:-1,y:0};}
        else{if(dy>0&&dir.y!==-1)nxt={x:0,y:1};else if(dir.y!==1)nxt={x:0,y:-1};}
    },{passive:true});
    draw();window._snakeInt=setInterval(step,speed);
}

function startScrabble(grade){
    const WORDS='apple bread chair dance eagle flame giant happy india jolly knife lemon music night ocean piano queen river stone tiger urban vivid water xenon yacht zebra jungle knight laptop mango narrow orange pencil purple rabbit silver turtle unique violet walnut yellow castle dragon forest garden humble island junior kitten lantern'.split(' ');
    const word=WORDS[rand(0,WORDS.length-1)].toUpperCase();
    const scrambled=shuffle([...word]).join('');
    let score=parseInt(document.getElementById('game-score')?.textContent)||0;
    let attempts=0;
    const vp=document.getElementById('game-viewport');
    function render(){
        vp.innerHTML=`<div style="text-align:center;color:#fff;">
            <div style="font-size:.8rem;color:#9ca3af;margin-bottom:10px;">Unscramble the word:</div>
            <div style="font-size:2.2rem;font-weight:700;letter-spacing:.18em;color:#f59e0b;margin-bottom:20px;">${escH(scrambled)}</div>
            <input id="scr-in" type="text" maxlength="${word.length}" style="background:#1e293b;color:#fff;border:1px solid #334155;border-radius:8px;padding:10px 16px;font-size:1.1rem;width:80%;text-align:center;letter-spacing:.12em;text-transform:uppercase;"
                onkeydown="if(event.key==='Enter')window._checkScrabble();">
            <div style="margin-top:12px;display:flex;gap:10px;justify-content:center;">
                <button onclick="window._checkScrabble()" style="background:#059669;color:#fff;border:none;border-radius:8px;padding:10px 24px;font-weight:700;cursor:pointer;">Check</button>
                <button onclick="startScrabble(${grade})" style="background:#374151;color:#fff;border:none;border-radius:8px;padding:10px 18px;font-weight:600;cursor:pointer;">Skip</button>
            </div>
            <div id="scr-msg" style="margin-top:16px;font-size:.9rem;min-height:24px;"></div>
            <div style="color:#6b7280;font-size:.72rem;margin-top:6px;">Attempts: ${attempts}/3</div>
        </div>`;
        document.getElementById('scr-in')?.focus();
    }
    window._checkScrabble=()=>{
        const ans=(document.getElementById('scr-in')?.value||'').toUpperCase().trim();
        if(ans===word){
            score+=15;document.getElementById('game-score').textContent=score;
            document.getElementById('scr-msg').innerHTML='<span style="color:#10b981;font-weight:700;">‚úì Correct! +15 points</span>';
            setTimeout(()=>startScrabble(grade),1200);
        } else {
            attempts++;
            if(attempts>=3){
                document.getElementById('scr-msg').innerHTML=`<span style="color:#ef4444;">The word was: <strong>${escH(word)}</strong></span>`;
                setTimeout(()=>startScrabble(grade),2200);
            } else {
                document.getElementById('scr-msg').innerHTML=`<span style="color:#f59e0b;">Not quite! ${3-attempts} attempt${3-attempts!==1?'s':''} left.</span>`;
            }
        }
    };
    render();
}

// ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ
window.toggleLeaderboard=async()=>{
    const c=document.getElementById('leaderboard-container');
    const btn=document.getElementById('show-leaderboard');
    if(c.classList.contains('hidden')){c.classList.remove('hidden');btn.innerHTML='<i class="fas fa-times mr-1"></i>Hide';await loadLeaderboard();}
    else{c.classList.add('hidden');btn.innerHTML='<i class="fas fa-trophy mr-1"></i>Leaderboard';}
};

async function loadLeaderboard(){
    const c=document.getElementById('leaderboard-content');
    try{
        const snap=await getDocs(query(collection(db,'game_scores'),orderBy('score','desc'),limit(30)));
        if(snap.empty){c.innerHTML='<p class="text-gray-500 text-sm text-center">No scores yet!</p>';return;}
        const byGame={};
        snap.docs.forEach(d=>{const s=d.data();const gid=s.gameId||'quiz';if(!byGame[gid])byGame[gid]=[];if(byGame[gid].length<3)byGame[gid].push(s);});
        c.innerHTML=Object.entries(byGame).map(([gid,list])=>`
            <div class="mb-5">
                <div class="font-bold text-gray-700 mb-2 text-sm uppercase tracking-wide">${escH(gid.replace(/_/g,' '))}</div>
                ${list.map((p,i)=>`
                <div class="flex items-center gap-3 py-1.5">
                    <span class="text-lg">${i===0?'ü•á':i===1?'ü•à':'ü•â'}</span>
                    <div class="flex-1">
                        <span class="text-sm font-medium text-gray-800">${escH(p.studentName||'Student')}</span>
                        <span class="text-xs text-gray-400 ml-1">${escH(p.grade||'')}</span>
                    </div>
                    <span class="text-sm font-bold text-brand-primary">${p.score} pts</span>
                </div>`).join('')}
            </div>`).join('')||'<p class="text-gray-500 text-sm text-center">No scores yet!</p>';
    }catch(e){c.innerHTML='<p class="text-red-400 text-sm">Error loading leaderboard.</p>';}
}

}); // end DOMContentLoaded
</script>
<!-- Inline annotation text input overlay -->
<div id="annot-text-input-overlay">
    <textarea id="annot-text-input-box" placeholder="Type your text here..." rows="3"></textarea>
    <div id="annot-text-input-actions">
        <button id="annot-text-cancel" onclick="window._annotTextCancel()">Cancel</button>
        <button id="annot-text-ok" onclick="window._annotTextOk()">Add Text ‚úì</button>
    </div>
</div>
</body>
</html>
