<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Grade Homework ‚Äî Blooming Kids</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: #f1f5f9;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Loading */
#loading {
  position: fixed; inset: 0;
  background: #f1f5f9;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 9999;
}
.spinner {
  width: 44px; height: 44px;
  border: 3px solid #e2e8f0;
  border-top-color: #6366f1;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  margin-bottom: 16px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Top bar */
#top-bar {
  background: linear-gradient(135deg, #1e1b4b, #3730a3);
  padding: 10px 18px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
  flex-shrink: 0; min-height: 56px;
}
#hdr-name {
  color: #fff; font-size: 1rem; font-weight: 800;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
#hdr-meta { color: #a5b4fc; font-size: 0.7rem; margin-top: 2px; }
.icon-btn {
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.2);
  color: #e2e8f0; padding: 6px 13px; border-radius: 8px;
  font-size: 0.75rem; font-weight: 700; cursor: pointer;
  white-space: nowrap; transition: background 0.15s;
}
.icon-btn:hover { background: rgba(255,255,255,0.24); }
.icon-btn.danger { color: #fca5a5; border-color: rgba(239,68,68,0.4); }
.icon-btn.danger:hover { background: rgba(239,68,68,0.22); }

/* Toolbar */
#toolbar {
  background: #1e293b; padding: 6px 14px;
  display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
  flex-shrink: 0; border-bottom: 1px solid #0f172a;
}
.tool {
  padding: 5px 12px; border-radius: 7px;
  border: 1px solid rgba(255,255,255,0.12);
  background: transparent; color: #94a3b8;
  font-size: 0.73rem; font-weight: 700; cursor: pointer;
  transition: all 0.12s; display: flex; align-items: center; gap: 4px;
  white-space: nowrap;
}
.tool:hover, .tool.on { background: #4338ca; border-color: #6366f1; color: #fff; }
.swatch {
  width: 20px; height: 20px; border-radius: 50%;
  cursor: pointer; border: 2px solid transparent;
  flex-shrink: 0; transition: transform 0.12s;
}
.swatch:hover, .swatch.on { transform: scale(1.3); border-color: #fff; }
.divider { width: 1px; height: 22px; background: rgba(255,255,255,0.1); margin: 0 3px; flex-shrink: 0; }
#size-range { width: 70px; accent-color: #6366f1; cursor: pointer; }
#zoom-lbl { color: #64748b; font-size: 0.68rem; min-width: 36px; }

/* Main */
#main { flex: 1; display: flex; overflow: hidden; min-height: 0; }

/* Canvas area */
#canvas-area {
  flex: 1; overflow: auto;
  background: #e2e8f0; position: relative;
}
#hw-img { display: block; max-width: none; user-select: none; }
#draw-canvas { position: absolute; top: 0; left: 0; touch-action: none; cursor: crosshair; }
#text-submission {
  padding: 40px; background: #fff;
  min-height: 100%; font-size: 1rem; line-height: 1.8; color: #1e293b; max-width: 760px;
}

/* Sidebar */
#sidebar {
  width: 300px; flex-shrink: 0; background: #fff;
  border-left: 1px solid #e2e8f0;
  display: flex; flex-direction: column; overflow-y: auto;
}
.sb-block { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; }
.sb-title { font-size: 0.62rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.08em; color: #94a3b8; margin-bottom: 8px; }

/* Grade grid */
#grade-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 6px; margin-bottom: 10px; }
.gq {
  padding: 8px 4px; border-radius: 10px;
  border: 1.5px solid #e2e8f0; background: #fff;
  cursor: pointer; text-align: center;
  font-weight: 800; font-size: 0.85rem; transition: all 0.15s; color: #374151;
}
.gq small { font-size: 0.6rem; font-weight: 600; display: block; margin-top: 2px; }
.gq-a:hover, .gq-a.sel { border-color: #16a34a; background: #dcfce7; color: #16a34a; }
.gq-b:hover, .gq-b.sel { border-color: #2563eb; background: #dbeafe; color: #2563eb; }
.gq-c:hover, .gq-c.sel { border-color: #d97706; background: #fef3c7; color: #d97706; }
.gq-f:hover, .gq-f.sel { border-color: #dc2626; background: #fee2e2; color: #dc2626; }

/* Score row */
.score-row { display: flex; align-items: center; gap: 8px; }
.score-row label { font-size: 0.82rem; font-weight: 700; color: #475569; white-space: nowrap; }
.score-row input {
  width: 72px; padding: 7px 10px;
  border: 1.5px solid #e2e8f0; border-radius: 9px;
  font-size: 1rem; font-weight: 800; text-align: center; outline: none;
  transition: border-color 0.15s;
}
.score-row input:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
.score-row span { color: #94a3b8; font-size: 0.82rem; }

/* Feedback */
#feedback {
  width: 100%; padding: 10px 12px;
  border: 1.5px solid #e2e8f0; border-radius: 10px;
  font-size: 0.85rem; font-family: inherit;
  resize: vertical; min-height: 110px; outline: none;
  transition: border-color 0.15s;
}
#feedback:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }

/* Notify */
.notify-row { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 4px 0; }
.notify-row input { accent-color: #6366f1; width: 15px; height: 15px; }
.notify-row span { font-size: 0.82rem; color: #374151; }

/* Save button */
#save-btn {
  width: 100%; padding: 13px;
  background: linear-gradient(135deg, #059669, #16a34a);
  color: #fff; border: none; border-radius: 12px;
  font-weight: 800; cursor: pointer; font-size: 0.9rem;
  box-shadow: 0 4px 14px rgba(5,150,105,0.3);
  transition: all 0.15s;
}
#save-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(5,150,105,0.4); }
#save-btn:disabled { background: #94a3b8; cursor: not-allowed; transform: none; box-shadow: none; }

#status-msg {
  display: none; padding: 10px 12px; border-radius: 10px;
  font-size: 0.82rem; font-weight: 700; text-align: center; margin-top: 8px;
}

@media (max-width: 640px) {
  #main { flex-direction: column; }
  #sidebar { width: 100%; height: 300px; border-left: none; border-top: 1px solid #e2e8f0; }
}
</style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div class="spinner"></div>
  <p style="color:#64748b;font-weight:700;font-size:0.9rem;">Loading assignment‚Ä¶</p>
</div>

<!-- Top bar -->
<div id="top-bar" style="display:none;">
  <div style="min-width:0;flex:1;">
    <div id="hdr-name">Grade Assignment</div>
    <div id="hdr-meta">Loading‚Ä¶</div>
  </div>
  <div style="display:flex;gap:8px;flex-shrink:0;">
    <button class="icon-btn" id="btn-undo">&#8617; Undo</button>
    <button class="icon-btn danger" id="btn-clear">&#128465; Clear All</button>
  </div>
</div>

<!-- Toolbar -->
<div id="toolbar" style="display:none;">
  <button class="tool on" id="tool-pen"       onclick="grading.setTool('pen')">&#9999; Pen</button>
  <button class="tool"    id="tool-highlight"  onclick="grading.setTool('highlight')">&#128397; Highlight</button>
  <button class="tool"    id="tool-arrow"      onclick="grading.setTool('arrow')">&#10148; Arrow</button>
  <button class="tool"    id="tool-text"       onclick="grading.setTool('text')">T Text</button>
  <button class="tool"    id="tool-eraser"     onclick="grading.setTool('eraser')">&#9633; Eraser</button>
  <div class="divider"></div>
  <div id="swatches" style="display:flex;gap:5px;align-items:center;"></div>
  <div class="divider"></div>
  <span style="color:#64748b;font-size:0.68rem;white-space:nowrap;">Brush:</span>
  <input type="range" id="size-range" min="1" max="20" value="3">
  <div class="divider"></div>
  <button class="tool" onclick="grading.zoom(1)">+</button>
  <button class="tool" onclick="grading.zoom(-1)">&minus;</button>
  <span id="zoom-lbl">100%</span>
</div>

<!-- Main -->
<div id="main" style="display:none;">

  <!-- Canvas / content -->
  <div id="canvas-area"></div>

  <!-- Sidebar -->
  <div id="sidebar">

    <div class="sb-block">
      <div class="sb-title">Quick Grade</div>
      <div id="grade-grid">
        <button class="gq gq-a" onclick="grading.quickGrade(100,this)">A<small>100%</small></button>
        <button class="gq gq-b" onclick="grading.quickGrade(85,this)">B<small>85%</small></button>
        <button class="gq gq-c" onclick="grading.quickGrade(65,this)">C<small>65%</small></button>
        <button class="gq gq-f" onclick="grading.quickGrade(40,this)">F<small>40%</small></button>
      </div>
      <div class="score-row">
        <label>Score:</label>
        <input type="number" id="score-input" min="0" max="100" placeholder="0-100">
        <span>/ 100</span>
      </div>
    </div>

    <div class="sb-block" style="flex:1;">
      <div class="sb-title">Feedback to Student</div>
      <textarea id="feedback" placeholder="Write corrections, encouragement, and next steps here‚Ä¶"></textarea>
    </div>

    <div class="sb-block">
      <div class="sb-title">Options</div>
      <label class="notify-row">
        <input type="checkbox" id="notify" checked>
        <span>Notify student after saving</span>
      </label>
    </div>

    <div style="padding:14px 16px;">
      <button id="save-btn" onclick="grading.save()">&#10003; Save Grade &amp; Notify Student</button>
      <div id="status-msg"></div>
    </div>

  </div>
</div>


<!-- Firebase module script -->
<script type="module">
import { auth, db } from './firebaseConfig.js';
import { doc, getDoc, updateDoc, addDoc, collection } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const params = new URLSearchParams(location.search);
const hwId   = params.get('hw')    || sessionStorage.getItem('grading_hw_id')       || '';
const tEmail = params.get('tutor') || sessionStorage.getItem('grading_tutor_email') || '';
const tName  = params.get('name')  || sessionStorage.getItem('grading_tutor_name')  || '';

// Expose to the plain script below
window._G = { db, doc, updateDoc, addDoc, collection, hwId, tEmail, tName, hw: null };

// ========== FIX: Wait for auth to be fully restored ==========
(async () => {
  try {
    // Wait for Firebase Auth to finish initialising (restores session from storage)
    await auth.authStateReady();

    const user = auth.currentUser;
    if (!user) {
      showLoadErr('üîí', 'Not logged in.', 'Please log in from the Tutor Portal first.');
      return;
    }

    if (!hwId) {
      showLoadErr('‚ö†Ô∏è', 'No assignment ID.', 'Open this page via the Review button in the portal.');
      return;
    }

    const snap = await getDoc(doc(db, 'homework_assignments', hwId));
    if (!snap.exists()) {
      showLoadErr('üì≠', 'Assignment not found.', 'It may have been deleted.');
      return;
    }

    const hw = snap.data();
    window._G.hw = hw;

    // Fill header
    const dateStr = hw.submittedAt && hw.submittedAt.toDate
      ? hw.submittedAt.toDate().toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' })
      : 'Unknown date';
    document.getElementById('hdr-name').textContent = 'Grading: ' + (hw.studentName || 'Student');
    document.getElementById('hdr-meta').textContent = (hw.subject || 'Homework') + ' ¬∑ ' + dateStr;

    // Pre-fill existing grade / feedback
    if (hw.score !== undefined && hw.score !== null) {
      document.getElementById('score-input').value = hw.score;
    }
    if (hw.feedback) {
      document.getElementById('feedback').value = hw.feedback;
    }

    // Reveal UI
    document.getElementById('loading').style.display = 'none';
    document.getElementById('top-bar').style.display = 'flex';
    document.getElementById('toolbar').style.display = 'flex';
    document.getElementById('main').style.display    = 'flex';

    // Load submission content
    loadContent(hw);

  } catch (err) {
    showLoadErr('‚ùå', 'Error loading.', err.message);
  }
})();
// ===============================================================

function loadContent(hw) {
  const area = document.getElementById('canvas-area');

  if (hw.imageUrl || hw.fileUrl) {
    const url = hw.imageUrl || hw.fileUrl;
    const img = document.createElement('img');
    img.id           = 'hw-img';
    img.crossOrigin  = 'anonymous';
    img.style.cssText = 'display:block;max-width:none;user-select:none;';

    img.onload = function () {
      const cvs         = document.createElement('canvas');
      cvs.id            = 'draw-canvas';
      cvs.width         = img.naturalWidth;
      cvs.height        = img.naturalHeight;
      cvs.style.cssText = 'position:absolute;top:0;left:0;touch-action:none;cursor:crosshair;'
                        + 'width:' + img.naturalWidth  + 'px;'
                        + 'height:' + img.naturalHeight + 'px;';
      area.style.position = 'relative';
      area.appendChild(img);
      area.appendChild(cvs);
      window._G.canvas = cvs;
      window._G.ctx    = cvs.getContext('2d');
      window._G.ctx.lineCap  = 'round';
      window._G.ctx.lineJoin = 'round';
      if (window.grading && window.grading.bindCanvas) {
        window.grading.bindCanvas(cvs);
      }
    };

    img.onerror = function () {
      area.innerHTML = infoBox('üñºÔ∏è', 'Image unavailable.', 'The file may have expired. You can still write feedback and save the grade.');
    };

    img.src = url; // set src after event handlers

  } else if (hw.answer || hw.content || hw.question) {
    const text = hw.answer || hw.content || hw.question || '';
    const div  = document.createElement('div');
    div.id = 'text-submission';
    div.innerHTML = '<div style="font-size:0.7rem;color:#6366f1;font-weight:800;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:16px;">Student Submission</div>'
                  + text.replace(/\n/g, '<br>');
    area.appendChild(div);

  } else {
    area.innerHTML = infoBox('üìÑ', 'No file or text found.', 'You can still write feedback and save the grade.');
  }
}

function infoBox(icon, title, sub) {
  return '<div style="padding:60px 40px;text-align:center;color:#94a3b8;">'
       + '<div style="font-size:2.5rem;margin-bottom:12px;">' + icon + '</div>'
       + '<p style="font-weight:700;color:#475569;font-size:1rem;margin-bottom:6px;">' + title + '</p>'
       + '<p style="font-size:0.875rem;">' + sub + '</p></div>';
}

function showLoadErr(icon, title, sub) {
  document.getElementById('loading').innerHTML =
    '<div style="text-align:center;padding:40px;">'
    + '<div style="font-size:3rem;margin-bottom:16px;">' + icon + '</div>'
    + '<p style="font-weight:800;color:#ef4444;font-size:1.05rem;margin-bottom:8px;">' + title + '</p>'
    + '<p style="color:#9ca3af;font-size:0.875rem;">' + sub + '</p></div>';
}

// Save grade ‚Äî called from grading.save() below
window._doSave = async function () {
  const btn      = document.getElementById('save-btn');
  const rawScore = document.getElementById('score-input').value.trim();
  const feedback = document.getElementById('feedback').value.trim();
  const notify   = document.getElementById('notify').checked;
  const scoreVal = rawScore !== '' ? parseInt(rawScore, 10) : null;

  if (scoreVal !== null && (isNaN(scoreVal) || scoreVal < 0 || scoreVal > 100)) {
    showStatus('Score must be between 0 and 100.', false); return;
  }
  if (!feedback && scoreVal === null) {
    showStatus('Please enter a score or write feedback before saving.', false); return;
  }

  // Capture any drawn annotations as a PNG
  let annotationImg = '';
  if (window._G.canvas && window._G.canvas.width > 0) {
    try { annotationImg = window._G.canvas.toDataURL('image/png'); } catch (e) { /* CORS ‚Äî skip */ }
  }

  btn.disabled    = true;
  btn.textContent = 'Saving‚Ä¶';
  showStatus('', null);

  try {
    const update = {
      status:           'graded',
      gradedAt:         new Date(),
      tutorEmail:       window._G.tEmail,
      tutorName:        window._G.tName,
      feedback,
      tutorAnnotations: feedback,
    };
    if (scoreVal !== null) update.score           = scoreVal;
    if (annotationImg)     update.annotationImage = annotationImg;

    await updateDoc(doc(db, 'homework_assignments', hwId), update);

    if (notify && window._G.hw) {
      try {
        await addDoc(collection(db, 'student_notifications'), {
          type:        'homework_graded',
          studentId:   window._G.hw.studentId   || '',
          studentName: window._G.hw.studentName || '',
          tutorName:   window._G.tName,
          score:       scoreVal,
          feedback,
          homeworkId:  hwId,
          createdAt:   new Date(),
          read:        false,
        });
      } catch (e) { /* optional ‚Äî don't block */ }
    }

    showStatus('Grade saved! Student has been notified.', true);
    btn.textContent  = 'Saved!';
    btn.style.background = 'linear-gradient(135deg,#4338ca,#6366f1)';
    btn.disabled = false;

  } catch (err) {
    showStatus('Error: ' + err.message, false);
    btn.disabled    = false;
    btn.textContent = 'Save Grade & Notify Student';
  }
};

function showStatus(msg, ok) {
  const el = document.getElementById('status-msg');
  if (!msg) { el.style.display = 'none'; return; }
  el.style.display    = 'block';
  el.style.background = ok ? '#d1fae5' : '#fee2e2';
  el.style.color      = ok ? '#065f46' : '#991b1b';
  el.textContent      = (ok ? '‚úÖ ' : '‚ùå ') + msg;
}
</script>


<!-- Drawing tools ‚Äî plain script, no module, wrapped in IIFE to avoid global pollution -->
<script>
(function () {
  'use strict';

  var tool    = 'pen';
  var color   = '#ef4444';
  var size    = 3;
  var drawing = false;
  var sx      = 0;
  var sy      = 0;
  var history = [];
  var zoom    = 1;

  var COLORS = ['#ef4444','#f97316','#22c55e','#3b82f6','#8b5cf6','#1e293b'];

  // Build swatches after DOM ready
  document.addEventListener('DOMContentLoaded', function () {
    var sw = document.getElementById('swatches');
    COLORS.forEach(function (c, i) {
      var d = document.createElement('div');
      d.className        = 'swatch' + (i === 0 ? ' on' : '');
      d.style.background = c;
      d.title            = c;
      d.onclick = function () {
        color = c;
        document.querySelectorAll('.swatch').forEach(function (s) { s.classList.remove('on'); });
        d.classList.add('on');
      };
      sw.appendChild(d);
    });

    document.getElementById('size-range').oninput = function (e) {
      size = parseInt(e.target.value, 10) || 3;
    };
    document.getElementById('btn-undo').onclick  = doUndo;
    document.getElementById('btn-clear').onclick = doClear;
  });

  // Expose public API used by HTML onclick attributes and module script
  window.grading = {

    bindCanvas: function (cvs) {
      cvs.addEventListener('pointerdown', function (e) {
        if (tool === 'text') { addTextBox(e); return; }
        saveHistory();
        drawing = true;
        var p = getPos(e, cvs);
        sx = p.x; sy = p.y;
        if (tool !== 'arrow') {
          getCtx().beginPath();
          getCtx().moveTo(p.x, p.y);
        }
      });

      cvs.addEventListener('pointermove', function (e) {
        if (!drawing) return;
        var p = getPos(e, cvs);
        var c = getCtx();
        if (tool === 'pen') {
          c.globalAlpha              = 1;
          c.globalCompositeOperation = 'source-over';
          c.strokeStyle              = color;
          c.lineWidth                = size;
          c.lineTo(p.x, p.y);
          c.stroke();
        } else if (tool === 'highlight') {
          c.globalAlpha              = 0.35;
          c.globalCompositeOperation = 'source-over';
          c.strokeStyle              = color;
          c.lineWidth                = size * 5;
          c.lineTo(p.x, p.y);
          c.stroke();
        } else if (tool === 'eraser') {
          c.globalCompositeOperation = 'destination-out';
          c.lineWidth                = size * 5;
          c.lineTo(p.x, p.y);
          c.stroke();
        }
      });

      cvs.addEventListener('pointerup', function (e) {
        if (!drawing) return;
        drawing = false;
        var p = getPos(e, cvs);
        if (tool === 'arrow') drawArrow(sx, sy, p.x, p.y);
        resetCtx();
      });

      cvs.addEventListener('pointerleave', function () {
        if (drawing) { drawing = false; resetCtx(); }
      });

      cvs.addEventListener('contextmenu', function (e) { e.preventDefault(); });
    },

    setTool: function (t) {
      tool = t;
      document.querySelectorAll('.tool').forEach(function (b) { b.classList.remove('on'); });
      var el = document.getElementById('tool-' + t);
      if (el) el.classList.add('on');
      var cvs = window._G && window._G.canvas;
      if (cvs) {
        cvs.style.cursor = t === 'text' ? 'text' : t === 'eraser' ? 'cell' : 'crosshair';
      }
    },

    quickGrade: function (score, btn) {
      document.getElementById('score-input').value = score;
      document.querySelectorAll('.gq').forEach(function (b) { b.classList.remove('sel'); });
      btn.classList.add('sel');
    },

    zoom: function (dir) {
      zoom = dir > 0 ? Math.min(zoom + 0.25, 4) : Math.max(zoom - 0.25, 0.25);
      var img = document.getElementById('hw-img');
      var cvs = window._G && window._G.canvas;
      if (img && cvs) {
        var w = img.naturalWidth  * zoom;
        var h = img.naturalHeight * zoom;
        img.style.width  = w + 'px';
        img.style.height = h + 'px';
        cvs.style.width  = w + 'px';
        cvs.style.height = h + 'px';
      }
      document.getElementById('zoom-lbl').textContent = Math.round(zoom * 100) + '%';
    },

    save: function () {
      if (window._doSave) window._doSave();
    }

  };

  // ‚îÄ‚îÄ Private helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function getCtx() {
    return (window._G && window._G.ctx) || null;
  }

  function getPos(e, cvs) {
    var r  = cvs.getBoundingClientRect();
    var sx = cvs.width  / r.width;
    var sy = cvs.height / r.height;
    return { x: (e.clientX - r.left) * sx, y: (e.clientY - r.top) * sy };
  }

  function resetCtx() {
    var c = getCtx();
    if (!c) return;
    c.globalAlpha              = 1;
    c.globalCompositeOperation = 'source-over';
  }

  function drawArrow(x1, y1, x2, y2) {
    var c   = getCtx();
    if (!c) return;
    var ang = Math.atan2(y2 - y1, x2 - x1);
    var L   = 20;
    var a   = Math.PI / 7;
    c.strokeStyle              = color;
    c.lineWidth                = size;
    c.globalAlpha              = 1;
    c.globalCompositeOperation = 'source-over';
    c.beginPath();
    c.moveTo(x1, y1);
    c.lineTo(x2, y2);
    c.stroke();
    c.beginPath();
    c.moveTo(x2 - L * Math.cos(ang - a), y2 - L * Math.sin(ang - a));
    c.lineTo(x2, y2);
    c.lineTo(x2 - L * Math.cos(ang + a), y2 - L * Math.sin(ang + a));
    c.stroke();
  }

  function addTextBox(e) {
    var area = document.getElementById('canvas-area');
    var r    = area.getBoundingClientRect();
    var box  = document.createElement('div');
    box.contentEditable = 'true';
    box.style.cssText   =
      'position:absolute;'
      + 'left:'   + (e.clientX - r.left + area.scrollLeft) + 'px;'
      + 'top:'    + (e.clientY - r.top  + area.scrollTop)  + 'px;'
      + 'min-width:80px;min-height:24px;'
      + 'padding:3px 6px;'
      + 'border:1.5px dashed #6366f1;'
      + 'background:rgba(255,255,255,0.92);'
      + 'border-radius:4px;'
      + 'font-size:' + Math.max(13, size * 3) + 'px;'
      + 'color:' + color + ';'
      + 'outline:none;cursor:move;z-index:50;resize:both;overflow:hidden;';
    area.appendChild(box);
    box.focus();

    var ox = 0;
    var oy = 0;
    box.onmousedown = function (ev) {
      if (ev.target !== box) return;
      ox = ev.clientX - box.offsetLeft;
      oy = ev.clientY - box.offsetTop;
      document.onmousemove = function (me) {
        box.style.left = (me.clientX - ox) + 'px';
        box.style.top  = (me.clientY - oy) + 'px';
      };
      document.onmouseup = function () {
        document.onmousemove = null;
        document.onmouseup   = null;
      };
    };
  }

  function saveHistory() {
    var cvs = window._G && window._G.canvas;
    if (!cvs) return;
    var c = getCtx();
    if (!c) return;
    history.push(c.getImageData(0, 0, cvs.width, cvs.height));
    if (history.length > 30) history.shift();
  }

  function doUndo() {
    var cvs = window._G && window._G.canvas;
    if (!cvs || !history.length) return;
    getCtx().putImageData(history.pop(), 0, 0);
  }

  function doClear() {
    var cvs = window._G && window._G.canvas;
    if (!cvs) return;
    saveHistory();
    getCtx().clearRect(0, 0, cvs.width, cvs.height);
    document.querySelectorAll('#canvas-area div[contenteditable]').forEach(function (el) {
      el.remove();
    });
  }

}());
</script>

</body>
</html>
