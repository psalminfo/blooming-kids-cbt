<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Grade Assignment ‚Äî Blooming Kids</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:#f8fafc;height:100vh;display:flex;flex-direction:column;}
#app-header{background:linear-gradient(135deg,#1e1b4b,#3730a3);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
#toolbar{background:#1e293b;padding:8px 16px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;flex-shrink:0;}
.tool-btn{padding:6px 13px;border-radius:8px;border:1.5px solid rgba(255,255,255,.15);background:rgba(255,255,255,.08);color:#e2e8f0;font-size:.75rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .15s;}
.tool-btn:hover,.tool-btn.active{background:#4f46e5;border-color:#6366f1;color:#fff;}
.color-swatch{width:22px;height:22px;border-radius:50%;border:2px solid rgba(255,255,255,.3);cursor:pointer;transition:transform .12s;}
.color-swatch:hover,.color-swatch.active{transform:scale(1.25);border-color:#fff;}
#workspace{flex:1;display:grid;grid-template-columns:1fr 360px;overflow:hidden;min-height:0;}
#canvas-wrap{position:relative;overflow:auto;background:#e2e8f0;}
#hw-image{display:block;max-width:none;}
#draw-canvas{position:absolute;top:0;left:0;cursor:crosshair;touch-action:none;}
#sidebar{background:#fff;border-left:1px solid #e2e8f0;display:flex;flex-direction:column;overflow-y:auto;}
.sb-section{padding:16px 18px;border-bottom:1px solid #f1f5f9;}
.sb-label{font-size:.65rem;font-weight:800;text-transform:uppercase;letter-spacing:.08em;color:#94a3b8;margin-bottom:8px;}
.grade-btn{padding:8px 14px;border-radius:10px;border:1.5px solid #e2e8f0;background:#fff;font-size:.82rem;font-weight:700;cursor:pointer;transition:all .15s;}
.grade-btn:hover{border-color:#6366f1;background:#eef2ff;color:#4338ca;}
.grade-btn.sel{background:#4338ca;color:#fff;border-color:#4338ca;}
textarea{width:100%;padding:10px 12px;border:1.5px solid #e2e8f0;border-radius:10px;font-size:.85rem;font-family:inherit;resize:vertical;outline:none;transition:border-color .15s;}
textarea:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,.1);}
input[type=number]{width:80px;padding:8px 10px;border:1.5px solid #e2e8f0;border-radius:10px;font-size:.95rem;font-weight:700;text-align:center;outline:none;}
input[type=number]:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,.1);}
#save-btn{background:linear-gradient(135deg,#059669,#16a34a);color:#fff;border:none;padding:13px 20px;border-radius:12px;font-weight:800;cursor:pointer;font-size:.9rem;width:100%;box-shadow:0 4px 14px rgba(5,150,105,.35);transition:all .15s;}
#save-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(5,150,105,.45);}
#save-btn:disabled{background:#94a3b8;cursor:not-allowed;transform:none;box-shadow:none;}
#status{font-size:.8rem;font-weight:700;text-align:center;padding:8px 12px;border-radius:10px;display:none;margin-top:8px;}
.type-tool{position:absolute;border:1.5px dashed #6366f1;background:rgba(255,255,255,.9);padding:4px;min-width:80px;min-height:24px;font-size:.85rem;cursor:move;outline:none;resize:both;overflow:hidden;border-radius:4px;}
@media(max-width:680px){#workspace{grid-template-columns:1fr;}#sidebar{border-left:none;border-top:1px solid #e2e8f0;height:280px;}}
</style>
</head>
<body>

<div id="app-header">
    <div style="display:flex;align-items:center;gap:12px;">
        <div style="width:38px;height:38px;background:rgba(255,255,255,.15);border-radius:10px;border:1.5px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:1.2rem;">üìù</div>
        <div>
            <div style="color:#fff;font-weight:900;font-size:.95rem;" id="hdr-title">Grade Assignment</div>
            <div style="color:#a5b4fc;font-size:.68rem;" id="hdr-sub">Loading‚Ä¶</div>
        </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
        <button id="clear-annotations" style="background:rgba(239,68,68,.2);border:1px solid rgba(239,68,68,.4);color:#fca5a5;padding:6px 12px;border-radius:8px;font-size:.72rem;font-weight:700;cursor:pointer;">üóë Clear Annotations</button>
        <button id="btn-undo" style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#e2e8f0;padding:6px 12px;border-radius:8px;font-size:.72rem;font-weight:700;cursor:pointer;">‚Ü© Undo</button>
    </div>
</div>

<div id="toolbar">
    <button class="tool-btn active" id="tool-pen"    onclick="setTool('pen')"   >‚úèÔ∏è Pen</button>
    <button class="tool-btn"        id="tool-highlight" onclick="setTool('highlight')">üñç Highlight</button>
    <button class="tool-btn"        id="tool-arrow"  onclick="setTool('arrow')" >‚û§ Arrow</button>
    <button class="tool-btn"        id="tool-text"   onclick="setTool('text')"  >T Text</button>
    <button class="tool-btn"        id="tool-eraser" onclick="setTool('eraser')">‚¨ú Eraser</button>
    <div style="width:1px;height:28px;background:rgba(255,255,255,.12);margin:0 4px;"></div>
    <div style="display:flex;gap:5px;align-items:center;">
        ${['#ef4444','#f97316','#22c55e','#3b82f6','#8b5cf6','#000000'].map(col=>`<div class="color-swatch ${col==='#ef4444'?'active':''}" style="background:${col};" data-color="${col}" onclick="setColor('${col}',this)"></div>`).join('')}
    </div>
    <div style="display:flex;align-items:center;gap:5px;margin-left:4px;">
        <span style="color:#94a3b8;font-size:.7rem;">Size:</span>
        <input id="brush-size" type="range" min="1" max="20" value="3" style="width:70px;accent-color:#6366f1;">
    </div>
    <button class="tool-btn" onclick="zoomIn()">üîç+</button>
    <button class="tool-btn" onclick="zoomOut()">üîç-</button>
    <span id="zoom-label" style="color:#64748b;font-size:.7rem;min-width:38px;">100%</span>
</div>

<div id="workspace">
    <div id="canvas-wrap">
        <img id="hw-image" src="" alt="Homework">
        <canvas id="draw-canvas"></canvas>
    </div>
    <div id="sidebar">
        <div class="sb-section">
            <div class="sb-label">Quick Grade</div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px;" id="grade-btns">
                ${[['A','100','#16a34a'],['B','80','#2563eb'],['C','65','#d97706'],['F','40','#dc2626']].map(([g,s,c])=>`<button class="grade-btn" onclick="quickGrade(${s})" style="color:${c};">${g}<br><small style="font-size:.6rem;">${s}%</small></button>`).join('')}
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
                <label style="font-size:.8rem;font-weight:700;color:#475569;">Score:</label>
                <input type="number" id="score-input" min="0" max="100" placeholder="0-100">
                <span style="color:#6b7280;font-size:.8rem;">/100</span>
            </div>
        </div>
        <div class="sb-section" style="flex:1;">
            <div class="sb-label">Tutor Feedback</div>
            <textarea id="feedback-text" rows="6" placeholder="Write your feedback, corrections, and encouragement here‚Ä¶"></textarea>
        </div>
        <div class="sb-section">
            <div class="sb-label">Notify Student</div>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 0;">
                <input type="checkbox" id="notify-student" checked style="accent-color:#6366f1;width:16px;height:16px;">
                <span style="font-size:.82rem;color:#374151;">Send notification when saved</span>
            </label>
        </div>
        <div style="padding:14px 18px;">
            <button id="save-btn" onclick="saveGrade()">‚úÖ Save Grade & Return</button>
            <div id="status"></div>
        </div>
    </div>
</div>

<script type="module">
import { auth, db } from './firebaseConfig.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { doc, getDoc, updateDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const params = new URLSearchParams(location.search);
const hwId   = params.get('hw') || sessionStorage.getItem('grading_hw_id') || '';
const tEmail = params.get('tutor') || sessionStorage.getItem('grading_tutor_email') || '';
const tName  = params.get('name')  || sessionStorage.getItem('grading_tutor_name')  || '';

window._db = db;
window._doc = doc;
window._updateDoc = updateDoc;
window._hwId  = hwId;
window._tEmail = tEmail;
window._tName  = tName;

onAuthStateChanged(auth, async user => {
    if (!user) {
        document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;"><div style="text-align:center;"><div style="font-size:3rem;margin-bottom:16px;">üîí</div><p style="color:#ef4444;font-weight:700;font-size:1.1rem;">Not authenticated.</p><p style="color:#9ca3af;margin-top:8px;">Please log in and try again.</p></div></div>';
        return;
    }

    if (!hwId) {
        document.getElementById('hdr-sub').textContent = 'No homework ID provided';
        return;
    }

    const snap = await getDoc(doc(db, 'homework_assignments', hwId));
    if (!snap.exists()) {
        document.getElementById('hdr-sub').textContent = 'Assignment not found';
        return;
    }

    const hw = snap.data();
    window._hw = hw;
    document.getElementById('hdr-title').textContent = `Grading: ${hw.studentName || 'Student'}`;
    document.getElementById('hdr-sub').textContent   = `${hw.subject || 'Assignment'} ¬∑ Submitted: ${hw.submittedAt?.toDate ? hw.submittedAt.toDate().toLocaleDateString() : 'Unknown'}`;

    // Load image
    const imgEl = document.getElementById('hw-image');
    if (hw.imageUrl || hw.fileUrl) {
        const url = hw.imageUrl || hw.fileUrl;
        imgEl.src = url;
        imgEl.onload = () => {
            const canvas = document.getElementById('draw-canvas');
            canvas.width  = imgEl.naturalWidth;
            canvas.height = imgEl.naturalHeight;
            canvas.style.width  = imgEl.width  + 'px';
            canvas.style.height = imgEl.height + 'px';
            initCanvas();
        };
    } else if (hw.content || hw.question) {
        // Text-based submission ‚Äî show as styled div
        const wrap = document.getElementById('canvas-wrap');
        wrap.innerHTML = `<div style="padding:40px;max-width:700px;font-family:serif;font-size:1.1rem;line-height:1.8;color:#1e293b;background:#fff;min-height:100%;border-right:1px solid #e2e8f0;">
            <h2 style="font-family:sans-serif;font-size:.75rem;color:#6366f1;text-transform:uppercase;letter-spacing:.08em;margin-bottom:20px;font-weight:800;">Student Submission</h2>
            <p>${(hw.content || hw.question || '').replace(/\n/g,'<br>')}</p>
        </div>`;
    }

    // Pre-fill existing feedback/score
    if (hw.score !== undefined) document.getElementById('score-input').value = hw.score;
    if (hw.feedback) document.getElementById('feedback-text').value = hw.feedback;
});

window.saveGrade = async function() {
    const btn    = document.getElementById('save-btn');
    const status = document.getElementById('status');
    const score  = document.getElementById('score-input').value.trim();
    const feedback = document.getElementById('feedback-text').value.trim();
    const notify   = document.getElementById('notify-student').checked;
    const scoreVal = score !== '' ? parseInt(score, 10) : null;

    if (scoreVal !== null && (isNaN(scoreVal)||scoreVal<0||scoreVal>100)) {
        showStatus('‚ùå Score must be between 0 and 100', false);
        return;
    }

    // Get annotation as base64 image
    let annotationImg = '';
    const canvas = document.getElementById('draw-canvas');
    if (canvas && canvas.width > 0) {
        try { annotationImg = canvas.toDataURL('image/png'); } catch(e){}
    }

    btn.disabled = true; btn.textContent = '‚è≥ Saving‚Ä¶';

    try {
        const update = {
            status: 'graded',
            gradedAt: new Date(),
            tutorEmail: window._tEmail,
            tutorName:  window._tName,
            feedback,
            tutorAnnotations: feedback,
        };
        if (scoreVal !== null) update.score = scoreVal;
        if (annotationImg)    update.annotationImage = annotationImg;

        await window._updateDoc(window._doc(window._db, 'homework_assignments', window._hwId), update);

        // Optionally send notification to student via messages collection
        if (notify && window._hw) {
            try {
                await addDoc(collection(window._db, 'student_notifications'), {
                    type: 'homework_graded',
                    studentId: window._hw.studentId,
                    studentName: window._hw.studentName,
                    tutorName: window._tName,
                    score: scoreVal,
                    feedback,
                    homeworkId: window._hwId,
                    createdAt: new Date(),
                    read: false
                });
            } catch(e) { /* notification optional ‚Äî don't block */ }
        }

        showStatus('‚úÖ Saved! Student has been graded.', true);
        btn.textContent = '‚úÖ Saved!';
        btn.style.background = 'linear-gradient(135deg,#6366f1,#4f46e5)';
    } catch(err) {
        showStatus('‚ùå ' + err.message, false);
        btn.disabled = false;
        btn.textContent = '‚úÖ Save Grade & Return';
    }
};

function showStatus(msg, ok) {
    const s = document.getElementById('status');
    s.style.display = 'block';
    s.style.background = ok ? '#d1fae5' : '#fee2e2';
    s.style.color      = ok ? '#065f46' : '#991b1b';
    s.textContent = msg;
}
</script>

<script>
/* ‚îÄ‚îÄ Canvas drawing tools ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let tool='pen', color='#ef4444', brushSize=3, drawing=false, startX=0, startY=0;
let ctx, canvas, scale=1;
let history=[], typingBoxes=[];

function initCanvas() {
    canvas = document.getElementById('draw-canvas');
    ctx    = canvas.getContext('2d');
    ctx.lineCap='round'; ctx.lineJoin='round';

    canvas.addEventListener('pointerdown', startDraw);
    canvas.addEventListener('pointermove', draw);
    canvas.addEventListener('pointerup',   endDraw);
    canvas.addEventListener('pointerleave',endDraw);
    canvas.oncontextmenu = e => e.preventDefault();
}

function getPos(e) {
    const r = canvas.getBoundingClientRect();
    const sx = canvas.width  / r.width;
    const sy = canvas.height / r.height;
    return { x:(e.clientX-r.left)*sx, y:(e.clientY-r.top)*sy };
}

function startDraw(e) {
    if (tool==='text') { addTextBox(e); return; }
    saveHistory();
    drawing=true;
    const p=getPos(e); startX=p.x; startY=p.y;
    if(tool==='pen'||tool==='highlight'||tool==='eraser'){
        ctx.beginPath(); ctx.moveTo(p.x,p.y);
    }
}

function draw(e) {
    if(!drawing) return;
    const p=getPos(e);
    if(tool==='pen'){ ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=color; ctx.lineWidth=brushSize; ctx.lineTo(p.x,p.y); ctx.stroke(); }
    else if(tool==='highlight'){ ctx.globalAlpha=.35; ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=color; ctx.lineWidth=brushSize*4; ctx.lineTo(p.x,p.y); ctx.stroke(); }
    else if(tool==='eraser'){ ctx.globalCompositeOperation='destination-out'; ctx.lineWidth=brushSize*4; ctx.lineTo(p.x,p.y); ctx.stroke(); }
}

function endDraw(e) {
    if(!drawing) return;
    drawing=false;
    const p=getPos(e);
    if(tool==='arrow') drawArrow(startX,startY,p.x,p.y);
    ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over';
}

function drawArrow(x1,y1,x2,y2){
    const angle=Math.atan2(y2-y1,x2-x1), len=20, a=Math.PI/7;
    ctx.strokeStyle=color; ctx.lineWidth=brushSize; ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over';
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x2-len*Math.cos(angle-a), y2-len*Math.sin(angle-a));
    ctx.lineTo(x2,y2);
    ctx.lineTo(x2-len*Math.cos(angle+a), y2-len*Math.sin(angle+a));
    ctx.stroke();
}

function addTextBox(e) {
    const wrap=document.getElementById('canvas-wrap');
    const r=wrap.getBoundingClientRect();
    const el=document.createElement('div');
    el.contentEditable='true';
    el.className='type-tool';
    el.style.left=(e.clientX-r.left+wrap.scrollLeft)+'px';
    el.style.top=(e.clientY-r.top+wrap.scrollTop)+'px';
    el.style.color=color;
    el.style.fontSize=Math.max(14,brushSize*3)+'px';
    el.style.zIndex='100';
    wrap.appendChild(el);
    el.focus();
    typingBoxes.push(el);
    // Make draggable
    let dx=0,dy=0,ox=0,oy=0;
    el.onmousedown=ev=>{if(ev.target!==el)return;ox=ev.clientX-el.offsetLeft;oy=ev.clientY-el.offsetTop;document.onmousemove=me=>{el.style.left=(me.clientX-ox)+'px';el.style.top=(me.clientY-oy)+'px';};document.onmouseup=()=>{document.onmousemove=document.onmouseup=null;};};
}

function saveHistory(){ if(ctx) history.push(ctx.getImageData(0,0,canvas.width,canvas.height)); if(history.length>30)history.shift(); }

function setTool(t){
    tool=t;
    document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('tool-'+t)?.classList.add('active');
    if(canvas) canvas.style.cursor = t==='text'?'text':t==='eraser'?'cell':'crosshair';
}

function setColor(c,el){
    color=c;
    document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('active'));
    el.classList.add('active');
}

function quickGrade(s){
    document.getElementById('score-input').value=s;
    document.querySelectorAll('.grade-btn').forEach(b=>b.classList.remove('sel'));
    event.currentTarget.classList.add('sel');
}

function zoomIn(){
    scale=Math.min(scale+.25,4);
    applyZoom();
}
function zoomOut(){
    scale=Math.max(scale-.25,.25);
    applyZoom();
}
function applyZoom(){
    const img=document.getElementById('hw-image');
    const c=document.getElementById('draw-canvas');
    if(img){ const w=img.naturalWidth*scale+'px'; img.style.width=c.style.width=w; const h=img.naturalHeight*scale+'px'; img.style.height=c.style.height=h; }
    document.getElementById('zoom-label').textContent=Math.round(scale*100)+'%';
}

document.getElementById('btn-undo').onclick=()=>{
    if(!ctx||!history.length) return;
    ctx.putImageData(history.pop(),0,0);
};
document.getElementById('clear-annotations').onclick=()=>{
    if(!ctx) return;
    saveHistory();
    ctx.clearRect(0,0,canvas.width,canvas.height);
    typingBoxes.forEach(el=>el.remove());
    typingBoxes=[];
};
document.getElementById('brush-size').oninput=e=>{ brushSize=parseInt(e.target.value); };

// Add color swatches to toolbar via JS (since they were template literals)
document.querySelectorAll('.color-swatch').forEach(el=>{
    el.onclick=function(){ setColor(this.dataset.color,this); };
});
</script>

</body>
</html>
