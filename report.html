<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Report</title>
  <link rel="icon" href="favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body class="bg-green-50 font-sans">
  <div class="container mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-3xl font-bold text-green-700">BLOOMING KIDS HOUSE ASSESSMENT REPORT</h1>
      <button id="logoutBtn" class="bg-yellow-400 hover:bg-yellow-500 text-white font-semibold px-4 py-2 rounded">Logout</button>
    </div>

    <div id="reportContent" class="bg-white shadow-md rounded-lg p-6 text-gray-800">
      <!-- Dynamic content will be injected here -->
    </div>

    <div class="flex justify-end mt-6">
      <button id="downloadBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-2 rounded">Download PDF</button>
    </div>

    <footer class="mt-10 text-center text-sm text-gray-500">
      POWERED BY <span style="color:#FFEB3B">POG</span>
    </footer>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const studentName = urlParams.get('student');
    const parentEmail = urlParams.get('email');

    if (!studentName || !parentEmail) {
      alert('Invalid access. Redirecting to parent login.');
      window.location.href = 'parent.html';
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
      window.location.href = 'parent.html';
    });

    const firebaseAppConfig = {
      apiKey: "AIzaSyBpwxvEoeuT8e6F5vGmDc1VkVfWTUdxavY",
      authDomain: "blooming-kids-house.firebaseapp.com",
      projectId: "blooming-kids-house",
      storageBucket: "blooming-kids-house.appspot.com",
      messagingSenderId: "739684305208",
      appId: "1:739684305208:web:ee1cc9e998b37e1f002f84"
    };

    // Load Firebase SDK via CDN
    const script1 = document.createElement('script');
    script1.src = "https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js";
    document.head.appendChild(script1);

    const script2 = document.createElement('script');
    script2.src = "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js";
    document.head.appendChild(script2);

    script2.onload = () => {
      firebase.initializeApp(firebaseAppConfig);
      const db = firebase.firestore();

      db.collection("studentReports")
        .where("studentName", "==", studentName)
        .where("parentEmail", "==", parentEmail)
        .get()
        .then(querySnapshot => {
          if (querySnapshot.empty) {
            document.getElementById('reportContent').innerHTML = `<p class='text-red-600 font-semibold'>No report found for ${studentName}.</p>`;
            return;
          }
          const doc = querySnapshot.docs[0].data();
          renderReport(doc);
        })
        .catch(err => {
          console.error("Error fetching report:", err);
        });
    };

    function renderReport(data) {
      const subjectReports = Object.entries(data.subjects || {}).map(([subject, scoreObj]) => {
        return `
          <div class="mb-4">
            <h3 class="text-lg font-semibold text-green-600">${subject.toUpperCase()}</h3>
            <p class="mb-2">Score: ${scoreObj.score}%</p>
            <p class="text-sm italic text-gray-600">Recommendations: ${generateRecommendation(subject, scoreObj.topics)}</p>
          </div>
        `;
      }).join('');

      const reportHTML = `
        <div class="mb-6">
          <p class="text-xl font-semibold">Student Name: ${data.studentName}</p>
          <p class="text-lg">Grade: ${data.grade}</p>
          <p class="text-lg">Tutor: ${data.tutorName}</p>
          <p class="text-lg">Location: ${data.location}</p>
        </div>
        <div class="border-t border-b py-4">
          ${subjectReports}
        </div>
        <div class="mt-6">
          <h2 class="text-xl font-semibold mb-2">Director's Message</h2>
          <p class="mb-1">Dear Parent,</p>
          <p class="mb-2">
            Thank you for entrusting us with ${data.studentName}'s academic journey. This report provides valuable insights into your child's strengths and areas that need targeted intervention. Our tutors, especially ${data.tutorName}, are fully prepared to provide expert support to help your child excel across all subjects.
          </p>
          <p>Sincerely,<br /><strong>Mrs. Yinka Isikalu</strong><br />Director, Blooming Kids House</p>
        </div>
      `;

      document.getElementById('reportContent').innerHTML = reportHTML;
    }

    function generateRecommendation(subject, topics = []) {
      if (!topics.length) return `Encourage continued practice in ${subject}.`;
      return `Focus on improving the following areas in ${subject.toLowerCase()}: ${topics.join(', ')}. Consider personalized sessions with ${studentName}'s tutor to reinforce these concepts.`;
    }

    document.getElementById("downloadBtn").addEventListener("click", () => {
      const doc = new jspdf.jsPDF();
      const content = document.getElementById("reportContent").innerText;
      const lines = doc.splitTextToSize(content, 180);
      doc.text(lines, 10, 10);
      doc.save(`${studentName}_Assessment_Report.pdf`);
    });
  </script>
</body>
</html>
