<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parent Assessment Report</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6 flex flex-col items-center">

  <header class="w-full max-w-4xl flex justify-between items-center bg-white p-6 rounded shadow mb-6">
    <h1 class="text-2xl font-bold text-green-700">Your Child's Assessment Report</h1>
    <div>
      <button id="downloadBtn" class="bg-green-600 text-white px-4 py-2 rounded mr-4 hover:bg-green-700">Download PDF</button>
      <button id="logoutBtn" class="bg-yellow-400 text-white px-4 py-2 rounded hover:bg-yellow-500">Logout</button>
    </div>
  </header>

  <main id="reportContainer" class="w-full max-w-4xl bg-white p-6 rounded shadow space-y-6">
    <p>Loading report...</p>
  </main>

  <footer class="mt-auto text-center text-sm text-gray-600 pt-8">
    POWERED BY <span style="color:#FFEB3B">POG</span>
  </footer>

  <script type="module">
    import { db } from './firebaseConfig.js';
    import { collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { auth } from './firebaseConfig.js';

    const reportContainer = document.getElementById('reportContainer');
    const downloadBtn = document.getElementById('downloadBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // Fetch student and parent info from localStorage (set after login)
    const studentName = localStorage.getItem('studentName');
    const parentEmail = localStorage.getItem('parentEmail');
    const grade = localStorage.getItem('grade') || 'N/A';
    const tutorName = localStorage.getItem('tutorName') || 'Your Assigned Tutor';

    if (!studentName || !parentEmail) {
      alert('Missing student or parent information.');
      window.location.href = 'parent.html';  // Parent login page
    }

    async function fetchResults() {
      try {
        const q = query(
          collection(db, "results"),
          where("studentName", "==", studentName),
          where("parentEmail", "==", parentEmail)
        );
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          reportContainer.innerHTML = '<p class="text-red-600">No reports found for this student.</p>';
          downloadBtn.disabled = true;
          return [];
        }

        const results = [];
        snapshot.forEach(doc => results.push(doc.data()));
        return results;
      } catch (err) {
        reportContainer.innerHTML = `<p class="text-red-600">Error loading report: ${err.message}</p>`;
        downloadBtn.disabled = true;
        return [];
      }
    }

    function renderReport(results) {
      if (results.length === 0) return;

      reportContainer.innerHTML = `
        <section class="mb-6">
          <p><strong>Name:</strong> ${studentName}</p>
          <p><strong>Grade:</strong> ${grade}</p>
          <p><strong>Tutor:</strong> ${tutorName}</p>
          <p><strong>Parent Email:</strong> ${parentEmail}</p>
        </section>
      `;

      results.forEach(res => {
        reportContainer.innerHTML += `
          <section class="mb-6 border p-4 rounded">
            <h2 class="text-lg font-semibold mb-2">${res.subject} Result</h2>
            <p><strong>Score:</strong> ${res.score ?? 'N/A'}%</p>

            <p class="mt-2 font-semibold">Knowledge Gained:</p>
            <ul class="list-disc list-inside">
              ${res.knowledge?.map(k => `<li>${k}</li>`).join('') ?? '<li>N/A</li>'}
            </ul>

            <p class="mt-2 font-semibold">Skills Developed:</p>
            <ul class="list-disc list-inside">
              ${res.skills?.map(s => `<li>${s}</li>`).join('') ?? '<li>N/A</li>'}
            </ul>
          </section>
        `;
      });

      // Recommendation and director message
      reportContainer.innerHTML += `
        <section class="mb-6">
          <h3 class="font-bold">Recommendation:</h3>
          <p>Based on the performance, we strongly recommend continued tutoring support with ${tutorName} to help ${studentName} improve and thrive academically.</p>
        </section>

        <section>
          <h3 class="font-bold">Message from the Director:</h3>
          <p>Thank you for trusting Blooming Kids House. Our mission is to guide and support every child toward excellence. We are proud of ${studentName}'s progress and remain committed to their academic journey.</p>
          <p>Sincerely,<br>Director, Blooming Kids House</p>
        </section>
      `;
    }

    async function generatePDF(results) {
      if (!results.length) return;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      const leftMargin = 20;

      doc.setFontSize(16);
      doc.setFont("helvetica", "bold");
      doc.text("BLOOMING KIDS HOUSE ASSESSMENT REPORT", 105, y, { align: "center" });
      y += 10;

      doc.setFontSize(12);
      doc.setFont("helvetica", "normal");
      doc.text(`Name: ${studentName}`, leftMargin, y);
      doc.text(`Grade: ${grade}`, 120, y);
      y += 8;
      doc.text(`Tutor: ${tutorName}`, leftMargin, y);
      doc.text(`Parent Email: ${parentEmail}`, 120, y);
      y += 10;

      results.forEach(res => {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        doc.setFont("helvetica", "bold");
        doc.text(`${res.subject} Result`, leftMargin, y);
        y += 6;

        doc.setFont("helvetica", "normal");
        doc.text(`Score: ${res.score ?? 'N/A'}%`, leftMargin + 5, y);
        y += 6;

        if (res.knowledge && Array.isArray(res.knowledge)) {
          doc.text("Knowledge Gained:", leftMargin + 5, y);
          y += 6;
          res.knowledge.forEach(item => {
            const lines = doc.splitTextToSize(`• ${item}`, 160);
            doc.text(lines, leftMargin + 10, y);
            y += lines.length * 5;
            if (y > 270) {
              doc.addPage();
              y = 20;
            }
          });
        }

        if (res.skills && Array.isArray(res.skills)) {
          doc.text("Skills Developed:", leftMargin + 5, y);
          y += 6;
          res.skills.forEach(skill => {
            const lines = doc.splitTextToSize(`• ${skill}`, 160);
            doc.text(lines, leftMargin + 10, y);
            y += lines.length * 5;
            if (y > 270) {
              doc.addPage();
              y = 20;
            }
          });
        }

        y += 8;
      });

      // Recommendation
      const recommendation = `Based on the performance, we strongly recommend continued tutoring support with ${tutorName} to help ${studentName} improve and thrive academically.`;
      const recLines = doc.splitTextToSize(recommendation, 170);
      doc.setFont("helvetica", "bold");
      doc.text("Recommendation:", leftMargin, y);
      y += 6;
      doc.setFont("helvetica", "normal");
      doc.text(recLines, leftMargin + 5, y);
      y += recLines.length * 6;

      // Director message
      if (y > 250) {
        doc.addPage();
        y = 20;
      }

      const directorMessage = `Thank you for trusting Blooming Kids House. Our mission is to guide and support every child toward excellence. We are proud of ${studentName}'s progress and remain committed to their academic journey.\n\nSincerely,\nDirector, Blooming Kids House`;
      const directorLines = doc.splitTextToSize(directorMessage, 170);
      doc.setFont("helvetica", "bold");
      doc.text("Message from the Director:", leftMargin, y);
      y += 6;
      doc.setFont("helvetica", "normal");
      doc.text(directorLines, leftMargin + 5, y);
      y += directorLines.length * 6;

      // Footer
      doc.setFontSize(10);
      doc.setTextColor("#4CAF50");
      doc.textWithLink("POWERED BY POG", 105, 285, { align: "center" });

      doc.save(`${studentName}-Assessment-Report.pdf`);
    }

    logoutBtn.addEventListener('click', () => {
      // Clear local storage and redirect to login
      localStorage.removeItem('studentName');
      localStorage.removeItem('parentEmail');
      localStorage.removeItem('grade');
      localStorage.removeItem('tutorName');
      window.location.href = 'parent.html';
    });

    downloadBtn.addEventListener('click', async () => {
      downloadBtn.disabled = true;
      downloadBtn.textContent = 'Generating...';
      const results = await fetchResults();
      if (results.length > 0) {
        generatePDF(results);
      }
      downloadBtn.disabled = false;
      downloadBtn.textContent = 'Download PDF';
    });

    // On load, fetch and render report
    (async () => {
      const results = await fetchResults();
      renderReport(results);
    })();

  </script>

</body>
</html>
