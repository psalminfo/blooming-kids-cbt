<!DOCTYPE html>
<html>
<head>
    <title>Phone Number Migration</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        button { padding: 15px 30px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #45a049; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        #output { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; max-height: 500px; overflow-y: auto; background: #f9f9f9; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h2>üì± Phone Number Migration Tool</h2>
    <p>This will add <code>normalizedPhone</code> field to all existing students for faster searching.</p>
    
    <button id="migrateBtn">Start Migration</button>
    <button id="verifyBtn" style="background: #2196F3;">Verify Migration</button>
    
    <div id="output"></div>

    <!-- Include Firebase -->
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js"></script>

    <script>
        // Your Firebase config (SAME AS YOUR APP)
        const firebaseConfig = {
            apiKey: "AIzaSyD1lJhsWMMs_qerLBSzk7wKhjLyI_11RJg",
            authDomain: "bloomingkidsassessment.firebaseapp.com",
            projectId: "bloomingkidsassessment",
            storageBucket: "bloomingkidsassessment.appspot.com",
            messagingSenderId: "238975054977",
            appId: "1:238975054977:web:87c70b4db044998a204980"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        async function migrateStudentPhones() {
            const btn = document.getElementById('migrateBtn');
            btn.disabled = true;
            btn.textContent = 'Migrating...';
            
            log('üöÄ Starting phone number migration...');
            
            // Process both collections
            const collections = ['students', 'pending_students'];
            let totalUpdated = 0;
            
            for (const collName of collections) {
                log(`üìÇ Processing ${collName} collection...`);
                
                try {
                    const querySnapshot = await db.collection(collName).get();
                    log(`Found ${querySnapshot.size} documents in ${collName}`);
                    
                    let updatedCount = 0;
                    let errorCount = 0;
                    
                    // Process each document
                    for (const studentDoc of querySnapshot.docs) {
                        const student = studentDoc.data();
                        const parentPhone = student.parentPhone;
                        
                        if (parentPhone && !student.normalizedPhone) {
                            const normalizedPhone = parentPhone.replace(/\D/g, '').slice(-10);
                            
                            try {
                                await db.collection(collName).doc(studentDoc.id).update({
                                    normalizedPhone: normalizedPhone
                                });
                                updatedCount++;
                                log(`‚úÖ Updated ${student.studentName}: ${normalizedPhone}`);
                                
                                // Add small delay to avoid overwhelming Firestore
                                await new Promise(resolve => setTimeout(resolve, 50));
                                
                            } catch (error) {
                                errorCount++;
                                log(`‚ùå Error updating ${student.studentName}: ${error.message}`, 'error');
                            }
                        } else if (!parentPhone) {
                            log(`‚ö†Ô∏è No phone number for ${student.studentName}`, 'error');
                        } else {
                            log(`‚úì Already migrated: ${student.studentName}`);
                        }
                    }
                    
                    log(`üéâ Successfully updated ${updatedCount} documents in ${collName} (${errorCount} errors)`, updatedCount > 0 ? 'success' : 'info');
                    totalUpdated += updatedCount;
                    
                } catch (error) {
                    log(`üí• Error processing ${collName}: ${error.message}`, 'error');
                }
            }
            
            log(`üèÅ MIGRATION COMPLETED! Total documents updated: ${totalUpdated}`, 'success');
            btn.textContent = 'Migration Complete';
        }

        async function verifyMigration() {
            log('üîç Verifying migration...');
            
            try {
                const studentsSnapshot = await db.collection('students').limit(10).get();
                let migratedCount = 0;
                let totalCount = 0;
                
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    totalCount++;
                    if (student.normalizedPhone) {
                        migratedCount++;
                        log(`‚úÖ ${student.studentName}: ${student.normalizedPhone}`);
                    } else {
                        log(`‚ùå ${student.studentName}: NO normalizedPhone`);
                    }
                });
                
                log(`üìä Verification: ${migratedCount}/${totalCount} students have normalizedPhone field`, migratedCount === totalCount ? 'success' : 'error');
                
            } catch (error) {
                log(`üí• Verification error: ${error.message}`, 'error');
            }
        }

        // Event listeners
        document.getElementById('migrateBtn').addEventListener('click', migrateStudentPhones);
        document.getElementById('verifyBtn').addEventListener('click', verifyMigration);

        log('‚úÖ Migration tool ready. Click "Start Migration" to begin.');
    </script>
</body>
</html>