<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blooming Kids · Tutor Portal</title>
    <!-- Tailwind CSS (lightweight) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <!-- utility libraries (future features) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ---------- CUSTOM STYLES (glass, orbs, modern touches) ---------- */
        * { font-family: 'Plus Jakarta Sans', system-ui, sans-serif; }
        body {
            background: #0b1a1e; /* fallback */
            background-image: 
                linear-gradient(125deg, rgba(20, 80, 70, 0.4) 0%, transparent 40%),
                repeating-linear-gradient(45deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 2px, transparent 2px, transparent 8px),
                url('https://res.cloudinary.com/dy2hxcyaf/image/upload/v1769020680/Gemini_Generated_Image_o5m8auo5m8auo5m8_hzzxks.png');
            background-size: cover, auto, cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            position: relative;
            transition: background-color 0.3s;
        }
        /* dark mode body adjustments */
        body.dark {
            background-color: #031013;
            background-blend-mode: overlay;
        }

        /* floating orbs (green / yellow) */
        .orb {
            position: fixed;
            width: 35vmax;
            height: 35vmax;
            border-radius: 50%;
            filter: blur(100px);
            z-index: 0;
            opacity: 0.5;
            animation: float 18s infinite alternate ease-in-out;
        }
        .orb-1 {
            background: #7ae07f;
            bottom: -10vh;
            left: -10vw;
            animation-duration: 22s;
        }
        .orb-2 {
            background: #ffd966;
            top: -5vh;
            right: -5vw;
            animation-duration: 19s;
        }
        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(4%, 6%) scale(1.1); }
        }

        /* main glass panel */
        .glass-panel {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 1280px;
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 2.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 1px 2px rgba(255,255,255,0.3);
            transition: background 0.3s, border-color 0.3s;
            padding: 2rem 1.8rem;
        }
        body.dark .glass-panel {
            background: rgba(10, 25, 27, 0.6);
            border-color: rgba(255,255,255,0.1);
        }

        /* gradient text */
        .text-gradient {
            background: linear-gradient(135deg, #2ecc71, #f1c40f);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
        }

        /* avatar with gradient */
        .avatar-modern {
            width: 48px;
            height: 48px;
            background: linear-gradient(145deg, #1abc9c, #f39c12);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 8px 16px -4px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.3);
        }

        /* date badge */
        .badge-date {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(8px);
            padding: 0.5rem 1.2rem;
            border-radius: 40px;
            border: 1px solid rgba(255,255,255,0.3);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        body.dark .badge-date {
            background: rgba(0,0,0,0.3);
            color: #ddd;
        }

        /* stat cards (clickable) */
        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 2rem;
            padding: 1.5rem 1rem;
            transition: all 0.2s ease;
            cursor: pointer;
            box-shadow: 0 8px 20px -8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .stat-card:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-3px);
            box-shadow: 0 18px 30px -8px black;
        }
        body.dark .stat-card {
            background: rgba(0, 20, 15, 0.5);
            border-color: rgba(255,255,255,0.08);
        }
        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(4px);
        }

        /* navigation pills (horizontal scroll) */
        .nav-pill-container {
            display: flex;
            gap: 0.6rem;
            overflow-x: auto;
            padding: 0.5rem 0.2rem 1rem 0.2rem;
            scrollbar-width: none; /* firefox */
            -ms-overflow-style: none; /* ie */
        }
        .nav-pill-container::-webkit-scrollbar { display: none; }
        .nav-tab-modern {
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.15);
            padding: 0.8rem 1.8rem;
            border-radius: 60px;
            font-weight: 600;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            white-space: nowrap;
            transition: all 0.15s;
            cursor: pointer;
        }
        .nav-tab-modern i { font-size: 1.2rem; opacity: 0.9; }
        .nav-tab-modern.active {
            background: white;
            color: #1f2937;
            border-color: rgba(0,0,0,0.1);
            box-shadow: 0 12px 24px -12px #00000055;
        }
        body.dark .nav-tab-modern.active {
            background: #1f2a2c;
            color: #ecfdf5;
        }

        /* generic frosted button */
        .btn-modern {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.25);
            padding: 0.6rem 1.5rem;
            border-radius: 40px;
            font-weight: 600;
            color: white;
            transition: 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .btn-modern:hover { background: rgba(255,255,255,0.25); }

        /* skeleton loader */
        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { opacity: 1; transform: scale(0.95); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(0.95); }
        }
        .skeleton-loader {
            background: rgba(255,255,255,0.08);
            border-radius: 2rem;
            padding: 3rem;
            text-align: center;
            backdrop-filter: blur(4px);
            border: 1px dashed rgba(255,255,255,0.2);
        }

        /* network error overlay */
        #networkErrorOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(12px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            visibility: hidden;
            opacity: 0;
            transition: 0.2s;
        }
        #networkErrorOverlay.show { visibility: visible; opacity: 1; }

        /* hide scrollbar helper */
        .hide-scrollbar { scrollbar-width: none; -ms-overflow-style: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="light">
    <!-- animated orbs -->
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>

    <!-- network warning banner (hidden by default) -->
    <div id="networkWarning" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 bg-yellow-400/80 backdrop-blur-md text-gray-900 px-6 py-3 rounded-full shadow-2xl flex items-center gap-4 border border-yellow-300 hidden">
        <i class="fa-solid fa-wifi text-xl"></i>
        <span id="warningMessage">You are offline. Some features may be unavailable.</span>
        <button onclick="hideNetworkWarning()" class="ml-2 text-xl font-bold">&times;</button>
    </div>

    <!-- full-screen network error overlay -->
    <div id="networkErrorOverlay">
        <div class="glass-panel max-w-md text-center text-white">
            <i class="fa-solid fa-cloud-moon text-6xl mb-4 text-amber-300"></i>
            <h2 class="text-3xl font-bold mb-2">Connection lost</h2>
            <p id="errorMessage" class="mb-6 opacity-80">Unable to reach the server. Please check your internet.</p>
            <div class="flex gap-4 justify-center">
                <button onclick="checkConnectivity()" class="btn-modern"><i class="fa-solid fa-rotate-right"></i> Retry</button>
                <button onclick="window.location.reload()" class="btn-modern"><i class="fa-solid fa-circle-check"></i> Refresh</button>
            </div>
        </div>
    </div>

    <!-- MAIN GLASS CONTAINER -->
    <div class="glass-panel">
        <!-- header -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-8">
            <div class="flex items-center gap-4">
                <img id="logoImg" src="https://res.cloudinary.com/dy2hxcyaf/image/upload/v1757700806/newbhlogo_umwqzy.svg" alt="Blooming Kids" class="h-14 w-auto drop-shadow-lg">
                <div class="text-white text-xl font-semibold">Welcome, <span class="text-gradient" id="tutorNameHeading">Tutor</span></div>
            </div>
            <div class="flex items-center gap-3 flex-wrap">
                <!-- date badge -->
                <div class="badge-date"><i class="fa-regular fa-calendar"></i> <span id="currentDate">—</span></div>
                <!-- dark mode toggle -->
                <button id="modeToggle" class="btn-modern !px-4 !py-3">
                    <i id="modeIcon" class="fa-regular fa-sun"></i>
                </button>
                <!-- whatsapp support -->
                <a id="whatsappBtn" href="https://wa.me/2348158768689" target="_blank" class="btn-modern bg-green-600/30 border-green-400/60 hover:bg-green-600/50">
                    <i class="fa-brands fa-whatsapp"></i> <span class="hidden sm:inline">Support</span>
                </a>
                <!-- logout button -->
                <button id="logoutBtn" class="btn-modern bg-amber-600/40 border-amber-400/60 hover:bg-amber-600/60">
                    <i class="fa-solid fa-right-from-bracket"></i> <span class="hidden sm:inline">Logout</span>
                </button>
                <!-- avatar -->
                <div class="avatar-modern">T</div>
            </div>
        </div>

        <!-- 4 stat cards (clickable) -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card" id="totalStudentsCard">
                <div class="stat-icon" style="color:#2ecc71;"><i class="fa-solid fa-users"></i></div>
                <div><div class="text-xs uppercase tracking-wider opacity-80">Total students</div><span class="text-3xl font-bold" id="totalStudentsCount">—</span></div>
            </div>
            <div class="stat-card" id="todayClassesCard">
                <div class="stat-icon" style="color:#f39c12;"><i class="fa-solid fa-clock"></i></div>
                <div><div class="text-xs uppercase tracking-wider opacity-80">Today's classes</div><span class="text-3xl font-bold" id="todayClassesCount">—</span></div>
            </div>
            <div class="stat-card" id="pendingReportsCard">
                <div class="stat-icon" style="color:#3498db;"><i class="fa-solid fa-file-pen"></i></div>
                <div><div class="text-xs uppercase tracking-wider opacity-80">Pending reports</div><span class="text-3xl font-bold" id="pendingReportsCount">—</span></div>
            </div>
            <div class="stat-card" id="achievementsCard">
                <div class="stat-icon" style="color:#e84393;"><i class="fa-solid fa-star"></i></div>
                <div><div class="text-xs uppercase tracking-wider opacity-80">Performance</div><span class="text-3xl font-bold" id="performanceScoreCount">—</span></div>
            </div>
        </div>

        <!-- navigation pills (6 tabs) -->
        <div class="nav-pill-container hide-scrollbar">
            <div class="nav-tab-modern active" id="navDashboard"><i class="fa-solid fa-chart-pie"></i> Dashboard</div>
            <div class="nav-tab-modern" id="navStudentDatabase"><i class="fa-solid fa-database"></i> Student Database</div>
            <div class="nav-tab-modern" id="navAutoStudents"><i class="fa-solid fa-robot"></i> Auto Students</div>
            <div class="nav-tab-modern" id="navAcademic"><i class="fa-solid fa-book-open"></i> Academic</div>
            <div class="nav-tab-modern" id="navScheduleManagement"><i class="fa-solid fa-calendar-week"></i> Schedule</div>
            <div class="nav-tab-modern" id="navCourses"><i class="fa-solid fa-layer-group"></i> Courses</div>
        </div>

        <!-- main content area (replaced by tutor.js) -->
        <div id="mainContent" class="mt-8 min-h-[300px]">
            <div class="skeleton-loader flex flex-col items-center justify-center">
                <div class="pulse-ring text-7xl mb-4"><i class="fa-solid fa-leaf text-green-300"></i></div>
                <p class="text-white/80 text-lg">Loading secure portal...</p>
            </div>
        </div>

        <!-- footer -->
        <div class="mt-8 text-center text-sm text-white/60 flex items-center justify-center gap-2">
            <i class="fa-solid fa-shield-halfling"></i> End‑to‑end encrypted · Blooming Kids Care v3.3
        </div>
    </div>

    <!-- external scripts (references only) -->
    <script type="module" src="tutor.js"></script>
    <script src="games.js"></script>

    <!-- inline enhancement script (dynamic stats, dark mode, network) -->
    <script>
        (function() {
            // ---------- DARK MODE ----------
            const modeToggle = document.getElementById('modeToggle');
            const modeIcon = document.getElementById('modeIcon');
            const body = document.body;
            function setTheme(theme) {
                if (theme === 'dark') {
                    body.classList.add('dark');
                    modeIcon.className = 'fa-regular fa-moon';
                } else {
                    body.classList.remove('dark');
                    modeIcon.className = 'fa-regular fa-sun';
                }
                localStorage.setItem('tutorTheme', theme);
            }
            const saved = localStorage.getItem('tutorTheme') || 'light';
            setTheme(saved);
            modeToggle.addEventListener('click', () => {
                setTheme(body.classList.contains('dark') ? 'light' : 'dark');
            });

            // ---------- CURRENT DATE ----------
            const dateSpan = document.getElementById('currentDate');
            const now = new Date();
            dateSpan.textContent = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            // ---------- NETWORK HANDLERS ----------
            const warningEl = document.getElementById('networkWarning');
            const overlayEl = document.getElementById('networkErrorOverlay');
            const warningMsg = document.getElementById('warningMessage');
            const errorMsg = document.getElementById('errorMessage');

            window.hideNetworkWarning = function() {
                warningEl.classList.add('hidden');
            };
            window.showNetworkError = function(show) {
                if (show) overlayEl.classList.add('show');
                else overlayEl.classList.remove('show');
            };
            window.checkConnectivity = function() {
                if (navigator.onLine) {
                    showNetworkError(false);
                    warningEl.classList.add('hidden');
                    location.reload(); // quick refresh
                } else {
                    errorMsg.innerText = 'Still offline. Check connection.';
                }
            };

            function updateNetworkUI() {
                if (!navigator.onLine) {
                    warningEl.classList.remove('hidden');
                    warningMsg.innerText = 'You are offline. Using cached data.';
                } else {
                    warningEl.classList.add('hidden');
                    showNetworkError(false);
                }
            }
            window.addEventListener('online', updateNetworkUI);
            window.addEventListener('offline', updateNetworkUI);
            updateNetworkUI(); // initial

            // ---------- WAIT FOR window.tutorData (set by tutor.js) AND UPDATE STATS / HANDLERS ----------
            function waitForTutorData() {
                if (window.tutorData && window.tutorData.email) {
                    initEnhancements(window.tutorData);
                } else {
                    setTimeout(waitForTutorData, 200);
                }
            }
            waitForTutorData();

            async function initEnhancements(tutor) {
                // update welcome with tutor name
                const nameHeading = document.getElementById('tutorNameHeading');
                if (tutor.name) nameHeading.innerText = tutor.name.split(' ')[0] || 'Tutor';

                // ------ DYNAMIC IMPORT FIRESTORE (fixed duplicate db) ------
                try {
                    // Import Firestore functions from CDN
                    const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js');
                    // Import the initialized db instance from your local config
                    const { db } = await import('./firebaseConfig.js');

                    // Build query
                    const studentsRef = collection(db, 'students');
                    const q = query(studentsRef, where('tutorEmail', '==', tutor.email));
                    const snapshot = await getDocs(q);
                    const activeStudents = snapshot.docs
                        .map(d => ({ id: d.id, ...d.data() }))
                        .filter(s => !['archived','graduated','transferred'].includes(s.status));

                    // 1) total students
                    document.getElementById('totalStudentsCount').innerText = activeStudents.length;

                    // 2) today's classes (weekday name)
                    const weekdays = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
                    const todayName = weekdays[new Date().getDay()];
                    let todayCount = 0;
                    activeStudents.forEach(s => {
                        if (s.schedule && Array.isArray(s.schedule)) {
                            todayCount += s.schedule.filter(slot => slot.day === todayName).length;
                        }
                    });
                    document.getElementById('todayClassesCount').innerText = todayCount;

                    // 3) pending reports (no report in last 7 days OR lastReportDate older than 7 days)
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    let pending = 0;
                    activeStudents.forEach(s => {
                        if (!s.lastReportDate) { pending++; return; }
                        let lastDate = s.lastReportDate?.toDate ? s.lastReportDate.toDate() : new Date(s.lastReportDate);
                        if (lastDate < sevenDaysAgo) pending++;
                    });
                    document.getElementById('pendingReportsCount').innerText = pending;

                    // 4) performance score (avg attendanceRate, default 85)
                    let totalRate = 0, count = 0;
                    activeStudents.forEach(s => {
                        if (s.attendanceRate != null) {
                            totalRate += Number(s.attendanceRate);
                            count++;
                        }
                    });
                    let avgScore = count ? Math.round(totalRate / count) : 85;
                    document.getElementById('performanceScoreCount').innerText = avgScore + '%';

                } catch (e) {
                    console.warn('Firestore dynamic import failed (offline or config missing). Using fallback.', e);
                    // fallback dummy data
                    document.getElementById('totalStudentsCount').innerText = '12';
                    document.getElementById('todayClassesCount').innerText = '5';
                    document.getElementById('pendingReportsCount').innerText = '3';
                    document.getElementById('performanceScoreCount').innerText = '91%';
                }

                // ----- ATTACH CLICK HANDLERS TO STAT CARDS & EXTRA TABS -----
                // total students → activate Student Database tab
                document.getElementById('totalStudentsCard').addEventListener('click', () => {
                    document.getElementById('navStudentDatabase')?.click();
                });
                // today's classes → try schedule modal (from tutor.js)
                document.getElementById('todayClassesCard').addEventListener('click', () => {
                    if (typeof window.showScheduleCalendarModal === 'function') window.showScheduleCalendarModal();
                    else alert('Schedule calendar modal not yet loaded.');
                });
                // pending reports → focus on dashboard (pending section)
                document.getElementById('pendingReportsCard').addEventListener('click', () => {
                    document.getElementById('navDashboard')?.click();
                });
                // achievements (performance) → maybe show gamification
                document.getElementById('achievementsCard').addEventListener('click', () => {
                    if (typeof window.initGamification === 'function') window.initGamification(tutor.id);
                    else alert('Performance details coming soon.');
                });

                // navigation pills active toggle and placeholder actions
                const tabs = ['navDashboard','navStudentDatabase','navAutoStudents','navAcademic','navScheduleManagement','navCourses'];
                tabs.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    el.addEventListener('click', (e) => {
                        // remove active from all
                        tabs.forEach(tabId => document.getElementById(tabId)?.classList.remove('active'));
                        el.classList.add('active');
                        // custom actions for extra tabs
                        if (id === 'navAcademic') {
                            alert('Academic module – coming soon.');
                        } else if (id === 'navScheduleManagement') {
                            if (typeof window.showScheduleCalendarModal === 'function') window.showScheduleCalendarModal();
                            else alert('Schedule view loading...');
                        } else if (id === 'navCourses') {
                            alert('Course materials will appear here.');
                        }
                        // other tabs are handled by tutor.js (Dashboard, StudentDatabase, AutoStudents)
                        // we just update active style.
                    });
                });

                // logout button (reuse from tutor.js if it exists, else simple redirect)
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    if (typeof window.signOut === 'function') {
                        // use global auth from tutor.js? just redirect.
                    }
                    window.location.href = 'tutor-auth.html';
                });
            }

            // attach quick placeholder for "Academic" etc even before tutorData
            document.getElementById('navAcademic').addEventListener('click', (e) => {
                // default behaviour (active will be set later but we can show toast)
                if (!window.tutorData) alert('Please wait for data load.');
            });
        })();
    </script>
</body>
</html>
