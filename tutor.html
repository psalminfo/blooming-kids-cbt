<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blooming · Tutor Portal — full features + courses per student</title>

    <!-- Preconnect & fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        :root {
            --primary:#1e8b4c; --primary-soft:#2ecc71; --primary-glow:rgba(46,204,113,0.4);
            --accent:#fbbf24; --accent-glow:rgba(251,191,36,0.5);
            --surface:rgba(255,255,255,0.7); --surface-dark:rgba(17,25,40,0.75);
            --text-light:#1e293b; --text-dark:#f1f5f9;
            --border-light:rgba(255,255,255,0.5); --border-dark:rgba(255,255,255,0.1);
            --shadow:0 20px 40px -15px rgba(0,20,10,0.2);
            --shadow-hover:0 30px 50px -20px rgba(0,40,20,0.3);
            --blur:16px; --transition:all 0.25s cubic-bezier(0.2,0,0,1);
        }
        body {
            font-family:'Plus Jakarta Sans',sans-serif;
            background:url('https://res.cloudinary.com/dy2hxcyaf/image/upload/v1769020680/Gemini_Generated_Image_o5m8auo5m8auo5m8_hzzxks.png') center/cover fixed;
            min-height:100vh; color:var(--text-light); transition:color 0.3s,background 0.3s; position:relative;
        }
        body::before {
            content:''; position:fixed; inset:0;
            background:radial-gradient(circle at 20% 30%,rgba(46,204,113,0.08) 0%,transparent 40%),
                       radial-gradient(circle at 80% 70%,rgba(251,191,36,0.1) 0%,transparent 40%),
                       repeating-linear-gradient(45deg,rgba(255,255,255,0.02) 0px,rgba(255,255,255,0.02) 2px,transparent 2px,transparent 8px);
            pointer-events:none; z-index:0;
        }
        body.dark { --surface:var(--surface-dark); --border-light:var(--border-dark); --text-light:var(--text-dark); }
        body.dark::before { opacity:0.6; }
        .glass-panel {
            background:var(--surface); backdrop-filter:blur(var(--blur)) saturate(180%);
            -webkit-backdrop-filter:blur(var(--blur)) saturate(180%);
            border:1px solid var(--border-light); box-shadow:var(--shadow),0 0 0 1px rgba(255,255,255,0.1) inset;
            border-radius:2.5rem; transition:var(--transition); position:relative; z-index:10;
        }
        .glass-panel:hover { box-shadow:var(--shadow-hover),0 0 0 1px rgba(255,255,255,0.2) inset; }
        .orb {
            position:absolute; border-radius:50%; filter:blur(70px); opacity:0.25; z-index:0;
            animation:float 20s infinite alternate ease-in-out;
        }
        .orb-1 { width:300px; height:300px; background:#2ecc71; top:-100px; right:-100px; }
        .orb-2 { width:400px; height:400px; background:#fbbf24; bottom:-150px; left:-150px; animation-delay:-5s; }
        @keyframes float { 0% { transform:translate(0,0) scale(1); } 100% { transform:translate(30px,30px) scale(1.1); } }
        .avatar-modern {
            width:48px; height:48px; background:linear-gradient(145deg,var(--primary),#0b5e2e);
            border-radius:24px 24px 24px 8px; display:flex; align-items:center; justify-content:center;
            color:#fff; font-weight:600; font-size:1.25rem; box-shadow:0 8px 18px var(--primary-glow);
            transition:var(--transition); border:2px solid rgba(255,255,255,0.3);
        }
        .badge-date {
            background:rgba(255,255,255,0.25); backdrop-filter:blur(8px); padding:0.4rem 1.2rem;
            border-radius:40px; font-weight:600; font-size:0.9rem; border:1px solid rgba(255,255,255,0.3);
        }
        .stat-card {
            background:rgba(255,255,255,0.2); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,0.3);
            border-radius:2rem; padding:1.2rem 1.5rem; transition:var(--transition);
            box-shadow:0 8px 20px -10px rgba(0,0,0,0.1); color:inherit; cursor:pointer;
        }
        .stat-card:hover { background:rgba(255,255,255,0.3); transform:translateY(-4px); border-color:var(--primary); }
        body.dark .stat-card { background:rgba(0,0,0,0.2); border-color:rgba(255,255,255,0.1); }
        .stat-icon {
            width:48px; height:48px; border-radius:20px; background:linear-gradient(135deg,var(--primary),#0b5e2e);
            display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.4rem;
            box-shadow:0 6px 14px var(--primary-glow);
        }
        .nav-pill-container {
            background:rgba(0,0,0,0.05); border-radius:3rem; padding:0.4rem; backdrop-filter:blur(4px);
            display:flex; flex-wrap:wrap; gap:0.2rem;
        }
        body.dark .nav-pill-container { background:rgba(255,255,255,0.05); }
        .nav-tab-modern {
            padding:0.7rem 1.8rem; border-radius:2.5rem; font-weight:600; color:var(--text-light);
            opacity:0.7; transition:var(--transition); border:none; background:transparent; cursor:pointer;
            letter-spacing:-0.01em; white-space:nowrap;
        }
        .nav-tab-modern i { margin-right:8px; }
        .nav-tab-modern:hover { opacity:1; background:rgba(255,255,255,0.3); }
        .nav-tab-modern.active {
            opacity:1; background:#fff; color:var(--primary);
            box-shadow:0 10px 20px -8px rgba(0,0,0,0.2),0 0 0 1px rgba(255,255,255,0.7);
        }
        body.dark .nav-tab-modern.active { background:#1e293b; color:var(--primary-soft); }
        .btn-modern {
            display:inline-flex; align-items:center; justify-content:center; gap:0.6rem;
            padding:0.7rem 1.4rem; border-radius:2rem; font-weight:600; transition:var(--transition);
            border:none; cursor:pointer; background:rgba(255,255,255,0.2); backdrop-filter:blur(12px);
            border:1px solid rgba(255,255,255,0.25); color:inherit; box-shadow:0 4px 12px rgba(0,0,0,0.05);
        }
        .btn-modern:hover { background:rgba(255,255,255,0.35); transform:translateY(-2px); border-color:var(--primary); box-shadow:0 14px 22px -10px var(--primary-glow); }
        .btn-primary { background:linear-gradient(135deg,var(--primary),#0f6b37); color:#fff; border:none; box-shadow:0 8px 20px var(--primary-glow); }
        .btn-accent { background:linear-gradient(135deg,var(--accent),#f59e0b); color:#422006; border:none; box-shadow:0 8px 20px var(--accent-glow); }

        /* modal high z-index */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px); z-index:10000; display:flex; align-items:center; justify-content:center; padding:1rem; }
        .modal-content { background:#fff; border-radius:2rem; padding:1.5rem; max-width:600px; width:100%; max-height:90vh; overflow-y:auto; box-shadow:0 25px 50px -12px #000; border:1px solid rgba(255,255,255,0.3); }
        body.dark .modal-content { background:#1e293b; color:#f1f5f9; border-color:#334155; }

        /* student grid cards (used by tutor.js dynamic content) */
        .student-grid-card {
            background:rgba(255,255,255,0.2); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,0.3);
            border-radius:1.5rem; padding:1rem; transition:all 0.2s;
        }
        .student-grid-card:hover { transform:translateY(-4px); background:rgba(255,255,255,0.3); border-color:var(--primary); }
        body.dark .student-grid-card { background:rgba(0,0,0,0.2); border-color:rgba(255,255,255,0.1); }

        /* file upload area */
        .upload-area { border:2px dashed var(--primary); border-radius:2rem; padding:1.5rem; text-align:center; background:rgba(255,255,255,0.1); cursor:pointer; transition:0.2s; }
        .upload-area:hover { background:rgba(46,204,113,0.1); }
        .file-list-item { background:rgba(255,255,255,0.1); border-radius:1rem; padding:0.75rem; margin-bottom:0.5rem; display:flex; align-items:center; gap:1rem; }

        .skeleton-loader { background:rgba(255,255,255,0.2); border-radius:2rem; padding:2rem; backdrop-filter:blur(4px); border:1px dashed rgba(255,255,255,0.4); }
        .pulse-ring { width:72px; height:72px; border-radius:50%; background:rgba(46,204,113,0.3); display:flex; align-items:center; justify-content:center; position:relative; }
        .pulse-ring::before { content:''; position:absolute; width:100%; height:100%; border-radius:50%; border:2px solid rgba(46,204,113,0.6); animation:pulse 1.8s infinite; }
        @keyframes pulse { 0% { transform:scale(1); opacity:0.8; } 100% { transform:scale(1.8); opacity:0; } }
        .text-gradient { background:linear-gradient(145deg,var(--primary),#0f6b37); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:700; }
        .hide-scrollbar::-webkit-scrollbar { display:none; }
        #networkWarning, #networkErrorOverlay { z-index:9999; }

        /* material chips */
        .material-chip { background:rgba(46,204,113,0.15); border-radius:2rem; padding:0.25rem 0.8rem; font-size:0.8rem; display:inline-flex; align-items:center; gap:4px; }
    </style>
</head>
<body class="antialiased">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>

    <!-- network warning -->
    <div id="networkWarning" class="fixed top-0 left-0 right-0 bg-yellow-100/80 backdrop-blur-md border-b border-yellow-400 text-yellow-800 px-4 py-3 text-center hidden shadow-lg z-50">
        <span id="warningMessage" class="font-medium">Offline</span>
        <button onclick="hideNetworkWarning()" class="ml-4 text-yellow-800 hover:text-yellow-900 font-bold text-xl">&times;</button>
    </div>

    <div class="min-h-screen p-3 md:p-6 lg:p-8 flex justify-center items-start relative">
        <div class="glass-panel w-full max-w-7xl p-5 md:p-8 lg:p-10 relative overflow-hidden">
            <!-- header -->
            <div class="relative z-20 flex flex-wrap items-center justify-between gap-4 mb-6">
                <div class="flex items-center gap-3 sm:gap-4">
                    <div class="relative group">
                        <div class="absolute -inset-1 bg-gradient-to-r from-green-400 to-blue-500 rounded-full blur-xl opacity-40 group-hover:opacity-70 transition"></div>
                        <img id="logoImg" src="https://res.cloudinary.com/dy2hxcyaf/image/upload/v1757700806/newbhlogo_umwqzy.svg" alt="Blooming Kids" class="relative h-14 w-auto object-contain drop-shadow-2xl">
                    </div>
                    <div>
                        <h1 id="tutorNameHeading" class="text-xl md:text-3xl font-extrabold tracking-tight">
                            Welcome, <span class="text-gradient">Tutor</span>
                        </h1>
                        <p class="text-xs md:text-sm text-gray-600 dark:text-gray-300 font-medium flex items-center gap-1">
                            <i class="fas fa-seedling text-green-600"></i> Blooming Kids House
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2 sm:gap-3">
                    <div class="badge-date hidden sm:flex items-center gap-2"><i class="far fa-calendar-alt text-green-600"></i><span id="currentDate"></span></div>
                    <button id="modeToggle" class="w-11 h-11 rounded-full bg-white/30 backdrop-blur-sm border border-white/40 hover:bg-white/50 flex items-center justify-center transition-all text-gray-700 dark:text-yellow-300 shadow-md">
                        <i class="fas fa-moon" id="modeIcon"></i>
                    </button>
                    <a id="whatsappBtn" href="https://wa.me/2348158768689" target="_blank" class="btn-modern btn-primary px-4 py-2 hidden sm:flex"><i class="fab fa-whatsapp text-lg"></i><span>Support</span></a>
                    <button id="logoutBtn" class="btn-modern btn-accent px-4 py-2"><i class="fas fa-sign-out-alt"></i><span class="hidden sm:inline">Logout</span></button>
                    <div class="avatar-modern hidden md:flex">T</div>
                </div>
            </div>

            <!-- stat cards (clickable) – will be updated by a small helper script -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8 relative z-20">
                <div class="stat-card flex items-center gap-3" id="totalStudentsCard"><div class="stat-icon"><i class="fas fa-users"></i></div><div><p class="text-xs opacity-70">Total students</p><p class="text-2xl font-bold" id="totalStudentsCount">0</p></div></div>
                <div class="stat-card flex items-center gap-3" id="todayClassesCard"><div class="stat-icon" style="background: linear-gradient(145deg, #fbbf24, #d97706);"><i class="fas fa-clock"></i></div><div><p class="text-xs opacity-70">Today's classes</p><p class="text-2xl font-bold" id="todayClassesCount">0</p></div></div>
                <div class="stat-card flex items-center gap-3" id="pendingReportsCard"><div class="stat-icon" style="background: linear-gradient(145deg, #3b82f6, #1e3a8a);"><i class="fas fa-book-open"></i></div><div><p class="text-xs opacity-70">Pending reports</p><p class="text-2xl font-bold" id="pendingReportsCount">0</p></div></div>
                <div class="stat-card flex items-center gap-3" id="achievementsCard"><div class="stat-icon" style="background: linear-gradient(145deg, #ec4899, #831843);"><i class="fas fa-star"></i></div><div><p class="text-xs opacity-70">Performance score</p><p class="text-2xl font-bold" id="performanceScore">0</p></div></div>
            </div>

            <!-- navigation pills: 5 tabs (some handled by tutor.js, others with custom triggers) -->
            <nav class="relative z-20 mb-8 overflow-x-auto hide-scrollbar">
                <div class="nav-pill-container">
                    <button id="navDashboard" class="nav-tab-modern active"><i class="fas fa-columns"></i>Dashboard</button>
                    <button id="navStudentDatabase" class="nav-tab-modern"><i class="fas fa-users"></i>Student Database</button>
                    <button id="navAutoStudents" class="nav-tab-modern"><i class="fas fa-user-plus"></i>Auto Students</button>
                    <button id="navAcademic" class="nav-tab-modern"><i class="fas fa-graduation-cap"></i>Academic</button>
                    <button id="navScheduleManagement" class="nav-tab-modern"><i class="fas fa-calendar-alt"></i>Schedule</button>
                    <button id="navCourses" class="nav-tab-modern"><i class="fas fa-folder-open"></i>Courses</button>
                </div>
            </nav>

            <!-- main content area – tutor.js will render here -->
            <main id="mainContent" class="relative z-20 min-h-[400px] transition-all duration-500">
                <div class="skeleton-loader flex flex-col items-center justify-center gap-6 py-12">
                    <div class="pulse-ring"><i class="fas fa-leaf text-3xl text-green-600"></i></div>
                    <p class="text-lg font-medium text-gray-700 dark:text-gray-200 animate-pulse">Loading secure portal...</p>
                </div>
            </main>

            <!-- footer -->
            <div class="relative z-20 mt-8 text-xs text-center opacity-40 flex items-center justify-center gap-2"><i class="fas fa-shield-alt text-green-500"></i> End-to-end encrypted · Blooming Kids Care v3.3</div>
        </div>
    </div>

    <!-- network error overlay -->
    <div id="networkErrorOverlay" class="fixed inset-0 bg-gray-900/80 backdrop-blur-xl z-50 hidden flex-col items-center justify-center p-4">
        <div class="bg-white/90 dark:bg-gray-800/90 rounded-3xl p-8 max-w-md w-full text-center shadow-2xl border border-white/30">
            <div class="w-20 h-20 bg-yellow-100/80 rounded-full flex items-center justify-center mx-auto mb-6"><i class="fas fa-wifi text-3xl text-yellow-600"></i></div>
            <h2 class="text-2xl font-bold mb-2 text-gray-800 dark:text-white">Connection Lost</h2>
            <p class="text-gray-600 dark:text-gray-300 mb-8" id="errorMessage">Can't reach Blooming Kids servers.</p>
            <div class="flex flex-col gap-3">
                <button onclick="window.location.reload()" class="btn-modern btn-primary w-full">Try Again</button>
                <button onclick="checkConnectivity()" class="btn-modern border border-gray-300 dark:border-gray-600 w-full">Check Connection</button>
            </div>
        </div>
    </div>

    <!-- scripts -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script type="module" src="tutor.js"></script>
    <script src="games.js"></script>

    <!-- lightweight helper: theme, date, network, stat updates + extra tab handlers (does NOT override tutor.js) -->
    <script>
        (function() {
            // --- theme & date (safe) ---
            const dateEl = document.getElementById('currentDate');
            if (dateEl) dateEl.innerText = new Date().toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
            const body = document.body;
            const toggle = document.getElementById('modeToggle');
            const icon = document.getElementById('modeIcon');
            function setTheme(theme) {
                if (theme === 'dark') { body.classList.add('dark'); icon?.classList.replace('fa-moon','fa-sun'); localStorage.setItem('tutor_theme','dark');
                } else { body.classList.remove('dark'); icon?.classList.replace('fa-sun','fa-moon'); localStorage.setItem('tutor_theme','light'); }
            }
            const saved = localStorage.getItem('tutor_theme');
            if (saved) setTheme(saved);
            else if (window.matchMedia('(prefers-color-scheme: dark)').matches) setTheme('dark');
            else setTheme('light');
            if (toggle) toggle.addEventListener('click',()=>setTheme(body.classList.contains('dark')?'light':'dark'));

            // --- network warning helpers ---
            window.hideNetworkWarning = ()=>document.getElementById('networkWarning')?.classList.add('hidden');
            window.hideNetworkError = ()=>document.getElementById('networkErrorOverlay')?.classList.add('hidden');
            window.showNetworkError = (msg)=>{ if(msg) document.getElementById('errorMessage').innerText=msg; document.getElementById('networkErrorOverlay')?.classList.remove('hidden'); };
            window.checkConnectivity = ()=>{ if (navigator.onLine) { hideNetworkError(); hideNetworkWarning(); } else showNetworkError('Still offline.'); };
            window.addEventListener('online',()=>{ hideNetworkWarning(); hideNetworkError(); });
            window.addEventListener('offline',()=>document.getElementById('networkWarning')?.classList.remove('hidden'));

            // --- wait for tutorData and then update stat cards + attach extra tab handlers ---
            function waitForTutorData(callback) {
                if (window.tutorData) callback();
                else setTimeout(()=>waitForTutorData(callback), 100);
            }

            waitForTutorData(async () => {
                const tutor = window.tutorData;
                if (!tutor) return;

                // update stat cards from Firestore (simple counts)
                try {
                    const { db } = await import('./firebaseConfig.js');
                    const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js");
                    
                    const q = query(collection(db, "students"), where("tutorEmail", "==", tutor.email));
                    const snap = await getDocs(q);
                    const all = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    const active = all.filter(s => !['archived','graduated','transferred'].includes(s.status));
                    document.getElementById('totalStudentsCount').textContent = active.length;

                    const todayName = new Date().toLocaleDateString('en-US', { weekday:'long' });
                    let todayCount = 0;
                    active.forEach(s => { if (s.schedule) s.schedule.forEach(slot => { if (slot.day === todayName) todayCount++; }); });
                    document.getElementById('todayClassesCount').textContent = todayCount;

                    // pending reports: approx based on lastReportDate (you may refine)
                    const oneWeekAgo = new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate()-7);
                    let pending = 0;
                    active.forEach(s => {
                        if (s.status === 'break') return;
                        if (!s.lastReportDate) { pending++; return; }
                        const last = s.lastReportDate?.toDate?.() || new Date(s.lastReportDate);
                        if (last < oneWeekAgo) pending++;
                    });
                    document.getElementById('pendingReportsCount').textContent = pending;

                    let earned = 0;
                    active.forEach(s => earned += s.attendanceRate || 85);
                    const perf = active.length ? Math.round((earned/(active.length*100))*100) : 100;
                    document.getElementById('performanceScore').textContent = perf;
                } catch (e) { console.warn('Stat update failed', e); }

                // attach click handlers for extra tabs (Academic, Schedule, Courses)
                // these call existing global functions from tutor.js
                document.getElementById('navAcademic')?.addEventListener('click', () => {
                    // Show Daily Topic modal for a random student? Better: show a picker first.
                    // For simplicity, we'll just call showDailyTopicModal with a placeholder – in practice you'd want a student selector.
                    // Instead, we can trigger the same "Add Today's Topic" flow as in dashboard.
                    // We'll simulate: open a student selector modal (reusing existing functions if possible).
                    // Since tutor.js doesn't export a direct "open topic" function without a student, we'll display a simple alert.
                    // Alternatively, you could open the Homework modal – but that's also student-specific.
                    alert('Please select a student from the Dashboard or Student Database to add a topic or assign homework.');
                });

                document.getElementById('navScheduleManagement')?.addEventListener('click', () => {
                    // Use tutor.js function directly
                    if (typeof showScheduleCalendarModal === 'function') {
                        showScheduleCalendarModal();
                    } else {
                        alert('Schedule calendar not available');
                    }
                });

                document.getElementById('navCourses')?.addEventListener('click', () => {
                    // Open a materials overview (could reuse the Courses render from old script, but better to use a global modal)
                    // For now, we'll show a simple modal with a list of students and mock materials.
                    if (typeof showCoursesModal === 'function') {
                        // If you define a global showCoursesModal, call it. Otherwise fallback.
                        alert('Courses feature coming soon – you can manage materials per student from the Student Database.');
                    } else {
                        alert('Courses feature coming soon – you can manage materials per student from the Student Database.');
                    }
                });

                // Also attach stat card clicks (optional – you can reuse the old modal or just ignore)
                document.getElementById('totalStudentsCard')?.addEventListener('click', () => {
                    // could show a simple list of students (like before) but we'll just navigate to Student Database
                    document.getElementById('navStudentDatabase')?.click();
                });
                document.getElementById('todayClassesCard')?.addEventListener('click', () => {
                    if (typeof showScheduleCalendarModal === 'function') showScheduleCalendarModal();
                });
                document.getElementById('pendingReportsCard')?.addEventListener('click', () => {
                    document.getElementById('navDashboard')?.click(); // dashboard shows pending reports
                });
                document.getElementById('achievementsCard')?.addEventListener('click', () => {
                    alert('Performance score is updated by management.');
                });
            });
        })();
    </script>
</body>
</html>
