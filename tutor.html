<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blooming Â· Tutor Portal</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #1e8b4c;
            --primary-soft: #2ecc71;
            --primary-glow: rgba(46, 204, 113, 0.4);
            --accent: #fbbf24;
            --accent-glow: rgba(251, 191, 36, 0.5);
            --surface: rgba(255, 255, 255, 0.75);
            --surface-dark: rgba(17, 25, 40, 0.85);
            --text-light: #1e293b;
            --text-dark: #f1f5f9;
            --border-light: rgba(255, 255, 255, 0.5);
            --border-dark: rgba(255, 255, 255, 0.1);
            --shadow: 0 20px 40px -15px rgba(0, 20, 10, 0.2);
            --shadow-hover: 0 30px 50px -20px rgba(0, 40, 20, 0.3);
            --blur: 16px;
            --transition: all 0.25s cubic-bezier(0.2, 0, 0, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: url('https://res.cloudinary.com/dy2hxcyaf/image/upload/v1769020680/Gemini_Generated_Image_o5m8auo5m8auo5m8_hzzxks.png') center/cover fixed;
            min-height: 100vh;
            color: var(--text-light);
            position: relative;
            overflow-x: hidden;
        }

        body.dark {
            --surface: var(--surface-dark);
            --text-light: var(--text-dark);
            --border-light: var(--border-dark);
        }

        /* Glass Containers */
        .glass-panel {
            background: var(--surface);
            backdrop-filter: blur(var(--blur)) saturate(180%);
            -webkit-backdrop-filter: blur(var(--blur)) saturate(180%);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow);
            border-radius: 2rem;
            transition: var(--transition);
        }

        /* Stat Cards */
        .stat-card {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border-light);
            border-radius: 1.5rem;
            padding: 1.25rem;
            transition: var(--transition);
        }
        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.5);
            border-color: var(--primary);
        }
        .stat-icon {
            width: 48px; height: 48px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 12px; color: white; font-size: 1.25rem;
        }

        /* Navigation */
        .nav-pill-container {
            background: rgba(0,0,0,0.05);
            border-radius: 3rem; padding: 0.35rem; display: flex; gap: 0.25rem;
        }
        .nav-tab-modern {
            padding: 0.6rem 1.2rem; border-radius: 2rem;
            font-weight: 600; opacity: 0.7; transition: var(--transition);
            white-space: nowrap;
        }
        .nav-tab-modern.active {
            opacity: 1; background: white; color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px); display: flex; align-items: center;
            justify-content: center; z-index: 2000; padding: 1rem;
        }
        .modal-content {
            background: white; border-radius: 2rem; width: 100%; max-width: 600px;
            max-height: 90vh; overflow-y: auto; padding: 2rem; position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        body.dark .modal-content { background: #1e293b; color: white; }

        /* Calendar View */
        .calendar-view { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; overflow-x: auto; }
        .calendar-day { min-width: 120px; border: 1px solid rgba(0,0,0,0.1); border-radius: 1rem; padding: 0.5rem; background: rgba(255,255,255,0.4); }
        .calendar-day-header { font-weight: 800; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 8px; text-align: center; }
        .calendar-event { background: white; border-radius: 0.5rem; padding: 0.5rem; margin-bottom: 4px; font-size: 0.7rem; border-left: 3px solid var(--primary); }

        /* Floating buttons */
        .floating-btn {
            position: fixed; right: 20px; width: 56px; height: 56px; border-radius: 28px;
            background: var(--primary); color: white; display: flex; align-items: center;
            justify-content: center; font-size: 1.5rem; cursor: pointer; z-index: 1000;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); transition: var(--transition);
        }
        .floating-btn:hover { transform: scale(1.1); }
        .btn-msg { bottom: 90px; }
        .btn-inbox { bottom: 20px; }
        .unread-badge {
            position: absolute; top: -5px; right: -5px; background: #ef4444;
            color: white; border-radius: 50%; width: 20px; height: 20px;
            font-size: 10px; display: flex; align-items: center; justify-content: center;
            border: 2px solid white;
        }

        /* Utility classes */
        .text-gradient {
            background: linear-gradient(135deg, var(--primary), #0b5e2e);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .badge { padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 700; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-info { background: #e0f2fe; color: #075985; }
        .spinner {
            border: 3px solid rgba(0,0,0,0.1); border-top: 3px solid var(--primary);
            border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Form styling */
        .form-input { width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; border: 1px solid rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .btn-action { padding: 0.75rem 1.5rem; border-radius: 1rem; font-weight: 700; transition: var(--transition); cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #166534; }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen p-4 md:p-8 flex justify-center items-start">
        <div class="glass-panel w-full max-w-7xl p-6 md:p-10">
            
            <!-- Header -->
            <header class="flex flex-col md:flex-row justify-between items-center gap-6 mb-10">
                <div class="flex items-center gap-4">
                    <img src="https://res.cloudinary.com/dy2hxcyaf/image/upload/v1757700806/newbhlogo_umwqzy.svg" alt="Logo" class="h-12 w-auto">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">
                            Welcome, <span class="text-gradient" id="tutorNameDisplay">Tutor</span>
                        </h1>
                        <p class="text-sm text-gray-500 font-medium" id="displayDate"></p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="modeToggle" class="w-10 h-10 rounded-full bg-white/40 flex items-center justify-center shadow-sm">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="logoutBtn" class="btn-action bg-red-500 text-white flex items-center gap-2">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </header>

            <!-- Stat Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-10">
                <div class="stat-card" onclick="showTotalStudentsDetail()">
                    <div class="flex items-center gap-4">
                        <div class="stat-icon bg-green-600"><i class="fas fa-users"></i></div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Total Students</p>
                            <p class="text-2xl font-black" id="stat-total-students">0</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card" onclick="showTodayClassesDetail()">
                    <div class="flex items-center gap-4">
                        <div class="stat-icon bg-amber-500"><i class="fas fa-calendar-check"></i></div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Today's Classes</p>
                            <p class="text-2xl font-black" id="stat-today-classes">0</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card" onclick="switchTab('academic')">
                    <div class="flex items-center gap-4">
                        <div class="stat-icon bg-blue-600"><i class="fas fa-clipboard-list"></i></div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Grading Inbox</p>
                            <p class="text-2xl font-black" id="stat-pending-homework">0</p>
                        </div>
                    </div>
                </div>
                <div id="performance-widget" class="stat-card">
                    <!-- Gamification injected here -->
                    <div class="flex items-center gap-4">
                        <div class="stat-icon bg-pink-600"><i class="fas fa-trophy"></i></div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Score</p>
                            <p class="text-2xl font-black" id="stat-score">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <nav class="mb-8 overflow-x-auto hide-scrollbar">
                <div class="nav-pill-container">
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="nav-tab-modern active"><i class="fas fa-th-large mr-2"></i>Dashboard</button>
                    <button onclick="switchTab('academic')" id="tab-academic" class="nav-tab-modern"><i class="fas fa-graduation-cap mr-2"></i>Academic</button>
                    <button onclick="switchTab('schedule')" id="tab-schedule" class="nav-tab-modern"><i class="fas fa-calendar-alt mr-2"></i>Schedule Management</button>
                    <button onclick="switchTab('students')" id="tab-students" class="nav-tab-modern"><i class="fas fa-user-friends mr-2"></i>Student Database</button>
                </div>
            </nav>

            <!-- Main Content Area -->
            <div id="main-content-area" class="min-h-[500px]">
                <div class="flex flex-col items-center justify-center py-20">
                    <div class="spinner mb-4"></div>
                    <p class="text-gray-500 font-bold">Initializing Portal...</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Floating UI -->
    <div id="msg-btn" class="floating-btn btn-msg" onclick="showNewMessageModal()">
        <i class="fas fa-paper-plane"></i>
    </div>
    <div id="inbox-btn" class="floating-btn btn-inbox" onclick="showInboxModal()">
        <i class="fas fa-envelope"></i>
        <div id="global-unread-count" class="unread-badge hidden">0</div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, addDoc, deleteDoc, onSnapshot, query, where, writeBatch, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // 1. Initial Configuration & Auth
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-tutor-app';

        // 2. Global State
        window.tutorData = null;
        window.allStudents = [];
        window.activeTab = 'dashboard';
        window.globalSettings = {
            isReportEnabled: false,
            isTutorAddEnabled: false,
            isSummerBreakEnabled: false,
            bypassPendingApproval: false,
            showStudentFees: false,
            showEditDeleteButtons: false,
            showTransitionButton: true,
            preschoolAddTransition: true
        };

        // Helper to get consistent paths (Rule 1)
        const getCol = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);
        const getDocRef = (name, id) => doc(db, 'artifacts', appId, 'public', 'data', name, id);

        // 3. Initialization
        window.onload = async () => {
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };
            await initAuth();

            document.getElementById('displayDate').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await syncTutorProfile(user);
                    listenToSettings();
                    listenToStudents();
                    listenToUnreadMessages();
                } else {
                    window.location.reload(); // Handle redirect to auth if environment allows
                }
            });
        };

        async function syncTutorProfile(user) {
            const tutorsCol = getCol('tutors');
            const q = query(tutorsCol, where('email', '==', user.email || ''));
            const snap = await getDocs(q);
            
            if (!snap.empty) {
                window.tutorData = { id: snap.docs[0].id, ...snap.docs[0].data() };
                document.getElementById('tutorNameDisplay').innerText = window.tutorData.name || 'Tutor';
                updateScoreDisplay();
            } else {
                // If not found, use user obj or placeholder
                window.tutorData = { id: user.uid, email: user.email, name: 'Guest Tutor' };
            }
        }

        function listenToSettings() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global_settings'), (doc) => {
                if (doc.exists()) {
                    window.globalSettings = { ...window.globalSettings, ...doc.data() };
                    renderCurrentTab();
                }
            }, (err) => console.error("Settings error", err));
        }

        function listenToStudents() {
            const q = query(getCol('students'), where('tutorEmail', '==', window.tutorData.email));
            onSnapshot(q, (snap) => {
                window.allStudents = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                updateStatCards();
                renderCurrentTab();
            }, (err) => console.error("Students list error", err));
        }

        // 4. Stat Cards Logic
        function updateStatCards() {
            // 1. Total Students
            const activeStudents = window.allStudents.filter(s => !['archived', 'graduated'].includes(s.status));
            document.getElementById('stat-total-students').innerText = activeStudents.length;

            // 2. Today's Classes
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            let todayCount = 0;
            activeStudents.forEach(s => {
                if (s.schedule && Array.isArray(s.schedule)) {
                    s.schedule.forEach(slot => { if (slot.day === today) todayCount++; });
                }
            });
            document.getElementById('stat-today-classes').innerText = todayCount;

            // 3. Score
            document.getElementById('stat-score').innerText = window.tutorData.performanceScore || 0;
        }

        window.showTotalStudentsDetail = () => {
            const active = window.allStudents.filter(s => !['archived', 'graduated'].includes(s.status));
            let listHtml = active.map(s => `
                <div class="flex justify-between items-center p-3 border-b border-gray-100 last:border-0">
                    <div>
                        <p class="font-bold">${s.studentName}</p>
                        <p class="text-xs text-gray-500">${s.grade} â€¢ ${s.isTransitioning ? 'Transitioning' : 'Full'}</p>
                    </div>
                    <span class="badge badge-info">${s.status || 'Active'}</span>
                </div>
            `).join('') || '<p class="text-center text-gray-500">No students assigned.</p>';

            showModal('assigned-students-modal', `
                <h3 class="text-xl font-bold mb-4">My Roster</h3>
                <div class="space-y-1">${listHtml}</div>
            `);
        };

        window.showTodayClassesDetail = () => {
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            const classes = [];
            window.allStudents.forEach(s => {
                if (s.schedule) {
                    s.schedule.forEach(slot => {
                        if (slot.day === today) classes.push({ name: s.studentName, start: slot.start, end: slot.end });
                    });
                }
            });
            classes.sort((a,b) => a.start.localeCompare(b.start));

            let html = classes.map(c => `
                <div class="p-3 bg-gray-50 rounded-xl flex justify-between items-center mb-2">
                    <p class="font-bold">${c.name}</p>
                    <p class="text-sm font-semibold text-blue-600">${formatTimeDisplay(c.start)} - ${formatTimeDisplay(c.end)}</p>
                </div>
            `).join('') || '<p class="text-center text-gray-500">No classes scheduled for today.</p>';

            showModal('today-classes-modal', `<h3 class="text-xl font-bold mb-4">Today's Schedule</h3>${html}`);
        };

        // 5. Navigation & Tab Logic
        window.switchTab = (tabId) => {
            window.activeTab = tabId;
            document.querySelectorAll('.nav-tab-modern').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            renderCurrentTab();
        };

        function renderCurrentTab() {
            const area = document.getElementById('main-content-area');
            const tutor = window.tutorData;

            switch (window.activeTab) {
                case 'dashboard':
                    renderDashboard(area);
                    break;
                case 'academic':
                    renderAcademicTab(area);
                    break;
                case 'schedule':
                    renderScheduleTab(area);
                    break;
                case 'students':
                    renderStudentDatabaseTab(area);
                    break;
            }
        }

        // --- DASHBOARD TAB ---
        function renderDashboard(container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="glass-panel p-6">
                            <h3 class="font-black text-xl mb-4">ðŸ”” Grading Overview</h3>
                            <div id="grading-feed" class="space-y-4">
                                <div class="flex justify-center p-10"><div class="spinner"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="glass-panel p-6 bg-gradient-to-br from-blue-500 to-indigo-600 text-white">
                            <h4 class="font-bold mb-2">Quick Tip</h4>
                            <p class="text-sm opacity-90">Remember to log your "Daily Topics" in the Academic tab right after your classes to keep parents updated in real-time!</p>
                        </div>
                        <div id="performance-summary" class="glass-panel p-6">
                            <h4 class="font-bold text-gray-500 uppercase text-xs mb-4">Monthly Performance</h4>
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-bold">Rating</span>
                                <span class="text-green-600 font-bold">${window.tutorData.performanceScore || 0}/100</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: ${window.tutorData.performanceScore || 0}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            loadGradingFeed();
        }

        async function loadGradingFeed() {
            const feed = document.getElementById('grading-feed');
            try {
                // Fetch student_results needing feedback
                const resultsSnap = await getDocs(query(getCol('student_results'), where('tutorEmail', '==', window.tutorData.email)));
                const items = [];
                resultsSnap.forEach(doc => {
                    const data = doc.data();
                    const needsFeedback = data.answers && data.answers.some(a => a.type === 'creative-writing' && !a.tutorReport);
                    if (needsFeedback) items.push({ id: doc.id, type: 'mcq', ...data });
                });
                
                // Fetch direct Creative Writing submissions
                const cwSnap = await getDocs(query(getCol('tutor_submissions'), where('tutorEmail', '==', window.tutorData.email), where('type', '==', 'creative_writing')));
                cwSnap.forEach(doc => {
                    const data = doc.data();
                    if (!data.tutorReport) items.push({ id: doc.id, type: 'cw', ...data });
                });

                if (items.length === 0) {
                    feed.innerHTML = '<p class="text-center text-gray-500 py-10">You have no pending assignments to grade. Great job!</p>';
                    return;
                }

                feed.innerHTML = items.map(item => `
                    <div class="p-4 bg-white rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-gray-800">${item.studentName}</p>
                            <p class="text-xs text-gray-500">${item.type === 'mcq' ? 'Assessment Feedback' : 'Creative Writing'}</p>
                        </div>
                        <button onclick="openGradingWizard('${item.id}', '${item.type}')" class="btn-action bg-blue-100 text-blue-700 text-sm py-2">Grade Now</button>
                    </div>
                `).join('');
            } catch (e) { feed.innerHTML = 'Error loading feed.'; }
        }

        // --- ACADEMIC TAB ---
        function renderAcademicTab(container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div class="glass-panel p-6">
                            <h3 class="font-black text-xl mb-4 text-blue-700"><i class="fas fa-book-reader mr-2"></i> Daily Topics</h3>
                            <p class="text-sm text-gray-500 mb-4">Record what you taught today.</p>
                            <select id="topic-student-select" class="form-input">
                                <option value="">Choose Student...</option>
                                ${window.allStudents.map(s => `<option value="${s.id}">${s.studentName}</option>`).join('')}
                            </select>
                            <button onclick="handleDailyTopicAction()" class="btn-action btn-primary w-full">Record Topic</button>
                        </div>
                        <div class="glass-panel p-6">
                            <h3 class="font-black text-xl mb-4 text-orange-600"><i class="fas fa-tasks mr-2"></i> Assign Homework</h3>
                            <select id="hw-student-select" class="form-input">
                                <option value="">Choose Student...</option>
                                ${window.allStudents.map(s => `<option value="${s.id}">${s.studentName}</option>`).join('')}
                            </select>
                            <button onclick="handleAssignHomeworkAction()" class="btn-action bg-orange-500 text-white w-full">Assign Homework</button>
                        </div>
                    </div>
                    <div class="glass-panel p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-black text-xl"><i class="fas fa-inbox mr-2"></i> Homework Inbox</h3>
                            <span class="badge badge-warning" id="hw-inbox-count">0</span>
                        </div>
                        <div id="homework-inbox-container" class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
                             <div class="spinner mx-auto"></div>
                        </div>
                    </div>
                </div>
            `;
            loadHomeworkInbox();
        }

        async function loadHomeworkInbox() {
            const container = document.getElementById('homework-inbox-container');
            const countBadge = document.getElementById('hw-inbox-count');
            try {
                const q = query(getCol('homework_assignments'), where('tutorEmail', '==', window.tutorData.email), where('status', '==', 'submitted'));
                const snap = await getDocs(q);
                const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                countBadge.innerText = items.length;

                if (items.length === 0) {
                    container.innerHTML = '<div class="text-center py-10 opacity-50"><i class="fas fa-check-circle text-4xl mb-2"></i><p>Inbox Clear!</p></div>';
                    return;
                }

                container.innerHTML = items.map(hw => `
                    <div class="p-4 bg-white/50 rounded-2xl border border-gray-100 cursor-pointer hover:bg-white transition-all" onclick="openHwGradingModal('${hw.id}')">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold">${hw.studentName}</p>
                                <p class="text-xs font-semibold text-gray-500">${hw.title}</p>
                            </div>
                            <span class="text-[10px] text-gray-400 font-bold">${new Date(hw.submittedAt?.seconds*1000).toLocaleDateString()}</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) { container.innerHTML = 'Error.'; }
        }

        // --- SCHEDULE TAB ---
        function renderScheduleTab(container) {
            container.innerHTML = `
                <div class="glass-panel p-6">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="font-black text-2xl">Weekly Calendar</h3>
                        <div class="flex gap-2">
                             <button onclick="setupAllSchedules()" class="btn-action btn-primary text-sm py-2">Manage All</button>
                             <button onclick="window.print()" class="btn-action bg-gray-200 text-sm py-2">Print</button>
                        </div>
                    </div>
                    <div id="calendar-grid" class="calendar-view"></div>
                </div>
            `;
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            
            grid.innerHTML = days.map(day => {
                const dayClasses = [];
                window.allStudents.forEach(s => {
                    if (s.schedule) s.schedule.forEach(slot => {
                        if (slot.day === day) dayClasses.push({ ...slot, studentName: s.studentName });
                    });
                });
                dayClasses.sort((a,b) => a.start.localeCompare(b.start));

                return `
                    <div class="calendar-day">
                        <div class="calendar-day-header">${day}</div>
                        <div class="space-y-2">
                            ${dayClasses.map(c => `
                                <div class="calendar-event">
                                    <p class="font-bold truncate">${c.studentName}</p>
                                    <p class="text-[10px] opacity-70">${formatTimeDisplay(c.start)}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- STUDENT DATABASE TAB ---
        function renderStudentDatabaseTab(container) {
            const canAdd = window.globalSettings.isTutorAddEnabled;
            container.innerHTML = `
                <div class="space-y-8">
                    ${canAdd ? `
                    <div class="glass-panel p-6 border-l-4 border-green-500">
                        <h3 class="font-bold text-lg mb-4">Add New Student</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input id="add-parent-name" class="form-input" placeholder="Parent Name">
                            <input id="add-parent-phone" class="form-input" placeholder="Parent Phone">
                            <input id="add-student-name" class="form-input" placeholder="Student Name">
                            <select id="add-grade" class="form-input">
                                <option value="">Select Grade</option>
                                <option value="Preschool">Preschool</option>
                                <option value="Kindergarten">Kindergarten</option>
                                <option value="Grade 1">Grade 1</option>
                                <option value="Grade 2">Grade 2</option>
                                <option value="Grade 3">Grade 3</option>
                                <option value="Grade 4">Grade 4</option>
                                <option value="Grade 5">Grade 5</option>
                                <option value="Grade 6">Grade 6</option>
                            </select>
                            <input id="add-fee" class="form-input" type="number" placeholder="Agreed Fee (â‚¦)">
                            <button onclick="handleRegisterStudent()" class="btn-action btn-primary">Register Student</button>
                        </div>
                    </div>` : ''}

                    <div class="glass-panel p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-black text-xl">My Active Students</h3>
                            <p class="text-sm font-bold text-gray-400">${window.allStudents.length} Students Total</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-xs font-bold uppercase text-gray-400 border-b">
                                        <th class="py-3">Student</th>
                                        <th>Status</th>
                                        <th>Fee</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    ${window.allStudents.map(s => `
                                        <tr>
                                            <td class="py-4">
                                                <p class="font-bold">${s.studentName}</p>
                                                <p class="text-xs text-gray-400">${s.grade}</p>
                                            </td>
                                            <td>
                                                <span class="badge ${s.summerBreak ? 'badge-warning' : 'badge-success'}">${s.summerBreak ? 'On Break' : 'Active'}</span>
                                            </td>
                                            <td class="font-mono text-sm">â‚¦${(s.studentFee || 0).toLocaleString()}</td>
                                            <td>
                                                <div class="flex gap-2">
                                                    <button onclick="editStudent('${s.id}')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button>
                                                    ${window.globalSettings.isSummerBreakEnabled ? `
                                                        <button onclick="toggleBreak('${s.id}', ${s.summerBreak})" class="text-amber-500"><i class="fas fa-umbrella-beach"></i></button>
                                                    ` : ''}
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // 6. Utility Functions
        function formatTimeDisplay(time) {
            const [h, m] = time.split(':');
            const hh = parseInt(h);
            const period = hh >= 12 ? 'PM' : 'AM';
            return `${hh % 12 || 12}:${m} ${period}`;
        }

        function showModal(id, content) {
            const existing = document.getElementById(id);
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.id = id;
            overlay.className = 'modal-overlay';
            overlay.innerHTML = `
                <div class="modal-content animate__animated animate__zoomIn animate__faster">
                    <button onclick="document.getElementById('${id}').remove()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
                    ${content}
                </div>
            `;
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            document.body.appendChild(overlay);
        }

        function showCustomAlert(msg, type='info') {
            const div = document.createElement('div');
            div.className = `fixed top-6 right-6 z-[3000] p-4 rounded-2xl shadow-xl flex items-center gap-3 animate__animated animate__fadeInRight ${type==='error'?'bg-red-500 text-white':'bg-white text-gray-800'}`;
            div.innerHTML = `<i class="fas fa-${type==='error'?'exclamation-circle':'check-circle'}"></i> <span>${msg}</span>`;
            document.body.appendChild(div);
            setTimeout(() => { div.remove(); }, 3000);
        }

        // 7. Feature Handlers (Placeholder for Logic from tutor.js)
        window.handleDailyTopicAction = () => {
            const sid = document.getElementById('topic-student-select').value;
            if(!sid) return showCustomAlert("Select a student first");
            const student = window.allStudents.find(s => s.id === sid);
            // Re-use showDailyTopicModal from original logic if preferred, or simplified version:
            showModal('topic-modal', `
                <h3 class="font-bold text-xl mb-4">Daily Topic: ${student.studentName}</h3>
                <textarea id="topic-content" class="form-input h-32" placeholder="e.g. Long Division, Geometry Introduction..."></textarea>
                <button id="save-topic-btn" class="btn-action btn-primary w-full">Save Topic</button>
            `);
            document.getElementById('save-topic-btn').onclick = async () => {
                const topics = document.getElementById('topic-content').value;
                if(!topics) return;
                await addDoc(getCol('daily_topics'), {
                    studentId: sid, studentName: student.studentName, tutorEmail: window.tutorData.email,
                    topics, date: new Date().toISOString().split('T')[0], createdAt: serverTimestamp()
                });
                showCustomAlert("Topic saved!");
                document.getElementById('topic-modal').remove();
            };
        };

        window.handleAssignHomeworkAction = () => {
            const sid = document.getElementById('hw-student-select').value;
            if(!sid) return showCustomAlert("Select a student first");
            const student = window.allStudents.find(s => s.id === sid);
            showModal('hw-modal', `
                <h3 class="font-bold text-xl mb-4">Assign Homework: ${student.studentName}</h3>
                <input id="hw-title" class="form-input" placeholder="Title (e.g. Algebra Practice)">
                <textarea id="hw-desc" class="form-input h-24" placeholder="Instructions..."></textarea>
                <input id="hw-due" type="date" class="form-input">
                <button id="assign-hw-confirm" class="btn-action btn-primary w-full">Post Assignment</button>
            `);
            document.getElementById('assign-hw-confirm').onclick = async () => {
                const title = document.getElementById('hw-title').value;
                const description = document.getElementById('hw-desc').value;
                const dueDate = document.getElementById('hw-due').value;
                if(!title || !dueDate) return;
                
                await addDoc(getCol('homework_assignments'), {
                    studentId: sid, studentName: student.studentName, tutorEmail: window.tutorData.email,
                    title, description, dueDate, assignedDate: serverTimestamp(), status: 'assigned'
                });
                showCustomAlert("Homework assigned!");
                document.getElementById('hw-modal').remove();
            };
        };

        window.toggleBreak = async (id, currentStatus) => {
            if(confirm(`Move student to ${currentStatus?'Active':'Break'}?`)) {
                await updateDoc(getDocRef('students', id), { summerBreak: !currentStatus });
                showCustomAlert("Status updated");
            }
        };

        // 8. Inbox & Messaging (Rule 3 compliant)
        async function listenToUnreadMessages() {
            const q = query(getCol('conversations'), where('participants', 'array-contains', window.tutorData.id));
            onSnapshot(q, (snap) => {
                let count = 0;
                snap.forEach(d => {
                    const data = d.data();
                    if(data.lastSenderId !== window.tutorData.id) count += (data.unreadCount || 0);
                });
                const badge = document.getElementById('global-unread-count');
                badge.innerText = count;
                badge.classList.toggle('hidden', count === 0);
            });
        }

        window.showInboxModal = () => {
             // Re-use showInboxModal logic from your tutor.js
             showCustomAlert("Opening Messaging Inbox...");
             // You can paste your showInboxModal() code here exactly as in tutor.js
        };

        window.logoutBtn = () => {
            signOut(auth).then(() => window.location.reload());
        };

        // UI Events
        document.getElementById('logoutBtn').onclick = () => signOut(auth);
        document.getElementById('modeToggle').onclick = () => {
            document.body.classList.toggle('dark');
            const icon = document.querySelector('#modeToggle i');
            icon.classList.toggle('fa-moon');
            icon.classList.toggle('fa-sun');
        };

        function updateScoreDisplay() {
            // Can be used to update achievement section
            document.getElementById('stat-score').innerText = window.tutorData.performanceScore || 0;
        }

    </script>

</body>
</html>
