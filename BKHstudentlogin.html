<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ========== SECTION 1: HEAD & METADATA ========== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal | Intelligent LMS</title>
    
    <!-- ========== SECTION 2: EXTERNAL DEPENDENCIES ========== -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- ========== SECTION 3: FIREBASE SDK ========== -->
    <!-- IMPORTANT: You need to update these paths to match your Firebase setup -->
    <script type="module">
        // Firebase imports - UPDATE THESE PATHS TO YOUR ACTUAL FILES
        import { auth, db } from './firebaseConfig-studentsignupmodular.js';
        import { 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { 
            collection, 
            query, 
            where, 
            getDocs, 
            doc, 
            getDoc 
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        
        // Make Firebase available globally
        window.firebaseModules = { auth, db, onAuthStateChanged, signOut, collection, query, where, getDocs, doc, getDoc };
    </script>
    
    <!-- ========== SECTION 4: TAILWIND CONFIG ========== -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            light: '#d1fae5',
                            primary: '#059669',
                            dark: '#064e3b',
                            accent: '#fbbf24',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- ========== SECTION 5: CUSTOM STYLES ========== -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .nav-item.active {
            background-color: #ecfdf5;
            color: #059669;
            border-right: 4px solid #059669;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ========== SECTION 6: SECURITY HEADERS (Recommended for pentest) ========== */
        /* Add these to your actual server headers:
        Content-Security-Policy: default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://www.gstatic.com; style-src 'self' https://cdnjs.cloudflare.com https://fonts.googleapis.com; img-src 'self' https://images.unsplash.com https://ui-avatars.com data:;
        X-Content-Type-Options: nosniff;
        X-Frame-Options: DENY;
        */
    </style>
</head>

<!-- ========== SECTION 7: BODY & LAYOUT ========== -->
<body class="bg-gray-50 text-gray-800 font-sans antialiased h-screen flex overflow-hidden">

    <!-- ========== SECTION 8: SIDEBAR NAVIGATION ========== -->
    <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col justify-between z-20 shadow-lg">
        <div>
            <div class="h-20 flex items-center px-8 border-b border-gray-100">
                <div class="h-10 w-10 bg-brand-primary rounded-lg flex items-center justify-center text-white font-bold text-xl mr-3 shadow-lg shadow-emerald-200">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span class="text-xl font-bold tracking-tight text-gray-900">LMS Portal</span>
            </div>

            <nav class="mt-8 px-4 space-y-2">
                <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item active flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-th-large w-6"></i> Dashboard
                </a>
                <a href="#" onclick="switchTab('courses')" id="nav-courses" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-book w-6"></i> My Courses
                </a>
                <a href="#" onclick="switchTab('assignments')" id="nav-assignments" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-clipboard-list w-6"></i> Assignments
                    <span id="pending-count" class="ml-auto bg-brand-accent text-white py-0.5 px-2 rounded-full text-xs font-bold shadow-sm">0</span>
                </a>
                <a href="#" onclick="switchTab('results')" id="nav-results" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-chart-line w-6"></i> Results
                </a>
                <a href="#" onclick="switchTab('calendar')" id="nav-calendar" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-calendar-alt w-6"></i> Schedule
                </a>
                <a href="#" onclick="switchTab('games')" id="nav-games" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-gamepad w-6"></i> Educational Games
                </a>
            </nav>
        </div>

        <div class="p-4 border-t border-gray-100">
            <div id="profile-section" class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 border border-gray-200">
                <!-- Profile will be loaded dynamically -->
                <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center">
                    <i class="fas fa-user text-gray-500"></i>
                </div>
                <div>
                    <p id="student-display-name" class="text-sm font-semibold text-gray-700">Loading...</p>
                    <p id="student-grade-country" class="text-xs text-gray-500">Loading...</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- ========== SECTION 9: MOBILE HEADER ========== -->
    <div class="md:hidden fixed top-0 w-full bg-white z-30 border-b px-4 h-16 flex items-center justify-between shadow-sm">
        <div class="font-bold text-lg text-brand-primary">LMS Portal</div>
        <button class="text-gray-600" onclick="toggleMobileMenu()">
            <i class="fas fa-bars text-xl"></i>
        </button>
    </div>

    <!-- ========== SECTION 10: MAIN CONTENT AREA ========== -->
    <main class="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-8 pt-20 md:pt-8 relative">
        
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 id="page-title" class="text-2xl font-bold text-gray-900">Dashboard Overview</h1>
                <p id="page-date" class="text-sm text-gray-500 mt-1">Welcome back, ready to learn?</p>
            </div>
            <div class="flex items-center gap-4">
                <button class="p-2 text-gray-400 hover:text-brand-primary transition-colors relative">
                    <i class="fas fa-bell text-xl"></i>
                    <span id="notification-badge" class="absolute top-1 right-1 h-2.5 w-2.5 bg-red-500 rounded-full border-2 border-white hidden"></span>
                </button>
                <button id="join-class-btn" class="hidden md:block bg-brand-primary hover:bg-brand-dark text-white px-5 py-2.5 rounded-lg text-sm font-medium shadow-lg shadow-emerald-200 transition-all transform hover:-translate-y-0.5">
                    <i class="fas fa-plus mr-2"></i> Join Class
                </button>
            </div>
        </header>

        <!-- ========== SECTION 11: DASHBOARD VIEW ========== -->
        <div id="view-dashboard" class="view-section fade-in space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Attendance Card -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 relative overflow-hidden group hover:shadow-md transition-all">
                    <div class="absolute right-0 top-0 h-full w-1 bg-brand-primary"></div>
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Attendance</p>
                            <h3 id="attendance-percent" class="text-2xl font-bold text-gray-800 mt-1">Loading...</h3>
                        </div>
                        <div class="h-8 w-8 rounded-full bg-green-50 flex items-center justify-center text-green-600">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                    <p id="attendance-trend" class="text-xs text-green-600 mt-auto flex items-center">
                        <i class="fas fa-arrow-up mr-1"></i> Calculating...
                    </p>
                </div>

                <!-- Pending Tasks Card -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 relative overflow-hidden hover:shadow-md transition-all">
                    <div class="absolute right-0 top-0 h-full w-1 bg-brand-accent"></div>
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Pending Tasks</p>
                            <h3 id="pending-tasks-count" class="text-2xl font-bold text-gray-800 mt-1">0</h3>
                        </div>
                        <div class="h-8 w-8 rounded-full bg-yellow-50 flex items-center justify-center text-yellow-600">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <p id="pending-due" class="text-xs text-gray-500 mt-auto">Checking due dates...</p>
                </div>

                <!-- Average Grade Card -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 hover:shadow-md transition-all">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Avg Grade</p>
                            <h3 id="average-grade" class="text-2xl font-bold text-gray-800 mt-1">--</h3>
                        </div>
                        <div class="h-8 w-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                            <i class="fas fa-star"></i>
                        </div>
                    </div>
                    <p id="grade-ranking" class="text-xs text-gray-500 mt-auto">Calculating rank...</p>
                </div>
                
                <!-- Next Live Class Card -->
                <div id="next-class-card" class="bg-brand-primary p-6 rounded-2xl shadow-lg shadow-emerald-200 text-white flex flex-col justify-between h-32 relative overflow-hidden">
                    <div class="absolute -right-6 -bottom-6 text-white opacity-10 text-9xl">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-emerald-100 uppercase tracking-wider">Next Live Class</p>
                        <h3 id="next-class-subject" class="text-lg font-bold mt-1">Loading schedule...</h3>
                        <p id="next-class-time" class="text-sm text-emerald-100 mt-1">Checking...</p>
                    </div>
                    <button id="join-room-btn" class="mt-auto bg-white text-brand-primary text-xs font-bold py-2 px-4 rounded-lg w-fit opacity-50 cursor-not-allowed">
                        <i class="fas fa-video mr-1"></i> Class Time: --
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Performance Chart -->
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-800">Performance Overview</h3>
                        <select id="performance-period" class="text-xs bg-gray-50 border-none rounded-lg text-gray-500 p-2 focus:ring-0">
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                    <div class="h-64">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <!-- Upcoming Schedule -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4">Upcoming Schedule</h3>
                    <div id="upcoming-schedule-list" class="space-y-4">
                        <!-- Schedule items will be loaded here -->
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-calendar-alt text-3xl mb-2"></i>
                            <p>Loading schedule...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SECTION 12: COURSES VIEW ========== -->
        <div id="view-courses" class="view-section hidden fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="courses-container">
                <!-- Courses will be loaded dynamically -->
                <div class="text-center col-span-3 py-12 text-gray-400">
                    <i class="fas fa-book-open text-4xl mb-4"></i>
                    <h3 class="text-lg font-semibold mb-2">Loading Your Courses</h3>
                    <p>Fetching course materials from database...</p>
                </div>
            </div>
        </div>

        <!-- ========== SECTION 13: ASSIGNMENTS VIEW ========== -->
        <div id="view-assignments" class="view-section hidden fade-in">
             <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800">Active Assignments</h3>
                    <div class="flex gap-2">
                         <button id="filter-all" class="text-xs font-medium text-brand-primary border-b-2 border-brand-primary pb-0.5">All</button>
                         <button id="filter-pending" class="text-xs font-medium text-gray-500 hover:text-brand-primary">Pending</button>
                         <button id="filter-graded" class="text-xs font-medium text-gray-500 hover:text-brand-primary">Graded</button>
                    </div>
                </div>
                <div id="assignments-list" class="divide-y divide-gray-50">
                    <!-- Assignments will be loaded here -->
                    <div class="p-8 text-center text-gray-400">
                        <i class="fas fa-clipboard-list text-3xl mb-3"></i>
                        <p>Loading assignments from database...</p>
                    </div>
                </div>
             </div>
        </div>

        <!-- ========== SECTION 14: RESULTS VIEW ========== -->
        <div id="view-results" class="view-section hidden fade-in">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <h3 class="font-bold text-gray-800 mb-6">Academic Results</h3>
                <div id="results-container">
                    <!-- Results will be loaded here -->
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-chart-line text-3xl mb-3"></i>
                        <p>Loading academic results...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SECTION 15: SCHEDULE VIEW ========== -->
        <div id="view-calendar" class="view-section hidden fade-in">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <h3 class="font-bold text-gray-800 mb-6">Class Schedule</h3>
                <div id="full-schedule-container">
                    <!-- Full schedule will be loaded here -->
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-calendar text-3xl mb-3"></i>
                        <p>Loading your class schedule...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SECTION 16: GAMES VIEW ========== -->
        <div id="view-games" class="view-section hidden fade-in">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-800">Educational Games</h3>
                    <button id="show-leaderboard" class="text-sm text-brand-primary font-semibold hover:text-brand-dark">
                        <i class="fas fa-trophy mr-1"></i> View Leaderboard
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="games-container">
                    <!-- Games will be loaded here -->
                    <div class="text-center py-8 text-gray-400 col-span-4">
                        <i class="fas fa-gamepad text-3xl mb-3"></i>
                        <p>Loading educational games...</p>
                    </div>
                </div>
                
                <div id="leaderboard-container" class="hidden">
                    <h4 class="font-bold text-gray-700 mb-4">Top Performers</h4>
                    <div id="leaderboard-content" class="bg-gray-50 rounded-xl p-4">
                        <!-- Leaderboard will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

    </main>

  <!-- ========== SECTION 17: MAIN APPLICATION LOGIC ========== -->
<script type="module">
    // Wait for DOM and Firebase modules to be ready
    document.addEventListener('DOMContentLoaded', async function() {
        // ========== SUBSECTION 17.1: INITIALIZATION ==========
        console.log('Student Portal Initializing...');
        
        // Set current date
        const dateElement = document.getElementById('page-date');
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateElement.innerText = new Date().toLocaleDateString('en-US', options);
        
        // Initialize chart
        initializeChart();
        
        // ========== SUBSECTION 17.2: AUTHENTICATION ==========
        try {
            // Check if Firebase modules are loaded
            if (!window.firebaseModules) {
                throw new Error('Firebase modules not loaded. Check your firebaseConfig path.');
            }
            
            const { auth, onAuthStateChanged, signOut, db, collection, query, where, getDocs, getDoc, doc } = window.firebaseModules;
            
            // Global logout function
            window.logout = async () => {
                try {
                    await signOut(auth);
                    window.location.href = 'studentsignup.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Error signing out. Please try again.');
                }
            };
            
            // ========== SUBSECTION 17.3: AUTH STATE LISTENER ==========
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log('User authenticated:', user.uid);
                    await loadStudentData(user);
                } else {
                    // No user signed in, redirect to signup
                    console.log('No user, redirecting to signup...');
                    window.location.href = 'studentsignup.html';
                }
            });
            
            // ========== SUBSECTION 17.4: LOAD STUDENT DATA ==========
            async function loadStudentData(user) {
                try {
                    // Update profile section
                    document.getElementById('student-display-name').innerText = user.displayName || "Student";
                    
                    // Fetch student document from Firestore
                    const studentQuery = query(collection(db, "students"), where("studentUid", "==", user.uid));
                    const studentSnapshot = await getDocs(studentQuery);
                    
                    if (!studentSnapshot.empty) {
                        const studentDoc = studentSnapshot.docs[0];
                        const studentData = studentDoc.data();
                        
                        // Get tutor information from student data
                        const tutorEmail = studentData.assignedTutor || studentData.tutorEmail;
                        const tutorName = studentData.tutorName || "Tutor";
                        
                        // Display student info
                        const gradeCountry = `${studentData.grade || 'Grade'} • ${studentData.country || 'Country'}`;
                        document.getElementById('student-grade-country').innerText = gradeCountry;
                        
                        // Load all dashboard data with tutor info
                        await Promise.all([
                            loadAttendance(studentData),
                            loadPendingTasks(user.uid),
                            loadAverageGrade(user.uid),
                            loadNextClass(studentData),
                            loadUpcomingSchedule(studentData),
                            loadCourses(studentData),
                            loadAssignments(user.uid),
                            loadResults(user.uid),
                            loadSchedule(studentData),
                            loadGames(studentData.grade || 3)
                        ]);
                        
                    } else {
                        console.error('No student data found for UID:', user.uid);
                        document.getElementById('student-grade-country').innerText = 'Profile Not Found';
                    }
                    
                } catch (error) {
                    console.error('Error loading student data:', error);
                    // Fallback to mock data for demo
                    loadMockData();
                }
            }
            
            // ========== SUBSECTION 17.5: ATTENDANCE CALCULATION ==========
            async function loadAttendance(studentData) {
                try {
                    // Query schedules collection for this student's tutor
                    if (studentData.assignedTutor || studentData.tutorEmail) {
                        const tutorEmail = studentData.assignedTutor || studentData.tutorEmail;
                        const schedulesQuery = query(
                            collection(db, "schedules"),
                            where("tutorEmail", "==", tutorEmail),
                            where("studentName", "==", studentData.studentName || studentData.displayName)
                        );
                        
                        const schedulesSnapshot = await getDocs(schedulesQuery);
                        const totalClasses = schedulesSnapshot.size;
                        
                        // Query homework submissions to count attended classes
                        const homeworkQuery = query(
                            collection(db, "homework_assignments"),
                            where("studentId", "==", studentData.studentUid),
                            where("status", "==", "submitted")
                        );
                        
                        const homeworkSnapshot = await getDocs(homeworkQuery);
                        const attendedClasses = homeworkSnapshot.size;
                        
                        // Calculate attendance percentage
                        const attendancePercent = totalClasses > 0 ? 
                            Math.round((attendedClasses / totalClasses) * 100) : 100;
                        
                        document.getElementById('attendance-percent').innerText = `${attendancePercent}%`;
                        
                        // Calculate trend (mock for now)
                        const trend = attendancePercent >= 95 ? '+3% this month' : 
                                     attendancePercent >= 90 ? '+1% this month' : 
                                     attendancePercent >= 85 ? 'No change' : '-2% this month';
                        
                        const trendColor = attendancePercent >= 90 ? 'text-green-600' : 
                                          attendancePercent >= 80 ? 'text-yellow-600' : 'text-red-600';
                        
                        document.getElementById('attendance-trend').innerHTML = 
                            `<i class="fas ${attendancePercent >= 85 ? 'fa-arrow-up' : 'fa-arrow-down'} mr-1"></i> ${trend}`;
                        document.getElementById('attendance-trend').className = `text-xs ${trendColor} mt-auto flex items-center`;
                        
                    } else {
                        document.getElementById('attendance-percent').innerText = 'No Tutor';
                        document.getElementById('attendance-trend').innerText = 'Tutor not assigned';
                    }
                    
                } catch (error) {
                    console.error('Error loading attendance:', error);
                    document.getElementById('attendance-percent').innerText = 'Error';
                }
            }
            
            // ========== SUBSECTION 17.6: PENDING TASKS ==========
            async function loadPendingTasks(studentUid) {
                try {
                    // Query pending homework using studentId
                    const pendingQuery = query(
                        collection(db, "homework_assignments"),
                        where("studentId", "==", studentUid),
                        where("status", "in", ["assigned", "pending"])
                    );
                    
                    const pendingSnapshot = await getDocs(pendingQuery);
                    const pendingCount = pendingSnapshot.size;
                    
                    document.getElementById('pending-tasks-count').innerText = pendingCount;
                    document.getElementById('pending-count').innerText = pendingCount;
                    
                    // Check due dates
                    const now = new Date();
                    let dueSoon = 0;
                    
                    pendingSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.dueDate) {
                            const dueDate = new Date(data.dueDate);
                            const diffHours = (dueDate - now) / (1000 * 60 * 60);
                            if (diffHours <= 48) dueSoon++;
                        }
                    });
                    
                    if (dueSoon > 0) {
                        document.getElementById('pending-due').innerText = `${dueSoon} due within 48 hours`;
                        document.getElementById('pending-due').className = 'text-xs text-red-500 mt-auto';
                    } else {
                        document.getElementById('pending-due').innerText = 'No immediate deadlines';
                    }
                    
                } catch (error) {
                    console.error('Error loading pending tasks:', error);
                }
            }
            
            // ========== SUBSECTION 17.7: AVERAGE GRADE ==========
            async function loadAverageGrade(studentUid) {
                try {
                    // Query all graded assignments using studentId
                    const gradesQuery = query(
                        collection(db, "homework_assignments"),
                        where("studentId", "==", studentUid),
                        where("status", "==", "graded"),
                        where("grade", "!=", null)
                    );
                    
                    const gradesSnapshot = await getDocs(gradesQuery);
                    
                    if (gradesSnapshot.empty) {
                        document.getElementById('average-grade').innerText = '--';
                        document.getElementById('grade-ranking').innerText = 'No grades yet';
                        return;
                    }
                    
                    // Calculate average
                    let total = 0;
                    let count = 0;
                    
                    gradesSnapshot.forEach(doc => {
                        const grade = doc.data().grade;
                        if (typeof grade === 'number') {
                            total += grade;
                            count++;
                        }
                    });
                    
                    const average = count > 0 ? Math.round(total / count) : 0;
                    
                    // Convert to letter grade
                    let letterGrade = '--';
                    if (average >= 90) letterGrade = 'A';
                    else if (average >= 80) letterGrade = 'B+';
                    else if (average >= 70) letterGrade = 'B';
                    else if (average >= 60) letterGrade = 'C+';
                    else if (average >= 50) letterGrade = 'C';
                    else letterGrade = 'F';
                    
                    document.getElementById('average-grade').innerText = letterGrade;
                    
                    // Mock ranking (you would need to compare with other students)
                    const ranking = average >= 85 ? 'Top 10% of class' :
                                  average >= 75 ? 'Top 25% of class' :
                                  average >= 65 ? 'Above average' : 'Average';
                    
                    document.getElementById('grade-ranking').innerText = ranking;
                    
                } catch (error) {
                    console.error('Error loading average grade:', error);
                }
            }
                
                // ========== SUBSECTION 17.8: NEXT CLASS WITH TIMEZONE ==========
                async function loadNextClass(studentData) {
                    try {
                        if (!studentData.assignedTutor) {
                            document.getElementById('next-class-subject').innerText = 'No tutor assigned';
                            document.getElementById('next-class-time').innerText = 'Please contact admin';
                            return;
                        }
                        
                        // Query upcoming schedules
                        const now = new Date();
                        const schedulesQuery = query(
                            collection(db, "schedules"),
                            where("tutorEmail", "==", studentData.assignedTutor),
                            where("studentName", "==", studentData.studentName || studentData.displayName),
                            where("dateTime", ">=", now.toISOString())
                        );
                        
                        const schedulesSnapshot = await getDocs(schedulesQuery);
                        
                        if (schedulesSnapshot.empty) {
                            document.getElementById('next-class-subject').innerText = 'No upcoming classes';
                            document.getElementById('next-class-time').innerText = 'Schedule not set';
                            return;
                        }
                        
                        // Find the next class
                        let nextClass = null;
                        let nextTime = null;
                        
                        schedulesSnapshot.forEach(doc => {
                            const schedule = doc.data();
                            const classTime = new Date(schedule.dateTime);
                            
                            if (!nextTime || classTime < nextTime) {
                                nextTime = classTime;
                                nextClass = schedule;
                            }
                        });
                        
                        if (nextClass) {
                            // Convert to student's local time
                            const studentCountry = studentData.country || 'NG'; // Default to Nigeria
                            const localTime = convertToLocalTime(nextTime, studentCountry);
                            
                            document.getElementById('next-class-subject').innerText = 
                                `${nextClass.subject || 'Class'} (${nextClass.grade || 'All'})`;
                            
                            document.getElementById('next-class-time').innerText = 
                                `${localTime.date} at ${localTime.time}`;
                            
                            // Update join button
                            const joinBtn = document.getElementById('join-room-btn');
                            joinBtn.innerHTML = `<i class="fas fa-video mr-1"></i> Join at ${localTime.time}`;
                            joinBtn.className = 'mt-auto bg-white text-brand-primary text-xs font-bold py-2 px-4 rounded-lg w-fit hover:bg-gray-50 transition-colors';
                            joinBtn.onclick = () => joinClass(nextClass.zoomLink || '#');
                            
                            // Store class info for join button
                            joinBtn.dataset.zoomLink = nextClass.zoomLink || '#';
                        }
                        
                    } catch (error) {
                        console.error('Error loading next class:', error);
                    }
                }
                
                // ========== SUBSECTION 17.9: TIMEZONE CONVERSION ==========
                function convertToLocalTime(utcTime, countryCode) {
                    // This is a simplified version. In production, use a proper timezone library
                    const time = new Date(utcTime);
                    
                    // Map country codes to timezone offsets (simplified)
                    const timezoneOffsets = {
                        'NG': 1,   // Nigeria: UTC+1
                        'US': -5,  // USA Eastern: UTC-5
                        'UK': 0,   // UK: UTC+0
                        'IN': 5.5, // India: UTC+5:30
                        'CA': -5,  // Canada Eastern: UTC-5
                        'AU': 10,  // Australia: UTC+10
                        // Add more as needed
                    };
                    
                    const offset = timezoneOffsets[countryCode] || 1; // Default to UTC+1
                    time.setHours(time.getHours() + offset);
                    
                    return {
                        date: time.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                        time: time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })
                    };
                }
                
                // ========== SUBSECTION 17.10: JOIN CLASS FUNCTION ==========
                function joinClass(zoomLink) {
                    if (zoomLink && zoomLink !== '#') {
                        window.open(zoomLink, '_blank');
                    } else {
                        alert('Zoom link not available. Please contact your tutor.');
                    }
                }
                
                // ========== SUBSECTION 17.11: UPCOMING SCHEDULE ==========
                async function loadUpcomingSchedule(studentData) {
                    try {
                        const container = document.getElementById('upcoming-schedule-list');
                        container.innerHTML = '';
                        
                        if (!studentData.assignedTutor) {
                            container.innerHTML = '<p class="text-gray-500">No tutor assigned.</p>';
                            return;
                        }
                        
                        const now = new Date();
                        const weekFromNow = new Date();
                        weekFromNow.setDate(now.getDate() + 7);
                        
                        const schedulesQuery = query(
                            collection(db, "schedules"),
                            where("tutorEmail", "==", studentData.assignedTutor),
                            where("studentName", "==", studentData.studentName || studentData.displayName),
                            where("dateTime", ">=", now.toISOString()),
                            where("dateTime", "<=", weekFromNow.toISOString())
                        );
                        
                        const schedulesSnapshot = await getDocs(schedulesQuery);
                        
                        if (schedulesSnapshot.empty) {
                            container.innerHTML = '<p class="text-gray-500">No upcoming classes this week.</p>';
                            return;
                        }
                        
                        // Sort by date
                        const schedules = [];
                        schedulesSnapshot.forEach(doc => {
                            schedules.push({ id: doc.id, ...doc.data() });
                        });
                        
                        schedules.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
                        
                        // Display first 3
                        schedules.slice(0, 3).forEach(schedule => {
                            const time = new Date(schedule.dateTime);
                            const localTime = convertToLocalTime(schedule.dateTime, studentData.country || 'NG');
                            
                            const scheduleElement = document.createElement('div');
                            scheduleElement.className = 'flex items-start gap-4 pb-4 border-b border-gray-50 last:border-0 last:pb-0';
                            scheduleElement.innerHTML = `
                                <div class="flex flex-col items-center justify-center bg-gray-50 rounded-lg h-12 w-12 text-gray-500">
                                    <span class="text-xs font-bold uppercase">${time.toLocaleString('en-US', { month: 'short' })}</span>
                                    <span class="text-lg font-bold text-gray-800">${time.getDate()}</span>
                                </div>
                                <div>
                                    <h4 class="text-sm font-bold text-gray-800">${schedule.subject || 'Class'}</h4>
                                    <p class="text-xs text-gray-500 mt-1">${localTime.time} • ${schedule.duration || '1 hour'}</p>
                                    <span class="inline-block mt-2 text-[10px] font-bold bg-blue-100 text-blue-600 px-2 py-0.5 rounded">Zoom</span>
                                </div>
                            `;
                            container.appendChild(scheduleElement);
                        });
                        
                    } catch (error) {
                        console.error('Error loading upcoming schedule:', error);
                    }
                }
                
                // ========== SUBSECTION 17.12: COURSES LOADING ==========
                async function loadCourses(studentData) {
                    try {
                        const container = document.getElementById('courses-container');
                        
                        // Query courses for student's grade/subjects
                        const coursesQuery = query(
                            collection(db, "courses"),
                            where("grade", "==", studentData.grade || 4),
                            where("status", "==", "active")
                        );
                        
                        const coursesSnapshot = await getDocs(coursesQuery);
                        
                        if (coursesSnapshot.empty) {
                            container.innerHTML = `
                                <div class="text-center col-span-3 py-12 text-gray-400">
                                    <i class="fas fa-book-open text-4xl mb-4"></i>
                                    <h3 class="text-lg font-semibold mb-2">No Courses Available</h3>
                                    <p>Your tutor will upload course materials soon.</p>
                                </div>
                            `;
                            return;
                        }
                        
                        container.innerHTML = '';
                        
                        // Display courses
                        coursesSnapshot.forEach(doc => {
                            const course = doc.data();
                            const progress = course.progress || Math.floor(Math.random() * 100);
                            
                            const courseElement = document.createElement('div');
                            courseElement.className = 'bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden group hover:shadow-lg transition-all';
                            courseElement.innerHTML = `
                                <div class="h-32 bg-gray-200 relative overflow-hidden">
                                    <div class="w-full h-full bg-gradient-to-r from-blue-500 to-purple-600 group-hover:scale-105 transition-transform duration-500"></div>
                                    <div class="absolute top-4 right-4 bg-white/90 backdrop-blur text-xs font-bold px-2 py-1 rounded text-gray-800">
                                        ${course.grade || 'Yr'} ${studentData.grade || 4}
                                    </div>
                                </div>
                                <div class="p-6">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="text-xs font-bold text-brand-primary bg-brand-light px-2 py-1 rounded">
                                            ${course.subject || 'Subject'}
                                        </span>
                                        <span class="text-xs text-gray-400">
                                            <i class="fas ${course.platform === 'drive' ? 'fa-google-drive' : 'fa-cloud'} mr-1"></i>
                                            ${course.platform || 'Cloud'}
                                        </span>
                                    </div>
                                    <h3 class="font-bold text-lg text-gray-800 mb-2">${course.title || 'Course Title'}</h3>
                                    <p class="text-xs text-gray-500 mb-4">${course.description || 'Course description not available.'}</p>
                                    
                                    <div class="w-full bg-gray-100 rounded-full h-1.5 mb-2">
                                        <div class="bg-brand-primary h-1.5 rounded-full" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-500">
                                        <span>${progress}% Complete</span>
                                        <span>${course.lessonsCompleted || 0}/${course.totalLessons || 10} Lessons</span>
                                    </div>
                                    
                                    <div class="mt-6 pt-4 border-t border-gray-50 flex gap-2">
                                        <button onclick="viewCourse('${course.materialLink || '#'}')" class="flex-1 bg-gray-50 hover:bg-gray-100 text-gray-700 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-external-link-alt mr-1"></i> Access
                                        </button>
                                        <button onclick="continueCourse('${course.id || doc.id}')" class="flex-1 bg-brand-primary text-white py-2 rounded-lg text-sm font-medium hover:bg-brand-dark transition-colors">
                                            Continue
                                        </button>
                                    </div>
                                </div>
                            `;
                            container.appendChild(courseElement);
                        });
                        
                    } catch (error) {
                        console.error('Error loading courses:', error);
                    }
                }
                
                // ========== SUBSECTION 17.13: ASSIGNMENTS LOADING ==========
            async function loadAssignments(studentUid) {
                try {
                    const container = document.getElementById('assignments-list');
                    
                    // Query assignments using studentId
                    const assignmentsQuery = query(
                        collection(db, "homework_assignments"),
                        where("studentId", "==", studentUid)
                    );
                    
                    const assignmentsSnapshot = await getDocs(assignmentsQuery);
                    
                    if (assignmentsSnapshot.empty) {
                        container.innerHTML = `
                            <div class="p-8 text-center text-gray-400">
                                <i class="fas fa-clipboard-check text-3xl mb-3"></i>
                                <p>No assignments found.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = '';
                    
                    // Filter buttons functionality
                    document.getElementById('filter-all').onclick = () => filterAssignments('all');
                    document.getElementById('filter-pending').onclick = () => filterAssignments('pending');
                    document.getElementById('filter-graded').onclick = () => filterAssignments('graded');
                    
                    // Store assignments for filtering
                    window.allAssignments = [];
                    
                    assignmentsSnapshot.forEach(doc => {
                        const assignment = { id: doc.id, ...doc.data() };
                        window.allAssignments.push(assignment);
                        displayAssignment(assignment, container);
                    });
                    
                    // Update pending count
                    const pendingCount = window.allAssignments.filter(a => 
                        a.status === 'assigned' || a.status === 'pending'
                    ).length;
                    
                    document.getElementById('pending-count').innerText = pendingCount;
                    document.getElementById('pending-tasks-count').innerText = pendingCount;
                    
                } catch (error) {
                    console.error('Error loading assignments:', error);
                }
            }
                
                // ========== SUBSECTION 17.14: ASSIGNMENT FILTERING ==========
                function filterAssignments(filter) {
                    const container = document.getElementById('assignments-list');
                    container.innerHTML = '';
                    
                    // Update active filter button
                    ['filter-all', 'filter-pending', 'filter-graded'].forEach(id => {
                        const btn = document.getElementById(id);
                        if (id === `filter-${filter}`) {
                            btn.className = 'text-xs font-medium text-brand-primary border-b-2 border-brand-primary pb-0.5';
                        } else {
                            btn.className = 'text-xs font-medium text-gray-500 hover:text-brand-primary';
                        }
                    });
                    
                    // Filter assignments
                    const filtered = window.allAssignments.filter(assignment => {
                        if (filter === 'all') return true;
                        if (filter === 'pending') return assignment.status === 'assigned' || assignment.status === 'pending';
                        if (filter === 'graded') return assignment.status === 'graded';
                        return true;
                    });
                    
                    // Display filtered assignments
                    filtered.forEach(assignment => {
                        displayAssignment(assignment, container);
                    });
                    
                    if (filtered.length === 0) {
                        container.innerHTML = `
                            <div class="p-8 text-center text-gray-400">
                                <i class="fas fa-clipboard-list text-3xl mb-3"></i>
                                <p>No ${filter} assignments found.</p>
                            </div>
                        `;
                    }
                }
                
                // ========== SUBSECTION 17.15: DISPLAY ASSIGNMENT ==========
                function displayAssignment(assignment, container) {
                    const assignmentElement = document.createElement('div');
                    assignmentElement.className = 'p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group';
                    
                    // Determine status color
                    let statusColor = 'bg-gray-100 text-gray-600';
                    let statusText = assignment.status || 'pending';
                    
                    if (assignment.status === 'graded') {
                        statusColor = 'bg-green-100 text-green-800';
                    } else if (assignment.status === 'submitted') {
                        statusColor = 'bg-blue-100 text-blue-800';
                    } else if (assignment.status === 'assigned' || assignment.status === 'pending') {
                        statusColor = 'bg-orange-100 text-orange-800';
                    }
                    
                    // Determine icon
                    let icon = 'fa-file-alt';
                    let iconColor = 'text-gray-600';
                    let bgColor = 'bg-gray-100';
                    
                    if (assignment.subject?.toLowerCase().includes('math')) {
                        icon = 'fa-calculator';
                        iconColor = 'text-blue-600';
                        bgColor = 'bg-blue-100';
                    } else if (assignment.subject?.toLowerCase().includes('english')) {
                        icon = 'fa-book';
                        iconColor = 'text-purple-600';
                        bgColor = 'bg-purple-100';
                    } else if (assignment.subject?.toLowerCase().includes('science')) {
                        icon = 'fa-flask';
                        iconColor = 'text-green-600';
                        bgColor = 'bg-green-100';
                    }
                    
                    assignmentElement.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="h-10 w-10 rounded-lg ${bgColor} ${iconColor} flex items-center justify-center">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-gray-800">${assignment.title || 'Assignment'}</h4>
                                <p class="text-xs text-gray-500">${assignment.subject || 'Subject'} • Due: ${assignment.dueDate || 'Not specified'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-bold ${statusColor} px-3 py-1 rounded-full capitalize">
                                ${statusText}${assignment.grade ? `: ${assignment.grade}%` : ''}
                            </span>
                            ${assignment.status === 'assigned' || assignment.status === 'pending' ? 
                                `<button onclick="uploadAssignment('${assignment.id}')" class="bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-gray-50">
                                    Upload <i class="fas fa-upload ml-1"></i>
                                </button>` :
                                `<button onclick="viewAssignment('${assignment.id}')" class="text-gray-400 hover:text-brand-primary">
                                    <i class="fas fa-eye"></i>
                                </button>`
                            }
                        </div>
                    `;
                    
                    container.appendChild(assignmentElement);
                }
                
               // ========== SUBSECTION 17.16: RESULTS LOADING ==========
            async function loadResults(studentUid) {
                try {
                    const container = document.getElementById('results-container');
                    
                    // Query graded assignments using studentId
                    const resultsQuery = query(
                        collection(db, "homework_assignments"),
                        where("studentId", "==", studentUid),
                        where("status", "==", "graded"),
                        where("grade", "!=", null)
                    );
                    
                    const resultsSnapshot = await getDocs(resultsQuery);
                    
                    if (resultsSnapshot.empty) {
                        container.innerHTML = `
                            <div class="text-center py-8 text-gray-400">
                                <i class="fas fa-chart-line text-3xl mb-3"></i>
                                <p>No graded results available yet.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Group by subject
                    const resultsBySubject = {};
                    resultsSnapshot.forEach(doc => {
                        const result = doc.data();
                        const subject = result.subject || 'General';
                        
                        if (!resultsBySubject[subject]) {
                            resultsBySubject[subject] = [];
                        }
                        
                        resultsBySubject[subject].push({
                            title: result.title,
                            grade: result.grade,
                            date: result.submittedDate || result.gradedDate,
                            feedback: result.feedback
                        });
                    });
                    
                    // Display results
                    container.innerHTML = '';
                    for (const [subject, results] of Object.entries(resultsBySubject)) {
                        const subjectElement = document.createElement('div');
                        subjectElement.className = 'mb-6 pb-6 border-b border-gray-100 last:border-0';
                        
                        let subjectHTML = `
                            <h4 class="font-bold text-gray-700 mb-3">${subject}</h4>
                            <div class="space-y-3">
                        `;
                        
                        results.forEach(result => {
                            // Determine grade color
                            let gradeColor = 'text-red-600';
                            if (result.grade >= 90) gradeColor = 'text-green-600';
                            else if (result.grade >= 80) gradeColor = 'text-blue-600';
                            else if (result.grade >= 70) gradeColor = 'text-yellow-600';
                            
                            subjectHTML += `
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <p class="text-sm font-medium text-gray-800">${result.title}</p>
                                        <p class="text-xs text-gray-500">${result.date ? new Date(result.date).toLocaleDateString() : 'No date'}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-bold ${gradeColor}">${result.grade}%</p>
                                        ${result.feedback ? `<p class="text-xs text-gray-500">${result.feedback}</p>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        
                        subjectHTML += `</div>`;
                        subjectElement.innerHTML = subjectHTML;
                        container.appendChild(subjectElement);
                    }
                    
                } catch (error) {
                    console.error('Error loading results:', error);
                }
            }
                
                // ========== SUBSECTION 17.17: SCHEDULE LOADING ==========
                async function loadSchedule(studentData) {
                    try {
                        const container = document.getElementById('full-schedule-container');
                        
                        if (!studentData.assignedTutor) {
                            container.innerHTML = '<p class="text-gray-500">No tutor assigned.</p>';
                            return;
                        }
                        
                        const now = new Date();
                        const monthFromNow = new Date();
                        monthFromNow.setMonth(now.getMonth() + 1);
                        
                        const schedulesQuery = query(
                            collection(db, "schedules"),
                            where("tutorEmail", "==", studentData.assignedTutor),
                            where("studentName", "==", studentData.studentName || studentData.displayName),
                            where("dateTime", ">=", now.toISOString()),
                            where("dateTime", "<=", monthFromNow.toISOString())
                        );
                        
                        const schedulesSnapshot = await getDocs(schedulesQuery);
                        
                        if (schedulesSnapshot.empty) {
                            container.innerHTML = `
                                <div class="text-center py-8 text-gray-400">
                                    <i class="fas fa-calendar text-3xl mb-3"></i>
                                    <p>No scheduled classes for the next month.</p>
                                </div>
                            `;
                            return;
                        }
                        
                        // Group by week
                        const schedulesByWeek = {};
                        schedulesSnapshot.forEach(doc => {
                            const schedule = doc.data();
                            const date = new Date(schedule.dateTime);
                            const weekStart = getWeekStart(date);
                            
                            if (!schedulesByWeek[weekStart]) {
                                schedulesByWeek[weekStart] = [];
                            }
                            
                            schedulesByWeek[weekStart].push({
                                ...schedule,
                                id: doc.id,
                                dateTime: schedule.dateTime
                            });
                        });
                        
                        // Display schedule
                        container.innerHTML = '';
                        for (const [weekStart, schedules] of Object.entries(schedulesByWeek)) {
                            const weekElement = document.createElement('div');
                            weekElement.className = 'mb-8';
                            
                            const weekStartDate = new Date(weekStart);
                            const weekEndDate = new Date(weekStart);
                            weekEndDate.setDate(weekEndDate.getDate() + 6);
                            
                            let weekHTML = `
                                <h4 class="font-bold text-gray-700 mb-4">
                                    Week of ${weekStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - 
                                    ${weekEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                </h4>
                                <div class="space-y-3">
                            `;
                            
                            schedules.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
                            
                            schedules.forEach(schedule => {
                                const time = new Date(schedule.dateTime);
                                const localTime = convertToLocalTime(schedule.dateTime, studentData.country || 'NG');
                                
                                weekHTML += `
                                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                        <div class="flex items-center gap-4">
                                            <div class="h-12 w-12 bg-white rounded-lg flex flex-col items-center justify-center border">
                                                <span class="text-xs font-bold text-gray-500">${time.toLocaleString('en-US', { weekday: 'short' })}</span>
                                                <span class="text-lg font-bold text-gray-800">${time.getDate()}</span>
                                            </div>
                                            <div>
                                                <p class="font-medium text-gray-800">${schedule.subject || 'Class'}</p>
                                                <p class="text-sm text-gray-500">${localTime.time} • ${schedule.duration || '1 hour'}</p>
                                            </div>
                                        </div>
                                        <button onclick="joinClass('${schedule.zoomLink || '#'}')" class="px-4 py-2 bg-brand-primary text-white text-sm font-medium rounded-lg hover:bg-brand-dark transition-colors">
                                            <i class="fas fa-video mr-1"></i> Join
                                        </button>
                                    </div>
                                `;
                            });
                            
                            weekHTML += `</div>`;
                            weekElement.innerHTML = weekHTML;
                            container.appendChild(weekElement);
                        }
                        
                    } catch (error) {
                        console.error('Error loading schedule:', error);
                    }
                }
                
                function getWeekStart(date) {
                    const d = new Date(date);
                    const day = d.getDay();
                    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
                    const weekStart = new Date(d.setDate(diff));
                    weekStart.setHours(0, 0, 0, 0);
                    return weekStart.toISOString();
                }
                
                // ========== SUBSECTION 17.18: EDUCATIONAL GAMES ==========
                async function loadGames(grade) {
                    try {
                        const container = document.getElementById('games-container');
                        const games = getGamesByGrade(grade);
                        
                        container.innerHTML = '';
                        
                        games.forEach(game => {
                            const gameElement = document.createElement('div');
                            gameElement.className = 'bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden group hover:shadow-lg transition-all';
                            gameElement.innerHTML = `
                                <div class="h-40 bg-gradient-to-r ${game.gradient} relative overflow-hidden">
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <i class="fas ${game.icon} text-white text-5xl opacity-80"></i>
                                    </div>
                                    <div class="absolute bottom-4 left-4">
                                        <span class="text-xs font-bold text-white bg-black/30 backdrop-blur px-2 py-1 rounded">Level ${game.currentLevel || 1}/50</span>
                                    </div>
                                </div>
                                <div class="p-5">
                                    <h3 class="font-bold text-gray-800 mb-2">${game.name}</h3>
                                    <p class="text-xs text-gray-500 mb-4">${game.description}</p>
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs font-bold ${game.subject === 'Math' ? 'text-blue-600' : game.subject === 'English' ? 'text-purple-600' : 'text-green-600'}">
                                            ${game.subject}
                                        </span>
                                        <button onclick="startGame('${game.id}')" class="px-4 py-2 bg-brand-primary text-white text-xs font-bold rounded-lg hover:bg-brand-dark transition-colors">
                                            Play <i class="fas fa-play ml-1"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                            container.appendChild(gameElement);
                        });
                        
                        // Leaderboard functionality
                        document.getElementById('show-leaderboard').onclick = toggleLeaderboard;
                        
                    } catch (error) {
                        console.error('Error loading games:', error);
                    }
                }
                
                function getGamesByGrade(grade) {
                    const gradeLevel = parseInt(grade) || 3;
                    
                    // Educational games categorized by grade level
                    const games = [
                        {
                            id: 'math_puzzle',
                            name: gradeLevel >= 5 ? 'Algebra Adventure' : 'Number Ninja',
                            description: gradeLevel >= 5 ? 
                                'Solve algebraic equations and unlock new levels' : 
                                'Master basic arithmetic with fun puzzles',
                            icon: gradeLevel >= 5 ? 'fa-superscript' : 'fa-calculator',
                            gradient: 'from-blue-500 to-cyan-400',
                            subject: 'Math',
                            currentLevel: Math.min(gradeLevel * 10, 50),
                            difficulty: gradeLevel
                        },
                        {
                            id: 'word_wizard',
                            name: gradeLevel >= 4 ? 'Vocabulary Voyage' : 'Spelling Safari',
                            description: gradeLevel >= 4 ?
                                'Expand your vocabulary with challenging word games' :
                                'Improve spelling through interactive challenges',
                            icon: 'fa-spell-check',
                            gradient: 'from-purple-500 to-pink-400',
                            subject: 'English',
                            currentLevel: Math.min(gradeLevel * 8, 50),
                            difficulty: gradeLevel
                        },
                        {
                            id: 'science_explorer',
                            name: gradeLevel >= 6 ? 'Physics Pioneer' : 'Biology Builder',
                            description: gradeLevel >= 6 ?
                                'Explore physics concepts through simulations' :
                                'Learn biology with interactive experiments',
                            icon: gradeLevel >= 6 ? 'fa-atom' : 'fa-dna',
                            gradient: 'from-green-500 to-emerald-400',
                            subject: 'Science',
                            currentLevel: Math.min(gradeLevel * 6, 50),
                            difficulty: gradeLevel
                        },
                        {
                            id: 'logic_lab',
                            name: 'Logic Lab',
                            description: 'Develop critical thinking with logic puzzles',
                            icon: 'fa-brain',
                            gradient: 'from-orange-500 to-red-400',
                            subject: 'Logic',
                            currentLevel: Math.min(gradeLevel * 12, 50),
                            difficulty: gradeLevel
                        }
                    ];
                    
                    return games;
                }
                
                function toggleLeaderboard() {
                    const container = document.getElementById('leaderboard-container');
                    const button = document.getElementById('show-leaderboard');
                    
                    if (container.classList.contains('hidden')) {
                        container.classList.remove('hidden');
                        button.innerHTML = '<i class="fas fa-times mr-1"></i> Hide Leaderboard';
                        loadLeaderboard();
                    } else {
                        container.classList.add('hidden');
                        button.innerHTML = '<i class="fas fa-trophy mr-1"></i> View Leaderboard';
                    }
                }
                
                async function loadLeaderboard() {
                    try {
                        const container = document.getElementById('leaderboard-content');
                        
                        // Query top scores (you would need a scores collection)
                        // For now, using mock data
                        const leaderboard = [
                            { name: 'Alex Johnson', score: 9850, grade: 'Grade 5', country: 'US' },
                            { name: 'Sophia Williams', score: 9420, grade: 'Grade 4', country: 'UK' },
                            { name: 'Mohammed Ali', score: 9150, grade: 'Grade 6', country: 'NG' },
                            { name: 'Emma Chen', score: 8920, grade: 'Grade 5', country: 'CA' },
                            { name: 'David Smith', score: 8650, grade: 'Grade 4', country: 'AU' }
                        ];
                        
                        let leaderboardHTML = `
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="text-left py-3 text-xs font-semibold text-gray-500">Rank</th>
                                            <th class="text-left py-3 text-xs font-semibold text-gray-500">Name</th>
                                            <th class="text-left py-3 text-xs font-semibold text-gray-500">Score</th>
                                            <th class="text-left py-3 text-xs font-semibold text-gray-500">Grade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        leaderboard.forEach((player, index) => {
                            const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                            leaderboardHTML += `
                                <tr class="border-b border-gray-100 last:border-0">
                                    <td class="py-3 text-sm font-bold">${medal}</td>
                                    <td class="py-3">
                                        <div class="flex items-center gap-2">
                                            <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center">
                                                <i class="fas fa-user text-gray-500 text-xs"></i>
                                            </div>
                                            <span class="text-sm font-medium">${player.name}</span>
                                        </div>
                                    </td>
                                    <td class="py-3 text-sm font-bold text-brand-primary">${player.score.toLocaleString()}</td>
                                    <td class="py-3 text-sm text-gray-600">${player.grade}</td>
                                </tr>
                            `;
                        });
                        
                        leaderboardHTML += `
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="shareLeaderboard()" class="px-4 py-2 bg-gray-800 text-white text-sm font-medium rounded-lg hover:bg-gray-900 transition-colors">
                                    <i class="fas fa-share-alt mr-2"></i> Share Leaderboard
                                </button>
                            </div>
                        `;
                        
                        container.innerHTML = leaderboardHTML;
                        
                    } catch (error) {
                        console.error('Error loading leaderboard:', error);
                    }
                }
                
                // ========== SUBSECTION 17.19: MOCK DATA FALLBACK ==========
                function loadMockData() {
                    console.log('Loading mock data for demo...');
                    
                    // Mock profile
                    document.getElementById('student-display-name').innerText = 'Demo Student';
                    document.getElementById('student-grade-country').innerText = 'Year 4 • UK';
                    
                    // Mock dashboard data
                    document.getElementById('attendance-percent').innerText = '94%';
                    document.getElementById('pending-tasks-count').innerText = '3';
                    document.getElementById('pending-count').innerText = '3';
                    document.getElementById('average-grade').innerText = 'B+';
                    document.getElementById('grade-ranking').innerText = 'Top 15% of class';
                    
                    document.getElementById('next-class-subject').innerText = 'Mathematics (Yr 4)';
                    document.getElementById('next-class-time').innerText = 'Mon, Feb 14 at 10:00 AM';
                    
                    const joinBtn = document.getElementById('join-room-btn');
                    joinBtn.innerHTML = '<i class="fas fa-video mr-1"></i> Join at 10:00 AM';
                    joinBtn.className = 'mt-auto bg-white text-brand-primary text-xs font-bold py-2 px-4 rounded-lg w-fit hover:bg-gray-50 transition-colors';
                    joinBtn.onclick = () => alert('Join class functionality would open Zoom link');
                    
                    // Mock upcoming schedule
                    const scheduleContainer = document.getElementById('upcoming-schedule-list');
                    scheduleContainer.innerHTML = `
                        <div class="flex items-start gap-4 pb-4 border-b border-gray-50">
                            <div class="flex flex-col items-center justify-center bg-gray-50 rounded-lg h-12 w-12 text-gray-500">
                                <span class="text-xs font-bold uppercase">Feb</span>
                                <span class="text-lg font-bold text-gray-800">14</span>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-gray-800">Math Mock Exam</h4>
                                <p class="text-xs text-gray-500 mt-1">09:00 AM - 11:00 AM</p>
                                <span class="inline-block mt-2 text-[10px] font-bold bg-red-100 text-red-600 px-2 py-0.5 rounded">CBT Platform</span>
                            </div>
                        </div>
                        <div class="flex items-start gap-4 pb-4 border-b border-gray-50">
                            <div class="flex flex-col items-center justify-center bg-gray-50 rounded-lg h-12 w-12 text-gray-500">
                                <span class="text-xs font-bold uppercase">Feb</span>
                                <span class="text-lg font-bold text-gray-800">16</span>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-gray-800">English Literature</h4>
                                <p class="text-xs text-gray-500 mt-1">Homework Submission</p>
                            </div>
                        </div>
                    `;
                    
                    // Load mock games
                    loadGames(4);
                }
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                alert('Error connecting to database. Using demo mode.');
                loadMockData();
            }
            
            // ========== SUBSECTION 17.20: UTILITY FUNCTIONS ==========
            // Make functions globally available
            window.switchTab = switchTab;
            window.viewCourse = (link) => {
                if (link && link !== '#') {
                    window.open(link, '_blank');
                } else {
                    alert('Course materials not available yet.');
                }
            };
            
            window.continueCourse = (courseId) => {
                alert(`Continue course ${courseId} - This would open the next lesson`);
            };
            
            window.uploadAssignment = (assignmentId) => {
                // Create upload modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800">Upload Assignment</h3>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select File</label>
                                <input type="file" id="assignment-file" class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Comments (Optional)</label>
                                <textarea id="assignment-comments" class="w-full p-3 border border-gray-300 rounded-lg" rows="3" placeholder="Add any comments for your tutor..."></textarea>
                            </div>
                            <div class="flex gap-3 pt-4">
                                <button onclick="submitAssignment('${assignmentId}')" class="flex-1 bg-brand-primary text-white py-3 rounded-lg font-medium hover:bg-brand-dark transition-colors">
                                    Submit
                                </button>
                                <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            };
            
            window.submitAssignment = async (assignmentId) => {
                const fileInput = document.getElementById('assignment-file');
                const comments = document.getElementById('assignment-comments').value;
                
                if (!fileInput.files[0]) {
                    alert('Please select a file to upload.');
                    return;
                }
                
                // In production, upload to Cloudinary/Firebase Storage here
                alert(`Assignment ${assignmentId} submitted successfully!\n\nFile: ${fileInput.files[0].name}\nComments: ${comments || 'None'}`);
                
                // Close modal
                document.querySelector('.fixed.inset-0').remove();
                
                // Refresh assignments list
                // Note: In production, you would update Firestore here
                alert('Assignment submitted! Your tutor will grade it soon.');
            };
            
            window.viewAssignment = (assignmentId) => {
                alert(`View assignment ${assignmentId} - This would show details and feedback`);
            };
            
            window.startGame = (gameId) => {
                const games = {
                    'math_puzzle': 'Math Puzzle Game',
                    'word_wizard': 'Word Wizard Game',
                    'science_explorer': 'Science Explorer Game',
                    'logic_lab': 'Logic Lab Game'
                };
                alert(`Starting ${games[gameId] || 'Educational Game'}...\n\nThis would open the game interface with 50 progressive levels.`);
            };
            
            window.shareLeaderboard = () => {
                alert('Leaderboard shared as image!\n\nThis would generate and download a shareable image of the leaderboard.');
            };
            
        });
        
        // ========== SECTION 18: CHART INITIALIZATION ==========
        function initializeChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            const myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
                    datasets: [{
                        label: 'Maths Score',
                        data: [65, 70, 75, 72, 85, 90],
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'English Score',
                        data: [70, 72, 68, 80, 82, 85],
                        borderColor: '#fbbf24',
                        borderDash: [5, 5],
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                borderDash: [2, 4],
                                color: '#f3f4f6'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            // Update chart on period change
            document.getElementById('performance-period').addEventListener('change', function(e) {
                const period = e.target.value;
                // In production, fetch new data based on period
                alert(`Loading ${period} performance data...`);
            });
        }
        
        // ========== SECTION 19: TAB SWITCHING ==========
        function switchTab(tabName) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Show selected view
            const selectedView = document.getElementById('view-' + tabName);
            if (selectedView) {
                selectedView.classList.remove('hidden');
            }
            
            // Update Nav State
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active', 'bg-gray-50', 'text-brand-primary', 'border-r-4', 'border-brand-primary');
                el.classList.add('text-gray-600');
            });
            
            const activeNav = document.getElementById('nav-' + tabName);
            if (activeNav) {
                activeNav.classList.add('active');
            }
            
            // Update Title
            const titles = {
                'dashboard': 'Dashboard Overview',
                'courses': 'My Enrolled Courses',
                'assignments': 'Homework & Tasks',
                'results': 'Academic Performance',
                'calendar': 'Class Schedule',
                'games': 'Educational Games'
            };
            document.getElementById('page-title').innerText = titles[tabName] || 'Portal';
        }
        
        // ========== SECTION 20: MOBILE MENU ==========
        function toggleMobileMenu() {
            const sidebar = document.querySelector('aside');
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('flex');
            sidebar.classList.toggle('fixed');
            sidebar.classList.toggle('inset-0');
            sidebar.classList.toggle('z-40');
        }
        
    </script>
    
    <!-- ========== SECTION 21: SECURITY CONSIDERATIONS ========== -->
    <!-- 
    For pentest/certification compliance:
    1. Add CSP headers on server
    2. Implement input validation for all user inputs
    3. Sanitize database queries
    4. Use HTTPS in production
    5. Implement rate limiting
    6. Regular security audits
    7. Data encryption at rest and in transit
    8. Secure Firebase rules
    -->
    
</body>
</html>
