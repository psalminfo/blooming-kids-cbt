<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ========== SECTION 1: HEAD & METADATA ========== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal | Intelligent LMS</title>
    
    <!-- ========== SECTION 2: EXTERNAL DEPENDENCIES ========== -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    
    <!-- PDF.js for PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <!-- ========== SECTION 3: FIREBASE SDK ========== -->
    <script type="module">
        // Firebase imports
        import { auth, db } from './firebaseConfig-studentsignupmodular.js';
        import { 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { 
            collection, 
            query, 
            where, 
            getDocs, 
            doc, 
            getDoc,
            updateDoc,
            addDoc,
            Timestamp,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        
        // Make Firebase available globally
        window.firebaseModules = { 
            auth, db, onAuthStateChanged, signOut, collection, query, where, getDocs, 
            doc, getDoc, updateDoc, addDoc, Timestamp, onSnapshot
        };
        
        // Cloudinary Configuration
        window.CLOUDINARY_CONFIG = {
            cloudName: 'dwjq7j5zp',
            uploadPreset: 'tutor_homework',
            apiKey: '963245294794452'
        };
    </script>
    
    <!-- ========== SECTION 4: TAILWIND CONFIG ========== -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            light: '#d1fae5',
                            primary: '#059669',
                            dark: '#064e3b',
                            accent: '#fbbf24',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- ========== SECTION 5: CUSTOM STYLES ========== -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .nav-item.active {
            background-color: #ecfdf5;
            color: #059669;
            border-right: 4px solid #059669;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .annotation-toolbar {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .canvas-container {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            position: relative;
        }
        
        .pdf-page {
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .tool-button {
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .tool-button.active {
            background-color: #059669;
            color: white;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Drawing tools */
        #annotation-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            cursor: crosshair;
        }
        
        #pdf-canvas {
            position: relative;
            z-index: 1;
        }
        
        /* Game styles */
        .game-option {
            padding: 12px;
            border-radius: 8px;
            background: white;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .game-option:hover {
            border-color: #059669;
            transform: translateY(-2px);
        }
        
        .game-option.correct {
            background-color: #d1fae5;
            border-color: #059669;
        }
        
        .game-option.wrong {
            background-color: #fee2e2;
            border-color: #ef4444;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans antialiased h-screen flex overflow-hidden">

    <!-- ========== SECTION 8: SIDEBAR NAVIGATION ========== -->
    <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col justify-between z-20 shadow-lg">
        <div>
            <div class="h-20 flex items-center px-8 border-b border-gray-100">
                <div class="h-10 w-10 bg-brand-primary rounded-lg flex items-center justify-center text-white font-bold text-xl mr-3 shadow-lg shadow-emerald-200">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span class="text-xl font-bold tracking-tight text-gray-900">LMS Portal</span>
            </div>

            <nav class="mt-8 px-4 space-y-2">
                <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item active flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-th-large w-6"></i> Dashboard
                </a>
                <a href="#" onclick="switchTab('courses')" id="nav-courses" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-book w-6"></i> My Courses
                </a>
                <a href="#" onclick="switchTab('assignments')" id="nav-assignments" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-clipboard-list w-6"></i> Assignments
                    <span id="pending-count" class="ml-auto bg-brand-accent text-white py-0.5 px-2 rounded-full text-xs font-bold shadow-sm">0</span>
                </a>
                <a href="#" onclick="switchTab('results')" id="nav-results" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-chart-line w-6"></i> Results
                </a>
                <a href="#" onclick="switchTab('calendar')" id="nav-calendar" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-calendar-alt w-6"></i> Schedule
                </a>
                <a href="#" onclick="switchTab('games')" id="nav-games" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-gamepad w-6"></i> Educational Games
                </a>
            </nav>
        </div>

        <div class="p-4 border-t border-gray-100">
            <div id="profile-section" class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 border border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors" onclick="toggleProfileMenu()">
                <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center">
                    <i class="fas fa-user text-gray-500"></i>
                </div>
                <div class="flex-1">
                    <p id="student-display-name" class="text-sm font-semibold text-gray-700">Loading...</p>
                    <p id="student-grade-country" class="text-xs text-gray-500">Loading...</p>
                </div>
                <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
            </div>
            <div id="profile-menu" class="hidden mt-2 bg-white border border-gray-200 rounded-lg shadow-lg">
                <button onclick="logout()" class="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 rounded-lg flex items-center">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </button>
            </div>
        </div>
    </aside>

    <!-- ========== SECTION 9: MOBILE HEADER ========== -->
    <div class="md:hidden fixed top-0 w-full bg-white z-30 border-b px-4 h-16 flex items-center justify-between shadow-sm">
        <div class="font-bold text-lg text-brand-primary">LMS Portal</div>
        <button class="text-gray-600" onclick="toggleMobileMenu()">
            <i class="fas fa-bars text-xl"></i>
        </button>
    </div>

    <!-- ========== SECTION 10: MAIN CONTENT AREA ========== -->
    <main class="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-8 pt-20 md:pt-8 relative">
        
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 id="page-title" class="text-2xl font-bold text-gray-900">Dashboard Overview</h1>
                <p id="page-date" class="text-sm text-gray-500 mt-1">Welcome back, ready to learn?</p>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="showNotifications()" class="p-2 text-gray-400 hover:text-brand-primary transition-colors relative">
                    <i class="fas fa-bell text-xl"></i>
                    <span id="notification-badge" class="notification-badge hidden">0</span>
                </button>
                <button id="join-class-btn" class="hidden md:block bg-brand-primary hover:bg-brand-dark text-white px-5 py-2.5 rounded-lg text-sm font-medium shadow-lg shadow-emerald-200 transition-all transform hover:-translate-y-0.5">
                    <i class="fas fa-plus mr-2"></i> Join Class
                </button>
            </div>
        </header>

        <!-- ========== SECTION 11: DASHBOARD VIEW ========== -->
        <div id="view-dashboard" class="view-section fade-in space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Attendance Card -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 relative overflow-hidden group hover:shadow-md transition-all">
                    <div class="absolute right-0 top-0 h-full w-1 bg-brand-primary"></div>
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Attendance</p>
                            <h3 id="attendance-percent" class="text-2xl font-bold text-gray-800 mt-1">Loading...</h3>
                        </div>
                        <div class="h-8 w-8 rounded-full bg-green-50 flex items-center justify-center text-green-600">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                    <p id="attendance-trend" class="text-xs text-green-600 mt-auto flex items-center">
                        <i class="fas fa-arrow-up mr-1"></i> Calculating...
                    </p>
                </div>

                <!-- Pending Tasks Card -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 relative overflow-hidden hover:shadow-md transition-all">
                    <div class="absolute right-0 top-0 h-full w-1 bg-brand-accent"></div>
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Pending Tasks</p>
                            <h3 id="pending-tasks-count" class="text-2xl font-bold text-gray-800 mt-1">0</h3>
                        </div>
                        <div class="h-8 w-8 rounded-full bg-yellow-50 flex items-center justify-center text-yellow-600">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <p id="pending-due" class="text-xs text-gray-500 mt-auto">Checking due dates...</p>
                </div>

                <!-- Average Grade Card -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 hover:shadow-md transition-all">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Avg Grade</p>
                            <h3 id="average-grade" class="text-2xl font-bold text-gray-800 mt-1">--</h3>
                        </div>
                        <div class="h-8 w-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                            <i class="fas fa-star"></i>
                        </div>
                    </div>
                    <p id="grade-ranking" class="text-xs text-gray-500 mt-auto">Calculating rank...</p>
                </div>
                
                <!-- Next Live Class Card -->
                <div id="next-class-card" class="bg-brand-primary p-6 rounded-2xl shadow-lg shadow-emerald-200 text-white flex flex-col justify-between h-32 relative overflow-hidden">
                    <div class="absolute -right-6 -bottom-6 text-white opacity-10 text-9xl">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-emerald-100 uppercase tracking-wider">Next Live Class</p>
                        <h3 id="next-class-subject" class="text-lg font-bold mt-1">Loading schedule...</h3>
                        <p id="next-class-time" class="text-sm text-emerald-100 mt-1">Checking...</p>
                        <p id="next-class-tutor" class="text-xs text-emerald-200 mt-1"></p>
                    </div>
                    <button id="join-room-btn" class="mt-auto bg-white text-brand-primary text-xs font-bold py-2 px-4 rounded-lg w-fit opacity-50 cursor-not-allowed">
                        <i class="fas fa-video mr-1"></i> Class Time: --
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Performance Chart -->
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-800">Performance Overview</h3>
                        <select id="performance-period" class="text-xs bg-gray-50 border-none rounded-lg text-gray-500 p-2 focus:ring-0">
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                    <div class="h-64">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <!-- Upcoming Schedule -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4">Upcoming Schedule</h3>
                    <div id="upcoming-schedule-list" class="space-y-4">
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-calendar-alt text-3xl mb-2"></i>
                            <p>Loading schedule...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SECTION 12: COURSES VIEW ========== -->
        <div id="view-courses" class="view-section hidden fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="courses-container">
                <div class="text-center col-span-3 py-12 text-gray-400">
                    <i class="fas fa-book-open text-4xl mb-4"></i>
                    <h3 class="text-lg font-semibold mb-2">Loading Your Courses</h3>
                    <p>Fetching course materials from database...</p>
                </div>
            </div>
        </div>

        <!-- ========== SECTION 13: ASSIGNMENTS VIEW ========== -->
        <div id="view-assignments" class="view-section hidden fade-in">
             <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800">Active Assignments</h3>
                    <div class="flex gap-2">
                         <button id="filter-all" class="text-xs font-medium text-brand-primary border-b-2 border-brand-primary pb-0.5">All</button>
                         <button id="filter-pending" class="text-xs font-medium text-gray-500 hover:text-brand-primary">Pending</button>
                         <button id="filter-graded" class="text-xs font-medium text-gray-500 hover:text-brand-primary">Graded</button>
                    </div>
                </div>
                <div id="assignments-list" class="divide-y divide-gray-50">
                    <div class="p-8 text-center text-gray-400">
                        <i class="fas fa-clipboard-list text-3xl mb-3"></i>
                        <p>Loading assignments from database...</p>
                    </div>
                </div>
             </div>
        </div>

        <!-- ========== SECTION 14: RESULTS VIEW ========== -->
        <div id="view-results" class="view-section hidden fade-in">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <h3 class="font-bold text-gray-800 mb-6">Academic Results</h3>
                <div id="results-container">
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-chart-line text-3xl mb-3"></i>
                        <p>Loading academic results...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SECTION 15: SCHEDULE VIEW ========== -->
        <div id="view-calendar" class="view-section hidden fade-in">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <h3 class="font-bold text-gray-800 mb-6">Class Schedule</h3>
                <div id="full-schedule-container">
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-calendar text-3xl mb-3"></i>
                        <p>Loading your class schedule...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SECTION 16: GAMES VIEW ========== -->
        <div id="view-games" class="view-section hidden fade-in">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-800">Educational Games</h3>
                    <button id="show-leaderboard" class="text-sm text-brand-primary font-semibold hover:text-brand-dark">
                        <i class="fas fa-trophy mr-1"></i> View Leaderboard
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="games-container">
                    <div class="text-center py-8 text-gray-400 col-span-4">
                        <i class="fas fa-gamepad text-3xl mb-3"></i>
                        <p>Loading educational games...</p>
                    </div>
                </div>
                
                <div id="leaderboard-container" class="hidden">
                    <h4 class="font-bold text-gray-700 mb-4">Top Performers</h4>
                    <div id="leaderboard-content" class="bg-gray-50 rounded-xl p-4">
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- ========== SECTION 17: MAIN APPLICATION LOGIC ========== -->
    <script type="module">
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Student Portal Initializing...');
            
            // Set current date
            const dateElement = document.getElementById('page-date');
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateElement.innerText = new Date().toLocaleDateString('en-US', options);
            
            // Initialize chart
            initializeChart();
            
            try {
                if (!window.firebaseModules) {
                    throw new Error('Firebase modules not loaded.');
                }
                
                const { 
                    auth, db, onAuthStateChanged, signOut, collection, query, where, 
                    getDocs, getDoc, doc, updateDoc, addDoc, Timestamp, onSnapshot 
                } = window.firebaseModules;
                
                // Global logout function
                window.logout = async () => {
                    try {
                        await signOut(auth);
                        window.location.href = 'studentsignup.html';
                    } catch (error) {
                        console.error('Logout error:', error);
                        alert('Error signing out. Please try again.');
                    }
                };
                
                // Profile menu toggle
                window.toggleProfileMenu = () => {
                    const menu = document.getElementById('profile-menu');
                    menu.classList.toggle('hidden');
                };
                
                document.addEventListener('click', (event) => {
                    const profileSection = document.getElementById('profile-section');
                    const profileMenu = document.getElementById('profile-menu');
                    
                    if (!profileSection.contains(event.target) && !profileMenu.contains(event.target)) {
                        profileMenu.classList.add('hidden');
                    }
                });
                
                // ========== REAL-TIME NOTIFICATIONS ==========
                let notificationListener = null;
                
                async function setupNotifications(userId) {
                    if (notificationListener) notificationListener();
                    
                    const notificationsQuery = query(
                        collection(db, "notifications"),
                        where("studentId", "==", userId),
                        where("read", "==", false)
                    );
                    
                    notificationListener = onSnapshot(notificationsQuery, (snapshot) => {
                        const unreadCount = snapshot.size;
                        const badge = document.getElementById('notification-badge');
                        
                        if (unreadCount > 0) {
                            badge.textContent = unreadCount;
                            badge.classList.remove('hidden');
                        } else {
                            badge.classList.add('hidden');
                        }
                    });
                }
                
                window.showNotifications = async () => {
                    try {
                        if (!window.currentStudent?.id) return;
                        
                        const notificationsQuery = query(
                            collection(db, "notifications"),
                            where("studentId", "==", window.currentStudent.id),
                            where("read", "==", false)
                        );
                        
                        const snapshot = await getDocs(notificationsQuery);
                        
                        const modal = document.createElement('div');
                        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
                        modal.innerHTML = `
                            <div class="bg-white rounded-2xl w-full max-w-md">
                                <div class="flex justify-between items-center p-6 border-b border-gray-100">
                                    <h3 class="font-bold text-gray-800 text-xl">Notifications</h3>
                                    <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="p-6 max-h-96 overflow-y-auto">
                                    ${snapshot.empty ? 
                                        '<p class="text-center text-gray-500 py-8">No new notifications</p>' :
                                        Array.from(snapshot.docs).map(doc => {
                                            const data = doc.data();
                                            return `
                                                <div class="p-3 bg-blue-50 rounded-lg mb-2">
                                                    <p class="font-medium text-gray-800">${data.title}</p>
                                                    <p class="text-sm text-gray-600 mt-1">${data.message}</p>
                                                    <p class="text-xs text-gray-400 mt-2">${new Date(data.createdAt?.toDate()).toLocaleString()}</p>
                                                </div>
                                            `;
                                        }).join('')
                                    }
                                </div>
                                ${!snapshot.empty ? `
                                    <div class="p-4 border-t border-gray-100">
                                        <button onclick="markAllAsRead()" class="w-full px-4 py-2 bg-brand-primary text-white rounded-lg text-sm font-medium hover:bg-brand-dark">
                                            Mark All as Read
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        
                        document.body.appendChild(modal);
                        
                    } catch (error) {
                        console.error('Error showing notifications:', error);
                    }
                };
                
                window.markAllAsRead = async () => {
                    try {
                        if (!window.currentStudent?.id) return;
                        
                        const notificationsQuery = query(
                            collection(db, "notifications"),
                            where("studentId", "==", window.currentStudent.id),
                            where("read", "==", false)
                        );
                        
                        const snapshot = await getDocs(notificationsQuery);
                        const updatePromises = [];
                        
                        snapshot.forEach(doc => {
                            updatePromises.push(updateDoc(doc.ref, { read: true }));
                        });
                        
                        await Promise.all(updatePromises);
                        document.querySelector('.fixed.inset-0.bg-black\\/50').remove();
                        document.getElementById('notification-badge').classList.add('hidden');
                        
                    } catch (error) {
                        console.error('Error marking notifications as read:', error);
                    }
                };
                
                // ========== AUTH STATE LISTENER ==========
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log('User authenticated:', user.uid);
                        await loadStudentData(user);
                    } else {
                        window.location.href = 'studentsignup.html';
                    }
                });
                
                // ========== LOAD STUDENT DATA ==========
                async function loadStudentData(user) {
                    try {
                        document.getElementById('student-display-name').innerText = user.displayName || "Student";
                        
                        const studentQuery = query(collection(db, "students"), where("studentUid", "==", user.uid));
                        const studentSnapshot = await getDocs(studentQuery);
                        
                        if (!studentSnapshot.empty) {
                            const studentDoc = studentSnapshot.docs[0];
                            const studentData = studentDoc.data();
                            
                            const gradeCountry = `${studentData.grade || 'Grade'} • ${studentData.country || 'Country'}`;
                            document.getElementById('student-grade-country').innerText = gradeCountry;
                            
                            const studentId = studentData.id || studentData.studentId || studentData.userId || studentDoc.id;
                            
                            window.currentStudent = {
                                uid: user.uid,
                                id: studentId,
                                docId: studentDoc.id,
                                name: studentData.studentName || studentData.displayName || user.displayName,
                                email: studentData.email || user.email,
                                grade: studentData.grade,
                                country: studentData.country,
                                tutorEmail: studentData.assignedTutor || studentData.tutorEmail,
                                tutorName: studentData.tutorName,
                                schedule: studentData.schedule || []
                            };
                            
                            // Setup notifications
                            await setupNotifications(studentId);
                            
                            await Promise.all([
                                loadAttendance(),
                                loadPendingTasks(),
                                loadAverageGrade(),
                                loadNextClass(),
                                loadUpcomingSchedule(),
                                loadCourses(),
                                loadAssignments(),
                                loadResults(),
                                loadSchedule(),
                                loadGames()
                            ]);
                            
                        } else {
                            console.error('No student data found for UID:', user.uid);
                            document.getElementById('student-grade-country').innerText = 'Profile Not Found';
                        }
                        
                    } catch (error) {
                        console.error('Error loading student data:', error);
                        loadMockData();
                    }
                }
                
                // ========== ATTENDANCE CALCULATION ==========
                async function loadAttendance() {
                    try {
                        if (!window.currentStudent?.id) return;
                        
                        const schedulesQuery = query(
                            collection(db, "schedules"),
                            where("studentName", "==", window.currentStudent.name)
                        );
                        
                        const schedulesSnapshot = await getDocs(schedulesQuery);
                        const totalClasses = schedulesSnapshot.size;
                        
                        const homeworkQuery = query(
                            collection(db, "homework_assignments"),
                            where("studentId", "==", window.currentStudent.id),
                            where("status", "==", "submitted")
                        );
                        
                        const homeworkSnapshot = await getDocs(homeworkQuery);
                        const attendedClasses = homeworkSnapshot.size;
                        
                        const attendancePercent = totalClasses > 0 ? 
                            Math.round((attendedClasses / totalClasses) * 100) : 100;
                        
                        document.getElementById('attendance-percent').innerText = `${attendancePercent}%`;
                        
                        const trend = attendancePercent >= 95 ? '+3% this month' : 
                                     attendancePercent >= 90 ? '+1% this month' : 
                                     attendancePercent >= 85 ? 'No change' : '-2% this month';
                        
                        const trendColor = attendancePercent >= 90 ? 'text-green-600' : 
                                          attendancePercent >= 80 ? 'text-yellow-600' : 'text-red-600';
                        
                        document.getElementById('attendance-trend').innerHTML = 
                            `<i class="fas ${attendancePercent >= 85 ? 'fa-arrow-up' : 'fa-arrow-down'} mr-1"></i> ${trend}`;
                        document.getElementById('attendance-trend').className = `text-xs ${trendColor} mt-auto flex items-center`;
                        
                    } catch (error) {
                        console.error('Error loading attendance:', error);
                        document.getElementById('attendance-percent').innerText = 'Error';
                    }
                }
                
                // ========== PENDING TASKS ==========
                async function loadPendingTasks() {
                    try {
                        if (!window.currentStudent?.id) return;
                        
                        const pendingQuery = query(
                            collection(db, "homework_assignments"),
                            where("studentId", "==", window.currentStudent.id),
                            where("status", "in", ["assigned", "pending"])
                        );
                        
                        const pendingSnapshot = await getDocs(pendingQuery);
                        const pendingCount = pendingSnapshot.size;
                        
                        document.getElementById('pending-tasks-count').innerText = pendingCount;
                        document.getElementById('pending-count').innerText = pendingCount;
                        
                        const now = new Date();
                        let dueSoon = 0;
                        
                        pendingSnapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.dueDate) {
                                const dueDate = new Date(data.dueDate);
                                const diffHours = (dueDate - now) / (1000 * 60 * 60);
                                if (diffHours <= 48) dueSoon++;
                            }
                        });
                        
                        if (dueSoon > 0) {
                            document.getElementById('pending-due').innerText = `${dueSoon} due within 48 hours`;
                            document.getElementById('pending-due').className = 'text-xs text-red-500 mt-auto';
                        } else {
                            document.getElementById('pending-due').innerText = 'No immediate deadlines';
                        }
                        
                    } catch (error) {
                        console.error('Error loading pending tasks:', error);
                    }
                }
                
                // ========== AVERAGE GRADE ==========
                async function loadAverageGrade() {
                    try {
                        if (!window.currentStudent?.id) return;
                        
                        const gradesQuery = query(
                            collection(db, "homework_assignments"),
                            where("studentId", "==", window.currentStudent.id),
                            where("status", "==", "graded"),
                            where("grade", "!=", null)
                        );
                        
                        const gradesSnapshot = await getDocs(gradesQuery);
                        
                        if (gradesSnapshot.empty) {
                            document.getElementById('average-grade').innerText = '--';
                            document.getElementById('grade-ranking').innerText = 'No grades yet';
                            return;
                        }
                        
                        let total = 0;
                        let count = 0;
                        
                        gradesSnapshot.forEach(doc => {
                            const grade = doc.data().grade;
                            if (typeof grade === 'number') {
                                total += grade;
                                count++;
                            }
                        });
                        
                        const average = count > 0 ? Math.round(total / count) : 0;
                        
                        let letterGrade = '--';
                        if (average >= 90) letterGrade = 'A';
                        else if (average >= 80) letterGrade = 'B+';
                        else if (average >= 70) letterGrade = 'B';
                        else if (average >= 60) letterGrade = 'C+';
                        else if (average >= 50) letterGrade = 'C';
                        else letterGrade = 'F';
                        
                        document.getElementById('average-grade').innerText = letterGrade;
                        
                        const ranking = average >= 85 ? 'Top 10% of class' :
                                      average >= 75 ? 'Top 25% of class' :
                                      average >= 65 ? 'Above average' : 'Average';
                        
                        document.getElementById('grade-ranking').innerText = ranking;
                        
                    } catch (error) {
                        console.error('Error loading average grade:', error);
                    }
                }
                
                // ========== NEXT CLASS WITH SCHEDULE ==========
                async function loadNextClass() {
                    try {
                        const student = window.currentStudent;
                        if (!student?.schedule || student.schedule.length === 0) {
                            document.getElementById('next-class-subject').innerText = 'No schedule set';
                            document.getElementById('next-class-time').innerText = 'Please contact your tutor';
                            document.getElementById('next-class-tutor').innerText = student?.tutorName ? `Tutor: ${student.tutorName}` : '';
                            return;
                        }
                        
                        const now = new Date();
                        let nextClass = null;
                        let nextTime = null;
                        
                        // Parse schedule from student data
                        student.schedule.forEach(schedule => {
                            if (schedule.days && schedule.time) {
                                // Simple implementation - in production, parse properly
                                const classTime = parseScheduleTime(schedule.days[0], schedule.time);
                                if (classTime > now && (!nextTime || classTime < nextTime)) {
                                    nextTime = classTime;
                                    nextClass = {
                                        subject: schedule.subject || 'Class',
                                        time: schedule.time,
                                        days: schedule.days
                                    };
                                }
                            }
                        });
                        
                        if (nextClass) {
                            const localTime = convertToLocalTime(nextTime, student.country || 'NG');
                            
                            document.getElementById('next-class-subject').innerText = 
                                `${nextClass.subject} (${student.grade || 'All'})`;
                            
                            document.getElementById('next-class-time').innerText = 
                                `${localTime.date} at ${localTime.time}`;
                            
                            document.getElementById('next-class-tutor').innerText = 
                                student.tutorName ? `Tutor: ${student.tutorName}` : '';
                            
                            const joinBtn = document.getElementById('join-room-btn');
                            joinBtn.innerHTML = `<i class="fas fa-video mr-1"></i> Join at ${localTime.time}`;
                            joinBtn.className = 'mt-auto bg-white text-brand-primary text-xs font-bold py-2 px-4 rounded-lg w-fit hover:bg-gray-50 transition-colors';
                            joinBtn.onclick = () => alert('Join class - would open Zoom link');
                            
                        } else {
                            document.getElementById('next-class-subject').innerText = 'No upcoming classes';
                            document.getElementById('next-class-time').innerText = 'Schedule not set';
                            document.getElementById('next-class-tutor').innerText = student?.tutorName ? `Tutor: ${student.tutorName}` : '';
                        }
                        
                    } catch (error) {
                        console.error('Error loading next class:', error);
                    }
                }
                
                function parseScheduleTime(day, timeStr) {
                    const now = new Date();
                    const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                    const targetDay = days.indexOf(day.toLowerCase());
                    
                    if (targetDay === -1) return new Date(now.getTime() + 24 * 60 * 60 * 1000);
                    
                    const targetDate = new Date(now);
                    const dayDiff = (targetDay + 7 - now.getDay()) % 7;
                    targetDate.setDate(now.getDate() + (dayDiff === 0 ? 7 : dayDiff));
                    
                    const [time, modifier] = timeStr.split(' ');
                    let [hours, minutes] = time.split(':');
                    hours = parseInt(hours);
                    minutes = parseInt(minutes);
                    
                    if (modifier === 'PM' && hours < 12) hours += 12;
                    if (modifier === 'AM' && hours === 12) hours = 0;
                    
                    targetDate.setHours(hours, minutes, 0, 0);
                    return targetDate;
                }
                
                function convertToLocalTime(utcTime, countryCode) {
                    const time = new Date(utcTime);
                    
                    const timezoneOffsets = {
                        'NG': 1,   // Nigeria: UTC+1
                        'US': -5,  // USA Eastern: UTC-5
                        'UK': 0,   // UK: UTC+0
                        'IN': 5.5, // India: UTC+5:30
                        'CA': -5,  // Canada Eastern: UTC-5
                        'AU': 10,  // Australia: UTC+10
                    };
                    
                    const offset = timezoneOffsets[countryCode] || 1;
                    time.setHours(time.getHours() + offset);
                    
                    return {
                        date: time.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                        time: time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })
                    };
                }
                
                // ========== UPCOMING SCHEDULE ==========
                async function loadUpcomingSchedule() {
                    try {
                        const container = document.getElementById('upcoming-schedule-list');
                        container.innerHTML = '';
                        
                        const student = window.currentStudent;
                        if (!student?.schedule || student.schedule.length === 0) {
                            container.innerHTML = '<p class="text-gray-500">No schedule set.</p>';
                            return;
                        }
                        
                        // Display next 3 classes
                        const upcomingClasses = [];
                        const now = new Date();
                        
                        student.schedule.forEach(schedule => {
                            if (schedule.days && schedule.time) {
                                schedule.days.forEach(day => {
                                    const classTime = parseScheduleTime(day, schedule.time);
                                    if (classTime > now) {
                                        upcomingClasses.push({
                                            subject: schedule.subject || 'Class',
                                            time: classTime,
                                            duration: schedule.duration || '1 hour'
                                        });
                                    }
                                });
                            }
                        });
                        
                        upcomingClasses.sort((a, b) => a.time - b.time);
                        
                        if (upcomingClasses.length === 0) {
                            container.innerHTML = '<p class="text-gray-500">No upcoming classes this week.</p>';
                            return;
                        }
                        
                        upcomingClasses.slice(0, 3).forEach(cls => {
                            const localTime = convertToLocalTime(cls.time, student.country || 'NG');
                            
                            const scheduleElement = document.createElement('div');
                            scheduleElement.className = 'flex items-start gap-4 pb-4 border-b border-gray-50 last:border-0 last:pb-0';
                            scheduleElement.innerHTML = `
                                <div class="flex flex-col items-center justify-center bg-gray-50 rounded-lg h-12 w-12 text-gray-500">
                                    <span class="text-xs font-bold uppercase">${cls.time.toLocaleString('en-US', { month: 'short' })}</span>
                                    <span class="text-lg font-bold text-gray-800">${cls.time.getDate()}</span>
                                </div>
                                <div>
                                    <h4 class="text-sm font-bold text-gray-800">${cls.subject}</h4>
                                    <p class="text-xs text-gray-500 mt-1">${localTime.time} • ${cls.duration}</p>
                                    <span class="inline-block mt-2 text-[10px] font-bold bg-blue-100 text-blue-600 px-2 py-0.5 rounded">${student.tutorName || 'Tutor'}</span>
                                </div>
                            `;
                            container.appendChild(scheduleElement);
                        });
                        
                    } catch (error) {
                        console.error('Error loading upcoming schedule:', error);
                    }
                }
                
                // ========== COURSES LOADING ==========
                async function loadCourses() {
                    try {
                        const container = document.getElementById('courses-container');
                        
                        const coursesQuery = query(
                            collection(db, "courses"),
                            where("grade", "==", window.currentStudent?.grade || 4),
                            where("status", "==", "active")
                        );
                        
                        const coursesSnapshot = await getDocs(coursesQuery);
                        
                        if (coursesSnapshot.empty) {
                            container.innerHTML = `
                                <div class="text-center col-span-3 py-12 text-gray-400">
                                    <i class="fas fa-book-open text-4xl mb-4"></i>
                                    <h3 class="text-lg font-semibold mb-2">No Courses Available</h3>
                                    <p>Your tutor will upload course materials soon.</p>
                                </div>
                            `;
                            return;
                        }
                        
                        container.innerHTML = '';
                        
                        coursesSnapshot.forEach(doc => {
                            const course = doc.data();
                            const progress = course.progress || Math.floor(Math.random() * 100);
                            
                            const courseElement = document.createElement('div');
                            courseElement.className = 'bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden group hover:shadow-lg transition-all';
                            courseElement.innerHTML = `
                                <div class="h-32 bg-gray-200 relative overflow-hidden">
                                    <div class="w-full h-full bg-gradient-to-r from-blue-500 to-purple-600 group-hover:scale-105 transition-transform duration-500"></div>
                                    <div class="absolute top-4 right-4 bg-white/90 backdrop-blur text-xs font-bold px-2 py-1 rounded text-gray-800">
                                        ${course.grade || 'Yr'} ${window.currentStudent?.grade || 4}
                                    </div>
                                </div>
                                <div class="p-6">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="text-xs font-bold text-brand-primary bg-brand-light px-2 py-1 rounded">
                                            ${course.subject || 'Subject'}
                                        </span>
                                        <span class="text-xs text-gray-400">
                                            <i class="fas ${course.platform === 'drive' ? 'fa-google-drive' : 'fa-cloud'} mr-1"></i>
                                            ${course.platform || 'Cloud'}
                                        </span>
                                    </div>
                                    <h3 class="font-bold text-lg text-gray-800 mb-2">${course.title || 'Course Title'}</h3>
                                    <p class="text-xs text-gray-500 mb-4">${course.description || 'Course description not available.'}</p>
                                    
                                    <div class="w-full bg-gray-100 rounded-full h-1.5 mb-2">
                                        <div class="bg-brand-primary h-1.5 rounded-full" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-500">
                                        <span>${progress}% Complete</span>
                                        <span>${course.lessonsCompleted || 0}/${course.totalLessons || 10} Lessons</span>
                                    </div>
                                    
                                    <div class="mt-6 pt-4 border-t border-gray-50 flex gap-2">
                                        <button onclick="viewCourse('${course.materialLink || '#'}')" class="flex-1 bg-gray-50 hover:bg-gray-100 text-gray-700 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-external-link-alt mr-1"></i> Access
                                        </button>
                                        <button onclick="continueCourse('${course.id || doc.id}')" class="flex-1 bg-brand-primary text-white py-2 rounded-lg text-sm font-medium hover:bg-brand-dark transition-colors">
                                            Continue
                                        </button>
                                    </div>
                                </div>
                            `;
                            container.appendChild(courseElement);
                        });
                        
                    } catch (error) {
                        console.error('Error loading courses:', error);
                    }
                }
                
                // ========== ASSIGNMENTS LOADING WITH CLOUDINARY ==========
                async function loadAssignments() {
                    try {
                        const container = document.getElementById('assignments-list');
                        
                        if (!window.currentStudent?.id) {
                            container.innerHTML = '<p class="text-gray-500">Student data not loaded.</p>';
                            return;
                        }
                        
                        const assignmentsQuery = query(
                            collection(db, "homework_assignments"),
                            where("studentId", "==", window.currentStudent.id)
                        );
                        
                        const assignmentsSnapshot = await getDocs(assignmentsQuery);
                        
                        if (assignmentsSnapshot.empty) {
                            container.innerHTML = `
                                <div class="p-8 text-center text-gray-400">
                                    <i class="fas fa-clipboard-check text-3xl mb-3"></i>
                                    <p>No assignments found.</p>
                                </div>
                            `;
                            return;
                        }
                        
                        container.innerHTML = '';
                        
                        document.getElementById('filter-all').onclick = () => filterAssignments('all');
                        document.getElementById('filter-pending').onclick = () => filterAssignments('pending');
                        document.getElementById('filter-graded').onclick = () => filterAssignments('graded');
                        
                        window.allAssignments = [];
                        
                        assignmentsSnapshot.forEach(doc => {
                            const assignment = { id: doc.id, ...doc.data() };
                            window.allAssignments.push(assignment);
                            displayAssignment(assignment, container);
                        });
                        
                        const pendingCount = window.allAssignments.filter(a => 
                            a.status === 'assigned' || a.status === 'pending'
                        ).length;
                        
                        document.getElementById('pending-count').innerText = pendingCount;
                        document.getElementById('pending-tasks-count').innerText = pendingCount;
                        
                    } catch (error) {
                        console.error('Error loading assignments:', error);
                        const container = document.getElementById('assignments-list');
                        container.innerHTML = `
                            <div class="p-8 text-center text-red-400">
                                <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                                <p>Error loading assignments: ${error.message}</p>
                            </div>
                        `;
                    }
                }
                
                function filterAssignments(filter) {
                    const container = document.getElementById('assignments-list');
                    container.innerHTML = '';
                    
                    ['filter-all', 'filter-pending', 'filter-graded'].forEach(id => {
                        const btn = document.getElementById(id);
                        if (id === `filter-${filter}`) {
                            btn.className = 'text-xs font-medium text-brand-primary border-b-2 border-brand-primary pb-0.5';
                        } else {
                            btn.className = 'text-xs font-medium text-gray-500 hover:text-brand-primary';
                        }
                    });
                    
                    const filtered = window.allAssignments.filter(assignment => {
                        if (filter === 'all') return true;
                        if (filter === 'pending') return assignment.status === 'assigned' || assignment.status === 'pending';
                        if (filter === 'graded') return assignment.status === 'graded';
                        return true;
                    });
                    
                    filtered.forEach(assignment => {
                        displayAssignment(assignment, container);
                    });
                    
                    if (filtered.length === 0) {
                        container.innerHTML = `
                            <div class="p-8 text-center text-gray-400">
                                <i class="fas fa-clipboard-list text-3xl mb-3"></i>
                                <p>No ${filter} assignments found.</p>
                            </div>
                        `;
                    }
                }
                
                function displayAssignment(assignment, container) {
                    const assignmentElement = document.createElement('div');
                    assignmentElement.className = 'p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group';
                    
                    let statusColor = 'bg-gray-100 text-gray-600';
                    let statusText = assignment.status || 'pending';
                    
                    if (assignment.status === 'graded') {
                        statusColor = 'bg-green-100 text-green-800';
                    } else if (assignment.status === 'submitted') {
                        statusColor = 'bg-blue-100 text-blue-800';
                    } else if (assignment.status === 'assigned' || assignment.status === 'pending') {
                        statusColor = 'bg-orange-100 text-orange-800';
                    }
                    
                    let icon = 'fa-file-alt';
                    let iconColor = 'text-gray-600';
                    let bgColor = 'bg-gray-100';
                    
                    if (assignment.subject?.toLowerCase().includes('math')) {
                        icon = 'fa-calculator';
                        iconColor = 'text-blue-600';
                        bgColor = 'bg-blue-100';
                    } else if (assignment.subject?.toLowerCase().includes('english')) {
                        icon = 'fa-book';
                        iconColor = 'text-purple-600';
                        bgColor = 'bg-purple-100';
                    } else if (assignment.subject?.toLowerCase().includes('science')) {
                        icon = 'fa-flask';
                        iconColor = 'text-green-600';
                        bgColor = 'bg-green-100';
                    }
                    
                    assignmentElement.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="h-10 w-10 rounded-lg ${bgColor} ${iconColor} flex items-center justify-center">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-gray-800">${assignment.title || 'Assignment'}</h4>
                                <p class="text-xs text-gray-500">${assignment.subject || 'Subject'} • Due: ${assignment.dueDate || 'Not specified'}</p>
                                ${assignment.attachments?.length > 0 ? 
                                    `<p class="text-xs text-blue-600 mt-1">
                                        <i class="fas fa-paperclip mr-1"></i>${assignment.attachments.length} file(s)
                                    </p>` : ''
                                }
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-bold ${statusColor} px-3 py-1 rounded-full capitalize">
                                ${statusText}${assignment.grade ? `: ${assignment.grade}%` : ''}
                            </span>
                            ${assignment.status === 'assigned' || assignment.status === 'pending' ? 
                                `<button onclick="openAssignmentWorkspace('${assignment.id}')" class="bg-brand-primary text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-brand-dark">
                                    Work on it <i class="fas fa-edit ml-1"></i>
                                </button>` :
                                `<button onclick="viewAssignmentDetails('${assignment.id}')" class="bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-gray-50">
                                    View <i class="fas fa-eye ml-1"></i>
                                </button>`
                            }
                        </div>
                    `;
                    
                    container.appendChild(assignmentElement);
                }
                
                // ========== ENHANCED ASSIGNMENT WORKSPACE WITH PDF TOOLS ==========
                window.openAssignmentWorkspace = async (assignmentId) => {
                    try {
                        const { db, doc, getDoc, updateDoc, Timestamp } = window.firebaseModules;
                        
                        const assignmentDoc = await getDoc(doc(db, "homework_assignments", assignmentId));
                        const assignment = assignmentDoc.data();
                        
                        const modal = document.createElement('div');
                        modal.className = 'fixed inset-0 bg-black/50 flex items-start justify-center z-50 p-4 overflow-y-auto';
                        modal.innerHTML = `
                            <div class="bg-white rounded-2xl w-full max-w-6xl mx-auto my-8">
                                <div class="sticky top-0 bg-white z-10 flex justify-between items-center p-6 border-b border-gray-100">
                                    <div>
                                        <h3 class="font-bold text-gray-800 text-xl">Assignment: ${assignment.title || 'Untitled'}</h3>
                                        <p class="text-sm text-gray-500">${assignment.subject || 'Subject'} • Due: ${assignment.dueDate || 'No due date'}</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="downloadAssignmentFile('${assignmentId}')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                                            <i class="fas fa-download mr-1"></i> Download
                                        </button>
                                        <button onclick="saveAssignmentDraft('${assignmentId}')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200">
                                            <i class="fas fa-save mr-1"></i> Save Draft
                                        </button>
                                        <button onclick="submitAssignmentFromWorkspace('${assignmentId}')" class="px-4 py-2 bg-brand-primary text-white rounded-lg text-sm font-medium hover:bg-brand-dark">
                                            <i class="fas fa-paper-plane mr-1"></i> Submit
                                        </button>
                                        <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="p-6">
                                    <div class="mb-6">
                                        <h4 class="font-bold text-gray-700 mb-2">Instructions:</h4>
                                        <div class="bg-gray-50 p-4 rounded-lg">
                                            <p class="text-gray-700">${assignment.instructions || assignment.description || 'No specific instructions provided.'}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <div class="lg:col-span-2">
                                            <!-- PDF Annotation Tools -->
                                            <div class="mb-4">
                                                <div class="flex justify-between items-center mb-4">
                                                    <h4 class="font-bold text-gray-700">Assignment Document</h4>
                                                    <div class="flex flex-wrap gap-2 annotation-toolbar" id="toolbar-${assignmentId}">
                                                        <button onclick="setTool('pen')" class="tool-button" data-tool="pen">
                                                            <i class="fas fa-pen mr-1"></i> Pen
                                                        </button>
                                                        <button onclick="setTool('highlighter')" class="tool-button" data-tool="highlighter">
                                                            <i class="fas fa-highlighter mr-1"></i> Highlighter
                                                        </button>
                                                        <button onclick="setTool('text')" class="tool-button" data-tool="text">
                                                            <i class="fas fa-font mr-1"></i> Text
                                                        </button>
                                                        <button onclick="setTool('line')" class="tool-button" data-tool="line">
                                                            <i class="fas fa-ruler-combined mr-1"></i> Ruler
                                                        </button>
                                                        <button onclick="setTool('rectangle')" class="tool-button" data-tool="rectangle">
                                                            <i class="fas fa-square mr-1"></i> Rectangle
                                                        </button>
                                                        <button onclick="setTool('circle')" class="tool-button" data-tool="circle">
                                                            <i class="fas fa-circle mr-1"></i> Circle
                                                        </button>
                                                        <button onclick="clearCanvas()" class="tool-button bg-red-100 text-red-700">
                                                            <i class="fas fa-eraser mr-1"></i> Clear
                                                        </button>
                                                        <div class="flex items-center gap-2">
                                                            <label class="text-xs">Size:</label>
                                                            <input type="range" id="brush-size" min="1" max="10" value="3" class="w-20">
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            <label class="text-xs">Color:</label>
                                                            <input type="color" id="brush-color" value="#059669">
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="canvas-container relative" style="height: 500px;">
                                                    <div id="pdf-viewer-${assignmentId}" class="h-full overflow-auto bg-gray-100">
                                                        <div class="text-center py-20">
                                                            <i class="fas fa-file-pdf text-4xl text-red-500 mb-2"></i>
                                                            <p class="text-gray-600">Loading assignment document...</p>
                                                            <p class="text-sm text-gray-500 mt-2">${assignment.fileName || 'assignment.pdf'}</p>
                                                            <button onclick="loadPdfDocument('${assignmentId}', '${assignment.fileUrl || assignment.attachments?.[0]?.url || ''}')" class="mt-4 px-4 py-2 bg-brand-primary text-white rounded-lg text-sm">
                                                                Load Document
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <canvas id="annotation-canvas-${assignmentId}" class="absolute top-0 left-0 w-full h-full" style="pointer-events: auto;"></canvas>
                                                </div>
                                            </div>
                                            
                                            <!-- Student Work Area -->
                                            <div class="bg-gray-50 p-4 rounded-lg mt-4">
                                                <h5 class="font-bold text-gray-700 mb-2">Your Work:</h5>
                                                <textarea id="work-text-${assignmentId}" class="w-full h-32 p-3 border border-gray-300 rounded-lg" placeholder="Type your answers or notes here...">${assignment.studentWork || ''}</textarea>
                                            </div>
                                        </div>
                                        
                                        <!-- Sidebar -->
                                        <div>
                                            <!-- File Upload -->
                                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                                <h5 class="font-bold text-gray-700 mb-2">Upload Your Work</h5>
                                                <div id="cloudinary-upload-${assignmentId}" class="mb-2">
                                                    <button onclick="openCloudinaryUpload('${assignmentId}')" class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg text-sm hover:bg-gray-900 flex items-center justify-center">
                                                        <i class="fas fa-cloud-upload-alt mr-2"></i> Upload to Cloudinary
                                                    </button>
                                                </div>
                                                <div id="uploaded-files-${assignmentId}" class="mt-2">
                                                    ${assignment.studentAttachments?.length > 0 ? 
                                                        assignment.studentAttachments.map(file => `
                                                            <div class="flex items-center justify-between bg-white p-2 rounded border mb-1">
                                                                <span class="text-xs truncate">${file.name}</span>
                                                                <button onclick="removeUploadedFile('${assignmentId}', '${file.url}')" class="text-red-500">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            </div>
                                                        `).join('') : 
                                                        '<p class="text-xs text-gray-500 text-center">No files uploaded yet</p>'
                                                    }
                                                </div>
                                            </div>
                                            
                                            <!-- Submission Status -->
                                            <div class="bg-blue-50 p-4 rounded-lg">
                                                <h5 class="font-bold text-gray-700 mb-2">Submission Status</h5>
                                                <div class="space-y-2">
                                                    <div class="flex justify-between">
                                                        <span class="text-sm text-gray-600">Status:</span>
                                                        <span class="text-sm font-bold ${assignment.status === 'graded' ? 'text-green-600' : assignment.status === 'submitted' ? 'text-blue-600' : 'text-orange-600'}">
                                                            ${assignment.status || 'Not Started'}
                                                        </span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-sm text-gray-600">Due:</span>
                                                        <span class="text-sm">${assignment.dueDate || 'No due date'}</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-sm text-gray-600">Files:</span>
                                                        <span id="file-count-${assignmentId}" class="text-sm">${assignment.studentAttachments?.length || 0} files</span>
                                                    </div>
                                                    ${assignment.grade ? `
                                                        <div class="mt-3 p-2 bg-green-100 rounded">
                                                            <div class="flex justify-between">
                                                                <span class="text-sm font-bold text-green-800">Grade:</span>
                                                                <span class="text-sm font-bold text-green-800">${assignment.grade}%</span>
                                                            </div>
                                                            ${assignment.feedback ? `
                                                                <p class="text-xs text-green-700 mt-1">${assignment.feedback}</p>
                                                            ` : ''}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        document.body.appendChild(modal);
                        
                        // Initialize drawing tools
                        initializeDrawingTools(assignmentId);
                        
                    } catch (error) {
                        console.error('Error opening workspace:', error);
                        alert('Error loading assignment workspace.');
                    }
                };
                
                // Drawing tools implementation
                let currentTool = 'pen';
                let isDrawing = false;
                let lastX = 0;
                let lastY = 0;
                let canvas, ctx;
                
                function initializeDrawingTools(assignmentId) {
                    const canvasElement = document.getElementById(`annotation-canvas-${assignmentId}`);
                    if (!canvasElement) return;
                    
                    canvas = canvasElement;
                    ctx = canvas.getContext('2d');
                    
                    // Set canvas dimensions
                    const container = canvas.parentElement;
                    canvas.width = container.clientWidth;
                    canvas.height = container.clientHeight;
                    
                    // Set initial styles
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.strokeStyle = '#059669';
                    
                    // Event listeners for drawing
                    canvas.addEventListener('mousedown', startDrawing);
                    canvas.addEventListener('mousemove', draw);
                    canvas.addEventListener('mouseup', stopDrawing);
                    canvas.addEventListener('mouseout', stopDrawing);
                    
                    // Touch events for mobile
                    canvas.addEventListener('touchstart', handleTouch);
                    canvas.addEventListener('touchmove', handleTouch);
                    canvas.addEventListener('touchend', stopDrawing);
                    
                    // Tool buttons activation
                    document.querySelectorAll(`#toolbar-${assignmentId} .tool-button`).forEach(btn => {
                        btn.addEventListener('click', function() {
                            document.querySelectorAll(`#toolbar-${assignmentId} .tool-button`).forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                        });
                    });
                    
                    // Brush size control
                    const brushSize = document.getElementById('brush-size');
                    const brushColor = document.getElementById('brush-color');
                    
                    if (brushSize) {
                        brushSize.addEventListener('input', function() {
                            ctx.lineWidth = this.value;
                        });
                    }
                    
                    if (brushColor) {
                        brushColor.addEventListener('input', function() {
                            ctx.strokeStyle = this.value;
                            ctx.fillStyle = this.value;
                        });
                    }
                }
                
                function setTool(tool) {
                    currentTool = tool;
                    
                    // Update tool button states
                    document.querySelectorAll('.tool-button').forEach(btn => {
                        if (btn.dataset.tool === tool) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                }
                
                function startDrawing(e) {
                    isDrawing = true;
                    const rect = canvas.getBoundingClientRect();
                    lastX = e.clientX - rect.left;
                    lastY = e.clientY - rect.top;
                    
                    if (currentTool === 'text') {
                        const text = prompt('Enter text:');
                        if (text) {
                            ctx.font = `${ctx.lineWidth * 5}px Arial`;
                            ctx.fillText(text, lastX, lastY);
                        }
                        isDrawing = false;
                    }
                }
                
                function draw(e) {
                    if (!isDrawing) return;
                    
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    ctx.beginPath();
                    
                    switch(currentTool) {
                        case 'pen':
                        case 'highlighter':
                            if (currentTool === 'highlighter') {
                                ctx.globalAlpha = 0.3;
                            }
                            ctx.moveTo(lastX, lastY);
                            ctx.lineTo(x, y);
                            ctx.stroke();
                            if (currentTool === 'highlighter') {
                                ctx.globalAlpha = 1.0;
                            }
                            break;
                            
                        case 'line':
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.beginPath();
                            ctx.moveTo(lastX, lastY);
                            ctx.lineTo(x, y);
                            ctx.stroke();
                            break;
                            
                        case 'rectangle':
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.strokeRect(lastX, lastY, x - lastX, y - lastY);
                            break;
                            
                        case 'circle':
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            const radius = Math.sqrt(Math.pow(x - lastX, 2) + Math.pow(y - lastY, 2));
                            ctx.beginPath();
                            ctx.arc(lastX, lastY, radius, 0, Math.PI * 2);
                            ctx.stroke();
                            break;
                    }
                    
                    lastX = x;
                    lastY = y;
                }
                
                function stopDrawing() {
                    isDrawing = false;
                }
                
                function handleTouch(e) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent('mousedown', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    
                    if (e.type === 'touchstart') {
                        startDrawing(mouseEvent);
                    } else if (e.type === 'touchmove') {
                        draw(mouseEvent);
                    }
                }
                
                function clearCanvas() {
                    if (confirm('Clear all annotations?')) {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }
                }
                
                // Load PDF document
                window.loadPdfDocument = async (assignmentId, pdfUrl) => {
                    try {
                        const viewer = document.getElementById(`pdf-viewer-${assignmentId}`);
                        if (!pdfUrl) {
                            viewer.innerHTML = '<p class="text-red-500">No document available</p>';
                            return;
                        }
                        
                        viewer.innerHTML = '<div class="text-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-brand-primary mx-auto"></div><p class="mt-2">Loading PDF...</p></div>';
                        
                        // Load PDF using pdf.js
                        const pdfjsLib = window['pdfjs-dist/build/pdf'];
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
                        
                        const loadingTask = pdfjsLib.getDocument(pdfUrl);
                        const pdf = await loadingTask.promise;
                        
                        viewer.innerHTML = '';
                        
                        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                            const page = await pdf.getPage(pageNum);
                            const viewport = page.getViewport({ scale: 1.5 });
                            
                            const canvas = document.createElement('canvas');
                            canvas.className = 'pdf-page mx-auto';
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            
                            const context = canvas.getContext('2d');
                            const renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };
                            
                            await page.render(renderContext).promise;
                            viewer.appendChild(canvas);
                        }
                        
                    } catch (error) {
                        console.error('Error loading PDF:', error);
                        document.getElementById(`pdf-viewer-${assignmentId}`).innerHTML = 
                            '<p class="text-red-500">Error loading document. You can still download it.</p>';
                    }
                };
                
                // Cloudinary Upload
                window.openCloudinaryUpload = (assignmentId) => {
                    const myWidget = cloudinary.createUploadWidget({
                        cloudName: window.CLOUDINARY_CONFIG.cloudName,
                        uploadPreset: window.CLOUDINARY_CONFIG.uploadPreset,
                        sources: ['local', 'camera', 'google_drive'],
                        multiple: true,
                        maxFiles: 5,
                        folder: 'student_homework',
                        resourceType: 'auto',
                        clientAllowedFormats: ['pdf', 'doc', 'docx', 'jpg', 'jpeg', 'png', 'txt', 'zip'],
                        maxFileSize: 10485760 // 10MB
                    }, (error, result) => {
                        if (!error && result && result.event === "success") {
                            const fileInfo = {
                                url: result.info.secure_url,
                                name: result.info.original_filename,
                                size: result.info.bytes,
                                type: result.info.resource_type,
                                publicId: result.info.public_id
                            };
                            
                            addUploadedFile(assignmentId, fileInfo);
                        }
                    });
                    
                    myWidget.open();
                };
                
                function addUploadedFile(assignmentId, fileInfo) {
                    const container = document.getElementById(`uploaded-files-${assignmentId}`);
                    const fileCount = document.getElementById(`file-count-${assignmentId}`);
                    
                    const fileElement = document.createElement('div');
                    fileElement.className = 'flex items-center justify-between bg-white p-2 rounded border mb-1';
                    fileElement.innerHTML = `
                        <span class="text-xs truncate">${fileInfo.name}</span>
                        <button onclick="removeUploadedFile('${assignmentId}', '${fileInfo.url}')" class="text-red-500">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    container.appendChild(fileElement);
                    
                    // Update file count
                    const currentCount = parseInt(fileCount.textContent) || 0;
                    fileCount.textContent = `${currentCount + 1} files`;
                    
                    // Store in temporary array
                    if (!window.uploadedFiles) window.uploadedFiles = {};
                    if (!window.uploadedFiles[assignmentId]) window.uploadedFiles[assignmentId] = [];
                    window.uploadedFiles[assignmentId].push(fileInfo);
                }
                
                window.removeUploadedFile = (assignmentId, fileUrl) => {
                    const container = document.getElementById(`uploaded-files-${assignmentId}`);
                    const fileCount = document.getElementById(`file-count-${assignmentId}`);
                    
                    // Find and remove element
                    Array.from(container.children).forEach(child => {
                        if (child.textContent.includes(fileUrl.split('/').pop())) {
                            container.removeChild(child);
                        }
                    });
                    
                    // Update file count
                    const currentCount = parseInt(fileCount.textContent) || 0;
                    fileCount.textContent = `${Math.max(0, currentCount - 1)} files`;
                    
                    // Remove from array
                    if (window.uploadedFiles && window.uploadedFiles[assignmentId]) {
                        window.uploadedFiles[assignmentId] = window.uploadedFiles[assignmentId].filter(
                            file => file.url !== fileUrl
                        );
                    }
                };
                
                window.saveAssignmentDraft = async (assignmentId) => {
                    try {
                        const { db, doc, updateDoc } = window.firebaseModules;
                        
                        const updates = {
                            studentWork: document.getElementById(`work-text-${assignmentId}`)?.value || '',
                            lastSaved: new Date()
                        };
                        
                        if (window.uploadedFiles && window.uploadedFiles[assignmentId]) {
                            updates.studentAttachments = window.uploadedFiles[assignmentId];
                        }
                        
                        await updateDoc(doc(db, "homework_assignments", assignmentId), updates);
                        alert('Draft saved successfully!');
                        
                    } catch (error) {
                        console.error('Error saving draft:', error);
                        alert('Error saving draft.');
                    }
                };
                
                window.submitAssignmentFromWorkspace = async (assignmentId) => {
                    try {
                        const { db, doc, updateDoc, Timestamp } = window.firebaseModules;
                        
                        const studentAttachments = window.uploadedFiles && window.uploadedFiles[assignmentId] || [];
                        
                        if (studentAttachments.length === 0 && !document.getElementById(`work-text-${assignmentId}`)?.value.trim()) {
                            if (!confirm('You haven\'t uploaded any files or entered any work. Submit anyway?')) {
                                return;
                            }
                        }
                        
                        await updateDoc(doc(db, "homework_assignments", assignmentId), {
                            status: 'submitted',
                            submittedDate: Timestamp.now(),
                            studentWork: document.getElementById(`work-text-${assignmentId}`)?.value || '',
                            studentAttachments: studentAttachments
                        });
                        
                        alert('Assignment submitted successfully!');
                        document.querySelector('.fixed.inset-0.bg-black\\/50').remove();
                        
                        await loadAssignments();
                        await loadPendingTasks();
                        
                    } catch (error) {
                        console.error('Error submitting assignment:', error);
                        alert('Error submitting assignment.');
                    }
                };
                
                window.downloadAssignmentFile = async (assignmentId) => {
                    try {
                        const { db, doc, getDoc } = window.firebaseModules;
                        
                        const assignmentDoc = await getDoc(doc(db, "homework_assignments", assignmentId));
                        const assignment = assignmentDoc.data();
                        
                        const fileUrl = assignment.fileUrl || assignment.attachments?.[0]?.url;
                        if (fileUrl) {
                            const link = document.createElement('a');
                            link.href = fileUrl;
                            link.download = assignment.fileName || assignment.attachments?.[0]?.name || 'assignment.pdf';
                            link.target = '_blank';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        } else {
                            alert('No file attached to this assignment.');
                        }
                    } catch (error) {
                        console.error('Error downloading file:', error);
                        alert('Error downloading assignment file.');
                    }
                };
                
                window.downloadGradedAssignment = async (assignmentId) => {
                    try {
                        const { db, doc, getDoc } = window.firebaseModules;
                        
                        const assignmentDoc = await getDoc(doc(db, "homework_assignments", assignmentId));
                        const assignment = assignmentDoc.data();
                        
                        if (assignment.gradedFileUrl) {
                            const link = document.createElement('a');
                            link.href = assignment.gradedFileUrl;
                            link.download = `graded_${assignment.fileName || 'assignment.pdf'}`;
                            link.target = '_blank';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        } else {
                            alert('No graded file available.');
                        }
                    } catch (error) {
                        console.error('Error downloading graded assignment:', error);
                        alert('Error downloading graded assignment.');
                    }
                };
                
                window.viewAssignmentDetails = async (assignmentId) => {
                    try {
                        const { db, doc, getDoc } = window.firebaseModules;
                        
                        const assignmentDoc = await getDoc(doc(db, "homework_assignments", assignmentId));
                        const assignment = assignmentDoc.data();
                        
                        const modal = document.createElement('div');
                        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
                        modal.innerHTML = `
                            <div class="bg-white rounded-2xl w-full max-w-2xl">
                                <div class="flex justify-between items-center p-6 border-b border-gray-100">
                                    <h3 class="font-bold text-gray-800 text-xl">Assignment Details</h3>
                                    <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="p-6 space-y-4">
                                    <div>
                                        <h4 class="font-bold text-gray-700 mb-1">${assignment.title || 'Untitled'}</h4>
                                        <p class="text-sm text-gray-500">${assignment.subject || 'Subject'} • Assigned by: ${assignment.tutorName || 'Tutor'}</p>
                                    </div>
                                    
                                    ${assignment.grade ? `
                                        <div class="bg-green-50 p-4 rounded-lg">
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <h5 class="font-bold text-green-800">Grade: ${assignment.grade}%</h5>
                                                    ${assignment.feedback ? `<p class="text-sm text-green-600 mt-1">${assignment.feedback}</p>` : ''}
                                                    <p class="text-xs text-green-600 mt-1">Graded on: ${new Date(assignment.gradedDate?.toDate()).toLocaleDateString()}</p>
                                                </div>
                                                ${assignment.gradedFileUrl ? `
                                                    <button onclick="downloadGradedAssignment('${assignmentId}')" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg text-sm hover:bg-green-200">
                                                        <i class="fas fa-download mr-1"></i> Download Graded
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    ` : assignment.status === 'submitted' ? `
                                        <div class="bg-blue-50 p-4 rounded-lg">
                                            <h5 class="font-bold text-blue-800">Submitted on: ${new Date(assignment.submittedDate?.toDate()).toLocaleDateString()}</h5>
                                            <p class="text-sm text-blue-600 mt-1">Awaiting grading by tutor</p>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h5 class="font-bold text-gray-700 mb-2">Description:</h5>
                                        <p class="text-gray-700">${assignment.description || 'No description provided.'}</p>
                                    </div>
                                    
                                    ${assignment.instructions ? `
                                        <div class="bg-blue-50 p-4 rounded-lg">
                                            <h5 class="font-bold text-gray-700 mb-2">Instructions:</h5>
                                            <p class="text-gray-700">${assignment.instructions}</p>
                                        </div>
                                    ` : ''}
                                    
                                    ${assignment.attachments?.length > 0 ? `
                                        <div class="bg-blue-50 p-4 rounded-lg">
                                            <h5 class="font-bold text-gray-700 mb-2">Attached Files:</h5>
                                            <div class="space-y-2">
                                                ${assignment.attachments.map((file, index) => `
                                                    <div class="flex items-center justify-between bg-white p-2 rounded">
                                                        <div class="flex items-center">
                                                            <i class="fas fa-file-pdf text-red-500 mr-2"></i>
                                                            <span class="text-sm">${file.name}</span>
                                                        </div>
                                                        <a href="${file.url}" target="_blank" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm">
                                                            View
                                                        </a>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${assignment.studentAttachments?.length > 0 ? `
                                        <div class="bg-green-50 p-4 rounded-lg">
                                            <h5 class="font-bold text-gray-700 mb-2">Your Submitted Files:</h5>
                                            <div class="space-y-2">
                                                ${assignment.studentAttachments.map((file, index) => `
                                                    <div class="flex items-center justify-between bg-white p-2 rounded">
                                                        <div class="flex items-center">
                                                            <i class="fas fa-file text-green-500 mr-2"></i>
                                                            <span class="text-sm">${file.name}</span>
                                                        </div>
                                                        <a href="${file.url}" target="_blank" class="px-3 py-1 bg-green-100 text-green-700 rounded text-sm">
                                                            View
                                                        </a>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="flex gap-3 pt-4">
                                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200">
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        document.body.appendChild(modal);
                        
                    } catch (error) {
                        console.error('Error viewing assignment:', error);
                        alert('Error loading assignment details.');
                    }
                };
                
                // ========== RESULTS LOADING ==========
                async function loadResults() {
                    try {
                        const container = document.getElementById('results-container');
                        
                        if (!window.currentStudent?.id) return;
                        
                        const resultsQuery = query(
                            collection(db, "homework_assignments"),
                            where("studentId", "==", window.currentStudent.id),
                            where("status", "==", "graded"),
                            where("grade", "!=", null)
                        );
                        
                        const resultsSnapshot = await getDocs(resultsQuery);
                        
                        if (resultsSnapshot.empty) {
                            container.innerHTML = `
                                <div class="text-center py-8 text-gray-400">
                                    <i class="fas fa-chart-line text-3xl mb-3"></i>
                                    <p>No graded results available yet.</p>
                                </div>
                            `;
                            return;
                        }
                        
                        const resultsBySubject = {};
                        resultsSnapshot.forEach(doc => {
                            const result = doc.data();
                            const subject = result.subject || 'General';
                            
                            if (!resultsBySubject[subject]) {
                                resultsBySubject[subject] = [];
                            }
                            
                            resultsBySubject[subject].push({
                                id: doc.id,
                                title: result.title,
                                grade: result.grade,
                                date: result.submittedDate || result.gradedDate,
                                feedback: result.feedback
                            });
                        });
                        
                        container.innerHTML = '';
                        for (const [subject, results] of Object.entries(resultsBySubject)) {
                            const subjectElement = document.createElement('div');
                            subjectElement.className = 'mb-6 pb-6 border-b border-gray-100 last:border-0';
                            
                            let subjectHTML = `
                                <h4 class="font-bold text-gray-700 mb-3">${subject}</h4>
                                <div class="space-y-3">
                            `;
                            
                            results.forEach(result => {
                                let gradeColor = 'text-red-600';
                                if (result.grade >= 90) gradeColor = 'text-green-600';
                                else if (result.grade >= 80) gradeColor = 'text-blue-600';
                                else if (result.grade >= 70) gradeColor = 'text-yellow-600';
                                
                                subjectHTML += `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="text-sm font-medium text-gray-800">${result.title}</p>
                                            <p class="text-xs text-gray-500">${result.date ? new Date(result.date.toDate()).toLocaleDateString() : 'No date'}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-lg font-bold ${gradeColor}">${result.grade}%</p>
                                            ${result.feedback ? `<p class="text-xs text-gray-500">${result.feedback}</p>` : ''}
                                            <button onclick="downloadGradedAssignment('${result.id}')" class="mt-2 text-xs text-brand-primary hover:text-brand-dark">
                                                <i class="fas fa-download mr-1"></i> Download
                                            </button>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            subjectHTML += `</div>`;
                            subjectElement.innerHTML = subjectHTML;
                            container.appendChild(subjectElement);
                        }
                        
                    } catch (error) {
                        console.error('Error loading results:', error);
                    }
                }
                
                // ========== SCHEDULE LOADING ==========
                async function loadSchedule() {
                    try {
                        const container = document.getElementById('full-schedule-container');
                        const student = window.currentStudent;
                        
                        if (!student?.schedule || student.schedule.length === 0) {
                            container.innerHTML = `
                                <div class="text-center py-8 text-gray-400">
                                    <i class="fas fa-calendar text-3xl mb-3"></i>
                                    <p>No scheduled classes for the next month.</p>
                                    <p class="text-sm mt-2">Tutor: ${student.tutorName || 'Not assigned'}</p>
                                </div>
                            `;
                            return;
                        }
                        
                        container.innerHTML = '';
                        
                        // Group by week
                        const now = new Date();
                        const weeks = {};
                        
                        student.schedule.forEach((schedule, index) => {
                            if (schedule.days && schedule.time) {
                                schedule.days.forEach(day => {
                                    const classTime = parseScheduleTime(day, schedule.time);
                                    const weekStart = getWeekStart(classTime);
                                    
                                    if (!weeks[weekStart]) {
                                        weeks[weekStart] = [];
                                    }
                                    
                                    weeks[weekStart].push({
                                        ...schedule,
                                        day: day,
                                        time: schedule.time,
                                        dateTime: classTime
                                    });
                                });
                            }
                        });
                        
                        // Sort weeks
                        const sortedWeeks = Object.keys(weeks).sort();
                        
                        sortedWeeks.forEach(weekStart => {
                            const weekStartDate = new Date(weekStart);
                            const weekEndDate = new Date(weekStart);
                            weekEndDate.setDate(weekEndDate.getDate() + 6);
                            
                            const weekElement = document.createElement('div');
                            weekElement.className = 'mb-8';
                            
                            let weekHTML = `
                                <h4 class="font-bold text-gray-700 mb-4">
                                    Week of ${weekStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - 
                                    ${weekEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                </h4>
                                <div class="space-y-3">
                            `;
                            
                            weeks[weekStart].sort((a, b) => a.dateTime - b.dateTime);
                            
                            weeks[weekStart].forEach(schedule => {
                                const localTime = convertToLocalTime(schedule.dateTime, student.country || 'NG');
                                
                                weekHTML += `
                                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                        <div class="flex items-center gap-4">
                                            <div class="h-12 w-12 bg-white rounded-lg flex flex-col items-center justify-center border">
                                                <span class="text-xs font-bold text-gray-500">${schedule.day.substring(0, 3)}</span>
                                                <span class="text-lg font-bold text-gray-800">${schedule.dateTime.getDate()}</span>
                                            </div>
                                            <div>
                                                <p class="font-medium text-gray-800">${schedule.subject || 'Class'}</p>
                                                <p class="text-sm text-gray-500">${localTime.time} • ${schedule.duration || '1 hour'}</p>
                                                <p class="text-xs text-brand-primary">${student.tutorName || 'Tutor'}</p>
                                            </div>
                                        </div>
                                        <button onclick="alert('Join class - would open Zoom link')" class="px-4 py-2 bg-brand-primary text-white text-sm font-medium rounded-lg hover:bg-brand-dark transition-colors">
                                            <i class="fas fa-video mr-1"></i> Join
                                        </button>
                                    </div>
                                `;
                            });
                            
                            weekHTML += `</div>`;
                            weekElement.innerHTML = weekHTML;
                            container.appendChild(weekElement);
                        });
                        
                    } catch (error) {
                        console.error('Error loading schedule:', error);
                    }
                }
                
                function getWeekStart(date) {
                    const d = new Date(date);
                    const day = d.getDay();
                    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                    const weekStart = new Date(d.setDate(diff));
                    weekStart.setHours(0, 0, 0, 0);
                    return weekStart.toISOString();
                }
                
                // ========== ENHANCED EDUCATIONAL GAMES ==========
                async function loadGames() {
                    try {
                        const container = document.getElementById('games-container');
                        const grade = window.currentStudent?.grade || 3;
                        const games = getGamesByGrade(grade);
                        
                        container.innerHTML = '';
                        
                        games.forEach(game => {
                            const gameElement = document.createElement('div');
                            gameElement.className = 'bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden group hover:shadow-lg transition-all';
                            gameElement.innerHTML = `
                                <div class="h-40 bg-gradient-to-r ${game.gradient} relative overflow-hidden">
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <i class="fas ${game.icon} text-white text-5xl opacity-80"></i>
                                    </div>
                                    <div class="absolute bottom-4 left-4">
                                        <span class="text-xs font-bold text-white bg-black/30 backdrop-blur px-2 py-1 rounded">${game.difficulty}</span>
                                    </div>
                                </div>
                                <div class="p-5">
                                    <h3 class="font-bold text-gray-800 mb-2">${game.name}</h3>
                                    <p class="text-xs text-gray-500 mb-4">${game.description}</p>
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs font-bold ${game.subject === 'Math' ? 'text-blue-600' : game.subject === 'English' ? 'text-purple-600' : 'text-green-600'}">
                                            ${game.subject}
                                        </span>
                                        <button onclick="startGame('${game.id}', '${game.name}', '${game.subject}', ${grade})" class="px-4 py-2 bg-brand-primary text-white text-xs font-bold rounded-lg hover:bg-brand-dark transition-colors">
                                            Play <i class="fas fa-play ml-1"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                            container.appendChild(gameElement);
                        });
                        
                        document.getElementById('show-leaderboard').onclick = toggleLeaderboard;
                        
                    } catch (error) {
                        console.error('Error loading games:', error);
                    }
                }
                
                function getGamesByGrade(grade) {
                    const gradeLevel = parseInt(grade) || 3;
                    
                    return [
                        {
                            id: 'math_puzzle',
                            name: gradeLevel >= 5 ? 'Algebra Adventure' : 'Number Ninja',
                            description: gradeLevel >= 5 ? 
                                'Solve algebraic equations in 5 levels' : 
                                'Master basic arithmetic with fun puzzles',
                            icon: gradeLevel >= 5 ? 'fa-superscript' : 'fa-calculator',
                            gradient: 'from-blue-500 to-cyan-400',
                            subject: 'Math',
                            difficulty: gradeLevel >= 5 ? 'Intermediate' : 'Beginner'
                        },
                        {
                            id: 'word_wizard',
                            name: gradeLevel >= 4 ? 'Vocabulary Voyage' : 'Spelling Safari',
                            description: gradeLevel >= 4 ?
                                'Expand your vocabulary with 5 challenging levels' :
                                'Improve spelling through 5 interactive levels',
                            icon: 'fa-spell-check',
                            gradient: 'from-purple-500 to-pink-400',
                            subject: 'English',
                            difficulty: gradeLevel >= 4 ? 'Intermediate' : 'Beginner'
                        },
                        {
                            id: 'science_explorer',
                            name: gradeLevel >= 6 ? 'Physics Pioneer' : 'Biology Builder',
                            description: gradeLevel >= 6 ?
                                'Explore physics concepts through 5 simulations' :
                                'Learn biology with 5 interactive experiments',
                            icon: gradeLevel >= 6 ? 'fa-atom' : 'fa-dna',
                            gradient: 'from-green-500 to-emerald-400',
                            subject: 'Science',
                            difficulty: gradeLevel >= 6 ? 'Advanced' : 'Intermediate'
                        },
                        {
                            id: 'logic_lab',
                            name: 'Logic Lab',
                            description: 'Develop critical thinking with 5 logic puzzles',
                            icon: 'fa-brain',
                            gradient: 'from-orange-500 to-red-400',
                            subject: 'Logic',
                            difficulty: 'All Levels'
                        }
                    ];
                }
                
                // Enhanced game system with 5 questions per level
                window.startGame = (gameId, gameName, subject, grade) => {
                    const gameContainer = document.createElement('div');
                    gameContainer.className = 'fixed inset-0 bg-gradient-to-br from-gray-900 to-black flex flex-col items-center justify-center z-50 p-4';
                    gameContainer.innerHTML = `
                        <div class="w-full max-w-4xl bg-gray-800 rounded-2xl overflow-hidden shadow-2xl">
                            <div class="flex justify-between items-center p-4 bg-gray-900">
                                <div>
                                    <h3 class="text-xl font-bold text-white">${gameName}</h3>
                                    <p class="text-sm text-gray-300">${subject} • Educational Game</p>
                                </div>
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-300 hover:text-white">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                            
                            <div class="p-6">
                                <div id="game-area-${gameId}" class="bg-gray-900 rounded-lg p-6 mb-6">
                                    <div class="text-center py-12">
                                        <i class="fas fa-gamepad text-6xl text-brand-primary mb-4"></i>
                                        <h4 class="text-2xl font-bold text-white mb-4">${gameName}</h4>
                                        <p class="text-gray-300 mb-6">Get ready to play! Answer 5 questions correctly to advance.</p>
                                        <div class="flex justify-center gap-4">
                                            <button onclick="start${gameId === 'math_puzzle' ? 'Math' : gameId === 'word_wizard' ? 'Word' : gameId === 'science_explorer' ? 'Science' : 'Logic'}Game('${gameId}', ${grade})" class="px-6 py-3 bg-brand-primary text-white font-bold rounded-lg hover:bg-brand-dark transition-all transform hover:scale-105">
                                                <i class="fas fa-play mr-2"></i> Start Game
                                            </button>
                                            <button onclick="showGameInstructions('${gameId}')" class="px-6 py-3 bg-gray-700 text-white font-bold rounded-lg hover:bg-gray-600">
                                                <i class="fas fa-info-circle mr-2"></i> How to Play
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-gray-900 p-4 rounded-lg">
                                        <h5 class="font-bold text-white mb-2">Score: <span id="score-${gameId}">0</span></h5>
                                        <div class="w-full bg-gray-700 rounded-full h-2">
                                            <div id="progress-${gameId}" class="bg-brand-primary h-2 rounded-full" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="bg-gray-900 p-4 rounded-lg">
                                        <h5 class="font-bold text-white mb-2">Questions: <span id="question-count-${gameId}">1/5</span></h5>
                                        <div class="w-full bg-gray-700 rounded-full h-2">
                                            <div id="question-progress-${gameId}" class="bg-blue-500 h-2 rounded-full" style="width: 20%"></div>
                                        </div>
                                    </div>
                                    <div class="bg-gray-900 p-4 rounded-lg">
                                        <h5 class="font-bold text-white mb-2">Level: <span id="level-${gameId}">1</span></h5>
                                        <button onclick="nextGameLevel('${gameId}')" class="w-full px-4 py-2 bg-green-600 text-white rounded text-sm font-bold hover:bg-green-700">
                                            Next Level
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(gameContainer);
                };
                
                // Math Game with 5 questions
                window.startMathGame = (gameId, grade) => {
                    const gameArea = document.getElementById(`game-area-${gameId}`);
                    let score = 0;
                    let currentQuestion = 1;
                    let level = 1;
                    let correctAnswers = 0;
                    
                    const generateMathProblem = () => {
                        let num1, num2, operator, answer;
                        
                        if (grade >= 5) {
                            // Algebra problems for higher grades
                            const x = Math.floor(Math.random() * 10) + 1;
                            const operators = ['+', '-', '×'];
                            operator = operators[Math.floor(Math.random() * operators.length)];
                            
                            if (operator === '+') {
                                num1 = x;
                                num2 = Math.floor(Math.random() * 10) + 1;
                                answer = num1 + num2;
                                return {
                                    question: `x + ${num2} = ${answer}`,
                                    answer: x,
                                    options: generateOptions(x, answer)
                                };
                            } else if (operator === '-') {
                                num1 = Math.floor(Math.random() * 20) + 10;
                                num2 = Math.floor(Math.random() * 10) + 1;
                                answer = num1 - num2;
                                return {
                                    question: `${num1} - x = ${answer}`,
                                    answer: num2,
                                    options: generateOptions(num2, num1)
                                };
                            } else {
                                num1 = x;
                                num2 = Math.floor(Math.random() * 5) + 1;
                                answer = num1 * num2;
                                return {
                                    question: `${num1} × ${num2} = ?`,
                                    answer: answer,
                                    options: generateOptions(answer, num1 * num2 + 10)
                                };
                            }
                        } else {
                            // Basic arithmetic for lower grades
                            const operators = ['+', '-', '×', '÷'];
                            operator = operators[Math.floor(Math.random() * (grade >= 3 ? 4 : 2))];
                            
                            if (operator === '+') {
                                num1 = Math.floor(Math.random() * 20) + 1;
                                num2 = Math.floor(Math.random() * 20) + 1;
                                answer = num1 + num2;
                            } else if (operator === '-') {
                                num1 = Math.floor(Math.random() * 30) + 10;
                                num2 = Math.floor(Math.random() * 10) + 1;
                                answer = num1 - num2;
                            } else if (operator === '×') {
                                num1 = Math.floor(Math.random() * 10) + 1;
                                num2 = Math.floor(Math.random() * 5) + 1;
                                answer = num1 * num2;
                            } else {
                                num2 = Math.floor(Math.random() * 5) + 2;
                                answer = Math.floor(Math.random() * 5) + 1;
                                num1 = answer * num2;
                            }
                            
                            return {
                                question: `${num1} ${operator} ${num2} = ?`,
                                answer: answer,
                                options: generateOptions(answer, answer + 20)
                            };
                        }
                    };
                    
                    const generateOptions = (correctAnswer, max) => {
                        const options = [correctAnswer];
                        while (options.length < 4) {
                            const option = correctAnswer + Math.floor(Math.random() * 10) - 5;
                            if (option !== correctAnswer && option > 0 && !options.includes(option)) {
                                options.push(option);
                            }
                        }
                        return options.sort(() => Math.random() - 0.5);
                    };
                    
                    const displayQuestion = () => {
                        const problem = generateMathProblem();
                        
                        gameArea.innerHTML = `
                            <div class="text-center">
                                <h4 class="text-2xl font-bold text-white mb-6">Question ${currentQuestion}/5</h4>
                                <div class="text-5xl font-bold text-white mb-8">
                                    ${problem.question}
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    ${problem.options.map((option, index) => `
                                        <button onclick="checkMathAnswer('${gameId}', ${option}, ${problem.answer}, ${grade})" 
                                                class="game-option p-4 bg-gray-700 text-white text-xl font-bold rounded-lg hover:bg-gray-600 transition-all transform hover:scale-105">
                                            ${option}
                                        </button>
                                    `).join('')}
                                </div>
                                <div class="mt-6 text-gray-300">
                                    <p>Level: ${level} | Score: ${score} | Correct: ${correctAnswers}/5</p>
                                </div>
                            </div>
                        `;
                        
                        document.getElementById(`question-count-${gameId}`).textContent = `${currentQuestion}/5`;
                        document.getElementById(`question-progress-${gameId}`).style.width = `${(currentQuestion / 5) * 100}%`;
                    };
                    
                    displayQuestion();
                    
                    window.checkMathAnswer = (gameId, selected, correct, grade) => {
                        const buttons = document.querySelectorAll(`#game-area-${gameId} .game-option`);
                        
                        buttons.forEach(btn => {
                            const btnValue = parseInt(btn.textContent);
                            btn.disabled = true;
                            
                            if (btnValue === correct) {
                                btn.classList.add('correct');
                            } else if (btnValue === selected) {
                                btn.classList.add('wrong');
                            }
                        });
                        
                        if (selected === correct) {
                            score += grade * 10;
                            correctAnswers++;
                            document.getElementById(`score-${gameId}`).textContent = score;
                            document.getElementById(`progress-${gameId}`).style.width = `${Math.min((score / 500) * 100, 100)}%`;
                        }
                        
                        setTimeout(() => {
                            currentQuestion++;
                            
                            if (currentQuestion > 5) {
                                // Level complete
                                if (correctAnswers >= 3) {
                                    level++;
                                    document.getElementById(`level-${gameId}`).textContent = level;
                                    gameArea.innerHTML = `
                                        <div class="text-center py-12">
                                            <h4 class="text-3xl font-bold text-white mb-4">Level Complete! 🎉</h4>
                                            <p class="text-xl text-gray-300 mb-6">Score: ${score} | Correct: ${correctAnswers}/5</p>
                                            <p class="text-lg text-green-400 mb-6">Advancing to Level ${level}!</p>
                                            <button onclick="startMathGame('${gameId}', ${grade})" class="px-6 py-3 bg-brand-primary text-white font-bold rounded-lg">
                                                Play Level ${level}
                                            </button>
                                        </div>
                                    `;
                                } else {
                                    gameArea.innerHTML = `
                                        <div class="text-center py-12">
                                            <h4 class="text-3xl font-bold text-white mb-4">Try Again! 💪</h4>
                                            <p class="text-xl text-gray-300 mb-6">You got ${correctAnswers}/5 correct</p>
                                            <button onclick="startMathGame('${gameId}', ${grade})" class="px-6 py-3 bg-brand-primary text-white font-bold rounded-lg">
                                                Retry Level ${level}
                                            </button>
                                        </div>
                                    `;
                                }
                                currentQuestion = 1;
                                correctAnswers = 0;
                            } else {
                                displayQuestion();
                            }
                        }, 1500);
                    };
                };
                
                // Word Game
                window.startWordGame = (gameId, grade) => {
                    const gameArea = document.getElementById(`game-area-${gameId}`);
                    let score = 0;
                    let currentQuestion = 1;
                    let level = 1;
                    let correctAnswers = 0;
                    
                    const wordLists = {
                        beginner: ['cat', 'dog', 'house', 'school', 'friend', 'water', 'apple', 'happy', 'sunny', 'book'],
                        intermediate: ['elephant', 'mountain', 'beautiful', 'discovery', 'adventure', 'knowledge', 'freedom', 'mystery', 'treasure', 'victory'],
                        advanced: ['philosophy', 'architecture', 'revolution', 'democracy', 'technology', 'university', 'opportunity', 'celebration', 'imagination', 'extraordinary']
                    };
                    
                    const getWordList = () => {
                        if (grade >= 6) return wordLists.advanced;
                        if (grade >= 4) return wordLists.intermediate;
                        return wordLists.beginner;
                    };
                    
                    const generateWordProblem = () => {
                        const wordList = getWordList();
                        const word = wordList[Math.floor(Math.random() * wordList.length)];
                        const scrambled = scrambleWord(word);
                        
                        return {
                            question: `Unscramble the word: ${scrambled}`,
                            answer: word,
                            options: generateWordOptions(word, wordList)
                        };
                    };
                    
                    const scrambleWord = (word) => {
                        const arr = word.split('');
                        for (let i = arr.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [arr[i], arr[j]] = [arr[j], arr[i]];
                        }
                        return arr.join('');
                    };
                    
                    const generateWordOptions = (correctWord, wordList) => {
                        const options = [correctWord];
                        while (options.length < 4) {
                            const randomWord = wordList[Math.floor(Math.random() * wordList.length)];
                            if (randomWord !== correctWord && !options.includes(randomWord)) {
                                options.push(randomWord);
                            }
                        }
                        return options.sort(() => Math.random() - 0.5);
                    };
                    
                    const displayQuestion = () => {
                        const problem = generateWordProblem();
                        
                        gameArea.innerHTML = `
                            <div class="text-center">
                                <h4 class="text-2xl font-bold text-white mb-6">Question ${currentQuestion}/5</h4>
                                <div class="text-4xl font-bold text-white mb-8">
                                    ${problem.question}
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    ${problem.options.map((option, index) => `
                                        <button onclick="checkWordAnswer('${gameId}', '${option}', '${problem.answer}', ${grade})" 
                                                class="game-option p-4 bg-gray-700 text-white text-xl font-bold rounded-lg hover:bg-gray-600 transition-all transform hover:scale-105">
                                            ${option}
                                        </button>
                                    `).join('')}
                                </div>
                                <div class="mt-6 text-gray-300">
                                    <p>Level: ${level} | Score: ${score} | Correct: ${correctAnswers}/5</p>
                                </div>
                            </div>
                        `;
                        
                        document.getElementById(`question-count-${gameId}`).textContent = `${currentQuestion}/5`;
                        document.getElementById(`question-progress-${gameId}`).style.width = `${(currentQuestion / 5) * 100}%`;
                    };
                    
                    displayQuestion();
                    
                    window.checkWordAnswer = (gameId, selected, correct, grade) => {
                        const buttons = document.querySelectorAll(`#game-area-${gameId} .game-option`);
                        
                        buttons.forEach(btn => {
                            const btnValue = btn.textContent;
                            btn.disabled = true;
                            
                            if (btnValue === correct) {
                                btn.classList.add('correct');
                            } else if (btnValue === selected) {
                                btn.classList.add('wrong');
                            }
                        });
                        
                        if (selected === correct) {
                            score += grade * 15;
                            correctAnswers++;
                            document.getElementById(`score-${gameId}`).textContent = score;
                            document.getElementById(`progress-${gameId}`).style.width = `${Math.min((score / 500) * 100, 100)}%`;
                        }
                        
                        setTimeout(() => {
                            currentQuestion++;
                            
                            if (currentQuestion > 5) {
                                if (correctAnswers >= 3) {
                                    level++;
                                    document.getElementById(`level-${gameId}`).textContent = level;
                                    gameArea.innerHTML = `
                                        <div class="text-center py-12">
                                            <h4 class="text-3xl font-bold text-white mb-4">Level Complete! 🎉</h4>
                                            <p class="text-xl text-gray-300 mb-6">Score: ${score} | Correct: ${correctAnswers}/5</p>
                                            <p class="text-lg text-green-400 mb-6">Advancing to Level ${level}!</p>
                                            <button onclick="startWordGame('${gameId}', ${grade})" class="px-6 py-3 bg-brand-primary text-white font-bold rounded-lg">
                                                Play Level ${level}
                                            </button>
                                        </div>
                                    `;
                                } else {
                                    gameArea.innerHTML = `
                                        <div class="text-center py-12">
                                            <h4 class="text-3xl font-bold text-white mb-4">Try Again! 💪</h4>
                                            <p class="text-xl text-gray-300 mb-6">You got ${correctAnswers}/5 correct</p>
                                            <button onclick="startWordGame('${gameId}', ${grade})" class="px-6 py-3 bg-brand-primary text-white font-bold rounded-lg">
                                                Retry Level ${level}
                                            </button>
                                        </div>
                                    `;
                                }
                                currentQuestion = 1;
                                correctAnswers = 0;
                            } else {
                                displayQuestion();
                            }
                        }, 1500);
                    };
                };
                
                window.startScienceGame = (gameId, grade) => {
                    // Similar implementation for science game
                    // Would include science questions based on grade level
                };
                
                window.startLogicGame = (gameId, grade) => {
                    // Similar implementation for logic game
                    // Would include logic puzzles based on grade level
                };
                
                window.showGameInstructions = (gameId) => {
                    const gameArea = document.getElementById(`game-area-${gameId}`);
                    gameArea.innerHTML = `
                        <div class="text-center">
                            <h4 class="text-2xl font-bold text-white mb-6">How to Play</h4>
                            <div class="text-left space-y-4 text-gray-300">
                                <p>1. Answer 5 questions correctly to complete a level</p>
                                <p>2. Get at least 3 correct answers to advance to next level</p>
                                <p>3. Each correct answer earns you points</p>
                                <p>4. Points multiplier increases with each level</p>
                                <p>5. Try to reach the highest level!</p>
                            </div>
                            <button onclick="startMathGame('${gameId}', ${window.currentStudent?.grade || 3})" class="mt-8 px-6 py-3 bg-brand-primary text-white font-bold rounded-lg">
                                Start Game Now
                            </button>
                        </div>
                    `;
                };
                
                window.nextGameLevel = (gameId) => {
                    alert('Complete the current level first!');
                };
                
                function toggleLeaderboard() {
                    const container = document.getElementById('leaderboard-container');
                    const button = document.getElementById('show-leaderboard');
                    
                    if (container.classList.contains('hidden')) {
                        container.classList.remove('hidden');
                        button.innerHTML = '<i class="fas fa-times mr-1"></i> Hide Leaderboard';
                        loadLeaderboard();
                    } else {
                        container.classList.add('hidden');
                        button.innerHTML = '<i class="fas fa-trophy mr-1"></i> View Leaderboard';
                    }
                }
                
                async function loadLeaderboard() {
                    try {
                        const container = document.getElementById('leaderboard-content');
                        
                        // In production, fetch from Firestore
                        const leaderboard = [
                            { name: window.currentStudent?.name || 'You', score: 450, grade: `Grade ${window.currentStudent?.grade || 3}`, country: window.currentStudent?.country || 'NG' },
                            { name: 'Alex Johnson', score: 9850, grade: 'Grade 5', country: 'US' },
                            { name: 'Sophia Williams', score: 9420, grade: 'Grade 4', country: 'UK' },
                            { name: 'Mohammed Ali', score: 9150, grade: 'Grade 6', country: 'NG' },
                            { name: 'Emma Chen', score: 8920, grade: 'Grade 5', country: 'CA' }
                        ];
                        
                        let leaderboardHTML = `
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="text-left py-3 text-xs font-semibold text-gray-500">Rank</th>
                                            <th class="text-left py-3 text-xs font-semibold text-gray-500">Name</th>
                                            <th class="text-left py-3 text-xs font-semibold text-gray-500">Score</th>
                                            <th class="text-left py-3 text-xs font-semibold text-gray-500">Grade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        leaderboard.forEach((player, index) => {
                            const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                            const isCurrentStudent = player.name === window.currentStudent?.name;
                            leaderboardHTML += `
                                <tr class="border-b border-gray-100 last:border-0 ${isCurrentStudent ? 'bg-brand-light' : ''}">
                                    <td class="py-3 text-sm font-bold">${medal}</td>
                                    <td class="py-3">
                                        <div class="flex items-center gap-2">
                                            <div class="h-8 w-8 rounded-full ${isCurrentStudent ? 'bg-brand-primary' : 'bg-gray-200'} flex items-center justify-center">
                                                <i class="fas fa-user ${isCurrentStudent ? 'text-white' : 'text-gray-500'} text-xs"></i>
                                            </div>
                                            <span class="text-sm font-medium ${isCurrentStudent ? 'text-brand-primary font-bold' : ''}">${player.name}</span>
                                        </div>
                                    </td>
                                    <td class="py-3 text-sm font-bold text-brand-primary">${player.score.toLocaleString()}</td>
                                    <td class="py-3 text-sm text-gray-600">${player.grade}</td>
                                </tr>
                            `;
                        });
                        
                        leaderboardHTML += `
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="shareLeaderboard()" class="px-4 py-2 bg-gray-800 text-white text-sm font-medium rounded-lg hover:bg-gray-900 transition-colors">
                                    <i class="fas fa-share-alt mr-2"></i> Share Leaderboard
                                </button>
                            </div>
                        `;
                        
                        container.innerHTML = leaderboardHTML;
                        
                    } catch (error) {
                        console.error('Error loading leaderboard:', error);
                    }
                }
                
                window.shareLeaderboard = () => {
                    alert('Leaderboard shared! In production, this would generate a shareable image.');
                };
                
                // ========== MOCK DATA FALLBACK ==========
                function loadMockData() {
                    console.log('Loading mock data for demo...');
                    
                    document.getElementById('student-display-name').innerText = 'Demo Student';
                    document.getElementById('student-grade-country').innerText = 'Year 4 • UK';
                    
                    document.getElementById('attendance-percent').innerText = '94%';
                    document.getElementById('pending-tasks-count').innerText = '3';
                    document.getElementById('pending-count').innerText = '3';
                    document.getElementById('average-grade').innerText = 'B+';
                    document.getElementById('grade-ranking').innerText = 'Top 15% of class';
                    
                    document.getElementById('next-class-subject').innerText = 'Mathematics (Yr 4)';
                    document.getElementById('next-class-time').innerText = 'Mon, Feb 14 at 10:00 AM';
                    document.getElementById('next-class-tutor').innerText = 'Tutor: Mr. Johnson';
                    
                    const joinBtn = document.getElementById('join-room-btn');
                    joinBtn.innerHTML = '<i class="fas fa-video mr-1"></i> Join at 10:00 AM';
                    joinBtn.className = 'mt-auto bg-white text-brand-primary text-xs font-bold py-2 px-4 rounded-lg w-fit hover:bg-gray-50 transition-colors';
                    joinBtn.onclick = () => alert('Join class functionality would open Zoom link');
                    
                    const scheduleContainer = document.getElementById('upcoming-schedule-list');
                    scheduleContainer.innerHTML = `
                        <div class="flex items-start gap-4 pb-4 border-b border-gray-50">
                            <div class="flex flex-col items-center justify-center bg-gray-50 rounded-lg h-12 w-12 text-gray-500">
                                <span class="text-xs font-bold uppercase">Feb</span>
                                <span class="text-lg font-bold text-gray-800">14</span>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-gray-800">Math Mock Exam</h4>
                                <p class="text-xs text-gray-500 mt-1">09:00 AM - 11:00 AM</p>
                                <span class="inline-block mt-2 text-[10px] font-bold bg-red-100 text-red-600 px-2 py-0.5 rounded">CBT Platform</span>
                            </div>
                        </div>
                        <div class="flex items-start gap-4 pb-4 border-b border-gray-50">
                            <div class="flex flex-col items-center justify-center bg-gray-50 rounded-lg h-12 w-12 text-gray-500">
                                <span class="text-xs font-bold uppercase">Feb</span>
                                <span class="text-lg font-bold text-gray-800">16</span>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-gray-800">English Literature</h4>
                                <p class="text-xs text-gray-500 mt-1">Homework Submission</p>
                                <span class="inline-block mt-2 text-[10px] font-bold bg-blue-100 text-blue-600 px-2 py-0.5 rounded">Mr. Johnson</span>
                            </div>
                        </div>
                    `;
                    
                    loadGames();
                }
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                alert('Error connecting to database. Using demo mode.');
                loadMockData();
            }
            
            // ========== UTILITY FUNCTIONS ==========
            window.switchTab = switchTab;
            window.viewCourse = (link) => {
                if (link && link !== '#') {
                    window.open(link, '_blank');
                } else {
                    alert('Course materials not available yet.');
                }
            };
            
            window.continueCourse = (courseId) => {
                alert(`Continue course ${courseId} - This would open the next lesson`);
            };
            
        });
        
        // ========== PERFORMANCE CHART WITH REAL DATA ==========
        function initializeChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            // In production, this would fetch real data
            const subjects = ['Math', 'English', 'Science', 'History', 'Geography'];
            const scores = [85, 78, 92, 70, 88];
            
            const myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: subjects,
                    datasets: [{
                        label: 'Average Score (%)',
                        data: scores,
                        backgroundColor: [
                            'rgba(5, 150, 105, 0.7)',
                            'rgba(251, 191, 36, 0.7)',
                            'rgba(59, 130, 246, 0.7)',
                            'rgba(139, 92, 246, 0.7)',
                            'rgba(14, 165, 233, 0.7)'
                        ],
                        borderColor: [
                            '#059669',
                            '#fbbf24',
                            '#3b82f6',
                            '#8b5cf6',
                            '#0ea5e9'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                borderDash: [2, 4],
                                color: '#f3f4f6'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            document.getElementById('performance-period').addEventListener('change', function(e) {
                const period = e.target.value;
                // In production, fetch data for selected period
                alert(`Loading ${period} performance data...`);
            });
        }
        
        // ========== TAB SWITCHING ==========
        function switchTab(tabName) {
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.add('hidden');
            });
            
            const selectedView = document.getElementById('view-' + tabName);
            if (selectedView) {
                selectedView.classList.remove('hidden');
            }
            
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active', 'bg-gray-50', 'text-brand-primary', 'border-r-4', 'border-brand-primary');
                el.classList.add('text-gray-600');
            });
            
            const activeNav = document.getElementById('nav-' + tabName);
            if (activeNav) {
                activeNav.classList.add('active');
            }
            
            const titles = {
                'dashboard': 'Dashboard Overview',
                'courses': 'My Enrolled Courses',
                'assignments': 'Homework & Tasks',
                'results': 'Academic Performance',
                'calendar': 'Class Schedule',
                'games': 'Educational Games'
            };
            document.getElementById('page-title').innerText = titles[tabName] || 'Portal';
        }
        
        // ========== MOBILE MENU ========== -->
        function toggleMobileMenu() {
            const sidebar = document.querySelector('aside');
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('flex');
            sidebar.classList.toggle('fixed');
            sidebar.classList.toggle('inset-0');
            sidebar.classList.toggle('z-40');
        }
        
    </script>
    
</body>
</html>
