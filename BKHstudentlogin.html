<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Portal | BKH LMS</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase SDK ‚Äî fixed: was 12.0.0 (does not exist), now 10.12.2 -->
<script type="module">
      import { auth, db } from './firebaseConfig-studentsignupmodular.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { collection, query, where, getDocs, doc, getDoc, updateDoc, addDoc, setDoc, orderBy, onSnapshot, Timestamp, limit }
        from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL }
        from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";
    window.firebaseModules = {
        auth, db, onAuthStateChanged, signOut, collection, query, where, getDocs,
        doc, getDoc, updateDoc, addDoc, setDoc, orderBy, onSnapshot, Timestamp, limit,
        getStorage, ref, uploadBytes, getDownloadURL
    };
</script>

<script>
tailwind.config = {
    theme: { extend: { colors: {
        brand: { light:'#d1fae5', primary:'#059669', dark:'#064e3b', accent:'#fbbf24' }
    }}}
}
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
body { font-family: 'Inter', sans-serif; }
.nav-item.active { background:#ecfdf5; color:#059669; border-right:4px solid #059669; }
.fade-in { animation: fadeIn 0.3s ease-in-out; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
.view-section { display:none; }
.view-section.active { display:block; }
#notif-dropdown { max-height:460px; overflow-y:auto; }
.notif-item { border-bottom:1px solid #f3f4f6; padding:10px 14px; font-size:.83rem; cursor:pointer; transition:background .15s; }
.notif-item:hover { background:#f0fdf4; }
.notif-item.unread { background:#eff6ff; border-left:3px solid #3b82f6; }
.notif-item.clickable:hover { background:#ecfdf5; }
.notif-badge { position:absolute; top:2px; right:2px; background:#ef4444; color:#fff;
    border-radius:999px; min-width:16px; height:16px; font-size:.65rem; font-weight:700;
    display:flex; align-items:center; justify-content:center; padding:0 3px; }
.chat-me { background:#059669; color:#fff; border-radius:16px 16px 4px 16px; padding:8px 12px; max-width:72%; margin-left:auto; font-size:.875rem; }
.chat-them { background:#fff; color:#1f2937; border:1px solid #e5e7eb; border-radius:16px 16px 16px 4px; padding:8px 12px; max-width:72%; font-size:.875rem; }
details > summary { list-style:none; cursor:pointer; user-select:none; }
details > summary::-webkit-details-marker { display:none; }
details[open] > summary .chev { transform:rotate(90deg); }
.chev { display:inline-block; transition:transform .2s; }
@keyframes spin { to{transform:rotate(360deg)} }
/* Annotation canvas styles */
.annot-toolbar { display:flex; align-items:center; gap:6px; flex-wrap:wrap; padding:8px 10px; background:#f8fafc; border-radius:10px; border:1px solid #e5e7eb; margin-bottom:10px; }
.annot-tool-btn { width:32px; height:32px; border-radius:8px; border:2px solid transparent; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:.75rem; transition:all .15s; }
.annot-tool-btn.active { border-color:#059669; background:#ecfdf5; color:#059669; }
.annot-tool-btn:not(.active) { background:#e5e7eb; color:#4b5563; }
.annot-tool-btn:hover:not(.active) { background:#d1d5db; }
.color-dot { width:20px; height:20px; border-radius:50%; cursor:pointer; border:3px solid transparent; transition:border-color .15s; flex-shrink:0; }
.color-dot.active { border-color:#059669; }
/* Ws tab styles */
.ws-tab-btn { padding:10px 18px; font-size:.875rem; font-weight:600; border-bottom:2px solid transparent; transition:all .15s; cursor:pointer; background:none; border-left:none; border-right:none; border-top:none; }
.ws-tab-btn.active { color:#059669; border-bottom-color:#059669; }
.ws-tab-btn:not(.active) { color:#6b7280; }
.ws-tab-btn:not(.active):hover { color:#059669; }
/* Notif ring animation */
@keyframes bellRing { 0%,100%{transform:rotate(0)} 20%{transform:rotate(-15deg)} 40%{transform:rotate(15deg)} 60%{transform:rotate(-10deg)} 80%{transform:rotate(10deg)} }
.bell-ring { animation: bellRing 0.6s ease; }
</style>
</head>

<body class="bg-gray-50 text-gray-800 h-screen flex overflow-hidden">

<!-- SIDEBAR -->
<aside id="main-sidebar" class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col justify-between z-20 shadow-lg">
    <div>
        <div class="h-20 flex items-center px-8 border-b border-gray-100">
            <div class="h-10 w-10 bg-brand-primary rounded-lg flex items-center justify-center text-white font-bold text-xl mr-3">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <span class="text-xl font-bold text-gray-900">BKH Student Portal</span>
        </div>
        <nav class="mt-6 px-4 space-y-1">
            <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item active flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50">
                <i class="fas fa-th-large w-6"></i> Dashboard
            </a>
            <a href="#" onclick="switchTab('messages')" id="nav-messages" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50">
                <i class="fas fa-comments w-6"></i> Messages
                <span id="msg-badge" class="ml-auto hidden bg-brand-primary text-white text-xs rounded-full px-2 py-0.5">0</span>
            </a>
            <a href="#" onclick="switchTab('courses')" id="nav-courses" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50">
                <i class="fas fa-book w-6"></i> My Courses
            </a>
            <a href="#" onclick="switchTab('assignments')" id="nav-assignments" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50">
                <i class="fas fa-clipboard-list w-6"></i> Assignments
                <span id="pending-count" class="ml-auto bg-brand-accent text-white py-0.5 px-2 rounded-full text-xs font-bold">0</span>
            </a>
            <a href="#" onclick="switchTab('results')" id="nav-results" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50">
                <i class="fas fa-chart-line w-6"></i> Results
            </a>
            <a href="#" onclick="switchTab('calendar')" id="nav-calendar" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50">
                <i class="fas fa-calendar-alt w-6"></i> Schedule
            </a>
            <a href="#" onclick="switchTab('games')" id="nav-games" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50">
                <i class="fas fa-gamepad w-6"></i> Games
            </a>
        </nav>
    </div>
    <div class="p-4 border-t border-gray-100">
        <div id="profile-section" class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 border border-gray-200 cursor-pointer hover:bg-gray-100" onclick="toggleProfileMenu()">
            <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center">
                <i class="fas fa-user text-gray-500"></i>
            </div>
            <div class="flex-1">
                <p id="student-display-name" class="text-sm font-semibold text-gray-700">Loading...</p>
                <p id="student-grade-country" class="text-xs text-gray-500">--</p>
            </div>
            <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
        </div>
        <div id="profile-menu" class="hidden mt-2 bg-white border border-gray-200 rounded-lg shadow-lg">
            <button onclick="logout()" class="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 rounded-lg flex items-center">
                <i class="fas fa-sign-out-alt mr-2"></i> Logout
            </button>
        </div>
    </div>
</aside>

<!-- MOBILE HEADER -->
<div class="md:hidden fixed top-0 w-full bg-white z-30 border-b px-4 h-16 flex items-center justify-between shadow-sm">
    <div class="font-bold text-lg text-brand-primary">BKH Student Portal</div>
    <button class="text-gray-600" onclick="toggleMobileMenu()"><i class="fas fa-bars text-xl"></i></button>
</div>

<!-- MAIN -->
<main class="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-8 pt-20 md:pt-8 relative">

    <header class="flex justify-between items-start mb-8 gap-4 flex-wrap">
        <div>
            <h1 id="page-title" class="text-2xl font-bold text-gray-900">Dashboard Overview</h1>
            <p id="page-date" class="text-sm text-gray-500 mt-1">--</p>
        </div>
        <div class="flex items-center gap-3 flex-wrap justify-end">
            <div class="text-right hidden md:block">
                <div id="student-clock" class="text-sm font-semibold text-blue-700 bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-200 whitespace-nowrap">--</div>
                <div id="student-location" class="text-xs text-gray-400 mt-0.5">Detecting location...</div>
            </div>
            <div class="relative">
                <button id="bell-btn" onclick="toggleNotifications()" class="p-2 text-gray-400 hover:text-brand-primary relative">
                    <i class="fas fa-bell text-xl"></i>
                    <span id="notification-badge" class="notif-badge hidden">0</span>
                </button>
                <div id="notif-dropdown" class="hidden absolute right-0 top-10 w-80 bg-white border border-gray-200 rounded-xl shadow-xl z-50">
                    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
                        <span class="font-bold text-gray-800">Notifications</span>
                        <button onclick="markAllRead()" class="text-xs text-brand-primary hover:underline">Mark all read</button>
                    </div>
                    <div id="notif-list"><div class="text-center py-6 text-gray-400 text-sm"><i class="fas fa-spinner fa-spin mr-1"></i> Loading...</div></div>
                </div>
            </div>
        </div>
    </header>

    <!-- DASHBOARD -->
    <div id="view-dashboard" class="view-section active fade-in space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 relative overflow-hidden hover:shadow-md transition-all">
                <div class="absolute right-0 top-0 h-full w-1 bg-brand-primary"></div>
                <div class="flex justify-between items-start">
                    <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Attendance</p>
                    <h3 id="attendance-percent" class="text-2xl font-bold text-gray-800 mt-1">--</h3></div>
                    <div class="h-8 w-8 rounded-full bg-green-50 flex items-center justify-center text-green-600"><i class="fas fa-check"></i></div>
                </div>
                <p id="attendance-trend" class="text-xs text-green-600 mt-auto flex items-center"><i class="fas fa-arrow-up mr-1"></i> Calculating...</p>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 hover:shadow-md transition-all">
                <div class="flex justify-between items-start">
                    <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Pending Tasks</p>
                    <h3 id="pending-tasks-count" class="text-2xl font-bold text-gray-800 mt-1">0</h3></div>
                    <div class="h-8 w-8 rounded-full bg-yellow-50 flex items-center justify-center text-yellow-600"><i class="fas fa-clock"></i></div>
                </div>
                <p id="pending-due" class="text-xs text-gray-500 mt-auto">--</p>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 hover:shadow-md transition-all">
                <div class="flex justify-between items-start">
                    <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Avg Grade</p>
                    <h3 id="average-grade" class="text-2xl font-bold text-gray-800 mt-1">--</h3></div>
                    <div class="h-8 w-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-600"><i class="fas fa-star"></i></div>
                </div>
                <p id="grade-ranking" class="text-xs text-gray-500 mt-auto">Calculating rank...</p>
            </div>

            <div class="bg-brand-primary p-6 rounded-2xl shadow-lg shadow-emerald-200 text-white flex flex-col justify-between h-32 relative overflow-hidden">
                <div class="absolute -right-6 -bottom-6 text-white opacity-10 text-9xl"><i class="fas fa-graduation-cap"></i></div>
                <div>
                    <p class="text-xs font-bold text-emerald-100 uppercase tracking-wider">Next Live Class</p>
                    <h3 id="next-class-subject" class="text-base font-bold mt-1">Loading...</h3>
                    <p id="next-class-time" class="text-xs text-emerald-100 mt-0.5">--</p>
                </div>
                <p id="next-class-local" class="text-xs text-emerald-100 mt-1">Your local time: --</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800">Performance Overview</h3>
                    <select id="performance-period" class="text-xs bg-gray-50 border border-gray-200 rounded-lg text-gray-500 p-2">
                        <option value="month">This Month</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="h-64"><canvas id="performanceChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-4">Upcoming Schedule</h3>
                <div id="upcoming-schedule-list" class="space-y-3">
                    <div class="text-center py-8 text-gray-400"><i class="fas fa-calendar-alt text-3xl mb-2"></i><p>Loading...</p></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MESSAGES -->
    <div id="view-messages" class="view-section fade-in">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden" style="height:72vh;display:flex;">
            <div style="width:260px;min-width:220px;border-right:1px solid #e5e7eb;display:flex;flex-direction:column;background:#fafafa;flex-shrink:0;">
                <div style="padding:14px 16px;border-bottom:1px solid #e5e7eb;font-weight:700;font-size:1rem;color:#1f2937;">Messages</div>
                <div id="student-conv-list" style="flex:1;overflow-y:auto;"></div>
            </div>
            <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
                <div id="student-chat-header" style="padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#fff;font-weight:700;color:#1f2937;">Select a conversation</div>
                <div id="student-chat-messages" style="flex:1;overflow-y:auto;padding:14px 16px;background:#f9fafb;display:flex;flex-direction:column;gap:8px;">
                    <div style="text-align:center;color:#9ca3af;margin-top:40px;">Select a conversation to read messages</div>
                </div>
                <div id="student-chat-inputs" style="border-top:1px solid #e5e7eb;padding:10px 14px;background:#fff;display:none;gap:8px;align-items:flex-end;">
                    <textarea id="student-msg-input" rows="2" placeholder="Type a message..." style="flex:1;border:1px solid #d1d5db;border-radius:8px;padding:8px;resize:none;font-size:.875rem;"></textarea>
                    <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;">
                        <label style="cursor:pointer;font-size:1.2rem;text-align:center;" title="Attach image">
                            <input type="file" id="student-img-file" accept="image/*" style="display:none;">
                            üìé
                        </label>
                        <button id="student-send-btn" style="background:#059669;color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font-weight:700;">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- COURSES -->
    <div id="view-courses" class="view-section fade-in">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="courses-container">
            <div class="text-center col-span-3 py-12 text-gray-400">
                <i class="fas fa-book-open text-4xl mb-4"></i><h3 class="text-lg font-semibold mb-2">Loading Courses</h3><p>Fetching materials...</p>
            </div>
        </div>
    </div>

    <!-- ASSIGNMENTS -->
    <div id="view-assignments" class="view-section fade-in">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-gray-800">Assignments</h3>
                <div class="flex gap-3">
                    <button id="filter-all"       onclick="filterAssignments('all')"       class="text-xs font-medium text-brand-primary border-b-2 border-brand-primary pb-0.5">All</button>
                    <button id="filter-pending"   onclick="filterAssignments('pending')"   class="text-xs font-medium text-gray-500 hover:text-brand-primary">Pending</button>
                    <button id="filter-submitted" onclick="filterAssignments('submitted')" class="text-xs font-medium text-gray-500 hover:text-brand-primary">Submitted</button>
                    <button id="filter-graded"    onclick="filterAssignments('graded')"    class="text-xs font-medium text-gray-500 hover:text-brand-primary">Graded</button>
                </div>
            </div>
            <div id="assignments-list" class="p-4 space-y-3">
                <div class="p-8 text-center text-gray-400"><i class="fas fa-clipboard-list text-3xl mb-3"></i><p>Loading assignments...</p></div>
            </div>
        </div>
    </div>

    <!-- RESULTS -->
    <div id="view-results" class="view-section fade-in">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <h3 class="font-bold text-gray-800 mb-6">Academic Results</h3>
            <div id="results-container">
                <div class="text-center py-8 text-gray-400"><i class="fas fa-chart-line text-3xl mb-3"></i><p>Loading results...</p></div>
            </div>
        </div>
    </div>

    <!-- SCHEDULE -->
    <div id="view-calendar" class="view-section fade-in">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <h3 class="font-bold text-gray-800 mb-6">Class Schedule</h3>
            <div id="full-schedule-container">
                <div class="text-center py-8 text-gray-400"><i class="fas fa-calendar text-3xl mb-3"></i><p>Loading schedule...</p></div>
            </div>
        </div>
    </div>

    <!-- GAMES -->
    <div id="view-games" class="view-section fade-in">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-800">Educational Games</h3>
                <button id="show-leaderboard" onclick="toggleLeaderboard()" class="text-sm text-brand-primary font-semibold hover:text-brand-dark">
                    <i class="fas fa-trophy mr-1"></i> Leaderboard
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="games-container">
                <div class="text-center py-8 text-gray-400 col-span-3"><i class="fas fa-gamepad text-3xl mb-3"></i><p>Loading games...</p></div>
            </div>
            <div id="leaderboard-container" class="hidden">
                <h4 class="font-bold text-gray-700 mb-4">Top Performers</h4>
                <div id="leaderboard-content" class="bg-gray-50 rounded-xl p-4"></div>
            </div>
        </div>
    </div>

</main>

<script type="module">
document.addEventListener('DOMContentLoaded', async () => {

// ‚îÄ‚îÄ Wait for Firebase modules (max 5s) ‚îÄ‚îÄ
await new Promise(r => { const t=setInterval(()=>{if(window.firebaseModules){clearInterval(t);r();}},50); setTimeout(()=>{clearInterval(t);r();},5000); });

const { auth,db,onAuthStateChanged,signOut,collection,query,where,getDocs,doc,getDoc,
        updateDoc,addDoc,setDoc,orderBy,onSnapshot,Timestamp,limit,getStorage,ref,uploadBytes,getDownloadURL }
    = window.firebaseModules || {};

if (!auth) { document.body.innerHTML = '<div style="padding:40px;text-align:center;color:red;font-size:1.2rem;">‚ö†Ô∏è Firebase failed to load. Check firebaseConfig file and internet connection.</div>'; return; }

const CLOUDINARY = { cloudName:'dwjq7j5zp', preset:'tutor_homework' };
let performanceChart       = null;
let _perfListenerAttached  = false;
let allAssignments         = [];
let studentUnsubChat       = null;
let studentUnsubInbox      = null;
let _notifUnsubscribers    = [];
let _notifData             = { pending: 0, pendingDocs: [], messages: 0, materials: [], convs: [] };
let _notifLoaded           = false;
let _prevNotifTotal        = 0;
const _annotState          = {};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ NOTIFICATION SOUNDS (Web Audio API) ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function playNotifSound(type) {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const master = ctx.createGain();
        master.gain.value = 0.35;
        master.connect(ctx.destination);

        if (type === 'message') {
            // Friendly two-tone ascending ping
            [[660, 0], [880, 0.18]].forEach(([freq, delay]) => {
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.connect(g); g.connect(master);
                osc.type = 'sine'; osc.frequency.value = freq;
                g.gain.setValueAtTime(0, ctx.currentTime + delay);
                g.gain.linearRampToValueAtTime(0.8, ctx.currentTime + delay + 0.02);
                g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + 0.35);
                osc.start(ctx.currentTime + delay);
                osc.stop(ctx.currentTime + delay + 0.35);
            });
        } else if (type === 'assignment') {
            // Three-note alert: C5, E5, G5
            [[523, 0], [659, 0.2], [784, 0.4]].forEach(([freq, delay]) => {
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.connect(g); g.connect(master);
                osc.type = 'triangle'; osc.frequency.value = freq;
                g.gain.setValueAtTime(0, ctx.currentTime + delay);
                g.gain.linearRampToValueAtTime(0.9, ctx.currentTime + delay + 0.02);
                g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + 0.28);
                osc.start(ctx.currentTime + delay);
                osc.stop(ctx.currentTime + delay + 0.28);
            });
        } else {
            // Single soft chime for general/material
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.connect(g); g.connect(master);
            osc.type = 'sine'; osc.frequency.value = 528;
            g.gain.setValueAtTime(0, ctx.currentTime);
            g.gain.linearRampToValueAtTime(0.7, ctx.currentTime + 0.03);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.6);
            osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.6);
        }
    } catch(e) { /* AudioContext blocked ‚Äî silent */ }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function escH(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a; }

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
function startClock(){
    const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
    const el=document.getElementById('student-clock');
    const loc=document.getElementById('student-location');
    if(loc) loc.textContent='üìç '+tz.replace(/_/g,' ');
    function tick(){
        if(el) el.textContent=new Intl.DateTimeFormat('en-US',{weekday:'short',day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true,timeZone:tz}).format(new Date());
    }
    tick(); setInterval(tick,1000);
}
startClock();
document.getElementById('page-date').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

// ‚îÄ‚îÄ TAB SWITCH (fixed: auto-close mobile menu) ‚îÄ‚îÄ
window.switchTab = (tab) => {
    document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active'));
    const v=document.getElementById('view-'+tab);
    if(v) v.classList.add('active');
    document.querySelectorAll('.nav-item').forEach(el=>{el.classList.remove('active','text-brand-primary');el.classList.add('text-gray-600');});
    const nav=document.getElementById('nav-'+tab);
    if(nav) nav.classList.add('active');
    const titles={dashboard:'Dashboard Overview',messages:'Messages',courses:'My Courses',assignments:'Assignments',results:'Academic Results',calendar:'Class Schedule',games:'Educational Games'};
    document.getElementById('page-title').textContent=titles[tab]||'Portal';
    // Auto-close mobile sidebar on nav
    if(window.innerWidth < 768) closeMobileMenu();
};

function closeMobileMenu(){
    const s=document.getElementById('main-sidebar');
    if(!s) return;
    s.classList.add('hidden');
    s.classList.remove('flex','fixed','inset-0','z-40');
}
window.toggleMobileMenu=()=>{
    const s=document.getElementById('main-sidebar');
    s.classList.toggle('hidden');
    s.classList.toggle('flex');
    s.classList.toggle('fixed');
    s.classList.toggle('inset-0');
    s.classList.toggle('z-40');
};
window.toggleProfileMenu=()=>document.getElementById('profile-menu').classList.toggle('hidden');
// Fixed: redirect to login page (update path if your login page differs)
window.logout=async()=>{
    try{await signOut(auth); window.location.href='studentsignup.html';}
    catch(e){alert('Logout error: '+e.message);}
};

document.addEventListener('click',e=>{
    const pm=document.getElementById('profile-menu');const ps=document.getElementById('profile-section');
    if(pm&&ps&&!ps.contains(e.target)&&!pm.contains(e.target)) pm.classList.add('hidden');
    const nd=document.getElementById('notif-dropdown');const bb=document.getElementById('bell-btn');
    if(nd&&bb&&!nd.contains(e.target)&&!bb.contains(e.target)) nd.classList.add('hidden');
});

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
onAuthStateChanged(auth, async user => {
    if(!user){window.location.href='studentsignup.html';return;}
    await initStudent(user);
});

async function initStudent(user){
    try{
        let snap=await getDocs(query(collection(db,'students'),where('studentUid','==',user.uid)));
        if(snap.empty) snap=await getDocs(query(collection(db,'students'),where('email','==',user.email)));
        if(snap.empty){document.getElementById('student-grade-country').textContent='Profile not found';return;}
        buildStudentGlobal(snap.docs[0],user);
        await loadAll();
    }catch(e){console.error('initStudent',e);}
}

function buildStudentGlobal(studentDoc, user){
    const d=studentDoc.data();
    document.getElementById('student-display-name').textContent=d.studentName||user.displayName||'Student';
    document.getElementById('student-grade-country').textContent=`${d.grade||'--'} ¬∑ ${d.country||'--'}`;
    window.currentStudent={
        uid:user.uid, id:studentDoc.id,
        name:d.studentName||user.displayName||'Student',
        email:d.email||user.email,
        grade:d.grade||'',
        country:d.country||'',
        subjects:d.subjects||[],
        tutorEmail:d.assignedTutor||d.tutorEmail||'',
        tutorId:d.tutorId||'',
        tutorName:d.tutorName||'',
        schedule:d.schedule||[]
    };
}

async function loadAll(){
    await Promise.allSettled([
        loadAttendance(),
        loadPendingTasks(),
        loadAverageGrade(),
        loadNextClass(),
        loadUpcomingSchedule(),
        loadPerformanceChart(),
        loadCourses(),
        loadAssignments(),
        loadResults(),
        loadSchedule(),
        loadGames(),
        initMessaging()
    ]);
    // Start real-time notifications AFTER other data is loaded
    initRealtimeNotifications();
}

// ‚îÄ‚îÄ ATTENDANCE ‚îÄ‚îÄ
async function loadAttendance(){
    try{
        const snap=await getDocs(query(collection(db,'homework_assignments'),where('studentId','==',window.currentStudent.id)));
        const total=snap.size;
        const done=snap.docs.filter(d=>['graded','submitted'].includes(d.data().status)).length;
        const pct=total>0?Math.round((done/total)*100):100;
        document.getElementById('attendance-percent').textContent=pct+'%';
        const trendEl=document.getElementById('attendance-trend');
        trendEl.innerHTML=`<i class="fas fa-arrow-${pct>=80?'up':'down'} mr-1"></i>${pct>=90?'Excellent attendance':pct>=75?'Good attendance':'Needs improvement'}`;
        trendEl.className=`text-xs ${pct>=80?'text-green-600':pct>=60?'text-yellow-600':'text-red-600'} mt-auto flex items-center`;
    }catch(e){console.error(e);}
}

// ‚îÄ‚îÄ PENDING TASKS ‚îÄ‚îÄ
async function loadPendingTasks(){
    try{
        const snap=await getDocs(query(collection(db,'homework_assignments'),where('studentId','==',window.currentStudent.id),where('status','in',['assigned','pending'])));
        document.getElementById('pending-tasks-count').textContent=snap.size;
        document.getElementById('pending-count').textContent=snap.size;
        const now=new Date();let due48=0;
        snap.forEach(d=>{const dd=new Date(d.data().dueDate||'');if(!isNaN(dd)&&(dd-now)/3600000<=48)due48++;});
        const el=document.getElementById('pending-due');
        el.textContent=due48>0?`${due48} due within 48 hrs`:'No immediate deadlines';
        el.className=`text-xs ${due48>0?'text-red-500':'text-gray-500'} mt-auto`;
    }catch(e){console.error(e);}
}

// ‚îÄ‚îÄ AVERAGE GRADE ‚îÄ‚îÄ
async function loadAverageGrade(){
    try{
        const mySnap=await getDocs(query(collection(db,'homework_assignments'),where('studentId','==',window.currentStudent.id),where('status','==','graded')));
        if(mySnap.empty){document.getElementById('average-grade').textContent='--';document.getElementById('grade-ranking').textContent='No grades yet';return;}
        let myTotal=0,myCount=0;
        mySnap.forEach(d=>{const s=parseFloat(d.data().score);if(!isNaN(s)){myTotal+=s;myCount++;}});
        const myAvg=myCount>0?Math.round(myTotal/myCount):0;
        const letter=myAvg>=90?'A':myAvg>=80?'B+':myAvg>=70?'B':myAvg>=60?'C+':myAvg>=50?'C':'F';
        document.getElementById('average-grade').textContent=`${myAvg}% (${letter})`;
        // Peer comparison ‚Äî batch-limited to avoid N+1 overload
        const grade=window.currentStudent.grade;
        if(grade){
            const peerStudents=await getDocs(query(collection(db,'students'),where('grade','==',grade)));
            // Limit to 8 peers to reduce reads
            const peerIds=peerStudents.docs.map(d=>d.id).filter(id=>id!==window.currentStudent.id).slice(0,8);
            let peerTotal=0,peerCount=0;
            for(const pid of peerIds){
                const ps=await getDocs(query(collection(db,'homework_assignments'),where('studentId','==',pid),where('status','==','graded')));
                ps.forEach(d=>{const s=parseFloat(d.data().score);if(!isNaN(s)){peerTotal+=s;peerCount++;}});
            }
            const rankEl=document.getElementById('grade-ranking');
            if(peerCount>0){
                const pAvg=Math.round(peerTotal/peerCount);
                const diff=myAvg-pAvg;
                rankEl.textContent=(diff>=0?'+':'')+diff+'% vs grade average ('+pAvg+'%)';
                rankEl.className=`text-xs ${diff>=0?'text-green-600':'text-red-500'} mt-auto`;
            } else {
                rankEl.textContent='Only student in this grade';
            }
        }
    }catch(e){console.error(e);}
}

// ‚îÄ‚îÄ TIME HELPERS ‚îÄ‚îÄ
function formatSlotTime(t){
    if(!t)return'';
    const[h,m]=t.split(':').map(Number);
    return (h%12||12)+':'+(m<10?'0':'')+m+' '+(h>=12?'PM':'AM');
}
function watSlotToLocal(day,startStr){
    const DAYS=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const watNow=new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Lagos'}));
    const todayIdx=watNow.getDay();const targetIdx=DAYS.indexOf(day);
    if(targetIdx===-1)return null;
    let ahead=targetIdx-todayIdx;
    if(ahead<0)ahead+=7;
    if(ahead===0){
        const[h,m]=startStr.split(':').map(Number);
        if(watNow.getHours()>h||(watNow.getHours()===h&&watNow.getMinutes()>=m))ahead=7;
    }
    const[h,m]=startStr.split(':').map(Number);
    const watDate=new Date(watNow);watDate.setDate(watNow.getDate()+ahead);watDate.setHours(h,m,0,0);
    return new Date(watDate.getTime()-3600000); // WAT=UTC+1
}

// ‚îÄ‚îÄ NEXT CLASS (fixed: shows day + time, not just day name) ‚îÄ‚îÄ
async function loadNextClass(){
    try{
        const schedule=window.currentStudent.schedule||[];
        if(!schedule.length){
            document.getElementById('next-class-subject').textContent='No schedule set';
            document.getElementById('next-class-time').textContent='Contact your tutor';
            return;
        }
        let soonest=null,soonestMs=Infinity;
        schedule.forEach(slot=>{
            const u=watSlotToLocal(slot.day,slot.start);
            if(u&&u.getTime()<soonestMs){soonestMs=u.getTime();soonest={slot,utc:u};}
        });
        if(!soonest)return;
        // Show subject if available, otherwise show day + "Live Class"
        const subjectLabel = soonest.slot.subject || ('Live Class ¬∑ ' + soonest.slot.day);
        document.getElementById('next-class-subject').textContent = subjectLabel;
        document.getElementById('next-class-time').textContent=`${formatSlotTime(soonest.slot.start)} ‚Äì ${formatSlotTime(soonest.slot.end)} (WAT)`;
        document.getElementById('next-class-local').textContent=
            'Your time: '+soonest.utc.toLocaleString([],{weekday:'short',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:true});
    }catch(e){console.error(e);}
}

// ‚îÄ‚îÄ UPCOMING SCHEDULE ‚îÄ‚îÄ
async function loadUpcomingSchedule(){
    const c=document.getElementById('upcoming-schedule-list');
    try{
        const schedule=window.currentStudent.schedule||[];
        if(!schedule.length){c.innerHTML='<p class="text-gray-500 text-sm">No schedule set.</p>';return;}
        const items=schedule.map(slot=>{const u=watSlotToLocal(slot.day,slot.start);return{...slot,utc:u};})
            .filter(s=>s.utc).sort((a,b)=>a.utc-b.utc).slice(0,4);
        c.innerHTML=items.map(s=>`
        <div class="flex items-start gap-4 pb-4 border-b border-gray-50 last:border-0 last:pb-0">
            <div class="flex flex-col items-center justify-center bg-gray-50 rounded-lg h-12 w-12 text-gray-500 flex-shrink-0">
                <span class="text-xs font-bold uppercase">${s.utc.toLocaleString('en-US',{month:'short'})}</span>
                <span class="text-lg font-bold text-gray-800">${s.utc.getDate()}</span>
            </div>
            <div>
                <h4 class="text-sm font-bold text-gray-800">${escH(s.subject||s.day)}</h4>
                <p class="text-xs text-gray-500 mt-0.5">${formatSlotTime(s.start)} ‚Äì ${formatSlotTime(s.end)} WAT</p>
                <p class="text-xs text-blue-500 mt-0.5">Local: ${s.utc.toLocaleString([],{hour:'2-digit',minute:'2-digit',hour12:true})}</p>
            </div>
        </div>`).join('')||'<p class="text-gray-500 text-sm">No upcoming classes.</p>';
    }catch(e){console.error(e);}
}

// ‚îÄ‚îÄ PERFORMANCE CHART (fixed: no duplicate listeners) ‚îÄ‚îÄ
async function loadPerformanceChart(){
    try{
        const snap=await getDocs(query(collection(db,'homework_assignments'),where('studentId','==',window.currentStudent.id),where('status','==','graded'),orderBy('gradedAt','asc')));
        window._allGradedSnap=snap.docs;
        renderChart(snap.docs);
        if(!_perfListenerAttached){
            _perfListenerAttached=true;
            document.getElementById('performance-period').addEventListener('change',e=>{
                const period=e.target.value,now=new Date();
                const filtered=(window._allGradedSnap||[]).filter(d=>{
                    const a=d.data();const date=a.gradedAt?.toDate?a.gradedAt.toDate():new Date(a.gradedAt||0);
                    return period==='month'?(date.getMonth()===now.getMonth()&&date.getFullYear()===now.getFullYear()):true;
                });
                renderChart(filtered);
            });
        }
    }catch(e){console.error(e);}
}

function renderChart(docs){
    const labels=[],scores=[],bySubject={};
    docs.forEach(d=>{
        const a=d.data();const s=parseFloat(a.score);if(isNaN(s))return;
        const date=a.gradedAt?.toDate?a.gradedAt.toDate():new Date(a.gradedAt||0);
        labels.push(date.toLocaleDateString('en-US',{month:'short',day:'numeric'}));
        scores.push(s);
        const sub=a.subject||'General';
        if(!bySubject[sub])bySubject[sub]=[];
        bySubject[sub].push(s);
    });
    const ctx=document.getElementById('performanceChart').getContext('2d');
    if(performanceChart)performanceChart.destroy();
    if(!scores.length){
        ctx.clearRect(0,0,400,200);ctx.fillStyle='#9ca3af';ctx.font='14px Inter';
        ctx.textAlign='center';ctx.fillText('No graded results yet',200,100);return;
    }
    const colours=['#059669','#3b82f6','#f59e0b','#ef4444','#8b5cf6'];
    const subjectEntries=Object.entries(bySubject);let datasets;
    if(subjectEntries.length>1){
        datasets=subjectEntries.map(([sub,vals],i)=>{
            let vi=0;
            const data=labels.map((_,li)=>{
                const d=docs[li]?.data();if(!d)return null;
                return(d.subject||'General')===sub?vals[vi++]||null:null;
            });
            return{label:sub,data,borderColor:colours[i%colours.length],backgroundColor:'transparent',tension:0.4,spanGaps:true,pointRadius:3};
        });
    } else {
        datasets=[{label:'Score (%)',data:scores,borderColor:'#059669',backgroundColor:'rgba(5,150,105,0.1)',tension:0.4,fill:true,pointRadius:4,pointBackgroundColor:'#059669'}];
    }
    performanceChart=new Chart(ctx,{
        type:'line',data:{labels,datasets},
        options:{responsive:true,maintainAspectRatio:false,
            plugins:{legend:{position:'bottom'}},
            scales:{y:{beginAtZero:false,min:0,max:100,grid:{color:'#f3f4f6'}},x:{grid:{display:false}}}}
    });
}

// ‚îÄ‚îÄ COURSES ‚îÄ‚îÄ
async function loadCourses(){
    const c=document.getElementById('courses-container');
    try{
        const snap=await getDocs(query(collection(db,'course_materials'),where('studentId','==',window.currentStudent.id),orderBy('uploadedAt','desc')));
        if(snap.empty){c.innerHTML='<div class="col-span-3 text-center py-12 text-gray-400"><i class="fas fa-book-open text-4xl mb-4"></i><p>No course materials yet.</p></div>';return;}
        const ICONS={'pdf':'üìÑ','jpg':'üñºÔ∏è','jpeg':'üñºÔ∏è','png':'üñºÔ∏è','gif':'üñºÔ∏è','ppt':'üìä','pptx':'üìä','doc':'üìù','docx':'üìù','xls':'üìä','xlsx':'üìä'};
        const COLORS=['from-emerald-500 to-teal-400','from-blue-500 to-cyan-400','from-purple-500 to-pink-400','from-orange-500 to-amber-400','from-red-500 to-rose-400'];
        c.innerHTML=snap.docs.map((d,i)=>{
            const m=d.data();
            const date=m.uploadedAt?.toDate?m.uploadedAt.toDate().toLocaleDateString():'';
            const ext=(m.fileName||'').split('.').pop().toLowerCase();
            const icon=ICONS[ext]||'üìÅ';
            return `
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-all">
                <div class="h-36 bg-gradient-to-br ${COLORS[i%COLORS.length]} flex items-center justify-center text-5xl">${icon}</div>
                <div class="p-4">
                    <h3 class="font-bold text-gray-800 mb-1 truncate">${escH(m.title)}</h3>
                    ${m.description?`<p class="text-xs text-gray-500 mb-3 line-clamp-2">${escH(m.description)}</p>`:''}
                    <div class="flex items-center justify-between mt-2">
                        <span class="text-xs text-gray-400">${escH(date)}</span>
                        <a href="${escH(m.fileUrl||'#')}" target="_blank" rel="noopener noreferrer"
                           class="px-3 py-1.5 bg-brand-primary text-white text-xs font-bold rounded-lg hover:bg-brand-dark">
                            Open <i class="fas fa-external-link-alt ml-1"></i>
                        </a>
                    </div>
                </div>
            </div>`;
        }).join('');
    }catch(e){console.error(e);c.innerHTML='<div class="col-span-3 text-center py-12 text-red-400">Error loading courses.</div>';}
}

// ‚îÄ‚îÄ ASSIGNMENTS ‚îÄ‚îÄ
async function loadAssignments(){
    const c=document.getElementById('assignments-list');
    try{
        const snap=await getDocs(query(collection(db,'homework_assignments'),where('studentId','==',window.currentStudent.id),orderBy('assignedDate','desc')));
        if(snap.empty){c.innerHTML='<div class="text-center py-8 text-gray-400">No assignments yet.</div>';return;}
        allAssignments=snap.docs.map(d=>({id:d.id,...d.data()}));
        renderAssignments(allAssignments);
    }catch(e){console.error(e);}
}

// Fixed: added 'submitted' filter
window.filterAssignments=(f)=>{
    ['all','pending','submitted','graded'].forEach(x=>{
        const btn=document.getElementById('filter-'+x);
        if(btn) btn.className=x===f
            ?'text-xs font-medium text-brand-primary border-b-2 border-brand-primary pb-0.5'
            :'text-xs font-medium text-gray-500 hover:text-brand-primary';
    });
    const filtered=f==='all'?allAssignments:allAssignments.filter(a=>{
        if(f==='pending') return a.status==='assigned'||a.status==='pending';
        return a.status===f;
    });
    renderAssignments(filtered);
};

function getWeekStart(date){
    const d=new Date(date);const day=d.getDay();
    const diff=d.getDate()-day+(day===0?-6:1);
    const ws=new Date(d);ws.setDate(diff);ws.setHours(0,0,0,0);return ws;
}

function renderAssignments(assignments){
    const c=document.getElementById('assignments-list');
    if(!assignments.length){c.innerHTML='<div class="text-center py-8 text-gray-400">No assignments in this category.</div>';return;}
    const weeks={};
    assignments.forEach(a=>{
        const raw=a.assignedDate||a.createdAt;
        const d=raw?.toDate?raw.toDate():new Date(raw||0);
        if(isNaN(d.getTime()))return;
        const ws=getWeekStart(d).toISOString();
        if(!weeks[ws])weeks[ws]=[];
        weeks[ws].push(a);
    });
    const sorted=Object.keys(weeks).sort((a,b)=>b.localeCompare(a));
    c.innerHTML=sorted.map(wk=>{
        const ws=new Date(wk);const we=new Date(wk);we.setDate(we.getDate()+6);
        const label=`Week of ${ws.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ‚Äì ${we.toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;
        const items=weeks[wk];
        return `
        <details class="bg-white border border-gray-200 rounded-xl overflow-hidden mb-3">
            <summary class="flex items-center gap-3 px-5 py-4 hover:bg-gray-50">
                <span class="font-bold text-gray-700 text-sm">${escH(label)}</span>
                <span class="ml-auto text-xs text-gray-400">${items.length} item${items.length!==1?'s':''}</span>
                <i class="fas fa-chevron-right text-gray-300 text-xs chev ml-1"></i>
            </summary>
            <div class="px-5 pb-5 space-y-3 bg-gray-50">
                ${items.map(a=>{
                    const sc=a.status==='graded'?'text-green-700 bg-green-100':a.status==='submitted'?'text-blue-700 bg-blue-100':'text-amber-700 bg-amber-100';
                    const sl=a.status==='graded'?'Graded':a.status==='submitted'?'Submitted':'Pending';
                    const fileUrl=a.fileUrl||a.attachmentUrl||(a.attachments&&a.attachments[0]?.url)||'';
                    return `
                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-gray-800">${escH(a.title||'Untitled')}</div>
                                ${a.description?`<div class="text-xs text-gray-500 mt-1 line-clamp-2">${escH(a.description)}</div>`:''}
                                <div class="text-xs text-gray-400 mt-1.5">Due: ${escH(a.dueDate||'‚Äî')}${a.score!=null?' ‚Ä¢ Score: '+a.score+'/100':''}</div>
                                ${a.feedback?`<div class="text-xs italic text-gray-500 mt-1 bg-gray-50 p-1.5 rounded">"${escH(a.feedback)}"</div>`:''}
                            </div>
                            <div class="flex flex-col items-end gap-2 flex-shrink-0">
                                <span class="text-xs font-bold px-2.5 py-1 rounded-full ${sc}">${sl}</span>
                                <div class="flex gap-1.5">
                                    ${fileUrl?`<a href="${escH(fileUrl)}" target="_blank" class="text-xs text-brand-primary hover:underline">View</a>`:''}
                                    ${a.status!=='graded'?`<button data-id="${escH(a.id)}" onclick="openWorkspace(this.dataset.id)" class="text-xs bg-brand-primary text-white px-3 py-1 rounded-lg hover:bg-brand-dark">${a.status==='submitted'?'View / Edit':'Submit'}</button>`:''}
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </details>`;
    }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ OPEN WORKSPACE ‚Äî with annotation tab ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openWorkspace = async (assignmentId) => {
    // Remove any existing workspace modal
    const existingModal = document.getElementById('ws-modal-' + assignmentId);
    if (existingModal) existingModal.remove();

    const snap = await getDoc(doc(db, 'homework_assignments', assignmentId));
    if (!snap.exists()) return alert('Assignment not found');
    const a = snap.data();

    const fileUrl = a.fileUrl || a.attachmentUrl || (a.attachments && a.attachments[0]?.url) || '';
    const ext = (a.fileName || fileUrl || '').split('.').pop().toLowerCase();
    const isImage = ['jpg','jpeg','png','gif','webp'].includes(ext);

    const modal = document.createElement('div');
    modal.id = 'ws-modal-' + assignmentId;
    modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-3';

    const colorDots = ['#1f2937','#ef4444','#3b82f6','#f59e0b','#059669','#8b5cf6']
        .map(c => `<span class="color-dot active" data-color="${c}" onclick="setAnnotColor('${assignmentId}','${c}')" style="background:${c};"></span>`).join('');

    modal.innerHTML = `
    <div class="bg-white rounded-2xl w-full max-w-3xl flex flex-col" style="max-height:92vh;">
        <!-- Header -->
        <div class="flex justify-between items-center px-5 py-4 border-b flex-shrink-0">
            <div>
                <h3 class="font-bold text-gray-800 text-base">${escH(a.title||'Assignment')}</h3>
                ${a.subject ? `<p class="text-xs text-gray-400">${escH(a.subject)}</p>` : ''}
            </div>
            <button onclick="document.getElementById('ws-modal-${assignmentId}').remove()" class="text-gray-400 hover:text-gray-600 text-xl leading-none">&times;</button>
        </div>
        <!-- Tabs -->
        <div class="flex border-b flex-shrink-0 bg-gray-50 px-2">
            <button class="ws-tab-btn active" id="wstab-view-${assignmentId}" onclick="wsTab('${assignmentId}','view')">
                <i class="fas fa-eye mr-1"></i>View
            </button>
            <button class="ws-tab-btn" id="wstab-annotate-${assignmentId}" onclick="wsTab('${assignmentId}','annotate')">
                <i class="fas fa-pen-nib mr-1"></i>Annotate
            </button>
            <button class="ws-tab-btn" id="wstab-submit-${assignmentId}" onclick="wsTab('${assignmentId}','submit')">
                <i class="fas fa-paper-plane mr-1"></i>Submit
            </button>
        </div>
        <!-- Tab bodies -->
        <div style="overflow-y:auto;flex:1;">

            <!-- VIEW TAB -->
            <div id="wscontent-view-${assignmentId}" class="p-5 space-y-4">
                <div class="bg-gray-50 rounded-xl p-4">
                    <h5 class="font-semibold text-gray-700 mb-2 text-sm">üìã Instructions</h5>
                    <p class="text-sm text-gray-600 leading-relaxed">${escH(a.description||a.instructions||'No specific instructions provided.')}</p>
                </div>
                ${a.dueDate?`<div class="flex items-center gap-2 text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2"><i class="fas fa-clock"></i><span>Due: <strong>${escH(a.dueDate)}</strong></span></div>`:''}
                ${a.score!=null?`<div class="flex items-center gap-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded-lg px-3 py-2"><i class="fas fa-star"></i><span>Score: <strong>${a.score}/100</strong></span></div>`:''}
                ${fileUrl?`
                <div class="border border-gray-200 rounded-xl overflow-hidden">
                    ${isImage
                        ? `<img src="${escH(fileUrl)}" class="w-full object-contain" style="max-height:380px;">`
                        : `<iframe src="${escH(fileUrl)}" class="w-full" style="height:380px;border:none;" allowfullscreen></iframe>`
                    }
                </div>
                <a href="${escH(fileUrl)}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-brand-primary text-xs font-medium hover:underline">
                    <i class="fas fa-external-link-alt"></i>Open file in new tab
                </a>` : `<p class="text-sm text-gray-400 italic text-center py-4">No file attached to this assignment.</p>`}
                ${a.feedback?`<div class="bg-blue-50 border border-blue-200 rounded-xl p-4"><p class="text-xs font-bold text-blue-700 mb-1">Tutor Feedback:</p><p class="text-sm text-blue-800 italic">"${escH(a.feedback)}"</p></div>`:''}
            </div>

            <!-- ANNOTATE TAB -->
            <div id="wscontent-annotate-${assignmentId}" class="p-5 hidden">
                <p class="text-xs text-gray-500 mb-3">Use the tools below to annotate your assignment. Your annotation will be included when you submit.</p>
                <div class="annot-toolbar">
                    <span class="text-xs font-semibold text-gray-500">Tool:</span>
                    <button id="tool-pen-${assignmentId}" class="annot-tool-btn active" onclick="setAnnotTool('${assignmentId}','pen')" title="Pen"><i class="fas fa-pen"></i></button>
                    <button id="tool-text-${assignmentId}" class="annot-tool-btn" onclick="setAnnotTool('${assignmentId}','text')" title="Add Text"><i class="fas fa-font"></i></button>
                    <button id="tool-eraser-${assignmentId}" class="annot-tool-btn" onclick="setAnnotTool('${assignmentId}','eraser')" title="Eraser"><i class="fas fa-eraser"></i></button>
                    <span class="text-xs font-semibold text-gray-500 ml-1">Size:</span>
                    <input type="range" id="brush-size-${assignmentId}" min="1" max="20" value="3" class="w-20" oninput="_annotState['${assignmentId}']&&(_annotState['${assignmentId}'].size=+this.value)">
                    <span class="text-xs font-semibold text-gray-500 ml-1">Color:</span>
                    ${colorDots}
                    <button onclick="undoAnnot('${assignmentId}')" class="ml-1 px-2 py-1 text-xs bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300" title="Undo"><i class="fas fa-undo"></i></button>
                    <button onclick="clearAnnotCanvas('${assignmentId}')" class="px-2 py-1 text-xs bg-red-100 text-red-600 rounded-lg hover:bg-red-200" title="Clear"><i class="fas fa-trash-alt"></i></button>
                </div>
                ${isImage && fileUrl
                    ? `<div style="position:relative;display:inline-block;width:100%;max-width:100%;">
                        <img id="annot-bg-${assignmentId}" src="${escH(fileUrl)}" style="max-width:100%;display:block;border-radius:10px;border:1px solid #e5e7eb;" crossorigin="anonymous">
                        <canvas id="annot-canvas-${assignmentId}" style="position:absolute;top:0;left:0;cursor:crosshair;border-radius:10px;"></canvas>
                       </div>`
                    : `<canvas id="annot-canvas-${assignmentId}" width="580" height="380"
                        style="border:2px dashed #d1d5db;border-radius:12px;cursor:crosshair;display:block;background:#fff;max-width:100%;"></canvas>`
                }
                <p id="annot-hint-${assignmentId}" class="text-xs text-blue-500 mt-2"><i class="fas fa-pen mr-1"></i>Pen selected ‚Äî click and drag to draw</p>
            </div>

            <!-- SUBMIT TAB -->
            <div id="wscontent-submit-${assignmentId}" class="p-5 hidden">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Your Answer / Notes</label>
                        <textarea id="ws-text-${assignmentId}" rows="6"
                            class="w-full p-3 border border-gray-300 rounded-xl text-sm resize-none focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                            placeholder="Type your answer, working-out, or notes here...">${escH(a.studentWork||'')}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Upload Your Work <span class="text-gray-400 font-normal">(optional ‚Äî image, PDF, Word)</span></label>
                        <input type="file" id="ws-file-${assignmentId}" accept="image/*,.pdf,.doc,.docx"
                            class="block w-full text-sm text-gray-500 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-brand-light file:text-brand-dark file:font-semibold hover:file:bg-emerald-200">
                    </div>
                    <div id="annot-preview-${assignmentId}" class="hidden bg-gray-50 rounded-xl p-3 border border-gray-200">
                        <p class="text-xs font-bold text-gray-600 mb-2"><i class="fas fa-pen-nib mr-1 text-brand-primary"></i>Your annotation will be sent to the tutor:</p>
                        <img id="annot-preview-img-${assignmentId}" class="max-w-xs rounded-lg border border-gray-200" src="">
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button onclick="document.getElementById('ws-modal-${assignmentId}').remove()"
                            class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-colors">
                            Cancel
                        </button>
                        <button data-id="${escH(assignmentId)}" onclick="submitWork(this.dataset.id)" id="submit-btn-${assignmentId}"
                            class="flex-1 px-4 py-3 bg-brand-primary text-white rounded-xl font-bold hover:bg-brand-dark transition-colors">
                            <i class="fas fa-paper-plane mr-1"></i>Submit
                        </button>
                    </div>
                </div>
            </div>

        </div><!-- end scrollable -->
    </div>`;

    document.body.appendChild(modal);

    // Init canvas after modal is in DOM
    setTimeout(() => initAnnotCanvas(assignmentId, isImage, fileUrl), 120);
};

// ‚îÄ‚îÄ ANNOTATION CANVAS ENGINE ‚îÄ‚îÄ
function initAnnotCanvas(id, isImage, fileUrl) {
    const canvas = document.getElementById('annot-canvas-' + id);
    if (!canvas) return;

    if (isImage && fileUrl) {
        const img = document.getElementById('annot-bg-' + id);
        if (img) {
            const applySize = () => {
                canvas.width = img.offsetWidth || 580;
                canvas.height = img.offsetHeight || 380;
                canvas.style.width = img.offsetWidth + 'px';
                canvas.style.height = img.offsetHeight + 'px';
            };
            img.complete ? applySize() : (img.onload = applySize);
        }
    }

    const ctx = canvas.getContext('2d');
    _annotState[id] = { tool:'pen', color:'#1f2937', size:3, drawing:false, history:[], ctx };
    _saveAnnotHistory(id);

    canvas.addEventListener('mousedown', e => _annotStart(e, id, canvas));
    canvas.addEventListener('mousemove', e => _annotDraw(e, id, canvas));
    canvas.addEventListener('mouseup',   () => _annotStop(id));
    canvas.addEventListener('mouseleave',() => _annotStop(id));
    canvas.addEventListener('touchstart', e => { e.preventDefault(); _annotStart(e.touches[0], id, canvas); }, {passive:false});
    canvas.addEventListener('touchmove',  e => { e.preventDefault(); _annotDraw(e.touches[0], id, canvas); }, {passive:false});
    canvas.addEventListener('touchend',   () => _annotStop(id));
}

function _getPos(e, canvas) {
    const r = canvas.getBoundingClientRect();
    return { x:(e.clientX-r.left)*(canvas.width/r.width), y:(e.clientY-r.top)*(canvas.height/r.height) };
}

function _annotStart(e, id, canvas) {
    const s = _annotState[id]; if (!s) return;
    const pos = _getPos(e, canvas);
    if (s.tool === 'text') {
        const txt = prompt('Enter text to add to annotation:');
        if (txt) {
            s.ctx.font = `bold ${Math.max(14, s.size*5)}px Inter, sans-serif`;
            s.ctx.fillStyle = s.color;
            s.ctx.fillText(txt, pos.x, pos.y);
            _saveAnnotHistory(id);
        }
        return;
    }
    s.drawing = true;
    s.ctx.beginPath();
    s.ctx.moveTo(pos.x, pos.y);
}

function _annotDraw(e, id, canvas) {
    const s = _annotState[id]; if (!s || !s.drawing) return;
    const pos = _getPos(e, canvas);
    if (s.tool === 'eraser') {
        s.ctx.clearRect(pos.x - s.size*2, pos.y - s.size*2, s.size*4, s.size*4);
    } else {
        s.ctx.strokeStyle = s.color;
        s.ctx.lineWidth = s.size;
        s.ctx.lineCap = 'round';
        s.ctx.lineJoin = 'round';
        s.ctx.lineTo(pos.x, pos.y);
        s.ctx.stroke();
    }
}

function _annotStop(id) {
    const s = _annotState[id]; if (!s || !s.drawing) return;
    s.drawing = false;
    _saveAnnotHistory(id);
}

function _saveAnnotHistory(id) {
    const s = _annotState[id]; if (!s) return;
    const c = document.getElementById('annot-canvas-'+id); if (!c) return;
    s.history.push(c.toDataURL());
    if (s.history.length > 25) s.history.shift();
}

window.setAnnotTool = (id, tool) => {
    const s = _annotState[id]; if (!s) return;
    s.tool = tool;
    ['pen','text','eraser'].forEach(t => {
        const btn = document.getElementById('tool-'+t+'-'+id);
        if (!btn) return;
        btn.classList.toggle('active', t === tool);
    });
    const hints = {
        pen: '<i class="fas fa-pen mr-1"></i>Pen ‚Äî click and drag to draw',
        text: '<i class="fas fa-font mr-1"></i>Text ‚Äî click on canvas to add a label',
        eraser: '<i class="fas fa-eraser mr-1"></i>Eraser ‚Äî drag to erase areas'
    };
    const hint = document.getElementById('annot-hint-'+id);
    if (hint) hint.innerHTML = hints[tool] || '';
};

window.setAnnotColor = (id, color) => {
    const s = _annotState[id]; if (!s) return;
    s.color = color;
    if (s.tool === 'eraser') setAnnotTool(id, 'pen');
    document.querySelectorAll(`#ws-modal-${id} .color-dot`).forEach(dot => {
        dot.classList.toggle('active', dot.dataset.color === color);
    });
};

window.undoAnnot = (id) => {
    const s = _annotState[id]; if (!s || s.history.length < 2) return;
    s.history.pop();
    const c = document.getElementById('annot-canvas-'+id); if (!c) return;
    const img = new Image();
    img.onload = () => { s.ctx.clearRect(0,0,c.width,c.height); s.ctx.drawImage(img,0,0); };
    img.src = s.history[s.history.length-1];
};

window.clearAnnotCanvas = (id) => {
    const s = _annotState[id]; if (!s) return;
    const c = document.getElementById('annot-canvas-'+id); if (!c) return;
    s.ctx.clearRect(0,0,c.width,c.height);
    _saveAnnotHistory(id);
};

window.wsTab = (id, tab) => {
    ['view','annotate','submit'].forEach(t => {
        const content = document.getElementById('wscontent-'+t+'-'+id);
        const btn = document.getElementById('wstab-'+t+'-'+id);
        if (content) content.classList.toggle('hidden', t !== tab);
        if (btn) btn.classList.toggle('active', t === tab);
    });
    if (tab === 'submit') _updateAnnotPreview(id);
    if (tab === 'annotate' && !_annotState[id]) {
        const c = document.getElementById('annot-canvas-'+id);
        if (c) initAnnotCanvas(id, false, '');
    }
};

function _updateAnnotPreview(id) {
    const canvas = document.getElementById('annot-canvas-'+id);
    const preview = document.getElementById('annot-preview-'+id);
    const previewImg = document.getElementById('annot-preview-img-'+id);
    if (!canvas || !preview || !previewImg) return;
    const data = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height).data;
    const hasContent = Array.from(data).some((v,i) => i%4===3 && v>0);
    if (hasContent) {
        preview.classList.remove('hidden');
        previewImg.src = canvas.toDataURL('image/png');
    } else {
        preview.classList.add('hidden');
    }
}

// ‚îÄ‚îÄ SUBMIT WORK (with annotation upload) ‚îÄ‚îÄ
window.submitWork = async (id) => {
    const btn = document.getElementById('submit-btn-'+id);
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Submitting...';
    btn.disabled = true;
    try {
        const txt = document.getElementById('ws-text-'+id)?.value || '';
        const fi = document.getElementById('ws-file-'+id);
        let subUrl = '';

        // Upload attached file (Cloudinary)
        if (fi?.files[0]) {
            const fd = new FormData();
            fd.append('file', fi.files[0]);
            fd.append('upload_preset', CLOUDINARY.preset);
            const r = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/upload`, {method:'POST',body:fd});
            const d = await r.json();
            subUrl = d.secure_url || '';
        }

        // Upload annotation canvas if student drew anything
        let annotUrl = '';
        const canvas = document.getElementById('annot-canvas-'+id);
        if (canvas) {
            const data = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height).data;
            const hasContent = Array.from(data).some((v,i) => i%4===3 && v>0);
            if (hasContent) {
                const blob = await new Promise(r => canvas.toBlob(r,'image/png'));
                const fd = new FormData();
                fd.append('file', blob, 'annotation.png');
                fd.append('upload_preset', CLOUDINARY.preset);
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/upload`, {method:'POST',body:fd});
                const d = await res.json();
                annotUrl = d.secure_url || '';
            }
        }

        // Update assignment in Firestore
        await updateDoc(doc(db,'homework_assignments',id), {
            status: 'submitted',
            submittedAt: new Date(),
            studentWork: txt,
            ...(subUrl ? {submissionUrl:subUrl, submissionFileName:fi.files[0].name} : {}),
            ...(annotUrl ? {annotationUrl:annotUrl} : {})
        });

        // Send annotation + notes to tutor via conversation
        if ((annotUrl || txt) && window.currentStudent) {
            try {
                const convSnap = await getDocs(query(collection(db,'conversations'), where('studentId','==',window.currentStudent.id)));
                const convId = convSnap.docs[0]?.id;
                if (convId) {
                    const assignSnap = await getDoc(doc(db,'homework_assignments',id));
                    const aTitle = assignSnap.exists() ? (assignSnap.data().title||'Assignment') : 'Assignment';
                    const msgContent = `üìé Submitted work for: "${aTitle}"${txt?'\n\nNotes: '+txt:''}`;
                    await addDoc(collection(db,'conversations',convId,'messages'), {
                        content: msgContent,
                        imageUrl: annotUrl || null,
                        senderId: window.currentStudent.id,
                        senderName: window.currentStudent.name,
                        senderRole: 'student',
                        createdAt: new Date(),
                        read: false
                    });
                    const cSnap = await getDoc(doc(db,'conversations',convId));
                    const cur = cSnap.exists() ? (cSnap.data().unreadCount||0) : 0;
                    await updateDoc(doc(db,'conversations',convId), {
                        lastMessage: annotUrl ? 'üìé Submitted annotated work' : 'üìé Submitted work',
                        lastMessageTimestamp: new Date(),
                        lastSenderId: window.currentStudent.id,
                        unreadCount: cur + 1
                    });
                }
            } catch(msgErr) { console.warn('Could not send to conversation:', msgErr); }
        }

        // Close modal by its unique ID
        document.getElementById('ws-modal-'+id)?.remove();
        playNotifSound('general');
        alert('‚úÖ Submitted successfully!');
        await loadAssignments();
        await loadPendingTasks();
    } catch(e) {
        btn.innerHTML = '<i class="fas fa-paper-plane mr-1"></i>Submit';
        btn.disabled = false;
        alert('Error submitting: ' + e.message);
    }
};

// ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ
async function loadResults(){
    const c=document.getElementById('results-container');
    try{
        const snap=await getDocs(query(collection(db,'homework_assignments'),where('studentId','==',window.currentStudent.id),where('status','==','graded'),orderBy('gradedAt','desc')));
        if(snap.empty){c.innerHTML='<div class="text-center py-8 text-gray-400">No graded results yet.</div>';return;}
        c.innerHTML=`<div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="border-b border-gray-200 text-left">
            <th class="pb-3 font-semibold text-gray-500">Assignment</th>
            <th class="pb-3 font-semibold text-gray-500">Subject</th>
            <th class="pb-3 font-semibold text-gray-500">Score</th>
            <th class="pb-3 font-semibold text-gray-500">Grade</th>
            <th class="pb-3 font-semibold text-gray-500">Date</th>
            <th class="pb-3 font-semibold text-gray-500">Feedback</th>
        </tr></thead><tbody>
        ${snap.docs.map(d=>{
            const a=d.data();
            const score=parseFloat(a.score)||0;
            const letter=score>=90?'A':score>=80?'B+':score>=70?'B':score>=60?'C+':score>=50?'C':'F';
            const color=score>=75?'text-green-600':score>=50?'text-yellow-600':'text-red-600';
            const dt=a.gradedAt?.toDate?a.gradedAt.toDate().toLocaleDateString():'--';
            return `<tr class="border-b border-gray-50 hover:bg-gray-50">
                <td class="py-3 font-medium text-gray-800">${escH(a.title||'Untitled')}</td>
                <td class="py-3 text-gray-500">${escH(a.subject||'--')}</td>
                <td class="py-3 font-bold ${color}">${score}/100</td>
                <td class="py-3 font-bold ${color}">${letter}</td>
                <td class="py-3 text-gray-500">${escH(dt)}</td>
                <td class="py-3 text-gray-500 italic text-xs max-w-xs truncate">${escH(a.feedback||'--')}</td>
            </tr>`;
        }).join('')}
        </tbody></table></div>`;
    }catch(e){console.error(e);}
}

// ‚îÄ‚îÄ SCHEDULE ‚îÄ‚îÄ
async function loadSchedule(){
    const c=document.getElementById('full-schedule-container');
    const schedule=window.currentStudent.schedule||[];
    if(!schedule.length){c.innerHTML='<div class="text-center py-8 text-gray-400">No schedule set by your tutor yet.</div>';return;}
    const DAYS=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
    const byDay={};DAYS.forEach(d=>{byDay[d]=[];});
    schedule.forEach(s=>{if(byDay[s.day])byDay[s.day].push(s);});
    DAYS.forEach(d=>byDay[d].sort((a,b)=>a.start.localeCompare(b.start)));
    const todayWAT=new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Lagos'})).toLocaleDateString('en-US',{weekday:'long'});
    c.innerHTML=`
    <div class="overflow-x-auto">
        <div style="display:grid;grid-template-columns:repeat(7,minmax(110px,1fr));border-left:1px solid #e5e7eb;border-top:1px solid #e5e7eb;">
        ${DAYS.map(day=>{
            const isToday=day===todayWAT;const cls=byDay[day];
            return `<div style="border-right:1px solid #e5e7eb;">
                <div style="padding:8px 10px;font-weight:700;font-size:.72rem;text-transform:uppercase;background:${isToday?'#ecfdf5':'#f9fafb'};color:${isToday?'#059669':'#6b7280'};border-bottom:1px solid #e5e7eb;">
                    ${day.substring(0,3)} ${isToday?'‚ñ∂':''}
                </div>
                <div style="padding:8px;min-height:80px;">
                ${cls.length?cls.map(slot=>`
                    <div style="background:${isToday?'#ecfdf5':'#f3f4f6'};border:1px solid ${isToday?'#bbf7d0':'#e5e7eb'};border-radius:6px;padding:5px 7px;margin-bottom:4px;font-size:.73rem;">
                        <div style="font-weight:700;color:#1f2937;">${formatSlotTime(slot.start)}</div>
                        <div style="color:#6b7280;">‚Äì ${formatSlotTime(slot.end)}</div>
                        ${slot.subject?`<div style="color:#059669;font-size:.68rem;margin-top:2px;">${escH(slot.subject)}</div>`:''}
                    </div>`).join(''):'<div style="color:#d1d5db;font-size:.7rem;text-align:center;padding:10px;">Free</div>'}
                </div>
            </div>`;
        }).join('')}
        </div>
    </div>
    <div class="mt-4 p-4 bg-blue-50 rounded-xl text-sm text-blue-700">
        <i class="fas fa-info-circle mr-2"></i>All times are in <strong>Nigeria time (WAT / UTC+1)</strong>.
        Your local conversion is shown on the clock above.
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ REAL-TIME NOTIFICATIONS (onSnapshot) ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initRealtimeNotifications() {
    const student = window.currentStudent;
    if (!student) return;

    // Unsubscribe any previous listeners
    _notifUnsubscribers.forEach(u => u());
    _notifUnsubscribers = [];

    // 1. Live pending assignments listener
    const q1 = query(collection(db,'homework_assignments'), where('studentId','==',student.id), where('status','in',['assigned','pending']));
    _notifUnsubscribers.push(onSnapshot(q1, snap => {
        const prev = _notifData.pending;
        _notifData.pending = snap.size;
        _notifData.pendingDocs = snap.docs.map(d => ({id:d.id,...d.data()}));
        if (_notifLoaded && snap.size > prev) {
            playNotifSound('assignment');
            _ringBell();
        }
        _updateNotifBadge();
    }, err => console.warn('Notif assignments listener:', err)));

    // 2. Live conversations (messages) listener
    const q2 = query(collection(db,'conversations'), where('studentId','==',student.id));
    _notifUnsubscribers.push(onSnapshot(q2, snap => {
        let msgCount = 0;
        _notifData.convs = snap.docs.map(d => ({id:d.id,...d.data()}));
        _notifData.convs.forEach(c => { if(c.unreadCount>0 && c.lastSenderId!==student.id) msgCount++; });
        const prev = _notifData.messages;
        _notifData.messages = msgCount;
        if (_notifLoaded && msgCount > prev) {
            playNotifSound('message');
            _ringBell();
        }
        _updateNotifBadge();
    }, err => console.warn('Notif conversations listener:', err)));

    // 3. New course materials listener
    const q3 = query(collection(db,'course_materials'), where('studentId','==',student.id), orderBy('uploadedAt','desc'), limit(5));
    _notifUnsubscribers.push(onSnapshot(q3, snap => {
        const now = new Date();
        const prev = _notifData.materials.length;
        _notifData.materials = [];
        snap.docs.forEach(d => {
            const m = d.data();
            const dt = m.uploadedAt?.toDate ? m.uploadedAt.toDate() : null;
            if (dt && (now - dt)/86400000 < 7) _notifData.materials.push(m);
        });
        if (_notifLoaded && _notifData.materials.length > prev) {
            playNotifSound('general');
            _ringBell();
        }
        _updateNotifBadge();
    }, err => console.warn('Notif materials listener:', err)));

    _notifLoaded = true;
}

function _ringBell() {
    const bellBtn = document.getElementById('bell-btn');
    if (!bellBtn) return;
    bellBtn.classList.remove('bell-ring');
    // Reflow trick to restart animation
    void bellBtn.offsetWidth;
    bellBtn.classList.add('bell-ring');
    setTimeout(() => bellBtn.classList.remove('bell-ring'), 700);
}

function _updateNotifBadge() {
    const total = _notifData.pending + _notifData.messages + _notifData.materials.length;
    const badge = document.getElementById('notification-badge');
    if (!badge) return;
    if (total > 0) {
        badge.textContent = total > 99 ? '99+' : total;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
    // Also update message badge in sidebar
    const msgBadge = document.getElementById('msg-badge');
    if (msgBadge) {
        if (_notifData.messages > 0) { msgBadge.textContent = _notifData.messages; msgBadge.classList.remove('hidden'); }
        else msgBadge.classList.add('hidden');
    }
}

// Build personalized notification dropdown content (called each time bell is clicked)
function _buildNotifList() {
    const list = document.getElementById('notif-list');
    if (!list) return;
    const student = window.currentStudent;
    if (!student) { list.innerHTML = '<div class="py-6 text-center text-gray-400 text-sm">Loading...</div>'; return; }

    const now = new Date();
    const dow = now.getDay();       // 0=Sun
    const dom = now.getDate();      // day of month
    const hour = now.getHours();
    const firstName = student.name.split(' ')[0];

    const items = [];

    // ‚îÄ‚îÄ Real-time: new messages ‚îÄ‚îÄ
    if (_notifData.messages > 0) {
        items.push({
            icon: 'üí¨',
            text: `You have <strong>${_notifData.messages} new message${_notifData.messages!==1?'s':''}</strong> from your tutor`,
            type: 'message', unread: true, time: 'New message'
        });
    }

    // ‚îÄ‚îÄ Real-time: pending assignments (each one listed, max 5) ‚îÄ‚îÄ
    if (_notifData.pendingDocs.length > 0) {
        _notifData.pendingDocs.slice(0,5).forEach(a => {
            const dueStr = a.dueDate ? ` ‚Äî Due: <strong>${escH(a.dueDate)}</strong>` : '';
            items.push({
                icon: 'üìù',
                text: `Assignment pending: <strong>${escH(a.title||'Untitled')}</strong>${dueStr}`,
                type: 'assignment', assignmentId: a.id,
                unread: true, time: 'Pending'
            });
        });
    }

    // ‚îÄ‚îÄ Real-time: new course materials ‚îÄ‚îÄ
    _notifData.materials.forEach(m => {
        items.push({
            icon: 'üìö',
            text: `New material added: <strong>${escH(m.title||'Untitled')}</strong> ‚Äî check My Courses`,
            type: 'material', unread: true, time: 'New this week'
        });
    });

    // ‚îÄ‚îÄ Personalised time-of-day greeting ‚îÄ‚îÄ
    const greetWord = hour < 12 ? 'morning' : hour < 17 ? 'afternoon' : 'evening';
    const tutorPart = student.tutorName ? ` Your tutor <strong>${escH(student.tutorName)}</strong> is here to support you.` : '';
    items.push({
        icon: 'üëã',
        text: `Good ${greetWord}, <strong>${escH(firstName)}</strong>!${tutorPart}`,
        type: 'general', unread: false, time: 'Welcome back'
    });

    // ‚îÄ‚îÄ Day-of-week personalised reminder ‚îÄ‚îÄ
    const DAY_MSGS = {
        1: `üóìÔ∏è <strong>New week, ${escH(firstName)}!</strong> Monday is perfect for reviewing last week and planning this week's goals.`,
        2: `‚úèÔ∏è <strong>Tuesday study tip:</strong> Break your work into 25-min sessions with short breaks for best focus.`,
        3: `üìñ <strong>Mid-week check-in!</strong> How's the homework going? Stay consistent ‚Äî small daily effort adds up fast.`,
        4: `üí° <strong>Thursday motivation:</strong> Almost there! Push through today and you'll thank yourself tomorrow.`,
        5: `üéâ <strong>Friday, ${escH(firstName)}!</strong> Finish strong, review your notes, then enjoy the weekend.`,
        6: `‚òÄÔ∏è <strong>Saturday reminder:</strong> A little weekend reading keeps knowledge fresh ‚Äî just 20 mins helps!`,
        0: `üìó <strong>Sunday tip:</strong> Use today to preview what's coming this week ‚Äî a quick look makes lessons easier.`
    };
    items.push({ icon: 'üìÖ', text: DAY_MSGS[dow] || '', type: 'general', unread: false, time: 'Today' });

    // ‚îÄ‚îÄ Rotating daily tip (changes each day based on date number) ‚îÄ‚îÄ
    const DAILY_TIPS = [
        `üí° Reading 20 minutes daily boosts your vocabulary and comprehension dramatically over time.`,
        `üß† Spaced repetition works: review a topic after 1 day, 1 week, then 1 month for strong memory.`,
        `üéØ Set one specific learning goal before each study session ‚Äî it makes everything more focused.`,
        `üìä Consistency beats cramming every time. 30 minutes daily beats 5 hours the night before.`,
        `üí™ You're making progress, ${escH(firstName)}! Every assignment you complete is a step forward.`,
        `üåü If anything is unclear, ask your tutor straight away ‚Äî that's exactly what they're here for.`,
        `‚úçÔ∏è Writing notes in your own words helps your brain process and remember better than just reading.`,
        `üîÑ Practice past questions ‚Äî it's one of the most effective ways to prepare for assessments.`,
        `‚è∞ Study at your peak energy time. Morning person? Study early. Night owl? Use those evening hours.`,
        `üìù Completing homework on time isn't just a grade ‚Äî it builds the discipline that leads to success.`,
    ];
    const tipIdx = dom % DAILY_TIPS.length;
    items.push({ icon: '‚ú®', text: DAILY_TIPS[tipIdx], type: 'general', unread: false, time: 'Tip of the day' });

    // ‚îÄ‚îÄ Monthly milestones ‚îÄ‚îÄ
    if (dom <= 3) items.push({ icon: 'üìÖ', text: `<strong>New month!</strong> Great time to set fresh goals and check your progress, ${escH(firstName)}.`, type: 'general', unread: true, time: 'Monthly' });
    if (dom >= 14 && dom <= 16) items.push({ icon: 'üìä', text: `<strong>Mid-month check-in!</strong> Have you reviewed all your subjects this month?`, type: 'general', unread: false, time: 'Mid-month' });
    if (dom >= 28) items.push({ icon: 'üèÅ', text: `<strong>End of month coming!</strong> Great time to review what you've learned and prep for next month.`, type: 'general', unread: false, time: 'End of month' });

    // ‚îÄ‚îÄ Performance-based message (if we have avg grade) ‚îÄ‚îÄ
    const avgEl = document.getElementById('average-grade');
    if (avgEl && avgEl.textContent !== '--') {
        const avgText = avgEl.textContent;
        const avgNum = parseInt(avgText);
        if (!isNaN(avgNum)) {
            let perfMsg = '';
            if (avgNum >= 90) perfMsg = `üèÜ Outstanding work, ${escH(firstName)}! Your average of <strong>${avgText}</strong> is excellent ‚Äî keep it up!`;
            else if (avgNum >= 75) perfMsg = `‚≠ê Great job! Your average of <strong>${avgText}</strong> is really solid. Keep pushing for that A!`;
            else if (avgNum >= 60) perfMsg = `üìà Your average is <strong>${avgText}</strong>. You're doing well ‚Äî a bit more practice will push you higher!`;
            else if (avgNum > 0) perfMsg = `üí™ Current average: <strong>${avgText}</strong>. Let's work together to improve ‚Äî you've got this, ${escH(firstName)}!`;
            if (perfMsg) items.push({ icon: 'üìä', text: perfMsg, type: 'general', unread: false, time: 'Your performance' });
        }
    }

    if (!items.length) {
        list.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">üéâ All caught up!</div>';
        return;
    }

    list.innerHTML = items.map(n => {
        const isClickable = n.type === 'message' || n.type === 'assignment' || n.type === 'material';
        return `<div class="notif-item ${n.unread?'unread':''} ${isClickable?'clickable':''}"
            data-type="${n.type}" data-assignment-id="${n.assignmentId||''}"
            onclick="handleNotifClick(this)">
            <div class="text-gray-800">${n.text}</div>
            <div class="text-gray-400 text-xs mt-0.5">${n.time}</div>
        </div>`;
    }).join('');
}

window.toggleNotifications = () => {
    const dd = document.getElementById('notif-dropdown');
    const wasHidden = dd.classList.contains('hidden');
    dd.classList.toggle('hidden');
    if (wasHidden) _buildNotifList(); // Rebuild fresh each time it opens
};

window.markAllRead = () => {
    _notifData.messages = 0;
    document.querySelectorAll('.notif-item.unread').forEach(el => el.classList.remove('unread'));
    _updateNotifBadge();
};

// Click handler for notification items
window.handleNotifClick = (el) => {
    el.classList.remove('unread');
    const type = el.dataset.type;
    const aId = el.dataset.assignmentId;
    if (type === 'message') {
        document.getElementById('notif-dropdown').classList.add('hidden');
        switchTab('messages');
    } else if (type === 'assignment' && aId) {
        document.getElementById('notif-dropdown').classList.add('hidden');
        switchTab('assignments');
        // Wait for tab render then open workspace
        setTimeout(() => openWorkspace(aId), 250);
    } else if (type === 'material') {
        document.getElementById('notif-dropdown').classList.add('hidden');
        switchTab('courses');
    }
};

// ‚îÄ‚îÄ MESSAGING ‚îÄ‚îÄ
async function initMessaging(){
    if(studentUnsubInbox)studentUnsubInbox();
    const q=query(collection(db,'conversations'),where('studentId','==',window.currentStudent.id));
    studentUnsubInbox=onSnapshot(q,snap=>{
        const convs=snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>{
            const tA=a.lastMessageTimestamp?.toDate?a.lastMessageTimestamp.toDate():new Date(a.lastMessageTimestamp||0);
            const tB=b.lastMessageTimestamp?.toDate?b.lastMessageTimestamp.toDate():new Date(b.lastMessageTimestamp||0);
            return tB-tA;
        });
        renderConvList(convs);
    });
}

function renderConvList(convs){
    const list=document.getElementById('student-conv-list');
    if(!convs.length){list.innerHTML='<div style="padding:20px;text-align:center;color:#9ca3af;font-size:.875rem;">No messages yet.</div>';return;}
    list.innerHTML='';
    convs.forEach(conv=>{
        const name=conv.tutorName||'Tutor';
        const isUnread=conv.unreadCount>0&&conv.lastSenderId!==window.currentStudent.id;
        const last=conv.lastMessage||'';
        const el=document.createElement('div');
        el.style.cssText=`padding:12px 14px;border-bottom:1px solid #f3f4f6;cursor:pointer;display:flex;align-items:center;gap:10px;background:${isUnread?'#eff6ff':'#fff'};`;
        el.innerHTML=`
            <div style="width:38px;height:38px;border-radius:50%;background:${isUnread?'#059669':'#e5e7eb'};color:${isUnread?'#fff':'#6b7280'};display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1rem;flex-shrink:0;">${escH(name.charAt(0).toUpperCase())}</div>
            <div style="flex:1;min-width:0;">
                <div style="font-weight:${isUnread?700:600};font-size:.875rem;color:#1f2937;">${escH(name)}</div>
                <div style="font-size:.75rem;color:#6b7280;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${isUnread?'':'You: '}${escH(last.substring(0,40))}${last.length>40?'‚Ä¶':''}</div>
            </div>
            ${isUnread?`<span style="background:#059669;color:#fff;border-radius:50%;min-width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;padding:0 3px;">${conv.unreadCount}</span>`:''}`;
        el.onmouseover=()=>el.style.background='#f0fdf4';
        el.onmouseout=()=>el.style.background=isUnread?'#eff6ff':'#fff';
        el.onclick=()=>openChat(conv.id,name);
        list.appendChild(el);
    });
}

function openChat(convId,name){
    document.getElementById('student-chat-header').textContent=name;
    document.getElementById('student-chat-inputs').style.display='flex';
    const msgEl=document.getElementById('student-chat-messages');
    msgEl.innerHTML='<div style="text-align:center;margin-top:40px;"><div style="display:inline-block;border:3px solid #059669;border-top-color:transparent;border-radius:50%;width:24px;height:24px;animation:spin .8s linear infinite;"></div></div>';
    updateDoc(doc(db,'conversations',convId),{unreadCount:0}).catch(()=>{});
    if(studentUnsubChat)studentUnsubChat();
    studentUnsubChat=onSnapshot(query(collection(db,'conversations',convId,'messages'),orderBy('createdAt','asc')),snap=>{
        msgEl.innerHTML='';
        snap.forEach(d=>{
            const msg=d.data();
            const isMe=msg.senderId===window.currentStudent.id;
            const wrap=document.createElement('div');
            wrap.style.cssText=`display:flex;flex-direction:column;align-items:${isMe?'flex-end':'flex-start'};`;
            const bubble=document.createElement('div');
            bubble.className=isMe?'chat-me':'chat-them';
            let html='';
            if(msg.subject) html+=`<div style="font-weight:700;font-size:.78rem;margin-bottom:3px;">${escH(msg.subject)}</div>`;
            if(msg.content) html+=`<div>${escH(msg.content)}</div>`;
            if(msg.imageUrl) html+=`<img src="${escH(msg.imageUrl)}" style="max-width:180px;border-radius:8px;margin-top:6px;cursor:pointer;" onclick="window.open('${escH(msg.imageUrl)}','_blank')">`;
            const ts=msg.createdAt?.toDate?msg.createdAt.toDate():new Date(msg.createdAt||0);
            html+=`<div style="font-size:.65rem;opacity:.7;margin-top:4px;">${ts.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}${msg.isUrgent?' üî¥':''}</div>`;
            bubble.innerHTML=html;wrap.appendChild(bubble);msgEl.appendChild(wrap);
        });
        msgEl.scrollTop=msgEl.scrollHeight;
    });
    const sendBtn=document.getElementById('student-send-btn');
    const input=document.getElementById('student-msg-input');
    const imgInput=document.getElementById('student-img-file');
    const newBtn=sendBtn.cloneNode(true);
    sendBtn.parentNode.replaceChild(newBtn,sendBtn);
    newBtn.onclick=async()=>{
        const txt=input.value.trim();const imgFile=imgInput.files[0]||null;
        if(!txt&&!imgFile)return;
        newBtn.disabled=true;newBtn.textContent='‚Ä¶';
        try{
            let imageUrl=null;
            if(imgFile){
                const fd=new FormData();fd.append('file',imgFile);fd.append('upload_preset',CLOUDINARY.preset);
                const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/image/upload`,{method:'POST',body:fd});
                const data=await res.json();imageUrl=data.secure_url||null;imgInput.value='';
            }
            const now=new Date();const lastMsg=imageUrl?(txt||'üì∑ Image'):txt;
            await addDoc(collection(db,'conversations',convId,'messages'),{content:txt,imageUrl,senderId:window.currentStudent.id,senderName:window.currentStudent.name,senderRole:'student',createdAt:now,read:false});
            const cSnap=await getDoc(doc(db,'conversations',convId));
            const cur=cSnap.exists()?(cSnap.data().unreadCount||0):0;
            await updateDoc(doc(db,'conversations',convId),{lastMessage:lastMsg,lastMessageTimestamp:now,lastSenderId:window.currentStudent.id,unreadCount:cur+1});
            input.value='';
        }catch(e){alert('Error: '+e.message);}
        finally{newBtn.disabled=false;newBtn.textContent='‚û§';}
    };
    input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();newBtn.click();}});
}

// ‚îÄ‚îÄ GAMES ‚îÄ‚îÄ
async function loadGames(){
    const c=document.getElementById('games-container');
    const student=window.currentStudent;
    const grade=parseInt(String(student.grade||'').replace(/\D/g,''))||3;
    const subjects=student.subjects||[];
    const hasSub=s=>subjects.length===0||subjects.some(x=>x.toLowerCase().includes(s.toLowerCase()));
    const ALL_GAMES=[
        {id:'math_quiz',name:'Maths Quiz',subject:'Maths',icon:'fa-calculator',grad:'from-blue-500 to-cyan-400',always:true},
        {id:'ela_quiz',name:'ELA Quiz',subject:'ELA',icon:'fa-spell-check',grad:'from-purple-500 to-pink-400',always:true},
        {id:'bio_quiz',name:'Biology Quiz',subject:'Biology',icon:'fa-dna',grad:'from-green-500 to-emerald-400',always:false},
        {id:'chem_quiz',name:'Chemistry Quiz',subject:'Chemistry',icon:'fa-flask',grad:'from-orange-500 to-amber-400',always:false},
        {id:'phy_quiz',name:'Physics Quiz',subject:'Physics',icon:'fa-atom',grad:'from-red-500 to-rose-400',always:false},
        {id:'scrabble',name:'Scrabble',subject:'ELA',icon:'fa-font',grad:'from-teal-500 to-cyan-400',always:true},
        {id:'snake',name:'Snake',subject:'Fun',icon:'fa-gamepad',grad:'from-gray-700 to-gray-900',always:true},
    ];
    const visible=ALL_GAMES.filter(g=>g.always||hasSub(g.subject));
    c.innerHTML=visible.map(g=>`
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-all">
        <div class="h-36 bg-gradient-to-r ${g.grad} flex items-center justify-center">
            <i class="fas ${g.icon} text-white text-5xl opacity-80"></i>
        </div>
        <div class="p-5">
            <h3 class="font-bold text-gray-800 mb-1">${escH(g.name)}</h3>
            <p class="text-xs text-gray-500 mb-4">${escH(g.subject)} ¬∑ Grade ${grade} difficulty</p>
            <button data-gameid="${g.id}" data-gamename="${escH(g.name)}" data-grade="${grade}"
                onclick="startGame(this.dataset.gameid,this.dataset.gamename,+this.dataset.grade)"
                class="w-full px-4 py-2 bg-brand-primary text-white text-sm font-bold rounded-xl hover:bg-brand-dark">
                Play <i class="fas fa-play ml-1"></i>
            </button>
        </div>
    </div>`).join('');
}

window.startGame=(gameId,gameName,grade)=>{
    // Clear any old game state
    if(window._gTimer)clearInterval(window._gTimer);
    if(window._snakeInt)clearInterval(window._snakeInt);
    const existing=document.getElementById('game-overlay');if(existing)existing.remove();

    const overlay=document.createElement('div');
    overlay.className='fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4';
    overlay.id='game-overlay';
    overlay.innerHTML=`
    <div style="width:100%;max-width:580px;background:#111827;border-radius:16px;overflow:hidden;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#0f172a;">
            <div><div style="font-size:1.1rem;font-weight:700;color:#fff;">${escH(gameName)}</div><div style="font-size:.75rem;color:#9ca3af;">Grade ${grade}</div></div>
            <button onclick="endGame()" style="color:#9ca3af;background:none;border:none;font-size:1.5rem;cursor:pointer;">&times;</button>
        </div>
        <div id="game-viewport" style="padding:16px;background:#1a1a2e;min-height:280px;"></div>
        <div style="padding:12px 18px;background:#0f172a;display:flex;gap:20px;">
            <div style="color:#fff;font-size:.875rem;">Score: <strong id="game-score" style="color:#10b981;">0</strong></div>
            <div style="color:#fff;font-size:.875rem;">Level: <strong id="game-level" style="color:#f59e0b;">${grade}</strong></div>
            <div style="color:#fff;font-size:.875rem;margin-left:auto;">Time: <strong id="game-timer" style="color:#60a5fa;">60s</strong></div>
        </div>
    </div>`;
    document.body.appendChild(overlay);
    window._lastGameId=gameId;
    if(gameId==='snake')startSnake(grade);
    else if(gameId==='scrabble')startScrabble(grade);
    else startQuiz(gameId,grade);
};

window.endGame=()=>{
    if(window._gTimer){clearInterval(window._gTimer);window._gTimer=null;}
    if(window._snakeInt){clearInterval(window._snakeInt);window._snakeInt=null;}
    const score=parseInt(document.getElementById('game-score')?.textContent)||0;
    if(score>0&&window.currentStudent){
        addDoc(collection(db,'game_scores'),{studentId:window.currentStudent.id,studentName:window.currentStudent.name,grade:window.currentStudent.grade,score,gameId:window._lastGameId||'quiz',playedAt:new Date()}).catch(()=>{});
    }
    document.getElementById('game-overlay')?.remove();
};

function startQuiz(gameId,grade){
    let score=0,timeLeft=60;
    const vp=document.getElementById('game-viewport');
    const qs=shuffle(getQuestions(gameId,grade));let qi=0;
    function showQ(){
        if(qi>=qs.length){qi=0;shuffle(qs);}
        const q=qs[qi++];const opts=shuffle([...q.wrong,q.correct]);
        vp.innerHTML=`<div style="color:#fff;font-size:1rem;font-weight:600;margin-bottom:16px;line-height:1.4;">${escH(q.q)}</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            ${opts.map(o=>`<button data-ans="${escH(o)}" data-correct="${escH(q.correct)}" data-grade="${grade}" onclick="ansQ(this)"
                style="background:#1e293b;color:#f1f5f9;border:1px solid #334155;border-radius:8px;padding:10px 14px;cursor:pointer;font-size:.85rem;text-align:left;">${escH(o)}</button>`).join('')}
            </div>`;
    }
    window.ansQ=(btn)=>{
        const chosen=btn.dataset.ans,correct=btn.dataset.correct,g=+btn.dataset.grade;
        const right=chosen===correct;
        btn.style.background=right?'#065f46':'#7f1d1d';
        vp.querySelectorAll('button').forEach(b=>{b.disabled=true;if(b.dataset.ans===correct)b.style.background='#065f46';});
        if(right){score+=10*g;document.getElementById('game-score').textContent=score;}
        setTimeout(showQ,700);
    };
    window._gTimer=setInterval(()=>{
        timeLeft--;document.getElementById('game-timer').textContent=timeLeft+'s';
        if(timeLeft<=0){clearInterval(window._gTimer);window._gTimer=null;vp.innerHTML=`<div style="text-align:center;color:#fff;padding:40px;"><div style="font-size:2rem;">üéâ</div><div style="font-size:1.4rem;font-weight:700;margin-top:8px;">Game Over!</div><div style="color:#10b981;font-size:1.2rem;margin-top:6px;">Score: ${score}</div><button onclick="endGame()" style="margin-top:16px;background:#059669;color:#fff;border:none;border-radius:8px;padding:10px 24px;font-weight:700;cursor:pointer;">Close</button></div>`;}
    },1000);
    showQ();
}

function getQuestions(id,g){
    if(id==='math_quiz'||id==='phy_quiz')return getMathQs(g);
    if(id==='ela_quiz')return getELAQs(g);
    if(id==='bio_quiz')return getBioQs();
    if(id==='chem_quiz')return getChemQs();
    return getMathQs(g);
}
function getMathQs(g){
    const qs=[];
    for(let i=0;i<20;i++){
        if(g<=4){const a=rand(1,10),b=rand(1,10),op=['+','-'][rand(0,1)];const ans=op==='+'?a+b:a-b;qs.push({q:`${a} ${op} ${b} = ?`,correct:String(ans),wrong:[String(ans+rand(1,4)),String(Math.abs(ans-rand(1,3))),String(ans+rand(5,9))]});}
        else if(g<=7){const a=rand(2,12),b=rand(2,12);qs.push({q:`${a} √ó ${b} = ?`,correct:String(a*b),wrong:[String(a*b+rand(1,5)),String(a*b-rand(1,4)),String(a*b+rand(6,12))]});}
        else{const a=rand(2,15);qs.push({q:`${a}¬≤ = ?`,correct:String(a*a),wrong:[String(a*a+rand(1,9)),String(a*a-rand(1,5)),String(a*(a+1))]});}
    }
    return qs;
}
function getELAQs(g){
    const base=[
        {q:'Choose the correct spelling:',correct:'necessary',wrong:['nessecary','necesary','neceserry']},
        {q:'Synonym of "happy":',correct:'joyful',wrong:['sad','angry','tired']},
        {q:'Antonym of "hot":',correct:'cold',wrong:['warm','boiling','sunny']},
        {q:'Which is correct?',correct:'She runs every day.',wrong:['She run every day.','Her runs every day.','She running every day.']},
        {q:'"quickly" is a:',correct:'Adverb',wrong:['Noun','Verb','Adjective']},
        {q:'Plural of "child":',correct:'children',wrong:['childs','childes','childrens']},
        {q:'He ___ to school every day.',correct:'goes',wrong:['go','gone','going']},
        {q:'"sat" in "The cat sat" is a:',correct:'Verb',wrong:['Noun','Adjective','Pronoun']},
    ];
    if(g>=6){base.push({q:'"The wind whispered" is:',correct:'Personification',wrong:['Simile','Metaphor','Alliteration']},{q:'"Fast as lightning" is a:',correct:'Simile',wrong:['Metaphor','Hyperbole','Personification']});}
    return base;
}
function getBioQs(){return[
    {q:'Powerhouse of the cell:',correct:'Mitochondria',wrong:['Nucleus','Ribosome','Vacuole']},
    {q:'Human heart chambers:',correct:'4',wrong:['2','3','6']},
    {q:'Plants absorb ___ during photosynthesis:',correct:'CO‚ÇÇ',wrong:['O‚ÇÇ','N‚ÇÇ','H‚ÇÇO']},
    {q:'DNA stands for:',correct:'Deoxyribonucleic acid',wrong:['Diribose nucleic acid','Dioxy nucleic acid','Deoxyribon acid']},
    {q:'Insulin is produced by:',correct:'Pancreas',wrong:['Liver','Kidney','Spleen']},
    {q:'Cell division is called:',correct:'Mitosis',wrong:['Photosynthesis','Osmosis','Diffusion']},
    {q:'Infection-fighting cells:',correct:'White blood cells',wrong:['Red blood cells','Platelets','Plasma']},
];}
function getChemQs(){return[
    {q:'H‚ÇÇO is:',correct:'Water',wrong:['Oxygen','Hydrogen peroxide','Salt']},
    {q:'Symbol for Gold:',correct:'Au',wrong:['Go','Gd','Gl']},
    {q:'Atomic number of Carbon:',correct:'6',wrong:['12','8','14']},
    {q:'NaCl is:',correct:'Table salt',wrong:['Sugar','Baking soda','Bleach']},
    {q:'pH of pure water:',correct:'7',wrong:['0','14','5']},
    {q:'Chemical symbol for Iron:',correct:'Fe',wrong:['Ir','In','Fr']},
    {q:'Which is a compound?',correct:'H‚ÇÇO (water)',wrong:['O‚ÇÇ','N‚ÇÇ','Au']},
];}

function startSnake(grade){
    const vp=document.getElementById('game-viewport');
    const speed=Math.max(70,160-grade*10);
    vp.innerHTML=`<canvas id="snake-canvas" width="380" height="260" style="display:block;margin:auto;background:#1a1a2e;border-radius:8px;"></canvas><div style="color:#9ca3af;text-align:center;font-size:.72rem;margin-top:8px;">Arrow keys or WASD ¬∑ Swipe on mobile</div>`;
    const cv=document.getElementById('snake-canvas');const ctx=cv.getContext('2d');
    const CELL=20,COLS=19,ROWS=13;
    let snake=[{x:5,y:6}],dir={x:1,y:0},nxt={x:1,y:0},food={x:rand(0,COLS-1),y:rand(0,ROWS-1)},score=0,alive=true;
    function draw(){
        ctx.fillStyle='#1a1a2e';ctx.fillRect(0,0,cv.width,cv.height);
        ctx.fillStyle='#f59e0b';ctx.beginPath();ctx.arc(food.x*CELL+CELL/2,food.y*CELL+CELL/2,CELL/2-2,0,Math.PI*2);ctx.fill();
        snake.forEach((seg,i)=>{ctx.fillStyle=i===0?'#10b981':'#059669';ctx.fillRect(seg.x*CELL+1,seg.y*CELL+1,CELL-2,CELL-2);});
    }
    function step(){
        if(!alive)return;dir={...nxt};
        const h={x:snake[0].x+dir.x,y:snake[0].y+dir.y};
        if(h.x<0||h.x>=COLS||h.y<0||h.y>=ROWS||snake.some(s=>s.x===h.x&&s.y===h.y)){
            alive=false;clearInterval(window._snakeInt);window._snakeInt=null;
            ctx.fillStyle='rgba(0,0,0,.65)';ctx.fillRect(0,0,cv.width,cv.height);
            ctx.fillStyle='#fff';ctx.font='bold 22px Inter';ctx.textAlign='center';
            ctx.fillText('Game Over!',cv.width/2,cv.height/2-10);
            ctx.font='16px Inter';ctx.fillText('Score: '+score,cv.width/2,cv.height/2+18);return;
        }
        snake.unshift(h);
        if(h.x===food.x&&h.y===food.y){score+=10;document.getElementById('game-score').textContent=score;food={x:rand(0,COLS-1),y:rand(0,ROWS-1)};}else snake.pop();
        draw();
    }
    function keyFn(e){
        if(!document.getElementById('snake-canvas')){document.removeEventListener('keydown',keyFn);return;}
        if(['ArrowUp','w'].includes(e.key)&&dir.y!==1)nxt={x:0,y:-1};
        else if(['ArrowDown','s'].includes(e.key)&&dir.y!==-1)nxt={x:0,y:1};
        else if(['ArrowLeft','a'].includes(e.key)&&dir.x!==1)nxt={x:-1,y:0};
        else if(['ArrowRight','d'].includes(e.key)&&dir.x!==-1)nxt={x:1,y:0};
        if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key))e.preventDefault();
    }
    document.addEventListener('keydown',keyFn);
    let tx=0,ty=0;
    cv.addEventListener('touchstart',e=>{tx=e.touches[0].clientX;ty=e.touches[0].clientY;},{passive:true});
    cv.addEventListener('touchend',e=>{
        const dx=e.changedTouches[0].clientX-tx,dy=e.changedTouches[0].clientY-ty;
        if(Math.abs(dx)>Math.abs(dy)){if(dx>0&&dir.x!==-1)nxt={x:1,y:0};else if(dir.x!==1)nxt={x:-1,y:0};}
        else{if(dy>0&&dir.y!==-1)nxt={x:0,y:1};else if(dir.y!==1)nxt={x:0,y:-1};}
    },{passive:true});
    draw();window._snakeInt=setInterval(step,speed);
}

function startScrabble(grade){
    const WORDS='apple bread chair dance eagle flame giant happy india jolly knife lemon music night ocean piano queen river stone tiger urban vivid water xenon yacht zebra jungle knight laptop mango narrow orange pencil purple rabbit silver turtle unique violet walnut yellow castle dragon forest garden humble island junior kitten lantern'.split(' ');
    const word=WORDS[rand(0,WORDS.length-1)].toUpperCase();
    const scrambled=shuffle([...word]).join('');
    let score=parseInt(document.getElementById('game-score')?.textContent)||0;
    let attempts=0;
    const vp=document.getElementById('game-viewport');
    function render(){
        vp.innerHTML=`<div style="text-align:center;color:#fff;">
            <div style="font-size:.8rem;color:#9ca3af;margin-bottom:10px;">Unscramble the word:</div>
            <div style="font-size:2.2rem;font-weight:700;letter-spacing:.18em;color:#f59e0b;margin-bottom:20px;">${escH(scrambled)}</div>
            <input id="scr-in" type="text" maxlength="${word.length}" style="background:#1e293b;color:#fff;border:1px solid #334155;border-radius:8px;padding:10px 16px;font-size:1.1rem;width:80%;text-align:center;letter-spacing:.12em;text-transform:uppercase;"
                onkeydown="if(event.key==='Enter')window._checkScrabble();">
            <div style="margin-top:12px;display:flex;gap:10px;justify-content:center;">
                <button onclick="window._checkScrabble()" style="background:#059669;color:#fff;border:none;border-radius:8px;padding:10px 24px;font-weight:700;cursor:pointer;">Check</button>
                <button onclick="startScrabble(${grade})" style="background:#374151;color:#fff;border:none;border-radius:8px;padding:10px 18px;font-weight:600;cursor:pointer;">Skip</button>
            </div>
            <div id="scr-msg" style="margin-top:16px;font-size:.9rem;min-height:24px;"></div>
            <div style="color:#6b7280;font-size:.72rem;margin-top:6px;">Attempts: ${attempts}/3</div>
        </div>`;
        document.getElementById('scr-in')?.focus();
    }
    window._checkScrabble=()=>{
        const ans=(document.getElementById('scr-in')?.value||'').toUpperCase().trim();
        if(ans===word){
            score+=15;document.getElementById('game-score').textContent=score;
            document.getElementById('scr-msg').innerHTML='<span style="color:#10b981;font-weight:700;">‚úì Correct! +15 points</span>';
            setTimeout(()=>startScrabble(grade),1200);
        } else {
            attempts++;
            if(attempts>=3){
                document.getElementById('scr-msg').innerHTML=`<span style="color:#ef4444;">The word was: <strong>${escH(word)}</strong></span>`;
                setTimeout(()=>startScrabble(grade),2200);
            } else {
                document.getElementById('scr-msg').innerHTML=`<span style="color:#f59e0b;">Not quite! ${3-attempts} attempt${3-attempts!==1?'s':''} left.</span>`;
            }
        }
    };
    render();
}

// ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ
window.toggleLeaderboard=async()=>{
    const c=document.getElementById('leaderboard-container');
    const btn=document.getElementById('show-leaderboard');
    if(c.classList.contains('hidden')){c.classList.remove('hidden');btn.innerHTML='<i class="fas fa-times mr-1"></i>Hide';await loadLeaderboard();}
    else{c.classList.add('hidden');btn.innerHTML='<i class="fas fa-trophy mr-1"></i>Leaderboard';}
};

async function loadLeaderboard(){
    const c=document.getElementById('leaderboard-content');
    try{
        const snap=await getDocs(query(collection(db,'game_scores'),orderBy('score','desc'),limit(30)));
        if(snap.empty){c.innerHTML='<p class="text-gray-500 text-sm text-center">No scores yet!</p>';return;}
        const byGame={};
        snap.docs.forEach(d=>{const s=d.data();const gid=s.gameId||'quiz';if(!byGame[gid])byGame[gid]=[];if(byGame[gid].length<3)byGame[gid].push(s);});
        c.innerHTML=Object.entries(byGame).map(([gid,list])=>`
            <div class="mb-5">
                <div class="font-bold text-gray-700 mb-2 text-sm uppercase tracking-wide">${escH(gid.replace(/_/g,' '))}</div>
                ${list.map((p,i)=>`
                <div class="flex items-center gap-3 py-1.5">
                    <span class="text-lg">${i===0?'ü•á':i===1?'ü•à':'ü•â'}</span>
                    <div class="flex-1">
                        <span class="text-sm font-medium text-gray-800">${escH(p.studentName||'Student')}</span>
                        <span class="text-xs text-gray-400 ml-1">${escH(p.grade||'')}</span>
                    </div>
                    <span class="text-sm font-bold text-brand-primary">${p.score} pts</span>
                </div>`).join('')}
            </div>`).join('')||'<p class="text-gray-500 text-sm text-center">No scores yet!</p>';
    }catch(e){c.innerHTML='<p class="text-red-400 text-sm">Error loading leaderboard.</p>';}
}

}); // end DOMContentLoaded
</script>
</body>
</html>
