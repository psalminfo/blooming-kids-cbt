<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://www.google.com https://www.gstatic.com https://www.recaptcha.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com; frame-src https://www.google.com https://recaptcha.google.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <title>Secure Student Portal | Intelligent LMS</title>
    
    <!-- reCAPTCHA v3 - YOU MUST ADD YOUR SITE KEY -->
    <script src="https://www.google.com/recaptcha/api.js?render=YOUR_RECAPTCHA_SITE_KEY_HERE"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { light: '#f0fdf4', primary: '#059669', dark: '#064e3b', accent: '#fbbf24', danger: '#dc2626' }
                    },
                    borderRadius: { '4xl': '2rem' }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            min-height: 100vh;
        }
        .hero-gradient { background: linear-gradient(135deg, #064e3b 0%, #059669 100%); }
        .hidden-step { display: none !important; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .google-btn {
            background: white;
            color: #757575;
            border: 1px solid #ddd;
            transition: all 0.3s;
        }
        .google-btn:hover {
            background: #f8f8f8;
            border-color: #ccc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .tab-btn {
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: #059669;
            color: white;
        }
        .password-strength-meter {
            height: 4px;
            margin-top: 4px;
            border-radius: 2px;
            transition: all 0.3s;
        }
        .strength-0 { width: 20%; background: #dc2626; }
        .strength-1 { width: 40%; background: #f97316; }
        .strength-2 { width: 60%; background: #eab308; }
        .strength-3 { width: 80%; background: #22c55e; }
        .strength-4 { width: 100%; background: #16a34a; }
        .password-requirements li {
            transition: all 0.3s;
            color: #6b7280;
        }
        .password-requirements li.valid {
            color: #16a34a;
        }
        .password-requirements li.valid:before {
            content: '✓ ';
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .toast.show { transform: translateX(0); }
        .toast.success { background: #16a34a; }
        .toast.error { background: #dc2626; }
        .toast.warning { background: #f59e0b; }
        .toast.info { background: #3b82f6; }
        
        /* Modal Background */
        .modal-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <div class="flex flex-col lg:flex-row w-full max-w-5xl bg-white rounded-4xl shadow-2xl overflow-hidden min-h-[700px] border border-gray-100">
        <!-- Left Side - Hero Section -->
        <div class="hidden lg:flex lg:w-2/5 hero-gradient p-12 flex-col justify-between text-white relative overflow-hidden">
            <div class="absolute top-0 left-0 w-32 h-32 bg-white/10 rounded-full -translate-x-16 -translate-y-16"></div>
            <div class="absolute bottom-0 right-0 w-48 h-48 bg-white/10 rounded-full translate-x-24 translate-y-24"></div>
            
            <div class="relative space-y-6">
                <div class="bg-white/20 p-4 rounded-2xl w-fit backdrop-blur-sm"><i class="fas fa-shield-alt text-3xl text-accent"></i></div>
                <h2 class="text-4xl font-extrabold leading-tight">Secure Student <br><span class="text-accent">Portal.</span></h2>
                <p class="text-emerald-100/80">Enterprise-grade security with military-grade encryption. Your data is protected 24/7.</p>
                
                <!-- Security Features List -->
                <div class="space-y-3 mt-8">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-check-circle text-accent"></i>
                        <span class="text-sm">End-to-end encryption</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-check-circle text-accent"></i>
                        <span class="text-sm">GDPR & COPPA compliant</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-check-circle text-accent"></i>
                        <span class="text-sm">Regular security audits</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-check-circle text-accent"></i>
                        <span class="text-sm">Pentest verified</span>
                    </div>
                </div>
            </div>
            <div class="relative text-xs opacity-60">ISO 27001 Certified • Powered by Blue Ocean Concepts</div>
        </div>

        <!-- Right Side - Auth Forms -->
        <div class="w-full lg:w-3/5 p-8 lg:p-16 flex flex-col justify-center">
            
            <!-- Logo for Mobile -->
            <div class="lg:hidden mb-8 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-brand-primary rounded-2xl mb-4">
                    <i class="fas fa-shield-alt text-3xl text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">Secure Student Portal</h2>
            </div>
            
            <!-- Tabs for Activation vs Login -->
            <div class="flex mb-8 bg-gray-100 p-1 rounded-2xl w-fit mx-auto">
                <button id="tab-activate" class="tab-btn active px-6 py-3 rounded-2xl font-semibold" onclick="switchTab('activate')">Activate Account</button>
                <button id="tab-login" class="tab-btn px-6 py-3 rounded-2xl font-semibold text-gray-600" onclick="switchTab('login')">Login</button>
            </div>

            <!-- Activation Flow -->
            <div id="activation-flow" class="space-y-6">
                <!-- Step 1: Parent Verification -->
                <div id="step-1" class="space-y-6 fade-in">
                    <div class="mb-8">
                        <h3 class="text-3xl font-bold text-gray-900">Verify Parent</h3>
                        <p class="text-gray-500">Enter the email used during registration.</p>
                    </div>
                    
                    <!-- Rate Limiting Indicator -->
                    <div id="rate-limit-warning" class="hidden p-4 bg-yellow-50 border border-yellow-200 rounded-2xl text-sm text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span id="rate-limit-message"></span>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1 flex items-center">
                            Parent's Registered Email
                            <span class="tooltip ml-1">
                                <i class="fas fa-info-circle text-gray-400 text-xs"></i>
                                <span class="tooltip-text">Must match the email used during parent registration</span>
                            </span>
                        </label>
                        <input type="email" id="parent-email" placeholder="e.g. parent@email.com" 
                            class="w-full px-6 py-4 rounded-2xl bg-gray-50 border border-gray-100 outline-none focus:ring-4 focus:ring-emerald-50 transition-all"
                            autocomplete="email">
                    </div>
                    
                    <!-- reCAPTCHA Badge -->
                    <div class="text-xs text-gray-400 text-center">
                        Protected by reCAPTCHA
                    </div>
                    
                    <button onclick="findStudents()" class="w-full bg-brand-primary text-white font-bold py-5 rounded-2xl shadow-xl hover:-translate-y-1 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            id="find-profile-btn">
                        <span id="find-profile-text">Find My Profile</span>
                        <span id="find-profile-loading" class="hidden">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Verifying...
                        </span>
                    </button>
                    
                    <!-- Divider with Google Sign-in option -->
                    <div class="relative py-4">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-200"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-4 bg-white text-gray-500">Or activate with</span>
                        </div>
                    </div>
                    
                    <button onclick="signInWithGoogleForActivation()" class="w-full google-btn font-semibold py-4 rounded-2xl flex items-center justify-center gap-3 hover:shadow-md">
                        <img src="https://www.google.com/favicon.ico" alt="Google" class="w-5 h-5">
                        Google Account
                    </button>
                </div>

                <!-- Step 2: Claim Profile -->
                <div id="step-2" class="hidden-step space-y-6 fade-in">
                    <button onclick="goBackToStep1()" class="flex items-center text-gray-600 hover:text-gray-900 transition-colors mb-2">
                        <i class="fas fa-arrow-left mr-2"></i> Back
                    </button>
                    
                    <div class="mb-8">
                        <h3 class="text-3xl font-bold text-gray-900">Claim Profile</h3>
                        <p class="text-gray-500">Select your name and set secure login details.</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1">Who are you?</label>
                            <select id="student-select" class="w-full px-6 py-4 rounded-2xl bg-gray-50 border border-gray-100 outline-none cursor-pointer focus:ring-4 focus:ring-emerald-50"></select>
                        </div>

                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1">Login Email (Student)</label>
                            <input type="email" id="student-email-input" placeholder="student@email.com" 
                                class="w-full px-6 py-4 rounded-2xl bg-gray-50 border border-gray-100 outline-none focus:ring-4 focus:ring-emerald-50"
                                autocomplete="email">
                        </div>

                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1 flex items-center">
                                Create Password
                                <span class="tooltip ml-1">
                                    <i class="fas fa-info-circle text-gray-400 text-xs"></i>
                                    <span class="tooltip-text">Must include uppercase, lowercase, number, and special character</span>
                                </span>
                            </label>
                            <div class="relative">
                                <input type="password" id="student-pass" placeholder="••••••••" 
                                    class="w-full px-6 py-4 rounded-2xl bg-gray-50 border border-gray-100 outline-none focus:ring-4 focus:ring-emerald-50 pr-12"
                                    oninput="checkPasswordStrength()">
                                <button type="button" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                                        onclick="togglePasswordVisibility('student-pass')">
                                    <i class="far fa-eye"></i>
                                </button>
                            </div>
                            <!-- Password Strength Meter -->
                            <div class="password-strength-meter" id="password-strength"></div>
                            
                            <!-- Password Requirements -->
                            <ul class="password-requirements text-xs text-gray-500 space-y-1 mt-2" id="password-requirements">
                                <li id="req-length">At least 12 characters</li>
                                <li id="req-uppercase">One uppercase letter</li>
                                <li id="req-lowercase">One lowercase letter</li>
                                <li id="req-number">One number</li>
                                <li id="req-special">One special character</li>
                            </ul>
                        </div>
                        
                        <!-- Remember Me -->
                        <div class="flex items-center space-x-2 pt-2">
                            <input type="checkbox" id="remember-me-activation" class="w-5 h-5 rounded text-brand-primary focus:ring-brand-primary">
                            <label for="remember-me-activation" class="text-sm text-gray-600">Remember me for 30 days</label>
                        </div>
                    </div>

                    <button onclick="completeRegistration()" class="w-full bg-brand-accent text-emerald-900 font-bold py-5 rounded-2xl shadow-xl hover:-translate-y-1 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            id="activate-btn">
                        <span id="activate-text">Activate My Portal</span>
                        <span id="activate-loading" class="hidden">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Securing Account...
                        </span>
                    </button>
                    
                    <p class="text-center text-sm text-gray-500 mt-4">
                        Already activated? <a href="javascript:void(0)" onclick="switchTab('login')" class="text-brand-primary font-semibold hover:underline">Switch to Login</a>
                    </p>
                </div>
            </div>

            <!-- Login Flow -->
            <div id="login-flow" class="hidden-step space-y-6 fade-in">
                <div class="mb-8">
                    <h3 class="text-3xl font-bold text-gray-900">Student Login</h3>
                    <p class="text-gray-500">Enter your student credentials to access your portal.</p>
                </div>
                
                <!-- Failed Attempts Warning -->
                <div id="failed-attempts-warning" class="hidden p-4 bg-red-50 border border-red-200 rounded-2xl text-sm text-red-800">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="failed-attempts-message"></span>
                </div>
                
                <div class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1">Student Email</label>
                        <input type="email" id="login-email" placeholder="student@email.com" 
                            class="w-full px-6 py-4 rounded-2xl bg-gray-50 border border-gray-100 outline-none focus:ring-4 focus:ring-emerald-50 transition-all"
                            autocomplete="username">
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1">Password</label>
                            <a href="javascript:void(0)" onclick="showForgotPassword()" class="text-xs text-brand-primary hover:underline font-medium">Forgot Password?</a>
                        </div>
                        <div class="relative">
                            <input type="password" id="login-password" placeholder="••••••••" 
                                class="w-full px-6 py-4 rounded-2xl bg-gray-50 border border-gray-100 outline-none focus:ring-4 focus:ring-emerald-50 pr-12"
                                autocomplete="current-password">
                            <button type="button" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                                    onclick="togglePasswordVisibility('login-password')">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Remember Me -->
                    <div class="flex items-center space-x-2 pt-2">
                        <input type="checkbox" id="remember-me-login" class="w-5 h-5 rounded text-brand-primary focus:ring-brand-primary" checked>
                        <label for="remember-me-login" class="text-sm text-gray-600">Remember me for 30 days</label>
                    </div>
                </div>

                <button onclick="loginStudent()" class="w-full bg-brand-primary text-white font-bold py-5 rounded-2xl shadow-xl hover:-translate-y-1 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        id="login-btn">
                    <span id="login-text">Login to Portal</span>
                    <span id="login-loading" class="hidden">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Verifying...
                    </span>
                </button>
                
                <button onclick="signInWithGoogle()" class="w-full google-btn font-semibold py-4 rounded-2xl flex items-center justify-center gap-3 hover:shadow-md">
                    <img src="https://www.google.com/favicon.ico" alt="Google" class="w-5 h-5">
                    Continue with Google
                </button>
                
                <p class="text-center text-sm text-gray-500 mt-4">
                    Haven't activated your account? <a href="javascript:void(0)" onclick="switchTab('activate')" class="text-brand-primary font-semibold hover:underline">Switch to Activation</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal-bg hidden-step">
        <div class="bg-white rounded-4xl p-8 max-w-md w-full space-y-6 mx-4">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-900">Reset Password</h3>
                <button onclick="hideForgotPassword()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="text-gray-600">Enter your email address and we'll send you a password reset link.</p>
            
            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1">Email Address</label>
                <input type="email" id="reset-email" placeholder="student@email.com" 
                    class="w-full px-6 py-4 rounded-2xl bg-gray-50 border border-gray-100 outline-none focus:ring-4 focus:ring-emerald-50">
            </div>
            
            <div class="flex space-x-3">
                <button onclick="hideForgotPassword()" class="flex-1 px-6 py-3 rounded-2xl border border-gray-300 text-gray-700 font-semibold hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button onclick="sendPasswordReset()" class="flex-1 px-6 py-3 rounded-2xl bg-brand-primary text-white font-semibold hover:bg-emerald-700 transition-colors"
                        id="reset-btn">
                    <span id="reset-text">Send Reset Link</span>
                    <span id="reset-loading" class="hidden">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Sending...
                    </span>
                </button>
            </div>
            
            <p class="text-xs text-gray-500 text-center">
                The reset link will expire in 1 hour for security.
            </p>
        </div>
    </div>

    <script type="module">
        // IMPORTANT: Replace with your actual reCAPTCHA site key
        const RECAPTCHA_SITE_KEY = 'YOUR_RECAPTCHA_SITE_KEY_HERE';
        
        import { auth, db } from './firebaseConfig-studentsignupmodular.js';
        import { 
            collection, 
            query, 
            where, 
            getDocs, 
            doc, 
            updateDoc, 
            setDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            updateProfile, 
            signInWithPopup, 
            GoogleAuthProvider,
            sendPasswordResetEmail,
            setPersistence,
            browserSessionPersistence,
            browserLocalPersistence,
            signOut
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

        // Security: Rate limiting variables
        let failedAttempts = 0;
        let lastAttemptTime = 0;
        const MAX_ATTEMPTS = 5;
        const LOCKOUT_TIME = 15 * 60 * 1000; // 15 minutes

        // Toast notification system
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, duration);
        }

        // Password strength checker - FIXED
        window.checkPasswordStrength = () => {
            const password = document.getElementById('student-pass').value;
            const meter = document.getElementById('password-strength');
            const requirements = document.getElementById('password-requirements');
            
            if (!password) {
                meter.className = 'password-strength-meter';
                // Reset all requirements
                document.querySelectorAll('#password-requirements li').forEach(li => {
                    li.classList.remove('valid');
                });
                return;
            }
            
            // Check requirements
            const hasLength = password.length >= 12;
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            
            // Update requirement indicators
            document.getElementById('req-length').classList.toggle('valid', hasLength);
            document.getElementById('req-uppercase').classList.toggle('valid', hasUpper);
            document.getElementById('req-lowercase').classList.toggle('valid', hasLower);
            document.getElementById('req-number').classList.toggle('valid', hasNumber);
            document.getElementById('req-special').classList.toggle('valid', hasSpecial);
            
            // Calculate strength score (0-4)
            let score = 0;
            if (hasLength) score++;
            if (hasUpper) score++;
            if (hasLower) score++;
            if (hasNumber) score++;
            if (hasSpecial) score++;
            
            // Update strength meter
            meter.className = `password-strength-meter strength-${score}`;
            
            // Enable/disable activation button based on minimum requirements
            const activateBtn = document.getElementById('activate-btn');
            const minRequirementsMet = hasLength && hasUpper && hasLower && hasNumber && hasSpecial;
            activateBtn.disabled = !minRequirementsMet;
        };

        // Toggle password visibility - FIXED
        window.togglePasswordVisibility = (inputId) => {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'far fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'far fa-eye';
            }
        };

        // Tab switching - FIXED
        window.switchTab = (tab) => {
            const activateTab = document.getElementById('tab-activate');
            const loginTab = document.getElementById('tab-login');
            const activationFlow = document.getElementById('activation-flow');
            const loginFlow = document.getElementById('login-flow');
            
            if (tab === 'activate') {
                activateTab.classList.add('active');
                activateTab.classList.remove('text-gray-600');
                loginTab.classList.remove('active');
                loginTab.classList.add('text-gray-600');
                activationFlow.classList.remove('hidden-step');
                loginFlow.classList.add('hidden-step');
                // Reset to step 1
                document.getElementById('step-1').classList.remove('hidden-step');
                document.getElementById('step-2').classList.add('hidden-step');
                resetRateLimiting();
            } else {
                loginTab.classList.add('active');
                loginTab.classList.remove('text-gray-600');
                activateTab.classList.remove('active');
                activateTab.classList.add('text-gray-600');
                loginFlow.classList.remove('hidden-step');
                activationFlow.classList.add('hidden-step');
                resetRateLimiting();
            }
        };

        // Go back to step 1
        window.goBackToStep1 = () => {
            document.getElementById('step-1').classList.remove('hidden-step');
            document.getElementById('step-2').classList.add('hidden-step');
        };

        // Show/hide forgot password - FIXED
        window.showForgotPassword = () => {
            document.getElementById('forgot-password-modal').classList.remove('hidden-step');
        };

        window.hideForgotPassword = () => {
            document.getElementById('forgot-password-modal').classList.add('hidden-step');
        };

        // Reset rate limiting
        function resetRateLimiting() {
            failedAttempts = 0;
            document.getElementById('rate-limit-warning').classList.add('hidden');
            document.getElementById('failed-attempts-warning').classList.add('hidden');
        }

        // Check if rate limited
        function checkRateLimit() {
            const now = Date.now();
            if (failedAttempts >= MAX_ATTEMPTS) {
                if (now - lastAttemptTime < LOCKOUT_TIME) {
                    const remainingMinutes = Math.ceil((LOCKOUT_TIME - (now - lastAttemptTime)) / 60000);
                    document.getElementById('rate-limit-message').textContent = 
                        `Too many attempts. Please try again in ${remainingMinutes} minutes.`;
                    document.getElementById('rate-limit-warning').classList.remove('hidden');
                    return true;
                } else {
                    // Reset after lockout period
                    failedAttempts = 0;
                }
            }
            return false;
        }

        // Get reCAPTCHA token - FIXED
        async function getRecaptchaToken(action) {
            return new Promise((resolve) => {
                if (typeof grecaptcha === 'undefined') {
                    console.warn('reCAPTCHA not loaded');
                    resolve('dev-token'); // For development only
                    return;
                }
                
                grecaptcha.ready(() => {
                    grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: action })
                        .then(token => resolve(token))
                        .catch(error => {
                            console.error('reCAPTCHA error:', error);
                            resolve(null);
                        });
                });
            });
        }

        // Original activation functions with security enhancements - FIXED
        window.findStudents = async () => {
            // Check rate limiting
            if (checkRateLimit()) return;
            
            const email = document.getElementById('parent-email').value.trim();
            if(!email) {
                showToast('Please enter the parent email.', 'error');
                return;
            }

            // Get reCAPTCHA token
            const recaptchaToken = await getRecaptchaToken('find_students');
            
            try {
                // Show loading
                document.getElementById('find-profile-text').classList.add('hidden');
                document.getElementById('find-profile-loading').classList.remove('hidden');
                document.getElementById('find-profile-btn').disabled = true;

                // Query students collection - NOT parent_users
                const q = query(collection(db, "students"), where("parentEmail", "==", email));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showToast('No student records found for this email.', 'error');
                    failedAttempts++;
                    lastAttemptTime = Date.now();
                    return;
                }

                const select = document.getElementById('student-select');
                select.innerHTML = '<option value="">Select your name</option>';
                let foundInactive = false;
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    // Only show students who haven't been activated yet
                    if (!data.studentUid || data.status !== 'active') {
                        const opt = document.createElement('option');
                        opt.value = doc.id;
                        opt.textContent = data.studentName + (data.grade ? ` - Grade ${data.grade}` : '');
                        select.appendChild(opt);
                        foundInactive = true;
                    }
                });
                
                if (foundInactive) {
                    document.getElementById('step-1').classList.add('hidden-step');
                    document.getElementById('step-2').classList.remove('hidden-step');
                    showToast('Students found! Please select your name.', 'success');
                } else {
                    showToast('All students under this email are already activated. Please login instead.', 'info');
                    switchTab('login');
                }
            } catch (error) {
                console.error('Error finding students:', error);
                showToast('An error occurred. Please try again.', 'error');
                failedAttempts++;
                lastAttemptTime = Date.now();
            } finally {
                // Reset loading state
                document.getElementById('find-profile-text').classList.remove('hidden');
                document.getElementById('find-profile-loading').classList.add('hidden');
                document.getElementById('find-profile-btn').disabled = false;
            }
        };

        window.completeRegistration = async () => {
            const docId = document.getElementById('student-select').value;
            const email = document.getElementById('student-email-input').value.trim();
            const pass = document.getElementById('student-pass').value;
            const rememberMe = document.getElementById('remember-me-activation').checked;

            if (!docId || docId === "") {
                showToast('Please select your name from the list.', 'error');
                return;
            }

            // Validate password strength
            const hasLength = pass.length >= 12;
            const hasUpper = /[A-Z]/.test(pass);
            const hasLower = /[a-z]/.test(pass);
            const hasNumber = /\d/.test(pass);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(pass);
            
            if(!email || !hasLength || !hasUpper || !hasLower || !hasNumber || !hasSpecial) {
                showToast('Please enter a valid email and strong password meeting all requirements.', 'error');
                return;
            }

            try {
                // Show loading
                document.getElementById('activate-text').classList.add('hidden');
                document.getElementById('activate-loading').classList.remove('hidden');
                document.getElementById('activate-btn').disabled = true;

                // Get reCAPTCHA token
                const recaptchaToken = await getRecaptchaToken('complete_registration');

                // Set persistence based on "Remember Me"
                const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, persistence);

                // Check if email already exists in students collection
                const emailCheck = query(collection(db, "students"), where("studentEmail", "==", email));
                const emailSnapshot = await getDocs(emailCheck);
                
                if (!emailSnapshot.empty) {
                    showToast('This email is already registered. Please use a different email or login.', 'error');
                    return;
                }

                // Create user in Firebase Auth
                const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                const studentName = document.getElementById('student-select').options[document.getElementById('student-select').selectedIndex].text.split(' - ')[0];
                
                // Update the students collection - NOT parent_users
                await updateDoc(doc(db, "students", docId), {
                    studentUid: userCred.user.uid,
                    studentEmail: email,
                    status: 'active',
                    activatedAt: serverTimestamp(),
                    lastLogin: serverTimestamp(),
                    security: {
                        passwordChangedAt: serverTimestamp(),
                        mfaEnabled: false
                    }
                });

                // Create audit log
                await setDoc(doc(collection(db, "audit_logs")), {
                    action: 'student_activation',
                    studentId: docId,
                    studentName: studentName,
                    email: email,
                    timestamp: serverTimestamp(),
                    userAgent: navigator.userAgent
                });

                await updateProfile(userCred.user, { 
                    displayName: studentName
                });

                showToast('Account activated successfully! Redirecting...', 'success');
                
                // Store session info
                if (rememberMe) {
                    localStorage.setItem('student_remember_me', 'true');
                    localStorage.setItem('student_email', email);
                }
                
                setTimeout(() => {
                    window.location.href = 'BKHstudentlogin.html';
                }, 2000);

            } catch (error) {
                console.error('Registration error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showToast('Email already registered. Please login instead.', 'error');
                    switchTab('login');
                } else if (error.code === 'auth/weak-password') {
                    showToast('Password is too weak. Please use a stronger password.', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    showToast('Invalid email format.', 'error');
                } else {
                    showToast('Registration failed: ' + error.message, 'error');
                }
            } finally {
                document.getElementById('activate-text').classList.remove('hidden');
                document.getElementById('activate-loading').classList.add('hidden');
                document.getElementById('activate-btn').disabled = false;
            }
        };

        // Login function with enhanced security - FIXED
        window.loginStudent = async () => {
            // Check rate limiting
            if (checkRateLimit()) {
                return;
            }
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me-login').checked;

            if (!email || !password) {
                showToast('Please enter both email and password.', 'error');
                return;
            }

            try {
                // Show loading
                document.getElementById('login-text').classList.add('hidden');
                document.getElementById('login-loading').classList.remove('hidden');
                document.getElementById('login-btn').disabled = true;

                // Get reCAPTCHA token
                const recaptchaToken = await getRecaptchaToken('login');

                // Set persistence
                const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, persistence);

                // Attempt login
                const userCred = await signInWithEmailAndPassword(auth, email, password);
                
                // Verify the user exists in students collection
                const q = query(collection(db, "students"), where("studentUid", "==", userCred.user.uid));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    await signOut(auth);
                    showToast('Student account not found in database. Please contact support.', 'error');
                    failedAttempts++;
                    lastAttemptTime = Date.now();
                    return;
                }

                // Update last login
                const studentDoc = querySnapshot.docs[0];
                await updateDoc(doc(db, "students", studentDoc.id), {
                    lastLogin: serverTimestamp(),
                    failedAttempts: 0 // Reset on successful login
                });

                // Create audit log
                await setDoc(doc(collection(db, "audit_logs")), {
                    action: 'student_login',
                    studentId: studentDoc.id,
                    studentName: studentDoc.data().studentName,
                    timestamp: serverTimestamp(),
                    userAgent: navigator.userAgent,
                    rememberMe: rememberMe
                });

                // Store session info
                if (rememberMe) {
                    localStorage.setItem('student_remember_me', 'true');
                    localStorage.setItem('student_email', email);
                } else {
                    localStorage.removeItem('student_remember_me');
                    localStorage.removeItem('student_email');
                }

                // Reset failed attempts
                failedAttempts = 0;
                
                showToast('Login successful! Redirecting...', 'success');
                
                setTimeout(() => {
                    window.location.href = 'BKHstudentlogin.html';
                }, 1500);

            } catch (error) {
                console.error('Login error:', error);
                failedAttempts++;
                lastAttemptTime = Date.now();
                
                // Update failed attempts warning
                const remainingAttempts = MAX_ATTEMPTS - failedAttempts;
                if (remainingAttempts > 0) {
                    document.getElementById('failed-attempts-message').textContent = 
                        `Invalid credentials. ${remainingAttempts} attempt${remainingAttempts > 1 ? 's' : ''} remaining.`;
                    document.getElementById('failed-attempts-warning').classList.remove('hidden');
                } else {
                    document.getElementById('failed-attempts-message').textContent = 
                        `Account locked. Please try again in 15 minutes or reset your password.`;
                    document.getElementById('failed-attempts-warning').classList.remove('hidden');
                }

                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    showToast('Invalid email or password.', 'error');
                } else if (error.code === 'auth/user-disabled') {
                    showToast('Account disabled. Please contact support.', 'error');
                } else if (error.code === 'auth/too-many-requests') {
                    showToast('Too many failed attempts. Account temporarily locked.', 'error');
                } else {
                    showToast('Login failed: ' + error.message, 'error');
                }
                
                // Shake animation for failed login
                document.getElementById('login-flow').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('login-flow').classList.remove('shake');
                }, 500);
            } finally {
                document.getElementById('login-text').classList.remove('hidden');
                document.getElementById('login-loading').classList.add('hidden');
                document.getElementById('login-btn').disabled = false;
            }
        };

        // Google Sign-in functions - FIXED
        window.signInWithGoogle = async () => {
            try {
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                provider.setCustomParameters({
                    prompt: 'select_account'
                });

                // Set persistence based on checkbox
                const rememberMe = document.getElementById('remember-me-login').checked;
                const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, persistence);

                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // Check if this Google user is in our students collection
                const q = query(collection(db, "students"), where("studentUid", "==", user.uid));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // Update last login
                    const studentDoc = querySnapshot.docs[0];
                    await updateDoc(doc(db, "students", studentDoc.id), {
                        lastLogin: serverTimestamp()
                    });

                    // Store session info
                    if (rememberMe) {
                        localStorage.setItem('student_remember_me', 'true');
                        localStorage.setItem('student_email', user.email);
                    }
                    
                    window.location.href = 'BKHstudentlogin.html';
                    return;
                }

                // Check if they have a matching email in students collection
                const emailQ = query(collection(db, "students"), where("studentEmail", "==", user.email));
                const emailSnapshot = await getDocs(emailQ);
                
                if (!emailSnapshot.empty) {
                    // Link the Google account to existing student record
                    const docId = emailSnapshot.docs[0].id;
                    await updateDoc(doc(db, "students", docId), {
                        studentUid: user.uid,
                        lastLogin: serverTimestamp()
                    });
                    
                    if (rememberMe) {
                        localStorage.setItem('student_remember_me', 'true');
                        localStorage.setItem('student_email', user.email);
                    }
                    
                    window.location.href = 'BKHstudentlogin.html';
                    return;
                }

                // No matching account found
                await signOut(auth);
                showToast('No student account found for this Google account. Please activate your account first.', 'error');
                
            } catch (error) {
                console.error("Google sign-in error:", error);
                if (error.code === 'auth/unauthorized-domain') {
                    showToast('Google sign-in not configured for this domain. Please contact administrator.', 'error');
                } else if (error.code === 'auth/popup-blocked') {
                    showToast('Popup blocked. Please allow popups for this site.', 'error');
                } else if (error.code === 'auth/popup-closed-by-user') {
                    showToast('Sign-in cancelled.', 'info');
                } else {
                    showToast('Google sign-in failed: ' + error.message, 'error');
                }
            }
        };

        window.signInWithGoogleForActivation = async () => {
            try {
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');

                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // Check if this Google user already has a student account
                const q = query(collection(db, "students"), where("studentUid", "==", user.uid));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    showToast('You already have an activated account. Please login instead.', 'info');
                    switchTab('login');
                    await signOut(auth);
                    return;
                }

                // Proceed to step 2 for profile selection
                document.getElementById('student-email-input').value = user.email;
                document.getElementById('step-1').classList.add('hidden-step');
                document.getElementById('step-2').classList.remove('hidden-step');
                
            } catch (error) {
                console.error("Google sign-in error:", error);
                if (error.code === 'auth/unauthorized-domain') {
                    showToast('Google sign-in not configured for this domain. Please contact administrator.', 'error');
                } else {
                    showToast('Google sign-in failed: ' + error.message, 'error');
                }
            }
        };

        // Password reset function - FIXED
        window.sendPasswordReset = async () => {
            const email = document.getElementById('reset-email').value.trim();
            
            if (!email) {
                showToast('Please enter your email address.', 'error');
                return;
            }

            try {
                // Show loading
                document.getElementById('reset-text').classList.add('hidden');
                document.getElementById('reset-loading').classList.remove('hidden');
                document.getElementById('reset-btn').disabled = true;

                // Check if email exists in students collection
                const emailQ = query(collection(db, "students"), where("studentEmail", "==", email));
                const emailSnapshot = await getDocs(emailQ);
                
                if (emailSnapshot.empty) {
                    showToast('No student account found with this email.', 'error');
                    return;
                }

                // Send password reset email
                await sendPasswordResetEmail(auth, email, {
                    url: window.location.origin + '/BKHstudentlogin.html',
                    handleCodeInApp: false
                });

                // Create audit log
                await setDoc(doc(collection(db, "audit_logs")), {
                    action: 'password_reset_requested',
                    email: email,
                    timestamp: serverTimestamp(),
                    userAgent: navigator.userAgent
                });

                showToast('Password reset link sent! Check your email.', 'success');
                setTimeout(() => {
                    hideForgotPassword();
                }, 2000);

            } catch (error) {
                console.error('Password reset error:', error);
                if (error.code === 'auth/user-not-found') {
                    showToast('No account found with this email.', 'error');
                } else if (error.code === 'auth/too-many-requests') {
                    showToast('Too many reset attempts. Please try again later.', 'error');
                } else {
                    showToast('Failed to send reset email: ' + error.message, 'error');
                }
            } finally {
                document.getElementById('reset-text').classList.remove('hidden');
                document.getElementById('reset-loading').classList.add('hidden');
                document.getElementById('reset-btn').disabled = false;
            }
        };

        // Auto-fill remembered email on page load
        document.addEventListener('DOMContentLoaded', () => {
            const rememberedEmail = localStorage.getItem('student_email');
            const rememberMe = localStorage.getItem('student_remember_me') === 'true';
            
            if (rememberedEmail && rememberMe) {
                document.getElementById('login-email').value = rememberedEmail;
                document.getElementById('remember-me-login').checked = true;
            }
        });

    </script>
</body>
</html>
