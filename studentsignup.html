<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com; img-src 'self' https: data:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <title>Secure Student Portal | Intelligent LMS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 
                            light: '#f0fdf4', 
                            primary: '#059669', 
                            dark: '#064e3b', 
                            accent: '#fbbf24', 
                            danger: '#dc2626' 
                        }
                    },
                    borderRadius: { 
                        '4xl': '2rem',
                        '5xl': '2.5rem'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            min-height: 100vh;
            line-height: 1.5;
        }
        
        .hero-gradient { 
            background: linear-gradient(135deg, #064e3b 0%, #059669 100%); 
        }
        
        .hidden-step { 
            display: none !important; 
        }
        
        .glass { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(10px); 
        }
        
        .google-btn {
            background: white;
            color: #757575;
            border: 1px solid #ddd;
            transition: all 0.3s ease;
        }
        
        .google-btn:hover {
            background: #f8f8f8;
            border-color: #ccc;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .tab-btn {
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .tab-btn.active {
            background: #059669;
            color: white;
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);
        }
        
        .password-strength-meter {
            height: 6px;
            margin-top: 6px;
            border-radius: 3px;
            transition: all 0.4s ease;
            background: #e5e7eb;
            overflow: hidden;
        }
        
        .password-strength-meter .strength-fill {
            height: 100%;
            transition: all 0.4s ease;
        }
        
        .strength-0 .strength-fill { width: 20%; background: #dc2626; }
        .strength-1 .strength-fill { width: 40%; background: #f97316; }
        .strength-2 .strength-fill { width: 60%; background: #eab308; }
        .strength-3 .strength-fill { width: 80%; background: #22c55e; }
        .strength-4 .strength-fill { width: 100%; background: #16a34a; }
        
        .password-requirements li {
            transition: all 0.3s ease;
            color: #6b7280;
            list-style: none;
            padding-left: 1.5rem;
            position: relative;
        }
        
        .password-requirements li:before {
            content: '○';
            position: absolute;
            left: 0;
            color: #9ca3af;
        }
        
        .password-requirements li.valid {
            color: #16a34a;
        }
        
        .password-requirements li.valid:before {
            content: '✓';
            color: #16a34a;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 10px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: normal;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            pointer-events: none;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        .fade-in { 
            animation: fadeIn 0.5s ease-in; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .slide-in-right {
            animation: slideInRight 0.5s ease-out;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 9999;
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toast.show { 
            transform: translateX(0); 
        }
        
        .toast.success { 
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); 
            border-left: 4px solid #15803d;
        }
        
        .toast.error { 
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); 
            border-left: 4px solid #b91c1c;
        }
        
        .toast.warning { 
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); 
            border-left: 4px solid #d97706;
        }
        
        .toast.info { 
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); 
            border-left: 4px solid #1d4ed8;
        }
        
        /* Modal Background */
        .modal-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        /* Loading Spinner */
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Input focus styles */
        input:focus, select:focus, button:focus {
            outline: none;
            ring: 4px;
        }
        
        /* Custom checkbox */
        input[type="checkbox"] {
            accent-color: #059669;
        }
        
        /* Smooth transitions */
        .transition-all-custom {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Security badge */
        .security-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(22, 163, 74, 0.1);
            color: #16a34a;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <div class="flex flex-col lg:flex-row w-full max-w-5xl bg-white rounded-5xl shadow-2xl overflow-hidden min-h-[700px] border border-gray-100">
        <!-- Left Side - Hero Section -->
        <div class="hidden lg:flex lg:w-2/5 hero-gradient p-12 flex-col justify-between text-white relative overflow-hidden">
            <!-- Background patterns -->
            <div class="absolute top-0 left-0 w-40 h-40 bg-white/10 rounded-full -translate-x-20 -translate-y-20"></div>
            <div class="absolute bottom-0 right-0 w-56 h-56 bg-white/10 rounded-full translate-x-28 translate-y-28"></div>
            <div class="absolute top-1/2 left-1/2 w-32 h-32 bg-white/5 rounded-full -translate-x-1/2 -translate-y-1/2"></div>
            
            <div class="relative space-y-6 z-10">
                <div class="bg-white/20 p-5 rounded-3xl w-fit backdrop-blur-sm border border-white/30">
                    <i class="fas fa-shield-alt text-3xl text-accent"></i>
                </div>
                <h1 class="text-5xl font-black leading-tight tracking-tight">
                    Secure <br>Student <br><span class="text-accent">Portal.</span>
                </h1>
                <p class="text-emerald-100/90 text-lg font-medium leading-relaxed">
                    Enterprise-grade security with military-grade encryption. Your data is protected 24/7 with automated threat detection.
                </p>
                
                <!-- Security Features List -->
                <div class="space-y-4 mt-10">
                    <div class="flex items-center space-x-4 p-3 rounded-2xl bg-white/10 backdrop-blur-sm">
                        <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                            <i class="fas fa-lock text-accent"></i>
                        </div>
                        <div>
                            <h4 class="font-bold">End-to-end encryption</h4>
                            <p class="text-emerald-100/70 text-sm">All data encrypted in transit and at rest</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4 p-3 rounded-2xl bg-white/10 backdrop-blur-sm">
                        <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                            <i class="fas fa-user-shield text-accent"></i>
                        </div>
                        <div>
                            <h4 class="font-bold">GDPR & COPPA compliant</h4>
                            <p class="text-emerald-100/70 text-sm">Full compliance with privacy regulations</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4 p-3 rounded-2xl bg-white/10 backdrop-blur-sm">
                        <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                            <i class="fas fa-search text-accent"></i>
                        </div>
                        <div>
                            <h4 class="font-bold">Regular security audits</h4>
                            <p class="text-emerald-100/70 text-sm">Continuous monitoring and penetration testing</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="relative z-10">
                <div class="flex items-center justify-between text-xs opacity-70">
                    <div class="security-badge">
                        <i class="fas fa-shield-check"></i>
                        ISO 27001 Certified
                    </div>
                    <span>Powered by Blue Ocean Concepts</span>
                </div>
            </div>
        </div>

        <!-- Right Side - Auth Forms -->
        <div class="w-full lg:w-3/5 p-8 lg:p-16 flex flex-col justify-center">
            
            <!-- Logo for Mobile -->
            <div class="lg:hidden mb-10 text-center">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-brand-primary to-brand-dark rounded-3xl mb-6 shadow-lg">
                    <i class="fas fa-shield-alt text-4xl text-white"></i>
                </div>
                <h2 class="text-3xl font-black text-gray-900 mb-2">Secure Student Portal</h2>
                <p class="text-gray-600">Enterprise-grade security for your education</p>
            </div>
            
            <!-- Tabs for Activation vs Login -->
            <div class="flex mb-10 bg-gray-100 p-2 rounded-3xl w-fit mx-auto border border-gray-200">
                <button id="tab-activate" class="tab-btn active px-8 py-4 rounded-3xl font-bold text-lg" onclick="switchTab('activate')">
                    <i class="fas fa-user-plus mr-2"></i>Activate Account
                </button>
                <button id="tab-login" class="tab-btn px-8 py-4 rounded-3xl font-bold text-lg text-gray-600" onclick="switchTab('login')">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                </button>
            </div>

            <!-- Activation Flow -->
            <div id="activation-flow" class="space-y-6">
                <!-- Step 1: Parent Verification -->
                <div id="step-1" class="space-y-6 fade-in">
                    <div class="mb-10">
                        <h3 class="text-4xl font-black text-gray-900 mb-3">Verify Parent</h3>
                        <p class="text-gray-600 text-lg">Enter the email address used during your parent's registration.</p>
                    </div>
                    
                    <!-- Rate Limiting Indicator -->
                    <div id="rate-limit-warning" class="hidden p-5 bg-yellow-50 border-2 border-yellow-200 rounded-3xl text-sm text-yellow-800">
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-exclamation-triangle text-xl mt-0.5"></i>
                            <div>
                                <h4 class="font-bold mb-1">Too Many Attempts</h4>
                                <p id="rate-limit-message"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-widest ml-2 flex items-center">
                            <i class="fas fa-envelope mr-2"></i>Parent's Registered Email
                            <span class="tooltip ml-2">
                                <i class="fas fa-question-circle text-gray-400"></i>
                                <span class="tooltip-text">This must match exactly the email your parent used during registration. Contact your parent if you're unsure.</span>
                            </span>
                        </label>
                        <div class="relative">
                            <i class="fas fa-at absolute left-5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="email" id="parent-email" placeholder="parent@email.com" 
                                class="w-full pl-12 pr-5 py-5 rounded-3xl bg-gray-50 border-2 border-gray-200 outline-none focus:border-brand-primary focus:ring-4 focus:ring-emerald-50 transition-all-custom text-lg"
                                autocomplete="email" required>
                        </div>
                        <p class="text-xs text-gray-500 ml-2">Enter the exact email your parent registered with</p>
                    </div>
                    
                    <button onclick="findStudents()" 
                            class="w-full bg-gradient-to-r from-brand-primary to-brand-dark text-white font-black py-6 rounded-3xl shadow-xl hover:shadow-2xl hover:-translate-y-1 active:scale-[0.98] transition-all-custom disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none"
                            id="find-profile-btn">
                        <span id="find-profile-text" class="flex items-center justify-center">
                            <i class="fas fa-search mr-3"></i>Find My Profile
                        </span>
                        <span id="find-profile-loading" class="hidden items-center justify-center">
                            <i class="fas fa-spinner spinner mr-3"></i>Verifying...
                        </span>
                    </button>
                    
                    <!-- Divider with Google Sign-in option -->
                    <div class="relative py-6">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t-2 border-gray-200"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-5 bg-white text-gray-500 font-medium">Or activate with</span>
                        </div>
                    </div>
                    
                    <button onclick="signInWithGoogleForActivation()" 
                            class="w-full google-btn font-bold py-5 rounded-3xl flex items-center justify-center gap-4 hover:shadow-lg text-lg">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-6 h-6">
                        Google Account
                    </button>
                    
                    <div class="pt-4 border-t border-gray-100">
                        <p class="text-sm text-gray-600 text-center">
                            <i class="fas fa-lock mr-2"></i>Your information is secured with 256-bit encryption
                        </p>
                    </div>
                </div>

                <!-- Step 2: Claim Profile -->
                <div id="step-2" class="hidden-step space-y-6 slide-in-right">
                    <button onclick="goBackToStep1()" 
                            class="flex items-center text-gray-600 hover:text-gray-900 transition-colors mb-2 group">
                        <i class="fas fa-arrow-left mr-3 group-hover:-translate-x-1 transition-transform"></i> 
                        <span class="font-semibold">Back to verification</span>
                    </button>
                    
                    <div class="mb-10">
                        <h3 class="text-4xl font-black text-gray-900 mb-3">Claim Profile</h3>
                        <p class="text-gray-600 text-lg">Select your name and set up secure login credentials.</p>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="space-y-3">
                            <label class="text-sm font-bold text-gray-500 uppercase tracking-widest ml-2 flex items-center">
                                <i class="fas fa-user mr-2"></i>Who are you?
                            </label>
                            <div class="relative">
                                <i class="fas fa-child absolute left-5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <select id="student-select" 
                                        class="w-full pl-12 pr-5 py-5 rounded-3xl bg-gray-50 border-2 border-gray-200 outline-none focus:border-brand-primary focus:ring-4 focus:ring-emerald-50 transition-all-custom cursor-pointer text-lg appearance-none">
                                    <option value="">Select your name</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-5 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <label class="text-sm font-bold text-gray-500 uppercase tracking-widest ml-2 flex items-center">
                                <i class="fas fa-envelope mr-2"></i>Login Email (Student)
                            </label>
                            <div class="relative">
                                <i class="fas fa-at absolute left-5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="email" id="student-email-input" placeholder="student@email.com" 
                                    class="w-full pl-12 pr-5 py-5 rounded-3xl bg-gray-50 border-2 border-gray-200 outline-none focus:border-brand-primary focus:ring-4 focus:ring-emerald-50 transition-all-custom text-lg"
                                    autocomplete="email" required>
                            </div>
                            <p class="text-xs text-gray-500 ml-2">This will be your login email for future access</p>
                        </div>

                        <div class="space-y-3">
                            <label class="text-sm font-bold text-gray-500 uppercase tracking-widest ml-2 flex items-center">
                                <i class="fas fa-lock mr-2"></i>Create Password
                                <span class="tooltip ml-2">
                                    <i class="fas fa-question-circle text-gray-400"></i>
                                    <span class="tooltip-text">Strong passwords include uppercase & lowercase letters, numbers, and special characters. Minimum 12 characters required.</span>
                                </span>
                            </label>
                            <div class="relative">
                                <i class="fas fa-key absolute left-5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="password" id="student-pass" placeholder="••••••••••••" 
                                    class="w-full pl-12 pr-14 py-5 rounded-3xl bg-gray-50 border-2 border-gray-200 outline-none focus:border-brand-primary focus:ring-4 focus:ring-emerald-50 transition-all-custom text-lg"
                                    oninput="checkPasswordStrength()" minlength="12" required>
                                <button type="button" class="absolute right-5 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 transition-colors"
                                        onclick="togglePasswordVisibility('student-pass')">
                                    <i class="far fa-eye" id="eye-icon-student"></i>
                                </button>
                            </div>
                            
                            <!-- Password Strength Meter -->
                            <div class="mt-4">
                                <div class="flex justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">Password Strength</span>
                                    <span id="strength-text" class="text-sm font-bold">Weak</span>
                                </div>
                                <div class="password-strength-meter" id="password-strength-meter">
                                    <div class="strength-fill"></div>
                                </div>
                            </div>
                            
                            <!-- Password Requirements -->
                            <ul class="password-requirements text-sm space-y-2 mt-4" id="password-requirements">
                                <li id="req-length">At least 12 characters</li>
                                <li id="req-uppercase">One uppercase letter (A-Z)</li>
                                <li id="req-lowercase">One lowercase letter (a-z)</li>
                                <li id="req-number">One number (0-9)</li>
                                <li id="req-special">One special character (!@#$%^&*)</li>
                            </ul>
                        </div>
                        
                        <!-- Remember Me -->
                        <div class="flex items-center space-x-3 pt-4">
                            <input type="checkbox" id="remember-me-activation" 
                                   class="w-6 h-6 rounded-lg text-brand-primary focus:ring-4 focus:ring-emerald-50">
                            <label for="remember-me-activation" class="text-gray-700 font-medium cursor-pointer">
                                <i class="fas fa-history mr-2"></i>Remember me for 30 days
                            </label>
                        </div>
                    </div>

                    <button onclick="completeRegistration()" 
                            class="w-full bg-gradient-to-r from-brand-accent to-yellow-500 text-emerald-900 font-black py-6 rounded-3xl shadow-xl hover:shadow-2xl hover:-translate-y-1 active:scale-[0.98] transition-all-custom disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none"
                            id="activate-btn">
                        <span id="activate-text" class="flex items-center justify-center">
                            <i class="fas fa-rocket mr-3"></i>Activate My Portal
                        </span>
                        <span id="activate-loading" class="hidden items-center justify-center">
                            <i class="fas fa-spinner spinner mr-3"></i>Securing Account...
                        </span>
                    </button>
                    
                    <p class="text-center text-gray-600 mt-6">
                        Already activated? 
                        <a href="javascript:void(0)" onclick="switchTab('login')" 
                           class="text-brand-primary font-bold hover:underline ml-1 transition-colors">
                            Switch to Login
                        </a>
                    </p>
                </div>
            </div>

            <!-- Login Flow -->
            <div id="login-flow" class="hidden-step space-y-6 fade-in">
                <div class="mb-10">
                    <h3 class="text-4xl font-black text-gray-900 mb-3">Student Login</h3>
                    <p class="text-gray-600 text-lg">Welcome back! Enter your credentials to access your portal.</p>
                </div>
                
                <!-- Failed Attempts Warning -->
                <div id="failed-attempts-warning" class="hidden p-5 bg-red-50 border-2 border-red-200 rounded-3xl text-sm text-red-800">
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-exclamation-circle text-xl mt-0.5"></i>
                        <div>
                            <h4 class="font-bold mb-1">Security Alert</h4>
                            <p id="failed-attempts-message"></p>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-6">
                    <div class="space-y-3">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-widest ml-2 flex items-center">
                            <i class="fas fa-envelope mr-2"></i>Student Email
                        </label>
                        <div class="relative">
                            <i class="fas fa-at absolute left-5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="email" id="login-email" placeholder="student@email.com" 
                                class="w-full pl-12 pr-5 py-5 rounded-3xl bg-gray-50 border-2 border-gray-200 outline-none focus:border-brand-primary focus:ring-4 focus:ring-emerald-50 transition-all-custom text-lg"
                                autocomplete="username" required>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-bold text-gray-500 uppercase tracking-widest ml-2 flex items-center">
                                <i class="fas fa-lock mr-2"></i>Password
                            </label>
                            <a href="javascript:void(0)" onclick="showForgotPassword()" 
                               class="text-sm text-brand-primary hover:underline font-bold transition-colors">
                                Forgot Password?
                            </a>
                        </div>
                        <div class="relative">
                            <i class="fas fa-key absolute left-5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="password" id="login-password" placeholder="••••••••" 
                                class="w-full pl-12 pr-14 py-5 rounded-3xl bg-gray-50 border-2 border-gray-200 outline-none focus:border-brand-primary focus:ring-4 focus:ring-emerald-50 transition-all-custom text-lg"
                                autocomplete="current-password" required>
                            <button type="button" class="absolute right-5 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 transition-colors"
                                    onclick="togglePasswordVisibility('login-password')">
                                <i class="far fa-eye" id="eye-icon-login"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Remember Me -->
                    <div class="flex items-center space-x-3 pt-2">
                        <input type="checkbox" id="remember-me-login" 
                               class="w-6 h-6 rounded-lg text-brand-primary focus:ring-4 focus:ring-emerald-50" checked>
                        <label for="remember-me-login" class="text-gray-700 font-medium cursor-pointer">
                            <i class="fas fa-history mr-2"></i>Remember me for 30 days
                        </label>
                    </div>
                </div>

                <button onclick="loginStudent()" 
                        class="w-full bg-gradient-to-r from-brand-primary to-brand-dark text-white font-black py-6 rounded-3xl shadow-xl hover:shadow-2xl hover:-translate-y-1 active:scale-[0.98] transition-all-custom disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none"
                        id="login-btn">
                    <span id="login-text" class="flex items-center justify-center">
                        <i class="fas fa-sign-in-alt mr-3"></i>Login to Portal
                    </span>
                    <span id="login-loading" class="hidden items-center justify-center">
                        <i class="fas fa-spinner spinner mr-3"></i>Verifying...
                    </span>
                </button>
                
                <button onclick="signInWithGoogle()" 
                        class="w-full google-btn font-bold py-5 rounded-3xl flex items-center justify-center gap-4 hover:shadow-lg text-lg">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-6 h-6">
                    Continue with Google
                </button>
                
                <p class="text-center text-gray-600 mt-6">
                    Haven't activated your account? 
                    <a href="javascript:void(0)" onclick="switchTab('activate')" 
                       class="text-brand-primary font-bold hover:underline ml-1 transition-colors">
                        Switch to Activation
                    </a>
                </p>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal-bg hidden-step">
        <div class="bg-white rounded-4xl p-8 max-w-md w-full space-y-6 mx-4 shadow-2xl border border-gray-100">
            <div class="flex justify-between items-center pb-4 border-b border-gray-100">
                <div>
                    <h3 class="text-2xl font-black text-gray-900">Reset Password</h3>
                    <p class="text-gray-600 mt-1">We'll send you a secure reset link</p>
                </div>
                <button onclick="hideForgotPassword()" 
                        class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-gray-600"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="text-sm font-bold text-gray-500 uppercase tracking-widest ml-2">Email Address</label>
                    <div class="relative">
                        <i class="fas fa-envelope absolute left-5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="email" id="reset-email" placeholder="student@email.com" 
                            class="w-full pl-12 pr-5 py-4 rounded-3xl bg-gray-50 border-2 border-gray-200 outline-none focus:border-brand-primary focus:ring-4 focus:ring-emerald-50 transition-all-custom">
                    </div>
                </div>
                
                <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                        <div>
                            <h4 class="font-bold text-blue-800 mb-1">How it works</h4>
                            <p class="text-blue-700 text-sm">We'll email you a secure link to reset your password. The link expires in 1 hour for security.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-3 pt-4">
                <button onclick="hideForgotPassword()" 
                        class="flex-1 px-6 py-4 rounded-3xl border-2 border-gray-300 text-gray-700 font-bold hover:bg-gray-50 transition-all-custom">
                    Cancel
                </button>
                <button onclick="sendPasswordReset()" 
                        class="flex-1 px-6 py-4 rounded-3xl bg-gradient-to-r from-brand-primary to-brand-dark text-white font-bold hover:shadow-lg transition-all-custom"
                        id="reset-btn">
                    <span id="reset-text" class="flex items-center justify-center">
                        <i class="fas fa-paper-plane mr-2"></i>Send Reset Link
                    </span>
                    <span id="reset-loading" class="hidden items-center justify-center">
                        <i class="fas fa-spinner spinner mr-2"></i>Sending...
                    </span>
                </button>
            </div>
            
            <div class="pt-4 border-t border-gray-100 text-center">
                <p class="text-xs text-gray-500">
                    <i class="fas fa-shield-alt mr-1"></i>
                    Protected by Firebase Authentication
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        // IMPORTANT: Import Firebase modules
        import { auth, db } from './firebaseConfig-studentsignupmodular.js';
        import { 
            collection, 
            query, 
            where, 
            getDocs, 
            doc, 
            updateDoc, 
            setDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            updateProfile, 
            signInWithPopup, 
            GoogleAuthProvider,
            sendPasswordResetEmail,
            setPersistence,
            browserSessionPersistence,
            browserLocalPersistence,
            signOut
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

        // Security: Rate limiting variables
        let failedAttempts = 0;
        let lastAttemptTime = 0;
        const MAX_ATTEMPTS = 5;
        const LOCKOUT_TIME = 15 * 60 * 1000; // 15 minutes

        // Toast notification system
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            toast.innerHTML = `
                <i class="fas ${icons[type]} text-xl"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Auto-remove toast after duration
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 400);
            }, duration);
        }

        // Password strength checker
        window.checkPasswordStrength = () => {
            const password = document.getElementById('student-pass').value;
            const meter = document.getElementById('password-strength-meter');
            const strengthText = document.getElementById('strength-text');
            
            if (!password) {
                meter.className = 'password-strength-meter';
                strengthText.textContent = 'Weak';
                strengthText.className = 'text-sm font-bold text-red-600';
                document.querySelectorAll('#password-requirements li').forEach(li => {
                    li.classList.remove('valid');
                });
                return;
            }
            
            // Check requirements
            const hasLength = password.length >= 12;
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            
            // Update requirement indicators
            document.getElementById('req-length').classList.toggle('valid', hasLength);
            document.getElementById('req-uppercase').classList.toggle('valid', hasUpper);
            document.getElementById('req-lowercase').classList.toggle('valid', hasLower);
            document.getElementById('req-number').classList.toggle('valid', hasNumber);
            document.getElementById('req-special').classList.toggle('valid', hasSpecial);
            
            // Calculate strength score (0-4)
            let score = 0;
            if (hasLength) score++;
            if (hasUpper) score++;
            if (hasLower) score++;
            if (hasNumber) score++;
            if (hasSpecial) score++;
            
            // Update strength meter and text
            meter.className = `password-strength-meter strength-${score}`;
            
            const strengthLabels = ['Very Weak', 'Weak', 'Fair', 'Strong', 'Very Strong'];
            const strengthColors = ['text-red-600', 'text-orange-500', 'text-yellow-500', 'text-green-500', 'text-emerald-600'];
            
            strengthText.textContent = strengthLabels[score];
            strengthText.className = `text-sm font-bold ${strengthColors[score]}`;
            
            // Enable/disable activation button based on minimum requirements
            const activateBtn = document.getElementById('activate-btn');
            const minRequirementsMet = hasLength && hasUpper && hasLower && hasNumber && hasSpecial;
            activateBtn.disabled = !minRequirementsMet;
        };

        // Toggle password visibility
        window.togglePasswordVisibility = (inputId) => {
            const input = document.getElementById(inputId);
            const eyeIcon = document.getElementById(`eye-icon-${inputId === 'student-pass' ? 'student' : 'login'}`);
            
            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.className = 'far fa-eye-slash';
            } else {
                input.type = 'password';
                eyeIcon.className = 'far fa-eye';
            }
        };

        // Tab switching
        window.switchTab = (tab) => {
            const activateTab = document.getElementById('tab-activate');
            const loginTab = document.getElementById('tab-login');
            const activationFlow = document.getElementById('activation-flow');
            const loginFlow = document.getElementById('login-flow');
            
            if (tab === 'activate') {
                // Update tabs
                activateTab.classList.add('active');
                activateTab.classList.remove('text-gray-600');
                loginTab.classList.remove('active');
                loginTab.classList.add('text-gray-600');
                
                // Update flows
                activationFlow.classList.remove('hidden-step');
                loginFlow.classList.add('hidden-step');
                
                // Reset to step 1
                document.getElementById('step-1').classList.remove('hidden-step');
                document.getElementById('step-2').classList.add('hidden-step');
                
                // Clear form
                document.getElementById('parent-email').value = '';
                resetRateLimiting();
            } else {
                // Update tabs
                loginTab.classList.add('active');
                loginTab.classList.remove('text-gray-600');
                activateTab.classList.remove('active');
                activateTab.classList.add('text-gray-600');
                
                // Update flows
                loginFlow.classList.remove('hidden-step');
                activationFlow.classList.add('hidden-step');
                
                // Auto-fill remembered email
                const rememberedEmail = localStorage.getItem('student_email');
                if (rememberedEmail) {
                    document.getElementById('login-email').value = rememberedEmail;
                }
                
                resetRateLimiting();
            }
        };

        // Go back to step 1
        window.goBackToStep1 = () => {
            document.getElementById('step-1').classList.remove('hidden-step');
            document.getElementById('step-2').classList.add('hidden-step');
        };

        // Show/hide forgot password
        window.showForgotPassword = () => {
            document.getElementById('forgot-password-modal').classList.remove('hidden-step');
        };

        window.hideForgotPassword = () => {
            document.getElementById('forgot-password-modal').classList.add('hidden-step');
            document.getElementById('reset-email').value = '';
        };

        // Reset rate limiting
        function resetRateLimiting() {
            failedAttempts = 0;
            document.getElementById('rate-limit-warning').classList.add('hidden');
            document.getElementById('failed-attempts-warning').classList.add('hidden');
        }

        // Check if rate limited
        function checkRateLimit() {
            const now = Date.now();
            if (failedAttempts >= MAX_ATTEMPTS) {
                if (now - lastAttemptTime < LOCKOUT_TIME) {
                    const remainingMinutes = Math.ceil((LOCKOUT_TIME - (now - lastAttemptTime)) / 60000);
                    document.getElementById('rate-limit-message').textContent = 
                        `Too many failed attempts. Please try again in ${remainingMinutes} minute${remainingMinutes > 1 ? 's' : ''}.`;
                    document.getElementById('rate-limit-warning').classList.remove('hidden');
                    return true;
                } else {
                    // Reset after lockout period
                    failedAttempts = 0;
                }
            }
            return false;
        }

        // Find students by parent email
        window.findStudents = async () => {
            // Check rate limiting
            if (checkRateLimit()) {
                return;
            }
            
            const email = document.getElementById('parent-email').value.trim();
            
            // Validate email
            if (!email) {
                showToast('Please enter the parent email.', 'error');
                return;
            }
            
            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address.', 'error');
                return;
            }

            try {
                // Show loading
                document.getElementById('find-profile-text').classList.add('hidden');
                document.getElementById('find-profile-loading').classList.remove('hidden');
                document.getElementById('find-profile-btn').disabled = true;

                // Query students collection
                const q = query(collection(db, "students"), where("parentEmail", "==", email));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showToast('No student records found for this email.', 'error');
                    failedAttempts++;
                    lastAttemptTime = Date.now();
                    return;
                }

                const select = document.getElementById('student-select');
                select.innerHTML = '<option value="">Select your name</option>';
                let foundInactive = false;
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    // Only show students who haven't been activated yet
                    if (!data.studentUid || data.status !== 'active') {
                        const opt = document.createElement('option');
                        opt.value = doc.id;
                        opt.textContent = data.studentName + (data.grade ? ` - Grade ${data.grade}` : '');
                        select.appendChild(opt);
                        foundInactive = true;
                    }
                });
                
                if (foundInactive) {
                    document.getElementById('step-1').classList.add('hidden-step');
                    document.getElementById('step-2').classList.remove('hidden-step');
                    showToast('Students found! Please select your name.', 'success');
                } else {
                    showToast('All students under this email are already activated. Please login instead.', 'info');
                    switchTab('login');
                }
            } catch (error) {
                console.error('Error finding students:', error);
                showToast('An error occurred. Please try again.', 'error');
                failedAttempts++;
                lastAttemptTime = Date.now();
            } finally {
                // Reset loading state
                document.getElementById('find-profile-text').classList.remove('hidden');
                document.getElementById('find-profile-loading').classList.add('hidden');
                document.getElementById('find-profile-btn').disabled = false;
            }
        };

        // Complete registration
        window.completeRegistration = async () => {
            const docId = document.getElementById('student-select').value;
            const email = document.getElementById('student-email-input').value.trim();
            const password = document.getElementById('student-pass').value;
            const rememberMe = document.getElementById('remember-me-activation').checked;

            // Validate selection
            if (!docId || docId === "") {
                showToast('Please select your name from the list.', 'error');
                return;
            }

            // Validate email
            if (!email) {
                showToast('Please enter your email address.', 'error');
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address.', 'error');
                return;
            }

            // Validate password strength
            const hasLength = password.length >= 12;
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            
            if (!hasLength || !hasUpper || !hasLower || !hasNumber || !hasSpecial) {
                showToast('Please ensure your password meets all requirements.', 'error');
                return;
            }

            try {
                // Show loading
                document.getElementById('activate-text').classList.add('hidden');
                document.getElementById('activate-loading').classList.remove('hidden');
                document.getElementById('activate-btn').disabled = true;

                // Set persistence based on "Remember Me"
                const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, persistence);

                // Check if email already exists in students collection
                const emailCheck = query(collection(db, "students"), where("studentEmail", "==", email));
                const emailSnapshot = await getDocs(emailCheck);
                
                if (!emailSnapshot.empty) {
                    showToast('This email is already registered. Please use a different email or login.', 'error');
                    return;
                }

                // Create user in Firebase Auth
                const userCred = await createUserWithEmailAndPassword(auth, email, password);
                const studentName = document.getElementById('student-select').options[document.getElementById('student-select').selectedIndex].text.split(' - ')[0];
                
                // Update the students collection
                await updateDoc(doc(db, "students", docId), {
                    studentUid: userCred.user.uid,
                    studentEmail: email,
                    status: 'active',
                    activatedAt: serverTimestamp(),
                    lastLogin: serverTimestamp(),
                    security: {
                        passwordChangedAt: serverTimestamp(),
                        mfaEnabled: false
                    }
                });

                // Create audit log
                await setDoc(doc(collection(db, "audit_logs")), {
                    action: 'student_activation',
                    studentId: docId,
                    studentName: studentName,
                    email: email,
                    timestamp: serverTimestamp(),
                    userAgent: navigator.userAgent,
                    ip: await getClientIP()
                });

                // Update user profile
                await updateProfile(userCred.user, { 
                    displayName: studentName
                });

                // Store session info
                if (rememberMe) {
                    localStorage.setItem('student_remember_me', 'true');
                    localStorage.setItem('student_email', email);
                }

                showToast('Account activated successfully! Redirecting...', 'success');
                
                // Redirect after delay
                setTimeout(() => {
                    window.location.href = 'BKHstudentlogin.html';
                }, 2000);

            } catch (error) {
                console.error('Registration error:', error);
                
                // Handle specific Firebase errors
                if (error.code === 'auth/email-already-in-use') {
                    showToast('Email already registered. Please login instead.', 'error');
                    switchTab('login');
                } else if (error.code === 'auth/weak-password') {
                    showToast('Password is too weak. Please use a stronger password.', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    showToast('Invalid email format.', 'error');
                } else if (error.code === 'auth/network-request-failed') {
                    showToast('Network error. Please check your connection.', 'error');
                } else {
                    showToast('Registration failed: ' + error.message, 'error');
                }
            } finally {
                // Reset loading state
                document.getElementById('activate-text').classList.remove('hidden');
                document.getElementById('activate-loading').classList.add('hidden');
                document.getElementById('activate-btn').disabled = false;
            }
        };

        // Login student
        window.loginStudent = async () => {
            // Check rate limiting
            if (checkRateLimit()) {
                return;
            }
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me-login').checked;

            // Validate inputs
            if (!email || !password) {
                showToast('Please enter both email and password.', 'error');
                return;
            }

            try {
                // Show loading
                document.getElementById('login-text').classList.add('hidden');
                document.getElementById('login-loading').classList.remove('hidden');
                document.getElementById('login-btn').disabled = true;

                // Set persistence
                const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, persistence);

                // Attempt login
                const userCred = await signInWithEmailAndPassword(auth, email, password);
                
                // Verify the user exists in students collection
                const q = query(collection(db, "students"), where("studentUid", "==", userCred.user.uid));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    await signOut(auth);
                    showToast('Student account not found in database. Please contact support.', 'error');
                    failedAttempts++;
                    lastAttemptTime = Date.now();
                    return;
                }

                // Update last login
                const studentDoc = querySnapshot.docs[0];
                await updateDoc(doc(db, "students", studentDoc.id), {
                    lastLogin: serverTimestamp(),
                    failedAttempts: 0 // Reset on successful login
                });

                // Create audit log
                await setDoc(doc(collection(db, "audit_logs")), {
                    action: 'student_login',
                    studentId: studentDoc.id,
                    studentName: studentDoc.data().studentName,
                    timestamp: serverTimestamp(),
                    userAgent: navigator.userAgent,
                    rememberMe: rememberMe,
                    ip: await getClientIP()
                });

                // Store session info
                if (rememberMe) {
                    localStorage.setItem('student_remember_me', 'true');
                    localStorage.setItem('student_email', email);
                } else {
                    localStorage.removeItem('student_remember_me');
                    localStorage.removeItem('student_email');
                }

                // Reset failed attempts
                failedAttempts = 0;
                
                showToast('Login successful! Redirecting...', 'success');
                
                // Redirect after delay
                setTimeout(() => {
                    window.location.href = 'BKHstudentlogin.html';
                }, 1500);

            } catch (error) {
                console.error('Login error:', error);
                failedAttempts++;
                lastAttemptTime = Date.now();
                
                // Update failed attempts warning
                const remainingAttempts = MAX_ATTEMPTS - failedAttempts;
                if (remainingAttempts > 0) {
                    document.getElementById('failed-attempts-message').textContent = 
                        `Invalid credentials. ${remainingAttempts} attempt${remainingAttempts > 1 ? 's' : ''} remaining.`;
                    document.getElementById('failed-attempts-warning').classList.remove('hidden');
                } else {
                    document.getElementById('failed-attempts-message').textContent = 
                        `Account locked. Please try again in 15 minutes or reset your password.`;
                    document.getElementById('failed-attempts-warning').classList.remove('hidden');
                }

                // Handle specific Firebase errors
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    showToast('Invalid email or password.', 'error');
                } else if (error.code === 'auth/user-disabled') {
                    showToast('Account disabled. Please contact support.', 'error');
                } else if (error.code === 'auth/too-many-requests') {
                    showToast('Too many failed attempts. Account temporarily locked.', 'error');
                } else if (error.code === 'auth/network-request-failed') {
                    showToast('Network error. Please check your connection.', 'error');
                } else {
                    showToast('Login failed: ' + error.message, 'error');
                }
                
                // Shake animation for failed login
                document.getElementById('login-flow').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('login-flow').classList.remove('shake');
                }, 500);
            } finally {
                // Reset loading state
                document.getElementById('login-text').classList.remove('hidden');
                document.getElementById('login-loading').classList.add('hidden');
                document.getElementById('login-btn').disabled = false;
            }
        };

        // Google Sign-in functions
        window.signInWithGoogle = async () => {
            try {
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                provider.setCustomParameters({
                    prompt: 'select_account'
                });

                // Set persistence based on checkbox
                const rememberMe = document.getElementById('remember-me-login').checked;
                const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, persistence);

                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // Check if this Google user is in our students collection
                const q = query(collection(db, "students"), where("studentUid", "==", user.uid));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // Update last login
                    const studentDoc = querySnapshot.docs[0];
                    await updateDoc(doc(db, "students", studentDoc.id), {
                        lastLogin: serverTimestamp()
                    });

                    // Store session info
                    if (rememberMe) {
                        localStorage.setItem('student_remember_me', 'true');
                        localStorage.setItem('student_email', user.email);
                    }
                    
                    window.location.href = 'BKHstudentlogin.html';
                    return;
                }

                // Check if they have a matching email in students collection
                const emailQ = query(collection(db, "students"), where("studentEmail", "==", user.email));
                const emailSnapshot = await getDocs(emailQ);
                
                if (!emailSnapshot.empty) {
                    // Link the Google account to existing student record
                    const docId = emailSnapshot.docs[0].id;
                    await updateDoc(doc(db, "students", docId), {
                        studentUid: user.uid,
                        lastLogin: serverTimestamp()
                    });
                    
                    if (rememberMe) {
                        localStorage.setItem('student_remember_me', 'true');
                        localStorage.setItem('student_email', user.email);
                    }
                    
                    window.location.href = 'BKHstudentlogin.html';
                    return;
                }

                // No matching account found
                await signOut(auth);
                showToast('No student account found for this Google account. Please activate your account first.', 'error');
                
            } catch (error) {
                console.error("Google sign-in error:", error);
                
                // Handle specific Google OAuth errors
                if (error.code === 'auth/unauthorized-domain') {
                    showToast('Google sign-in not configured for this domain. Please contact administrator.', 'error');
                } else if (error.code === 'auth/popup-blocked') {
                    showToast('Popup blocked. Please allow popups for this site.', 'error');
                } else if (error.code === 'auth/popup-closed-by-user') {
                    showToast('Sign-in cancelled.', 'info');
                } else if (error.code === 'auth/network-request-failed') {
                    showToast('Network error. Please check your connection.', 'error');
                } else {
                    showToast('Google sign-in failed: ' + error.message, 'error');
                }
            }
        };

        // Google sign-in for activation
        window.signInWithGoogleForActivation = async () => {
            try {
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');

                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // Check if this Google user already has a student account
                const q = query(collection(db, "students"), where("studentUid", "==", user.uid));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    showToast('You already have an activated account. Please login instead.', 'info');
                    switchTab('login');
                    await signOut(auth);
                    return;
                }

                // Proceed to step 2 for profile selection
                document.getElementById('student-email-input').value = user.email;
                document.getElementById('step-1').classList.add('hidden-step');
                document.getElementById('step-2').classList.remove('hidden-step');
                showToast('Google account linked. Please select your name and create a password.', 'success');
                
            } catch (error) {
                console.error("Google sign-in error:", error);
                
                if (error.code === 'auth/unauthorized-domain') {
                    showToast('Google sign-in not configured for this domain. Please contact administrator.', 'error');
                } else if (error.code === 'auth/popup-blocked') {
                    showToast('Popup blocked. Please allow popups for this site.', 'error');
                } else if (error.code === 'auth/popup-closed-by-user') {
                    showToast('Sign-in cancelled.', 'info');
                } else {
                    showToast('Google sign-in failed: ' + error.message, 'error');
                }
            }
        };

        // Password reset function
        window.sendPasswordReset = async () => {
            const email = document.getElementById('reset-email').value.trim();
            
            if (!email) {
                showToast('Please enter your email address.', 'error');
                return;
            }
            
            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address.', 'error');
                return;
            }

            try {
                // Show loading
                document.getElementById('reset-text').classList.add('hidden');
                document.getElementById('reset-loading').classList.remove('hidden');
                document.getElementById('reset-btn').disabled = true;

                // Check if email exists in students collection
                const emailQ = query(collection(db, "students"), where("studentEmail", "==", email));
                const emailSnapshot = await getDocs(emailQ);
                
                if (emailSnapshot.empty) {
                    showToast('No student account found with this email.', 'error');
                    return;
                }

                // Send password reset email
                await sendPasswordResetEmail(auth, email, {
                    url: window.location.origin + '/studentsignup.html',
                    handleCodeInApp: false
                });

                // Create audit log
                await setDoc(doc(collection(db, "audit_logs")), {
                    action: 'password_reset_requested',
                    email: email,
                    timestamp: serverTimestamp(),
                    userAgent: navigator.userAgent,
                    ip: await getClientIP()
                });

                showToast('Password reset link sent! Check your email.', 'success');
                setTimeout(() => {
                    hideForgotPassword();
                }, 2000);

            } catch (error) {
                console.error('Password reset error:', error);
                
                if (error.code === 'auth/user-not-found') {
                    showToast('No account found with this email.', 'error');
                } else if (error.code === 'auth/too-many-requests') {
                    showToast('Too many reset attempts. Please try again later.', 'error');
                } else if (error.code === 'auth/network-request-failed') {
                    showToast('Network error. Please check your connection.', 'error');
                } else {
                    showToast('Failed to send reset email: ' + error.message, 'error');
                }
            } finally {
                document.getElementById('reset-text').classList.remove('hidden');
                document.getElementById('reset-loading').classList.add('hidden');
                document.getElementById('reset-btn').disabled = false;
            }
        };

        // Get client IP address
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.warn('Could not fetch IP address:', error);
                return 'unknown';
            }
        }

        // Auto-fill remembered email on page load
        document.addEventListener('DOMContentLoaded', () => {
            const rememberedEmail = localStorage.getItem('student_email');
            const rememberMe = localStorage.getItem('student_remember_me') === 'true';
            
            if (rememberedEmail && rememberMe) {
                document.getElementById('login-email').value = rememberedEmail;
                document.getElementById('remember-me-login').checked = true;
            }
            
            // Focus on first input in active tab
            if (document.getElementById('activation-flow').classList.contains('hidden-step')) {
                document.getElementById('login-email').focus();
            } else {
                document.getElementById('parent-email').focus();
            }
            
            // Add input event listeners for better UX
            document.getElementById('parent-email').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    findStudents();
                }
            });
            
            document.getElementById('student-email-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('student-pass').focus();
                }
            });
            
            document.getElementById('student-pass').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    completeRegistration();
                }
            });
            
            document.getElementById('login-email').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('login-password').focus();
                }
            });
            
            document.getElementById('login-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loginStudent();
                }
            });
            
            document.getElementById('reset-email').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendPasswordReset();
                }
            });
        });

    </script>
</body>
</html>
