<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Student Test - Blooming Kids House</title>
    <link rel="icon" href="favicon.ico" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
    <link rel="stylesheet" href="style.css" />
    
    <!-- Firebase for referral system -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body class="bg-green-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold text-green-800">Blooming Kids House Test</h1>
            <button onclick="logout()" class="bg-yellow-400 text-white px-4 py-2 rounded hover:bg-yellow-500">Logout</button>
        </div>

        <div id="question-container" class="space-y-4">
            <p class="text-gray-600">Loading questions...</p>
        </div>

        <div id="submit-button-container" class="mt-6 flex justify-center" style="display: none;">
            <button id="submit-test-btn" class="bg-green-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors duration-200">
                Submit Test
            </button>
        </div>
    </div>

    <script type="module">
        // --- START: FIREBASE INITIALIZATION (Surgical Addition for Database Access) ---
        // Configuration taken from parent (3).js
        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp({
                apiKey: "AIzaSyD1lJhsWMMs_qerLBSzk7wKhjLyI_11RJg",
                authDomain: "bloomingkidsassessment.firebaseapp.com",
                projectId: "bloomingkidsassessment",
                storageBucket: "bloomingkidsassessment.appspot.com",
                messagingSenderId: "238975054977",
                appId: "1:238975054977:web:87c70b4db044998a204980"
            });
        }
        const db = firebase.firestore();
        const REFERRAL_REWARD_AMOUNT = 5000; // ₦5,000 as per parent (3).js
        // --- END: FIREBASE INITIALIZATION ---

        // --- START: MODULE IMPORTS FOR QUESTION LOADING ---
        import { loadQuestions, getAnswerData, getAllLoadedQuestions, clearTestSession } from './autoQuestionGen.js';
        // --- END: MODULE IMPORTS ---

        // --- START: NEW REFERRAL LOGIC FUNCTIONS ---
        
        /**
         * Validates referral code and logs a pending transaction.
         */
        async function handleReferralLogic(code, studentName, studentUid) {
            const cleanCode = code.trim().toUpperCase();
            if (!cleanCode || cleanCode.length < 9) {
                console.log("No valid referral code provided. Skipping referral logic.");
                return;
            }

            try {
                // 1. Find the parent who owns this referral code
                const parentQuery = await db.collection('parent_users')
                    .where('referralCode', '==', cleanCode)
                    .limit(1)
                    .get();

                if (parentQuery.empty) {
                    console.warn(`Referral Code ${cleanCode} is invalid or expired. Skipping logging.`);
                    return;
                }

                const parentDoc = parentQuery.docs[0];
                const referringParentUid = parentDoc.id;

                // 2. Log the Pending Transaction
                await db.collection('referral_transactions').add({
                    referringParentUid: referringParentUid,
                    referredStudentUid: studentUid,
                    referredStudentName: studentName,
                    referralCode: cleanCode,
                    rewardAmount: REFERRAL_REWARD_AMOUNT, // ₦5,000
                    status: 'pending', // Pending payment confirmation
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    ownerUid: referringParentUid // For easy querying in parent portal
                });

                console.log(`Referral transaction logged successfully for Parent UID: ${referringParentUid}`);
                
            } catch (error) {
                console.error("Error during referral logic execution:", error);
                // Non-critical error, allows student process to continue
            }
        }
        
        /**
         * Combines the permanent student record creation, test saving, and referral logic.
         */
        async function createStudentAndSaveTest(subject, grade, studentName, parentEmail, tutorEmail, studentCountry, referralCode, testAnswers, questions) {
            try {
                // --- 1. Create Student Record (Initial Login) ---
                const studentData = {
                    studentName: studentName,
                    parentEmail: parentEmail,
                    tutorEmail: tutorEmail,
                    grade: grade,
                    country: studentCountry,
                    referralCodeUsed: referralCode.toUpperCase(), 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const studentRef = await db.collection('students').add(studentData); 
                const studentUid = studentRef.id;

                // --- 2. Save Test Results ---
                const testResultData = {
                    studentUid: studentUid,
                    studentName: studentName,
                    parentEmail: parentEmail,
                    parentPhone: '', // You might want to capture this
                    tutorEmail: tutorEmail,
                    grade: grade,
                    subject: subject,
                    answers: testAnswers,
                    questions: questions,
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'completed',
                    totalScoreableQuestions: questions.length,
                    score: calculateScore(testAnswers, questions),
                    studentCountry: studentCountry
                };

                await db.collection('student_results').add(testResultData);
                
                // --- 3. Run Referral Logic ---
                await handleReferralLogic(referralCode, studentName, studentUid);
                
                return studentUid;
            } catch (error) {
                console.error("Error saving student and test data:", error);
                throw error;
            }
        }

        /**
         * Calculate test score based on answers
         */
        function calculateScore(answers, questions) {
            let score = 0;
            questions.forEach((question, index) => {
                if (question.correctAnswer && answers[`q${index}`] === question.correctAnswer) {
                    score++;
                }
            });
            return score;
        }

        // --- END: NEW REFERRAL LOGIC FUNCTIONS ---

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const subject = urlParams.get('subject');
            const grade = urlParams.get('grade');
            const studentName = urlParams.get('studentName');
            const parentEmail = urlParams.get('parentEmail');
            const tutorEmail = urlParams.get('tutorEmail');
            const studentCountry = urlParams.get('country');
            const referralCode = urlParams.get('referralCode') || '';
            const state = urlParams.get('state') || (subject === 'ela' ? 'creative-writing' : 'mcq');

            if (!subject || !grade || !studentName || !parentEmail || !tutorEmail || !studentCountry) {
                alert("Missing student info. Redirecting...");
                window.location.href = "index.html";
                return;
            }

            // Clear localStorage and load questions
            localStorage.clear();
            
            try {
                // Load questions using the imported function
                await loadQuestions(subject, grade, state);
                document.getElementById("submit-button-container").style.display = 'flex';
            } catch (error) {
                console.error("Error loading questions:", error);
                document.getElementById("question-container").innerHTML = 
                    `<p class="text-red-600">Error loading questions. Please try again.</p>`;
            }

            // Setup submit button
            const submitBtn = document.getElementById("submit-test-btn");
            if (submitBtn) {
                submitBtn.addEventListener('click', async () => {
                    // Validate all questions are answered
                    const allQuestions = getAllLoadedQuestions();
                    const answers = getAnswerData();
                    
                    // Check if all questions are answered
                    const unansweredQuestions = allQuestions.filter((q, index) => {
                        return !answers[`q${index}`] && !answers[q.id];
                    });

                    if (unansweredQuestions.length > 0) {
                        alert(`Please answer all ${unansweredQuestions.length} remaining questions before submitting.`);
                        return;
                    }

                    // Disable button to prevent double-submission
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';

                    try {
                        // Save everything to Firebase
                        await createStudentAndSaveTest(
                            subject, grade, studentName, parentEmail, 
                            tutorEmail, studentCountry, referralCode, 
                            answers, allQuestions
                        );
                        
                        // Clear test session
                        clearTestSession(true);
                        
                        // Show success and redirect
                        document.getElementById("question-container").innerHTML = 
                            `<div class="text-center p-6 text-green-700 font-semibold text-xl">✅ Test Submitted Successfully! Redirecting...</div>`;
                        
                        setTimeout(() => window.location.href = "subject-select.html", 2000);
                    } catch (error) {
                        console.error("Submission error:", error);
                        alert("Error submitting test. Please try again.");
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Test';
                    }
                });
            }
        });

        window.logout = () => {
            localStorage.clear();
            clearTestSession(true);
            window.location.href = 'index.html';
        };
    </script>
</body>
</html>
